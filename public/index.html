<!DOCTYPE html>
<html lang="en">
  <head>
    
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InkWell</title>
  <link href="https://fonts.googleapis.com/css2?family=Alice&display=swap" rel="stylesheet" />
  <style>
    :root {
      /* Brand (Cyan/Teal) */
      --brand-primary: #2A6972;
      --brand-secondary: #388b97;
      --brand-alt: #3f9caa;
      --brand-outline: #4f4f4f;
      --font-main: #4f4f4f;
      --font-accent: #2A6972;
      --font-white: #ffffff;
      --title-font: 'Helvetica Neue', sans-serif;
      --body-font: 'Alice', serif;

      /* Backgrounds (Light) */
      --bg-light: #89C9D4;
      --bg-light-alt: #aedae2;
      --bg-card: #ffffff;
      --bg-muted: #f6fbfc;

      /* Muted Info */
      --info-muted: #388b97;
      --info-bg: #eaf6fb;

      /* Accent (Sophy, coach) */
      --accent: #d49489;
      --accent-dark: #72332;

      /* Buttons */
      --btn-bg: #2A6972;
      --btn-hover: #388b97;
      --btn-font: #ffffff;

      /* Border */
      --border: #aedae2;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-light: #15363a;
        --bg-light-alt: #23585f;
        --bg-card: #1c474d;
        --bg-muted: #23585f;
        --font-main: #ffffff;
        --font-accent: #3f9caa;
        --brand-primary: #2A6972;
        --brand-secondary: #388b97;
        --brand-alt: #3f9caa;
        --brand-outline: #4f4f4f;
        --info-muted: #3f9caa;
        --info-bg: #23585f;
        --accent: #d49489;
        --accent-dark: #72332;
        --btn-bg: #388b97;
        --btn-hover: #2A6972;
        --btn-font: #ffffff;
        --border: #2A6972;
      }
    }
    html[data-theme='dark'] {
      --bg-light: #15363a;
      --bg-light-alt: #23585f;
      --bg-card: #1c474d;
      --bg-muted: #23585f;
      --font-main: #ffffff;
      --font-accent: #3f9caa;
      --brand-primary: #2A6972;
      --brand-secondary: #388b97;
      --brand-alt: #3f9caa;
      --brand-outline: #4f4f4f;
      --info-muted: #3f9caa;
      --info-bg: #23585f;
      --accent: #d49489;
      --accent-dark: #72332;
      --btn-bg: #388b97;
      --btn-hover: #2A6972;
      --btn-font: #ffffff;
      --border: #2A6972;
    }
    html[data-theme='light'] {
      --bg-light: #89C9D4;
      --bg-light-alt: #aedae2;
      --bg-card: #ffffff;
      --bg-muted: #f6fbfc;
      --font-main: #4f4f4f;
      --font-accent: #2A6972;
      --brand-primary: #2A6972;
      --brand-secondary: #388b97;
      --brand-alt: #3f9caa;
      --brand-outline: #4f4f4f;
      --info-muted: #388b97;
      --info-bg: #eaf6fb;
      --accent: #d49489;
      --accent-dark: #72332;
      --btn-bg: #2A6972;
      --btn-hover: #388b97;
      --btn-font: #ffffff;
      --border: #aedae2;
    }

    body {
      margin: 0;
      background: var(--bg-light);
      color: var(--font-main);
      font-family: var(--body-font);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2em;
    }

    main {
      background: var(--bg-card);
      color: var(--font-main);
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(49, 122, 133, 0.07);
      padding: 2em;
      max-width: 600px;
      width: 100%;
    }

    header {
      text-align: center;
      margin-bottom: 2em;
      color: var(--font-main);
    }

    h1, h2, h3, h4, h5 {
      font-family: var(--title-font);
      color: var(--brand-primary);
      font-weight: 600;
    }

    h1 {
      font-size: 2.5em;
    }

    p, label, input, textarea, button {
      font-family: var(--body-font);
      color: var(--font-main);
    }

    .section-header {
      font-size: 1.2em;
      color: var(--brand-primary);
      margin-top: 0;
      margin-bottom: 0.5em;
    }

    /* Override section-header color in dark mode for readability */
    @media (prefers-color-scheme: dark) {
      .section-header {
        color: #FDF7F1; /* soft off-white for readability */
      }
    }
    html[data-theme='dark'] .section-header {
      color: #FDF7F1 !important;
    }

    .subtext-muted {
      font-size: 0.85em;
      color: var(--info-muted);
      font-style: italic;
      margin-top: 0.25em;
    }

    .sophy-info {
      background: #fff;
      color: var(--info-muted);
      font-style: italic;
      border-radius: 5px;
      padding: 0.75em 1em;
      border: 1px solid var(--border);
      margin-top: 0.5em;
      margin-bottom: 0.5em;
      font-size: 0.95em;
    }

    .card-block {
      background: var(--bg-muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 2em;
    }
    .card-block p {
      font-size: 1em;
      line-height: 1.6;
    }

    footer, footer p, footer a {
      color: var(--info-muted) !important;
    }

    /* Buttons */
    .btn {
      background-color: var(--btn-bg);
      color: var(--btn-font);
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 0.5em 1em;
      font-size: 0.95em;
      margin-top: 0.5em;
      transition: background 0.2s;
      outline: 2px solid var(--brand-outline);
    }
    .btn:hover {
      background-color: var(--btn-hover);
    }
    .btn:active, .btn:focus {
      outline: 2px solid var(--accent);
    }

    /* Tab active and inactive styles: shades of primary brand color */
    .tab-btn {
      background-color: var(--brand-primary);
      color: var(--font-white);
      border: none;
      border-radius: 5px 5px 0 0;
      padding: 0.5em 1em;
      font-size: 1em;
      margin-bottom: -1px;
      transition: background 0.2s;
      position: relative;
      z-index: 1;
      font-weight: 500;
    }
    .tab-btn.active {
      background-color: var(--brand-secondary);
      color: var(--font-white);
      font-weight: bold;
      z-index: 2;
    }

    /* Sophy-themed button: accent color, works for both light and dark */
    .btn-sophy {
      background-color: var(--accent);
      color: var(--btn-font);
      outline: 2px solid var(--accent-dark);
      transition: background 0.2s;
    }
    .btn-sophy:hover,
    .btn-sophy:focus {
      background-color: var(--accent-dark);
      color: var(--font-white);
    }

    /* Theme-specific Sophy hover/focus overrides (complementary accent) */
    html[data-theme='light'] .btn-sophy:hover,
    html[data-theme='light'] .btn-sophy:focus {
      background-color: #723332; /* dark complementary */
      color: #fff;
    }
    html[data-theme='dark'] .btn-sophy:hover,
    html[data-theme='dark'] .btn-sophy:focus {
      background-color: #723332 !important; /* dark complementary, more visible */
      color: #fff !important;
    }

    /* Sign In/Sign Up button styles for login modal */
    .login-btn-signin {
      background-color: var(--brand-secondary) !important;
      color: var(--btn-font) !important;
    }
    .login-btn-signin:hover,
    .login-btn-signin:focus {
      background-color: #5bb7c8 !important;
      color: var(--btn-font) !important;
      filter: brightness(1.09);
    }
    .login-btn-signup {
      background-color: var(--btn-bg) !important;
      color: var(--btn-font) !important;
    }
    .login-btn-signup:hover,
    .login-btn-signup:focus {
      background-color: var(--brand-secondary) !important;
      color: var(--btn-font) !important;
      filter: brightness(1.07);
    }

    /* Inputs/textareas */
    input, textarea {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--font-main);
      border-radius: 5px;
      padding: 0.5em;
    }
    input:focus, textarea:focus {
      border: 1.5px solid var(--brand-primary);
      outline: none;
    }

    textarea {
      width: 100%;
      height: 200px;
      
      font-size: 1em;
      resize: vertical;
    }

    /* Accent and AI highlight (Sophy, coach) */
    #generatedPrompt,
    #sophyInsight,
    .coach-reply,
    .ai-highlight,
    .sophy-accent {
      color: var(--accent-dark);
      background: var(--accent);
      border-left: 4px solid var(--accent-dark);
      padding: 0.75em 1em;
      border-radius: 5px;
      font-style: italic;
    }

    /* Modals and overlays */
    #embeddedAgreementNotice,
    #loginModal,
    #goodbyeModal {
      background: rgba(21, 54, 58, 0.85) !important;
      color: var(--font-white);
    }
    #embeddedAgreementNotice .card-block,
    #loginModal .card-block,
    #goodbyeModal .card-block {
      background: var(--bg-card);
      color: var(--font-main);
      border: 2px dashed var(--brand-primary);
    }

    /* Calendar overrides */
    #calendarTab th,
    #calendarTab td,
    #calendarTab p,
    #calendarTab h2,
    #calendarTab h3 {
      color: var(--font-main);
    }

    /* Pop-up and toast notifications */
    .toast {
      background: var(--accent);
      color: var(--font-white);
      border-radius: 5px;

    }


    /* Flash confirmation animation for journal entry */
    .flash-confirmation {
      animation: flashHighlight 1s ease-in-out;
    }
    @keyframes flashHighlight {
      0% { background-color: #D4F5D0; }
      50% { background-color: #A1E3A1; }
      100% { background-color: transparent; }
    }

    .spinner {
      display: inline-block;
      width: 1em;
      height: 1em;
      border: 2px solid rgba(49, 122, 133, 0.15);
      border-top-color: var(--btn-bg);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5em;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .entry-preview {
      max-height: 4.5em;
      overflow: hidden;
      position: relative;
    }
    .entry-preview::after {
      content: "...";
      position: absolute;
      bottom: 0;
      right: 0;
      background: linear-gradient(to right, transparent, var(--bg-card) 50%);
    }

    /* Responsive: Inherit colors for mobile, too */
    @media (max-width: 600px) {
      body {
        padding: 1em;
        background: var(--bg-light-alt);
      }

      main {
        background: var(--bg-card);
        padding: 1em;
        max-width: 100%;
        border-radius: 0;
        box-shadow: none;
      }

      textarea {
        height: 150px;
      }

      button {
        width: 100%;
        font-size: 0.95em;
        padding: 0.5em;
      }

      header img {
        max-width: 100%;
        height: auto;
      }

      input[type="text"],
      input[type="date"],
      input[type="file"],
      textarea {
        font-size: 1em;
      }
    }
    /* Tighter file upload UI for mobile */
    @media (max-width: 600px) {
      .card-block {
        padding: 0.5em !important;
      }
      label[for="attachment"] {
        font-size: 1em;
        margin-bottom: 0.5em;
      }
      #attachment {
        width: 100% !important;
        min-width: 0 !important;
        max-width: 100% !important;
        box-sizing: border-box;
      }
      #attachmentPreview {
        max-width: 100% !important;
      }
      .card-block {
        max-width: 100vw;
        box-sizing: border-box;
        overflow-x: auto;
      }
    }
    html {
      transition: background-color 0.3s ease, color 0.3s ease;
    }
/* User theme override (takes priority over prefers-color-scheme) */
html[data-theme='light'] {
  color-scheme: light;
}
html[data-theme='dark'] {
  color-scheme: dark;
}

    /* Custom checkboxes using accent color */
    input[type="checkbox"] {
      accent-color: var(--accent);
      width: 1.1em;
      height: 1.1em;
      vertical-align: middle;
      margin-right: 0.4em;
      border-radius: 3px;
      transition: accent-color 0.2s;
    }
    input[type="checkbox"]:focus {
      outline: 2px solid var(--accent-dark);
      outline-offset: 1px;
    }

    .coach-tag-label {
      display: block;
      margin-top: 1em;
      margin-bottom: 0.5em;
      font-size: 1em;
      font-weight: 600;
      border-left: 3px solid var(--accent);
      padding-left: 0.75em;
      color: var(--accent-dark);
      background: rgba(212,148,137,0.08);
      border-radius: 3px;
      transition: background 0.2s;
    }
    .coach-tag-label:hover {
      background: rgba(212,148,137,0.18);
    }

    /* Override default text selection color to match theme */
    ::selection {
      background: var(--brand-secondary);
      color: #ffffff;
    }
    ::-moz-selection {
      background: var(--brand-secondary);
      color: #ffffff;
    }
  .logo-hero {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 2.6em auto;
    width: 324px;
    height: 324px;
    position: relative;
    /* Deep/wide drop shadow for logo container */
    box-shadow: 0 8px 44px 0 rgba(255,255,255,0.135), 0 12px 60px 0 rgba(137,201,212,0.07);
    border-radius: 28px;
    background: none;
    margin-bottom: 2.6em;
  }
  .logo-image {
    display: block;
    max-width: 276px;
    max-height: 276px;
    width: auto;
    height: auto;
    border-radius: 26px;
    box-shadow: none;
    z-index: 2;
    position: relative;
  }

  /* Unified soft radial background for logo - ALL THEMES */
  .logo-hero::before,
  html[data-theme='light'] .logo-hero::before,
  html[data-theme='dark'] .logo-hero::before,
  :root:not([data-theme='dark']):not([data-theme='light']) .logo-hero::before {
    content: "";
    position: absolute;
    left: 50%;
    top: 50%;
    width: 240px;
    height: 240px;
    transform: translate(-50%, -50%);
    background: radial-gradient(circle, rgba(255,255,255,0.92) 80%, rgba(137,201,212,0.17) 100%);
    border-radius: 50%;
    z-index: 1;
    pointer-events: none;
  }

  /* Drop shadow for logo-hero in dark and light theme overrides */
  html[data-theme='dark'] .logo-hero {
    box-shadow: 0 8px 44px 0 rgba(255,255,255,0.135), 0 12px 60px 0 rgba(137,201,212,0.07);
  }
  html[data-theme='light'] .logo-hero {
    box-shadow: 0 4px 32px 0 rgba(42, 105, 114, 0.26), 0 6px 44px 0 rgba(72, 109, 112, 0.15);
  }
  :root:not([data-theme='light']) .logo-hero {
    box-shadow: 0 8px 44px 0 rgba(255,255,255,0.135), 0 12px 60px 0 rgba(137,201,212,0.07);
  }
    #attachment {
      width: 90%;
      max-width: 330px;
      min-width: 140px;
    }
  </style>
  <script type="module">
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDivYKnp_SinGjL7iVVwSyQH-RnFHMFDM0",
      authDomain: "inkwell-alpha.firebaseapp.com",
      projectId: "inkwell-alpha",
      storageBucket: "inkwell-alpha.firebasestorage.app",
      appId: "1:1066466790954:web:adc4e0a397295cb7c520eb"
    };
    // --- Smart Search imports ---
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-functions.js";
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import { sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    window.app = app;

    const db = getFirestore(app);
    window.db = db;

    const storage = getStorage(app);
    const auth = getAuth(app);
    window.auth = auth;
    
// ... all your Firebase and other imports above ...

// === THEME TOGGLE LOGIC ===
function applyTheme(mode) {
  document.documentElement.removeAttribute('data-theme');
  if (mode === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
  } else if (mode === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
  }
  // 'default' means use system preference only
}

document.addEventListener("DOMContentLoaded", () => {
  const themeSelect = document.getElementById('themeModeSelect');
  if (!themeSelect) return;
  // Load saved mode
  const savedMode = localStorage.getItem('inkwell-theme-mode') || 'default';
  themeSelect.value = savedMode;
  applyTheme(savedMode);

  themeSelect.addEventListener('change', function () {
    localStorage.setItem('inkwell-theme-mode', this.value);
    applyTheme(this.value);
  });
});


    // === SESSION MANAGEMENT: Auto-logout on close/refresh and inactivity ===
    // Helper: logout only if signed in
    async function safeLogout(reason) {
      if (auth.currentUser) {
        localStorage.setItem("userJustLoggedOut", "true");
        await auth.signOut();
        document.querySelector("main").style.display = "none";
        // Always hide the Alpha modal on logout
        document.getElementById("embeddedAgreementNotice").style.display = "none";
        setTimeout(() => {
          document.getElementById("goodbyeModal").style.display = "flex";
          if (reason === "inactivity") {
            // Show a user-friendly alert
            alert("You were logged out due to inactivity. Please sign in again to continue journaling.");
          }
        }, 100);
      }
    }

    // Logout on tab close/refresh
    window.addEventListener("beforeunload", (e) => {
      if (auth.currentUser) {
        // Use navigator.sendBeacon or sync XHR for best effort logout
        // But Firebase signOut is async and may not complete, so just set flag
        localStorage.setItem("userJustLoggedOut", "true");
        // Try to sign out (may not complete)
        auth.signOut();
      }
    });

    // Inactivity auto-logout (15 min), warn user before logout
    let inactivityTimeout = null;
    let warningTimeout = null;
    const INACTIVITY_LIMIT = 15 * 60 * 1000; // 15 min
    const WARNING_TIME = 14 * 60 * 1000; // 14 min (1 min before logout)

    function resetInactivityTimers() {
      if (inactivityTimeout) clearTimeout(inactivityTimeout);
      if (warningTimeout) clearTimeout(warningTimeout);
      // Only set timers if signed in
      if (auth.currentUser) {
        warningTimeout = setTimeout(() => {
          // Show alert 1 min before auto-logout
          alert("You will be logged out soon due to inactivity. Move your mouse or press a key to stay logged in.");
        }, WARNING_TIME);
        inactivityTimeout = setTimeout(() => {
          safeLogout("inactivity");
        }, INACTIVITY_LIMIT);
      }
    }

    // Reset inactivity timer on user activity
    ["mousemove", "keydown", "mousedown", "touchstart"].forEach(evt =>
      window.addEventListener(evt, resetInactivityTimers, true)
    );

    // Reset timers on login/logout state change
    onAuthStateChanged(auth, user => {
      if (user && !user.isAnonymous) {
        resetInactivityTimers();
      } else {
        if (inactivityTimeout) clearTimeout(inactivityTimeout);
        if (warningTimeout) clearTimeout(warningTimeout);
      }
    });

// Move showTab global function here (outside onAuthStateChanged)
window.showTab = function(tabId) {
  const tabs = ["journalTab", "calendarTab"];
  const buttons = {
    journalTab: document.getElementById("journalTabButton"),
    calendarTab: document.getElementById("calendarTabButton")
  };

  tabs.forEach(id => {
    document.getElementById(id).style.display = (id === tabId ? "block" : "none");
    // Remove direct style overrides for tab background and color; rely on CSS classes
    // if (buttons[id]) {
    //   buttons[id].style.setProperty("background-color", id === tabId ? "#2A6D6D" : "#FFA76D", "important");
    //   buttons[id].style.color = "white";
    // }
  });

  // Remove all active classes from tab buttons, then set active on the selected
  if (buttons.journalTab) buttons.journalTab.classList.remove("active");
  if (buttons.calendarTab) buttons.calendarTab.classList.remove("active");
  if (tabId === "journalTab" && buttons.journalTab) {
    buttons.journalTab.classList.add("active");
  } else if (tabId === "calendarTab" && buttons.calendarTab) {
    buttons.calendarTab.classList.add("active");
  }

  if (tabId === "calendarTab") {
    buildCalendar();
    loadPastEntries();
    document.getElementById("calendarEntries") && (document.getElementById("calendarEntries").innerHTML = "<p>Click a calendar date to view entries.</p>");
    document.getElementById("searchResults") && (document.getElementById("searchResults").innerHTML = "<p>Use Smart Search to explore your journal history.</p>");
  }
};
// Handle embedded agreement button logic
window.acceptEmbeddedAgreement = async function () {
  const embeddedCheckbox = document.getElementById("embeddedAgreementCheckbox");
  const acceptEmbeddedBtn = document.getElementById("acceptEmbeddedAgreementButton");

  if (!embeddedCheckbox.checked || !window.currentUserId) return;

  try {
    localStorage.setItem("alphaAgreementAccepted", "true");

    await setDoc(doc(db, "users", window.currentUserId), {
      agreementAccepted: true
    }, { merge: true });

    document.getElementById("embeddedAgreementNotice").style.display = "none";
    document.getElementById("journalTab").style.display = "block";
    document.getElementById("tabButtons").style.display = "flex";
    document.querySelector("main").style.display = "block";
  } catch (err) {
    alert("Error saving agreement: " + err.message);
    console.error("Detailed agreement save error:", err);
  }
};


// Enable the Accept button only when checkbox is checked
document.addEventListener("DOMContentLoaded", () => {
  const embeddedCheckbox = document.getElementById("embeddedAgreementCheckbox");
  const acceptEmbeddedBtn = document.getElementById("acceptEmbeddedAgreementButton");

  embeddedCheckbox?.addEventListener("change", () => {
    acceptEmbeddedBtn.disabled = !embeddedCheckbox.checked;
  });

  // Disable search button by default (safer inside DOMContentLoaded)
  const searchBtn = document.getElementById("searchBtn");
  if (searchBtn) searchBtn.disabled = true;
});

let currentUserId = null;

onAuthStateChanged(auth, async (user) => {
  // DEBUG: Log when onAuthStateChanged handler runs and user object
  console.log("onAuthStateChanged triggered. User object:", user);

  // Always hide the Alpha Agreement modal by default
  document.getElementById("embeddedAgreementNotice").style.display = "none";

  if (!user) {
    const justLoggedOut = localStorage.getItem("userJustLoggedOut") === "true";

    document.getElementById("embeddedAgreementNotice").style.display = "none";
    document.getElementById("journalTab").style.display = "none";
    document.getElementById("tabButtons").style.display = "none";

    if (justLoggedOut) {
      document.getElementById("goodbyeModal").style.display = "flex";
      localStorage.removeItem("userJustLoggedOut");
      document.getElementById("loginModal").style.display = "none";
    } else {
      document.getElementById("loginModal").style.display = "flex";
      document.getElementById("goodbyeModal").style.display = "none";
    }
    document.querySelector("main").style.display = "none";
    // Disable Smart Search button and function for logged-out users
    const searchBtn = document.getElementById("searchBtn");
    if (searchBtn) searchBtn.disabled = true;
    window.runSmartSearch = function () { alert("You must be logged in."); };
    const searchInput = document.getElementById("searchQuery");
    if (searchInput) searchInput.value = "";
    // Clear the Smart Search field on logout
    return;
  }

  // If anonymous or missing UID, hide Alpha modal and main UI
  if (!user.uid || user.isAnonymous) {
    document.getElementById("embeddedAgreementNotice").style.display = "none";
    document.querySelector("main").style.display = "none";
    // Disable Smart Search button and function for anonymous users
    const searchBtn = document.getElementById("searchBtn");
    if (searchBtn) searchBtn.disabled = true;
    window.runSmartSearch = function () { alert("You must be logged in."); };
    return;
  }


  currentUserId = user.uid;
  window.currentUserId = user.uid;

  const userDocRef = doc(db, "users", user.uid);
  const userDoc = await getDoc(userDocRef);

  if (!userDoc.exists()) {
    await setDoc(userDocRef, {
      email: user.email || "",
      createdAt: serverTimestamp(),
      userRole: "journaler",
      agreementAccepted: false
    });
  }


  const statusDiv = document.getElementById("userStatus");
  const displayName = userDoc.data()?.displayName;
  statusDiv.textContent = displayName
    ? `Journaling as: ${displayName}`
    : user.email
      ? `Journaling as: ${user.email}`
      : "Journaling anonymously";

  if (userDoc.data()?.avatarUrl) {
    const avatarImg = document.createElement("img");
    avatarImg.src = userDoc.data().avatarUrl;
    avatarImg.alt = "User Avatar";
    avatarImg.style.width = "40px";
    avatarImg.style.height = "40px";
    avatarImg.style.borderRadius = "50%";
    avatarImg.style.marginLeft = "10px";
    statusDiv.appendChild(avatarImg);
  }

  const agreed = userDoc.data()?.agreementAccepted === true;
  const localAccepted = localStorage.getItem("alphaAgreementAccepted") === "true";
  // DEBUG: Log agreement check state
  console.log("Agreement debug:", {agreed, localAccepted, userDoc: userDoc.data()});
  // Only show Alpha modal if user exists and is not anonymous and hasn't agreed
  if (!agreed && !localAccepted) {
    document.getElementById("embeddedAgreementNotice").style.display = "block";
    document.getElementById("journalTab").style.display = "none";
    document.getElementById("tabButtons").style.display = "none";
    document.getElementById("loginModal").style.display = "none";
    document.getElementById("goodbyeModal").style.display = "none";
    document.querySelector("main").style.display = "none";
    return;
  }

  document.getElementById("embeddedAgreementNotice").style.display = "none";
  document.getElementById("loginModal").style.display = "none";

  document.getElementById("goodbyeModal").style.display = "none";
  document.getElementById("tabButtons").style.display = "flex";
  document.getElementById("journalTab").style.display = "block";
  document.querySelector("main").style.display = "block";
  // Enable Smart Search button only for logged-in users (not anonymous)
  const searchBtn = document.getElementById("searchBtn");
  if (searchBtn) searchBtn.disabled = false;
  window.runSmartSearch = runSmartSearch;

  // Always refresh Manifest Statement after login
  if (window.currentUserId) {
    try {
      const manifestDoc = await getDoc(doc(db, "manifests", window.currentUserId));
      const manifestInput = document.getElementById("manifestInput");
      if (manifestDoc.exists() && manifestInput) {
        manifestInput.value = manifestDoc.data().statement || "";
        console.log("âœ… Manifest loaded after login.");
      } else if (manifestInput) {
        manifestInput.value = "";
        console.log("â„¹ï¸ No manifest found after login.");
      }
    } catch (err) {
      console.error("âŒ Error loading manifest after login:", err);
      const manifestInput = document.getElementById("manifestInput");
      if (manifestInput) manifestInput.value = "";
    }
  }

  setTimeout(() => showTab('journalTab'), 20);



  buildCalendar();

  // âœ… Check for new coach replies and show toast if present
  try {
    const entriesRef = collection(db, "journalEntries");
    const q = query(entriesRef, where("userId", "==", currentUserId), where("newCoachReply", "==", true));
    const snap = await getDocs(q);

    if (!snap.empty) {
      const toast = document.createElement("div");
      toast.textContent = "ðŸ’¬ You have a new reply from your coach!";
      toast.style.position = "fixed";
      toast.style.top = "20px";               // Show at top
      toast.style.bottom = "";                // Clear bottom style
      toast.style.left = "50%";
      toast.style.transform = "translateX(-50%)";
      toast.style.backgroundColor = "#FFA76D";
      toast.style.color = "#fff";
      toast.style.padding = "1em 1.5em";
      toast.style.borderRadius = "5px";
      toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
      toast.style.zIndex = "9999";
      document.body.appendChild(toast);
      setTimeout(async () => {
        toast.remove();

        
        // ðŸ”„ Clear newCoachReply flags from entries
        try {
          for (const doc of snap.docs) {
            await updateDoc(doc.ref, { newCoachReply: false });
          }
          console.log("âœ… Cleared newCoachReply flags.");
        } catch (clearErr) {
          console.warn("âš ï¸ Failed to clear coach reply flags:", clearErr);
        }

      }, 6000);
    }
  } catch (err) {
    console.warn("Coach reply check failed:", err);
  }
});


window.onload = function () {
  // === InkOutLoud Voice Input Integration ===
  const voiceBtn = document.getElementById("voiceBtn");
  const voiceStatus = document.getElementById("voiceStatus");
  const journalEntry = document.getElementById("journal");

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    if (voiceBtn) voiceBtn.disabled = true;
    if (voiceStatus) voiceStatus.textContent = "InkOutLoud requires Chrome or Edge.";
  } else {
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    let isListening = false;
    let stopTimeout = null;

    recognition.onstart = () => {
      if (voiceStatus) voiceStatus.textContent = "ðŸŽ¤ Listening... Tap again to stop.";
      if (voiceBtn) voiceBtn.textContent = "ðŸ›‘ Stop InkOutLoud";
    };

    recognition.onresult = async (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript;
      if (voiceStatus) voiceStatus.textContent = "ðŸ§  Cleaning up your voice entry...";

      try {
        const user = auth?.currentUser;
        if (!user) {
          console.warn("User not signed in. Cannot clean transcript.");
          if (voiceStatus) voiceStatus.textContent = "âš ï¸ You must be logged in to use voice journaling.";
          return;
        }

        const idToken = await user.getIdToken();
        const response = await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/cleanVoiceTranscript", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${idToken}`
          },
          body: JSON.stringify({ rawText: transcript })
        });

        const data = await response.json();
        if (data.cleanedText) {
          if (journalEntry) {
            journalEntry.value += (journalEntry.value ? " " : "") + data.cleanedText;
          }
          if (voiceStatus) voiceStatus.textContent = "âœ… Voice entry added.";
        } else {
          throw new Error("No cleaned text received.");
        }
      } catch (err) {
        console.error("ðŸ›‘ Error cleaning voice transcript:", err);
        if (voiceStatus) voiceStatus.textContent = "âŒ Failed to clean voice input.";
      }
    };

    recognition.onerror = (event) => {
      if (voiceStatus) voiceStatus.textContent = "âŒ Error: " + event.error;
    };

    recognition.onend = () => {
      if (isListening) {
        recognition.start(); // Auto-restart if session ends prematurely
      }
    };

    if (voiceBtn) {
      voiceBtn.onclick = () => {
        if (!isListening) {
          recognition.start();
          isListening = true;
          voiceBtn.textContent = "ðŸ›‘ Stop InkOutLoud";

          stopTimeout = setTimeout(() => {
            recognition.stop();
            isListening = false;
            voiceBtn.textContent = "ðŸŽ™ï¸ Try InkOutLoud";
          }, 90000); // 90 seconds
        } else {
          recognition.stop();
          isListening = false;
          voiceBtn.textContent = "ðŸŽ™ï¸ Try InkOutLoud";
          if (stopTimeout) clearTimeout(stopTimeout);
        }
      };
    }
  }
  window.saveJournalEntry = async function () {
    const textarea = document.getElementById("journal");
    const text = textarea.value.trim();
    // --- Begin: Insert logic to optionally include Sophy's reflection ---
    const includeReflection = document.getElementById("autoInsertReflection")?.checked;
    const sophyText = document.getElementById("sophyInsight")?.textContent || "";
    const finalText = includeReflection ? text + "\n\n[Sophy's Reflection]\n" + sophyText : text;
    // --- End: Insert logic to optionally include Sophy's reflection ---
    if (!text) return alert("Please enter something before saving.");
    showSpinner("saveStatus", "Saving...");

    try {
      // Multiple file upload support
      const fileInput = document.getElementById("attachment");
      const files = Array.from(fileInput.files || []);
      const maxFileSizeMB = 10;
      const previewDiv = document.getElementById("attachmentPreview");
      previewDiv.innerHTML = ""; // Clear previous preview

      // Validate all files for size
      for (const file of files) {
        if (file && file.size > maxFileSizeMB * 1024 * 1024) {
          alert(`File "${file.name}" exceeds ${maxFileSizeMB}MB limit. Please upload a smaller file.`);
          return;
        }
      }

      // Preview all files
      for (const file of files) {
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.alt = file.name;
            img.style.maxWidth = "100px";
            img.style.marginRight = "10px";
            img.style.borderRadius = "5px";
            previewDiv.appendChild(img);
          };
          reader.readAsDataURL(file);
        } else {
          const span = document.createElement("span");
          span.textContent = file.name;
          span.style.display = "inline-block";
          span.style.padding = "0.5em";
          span.style.background = "#eee";
          span.style.borderRadius = "5px";
          previewDiv.appendChild(span);
        }
      }

      // Upload all files to Firebase Storage, collect URLs and names (using Firebase modular SDK)
      let attachments = [];
      for (const file of files) {
        // Always use modular SDK for storage
        const filename = `attachments/${Date.now()}_${currentUserId}_${file.name}`;
        const storageRef = ref(storage, filename);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        attachments.push({ url, name: file.name });
      }

      const tagsInput = document.getElementById("tags")?.value.trim?.() || "";
      const tags = tagsInput ? tagsInput.split(",").map(tag => tag.trim()) : [];

      // Build entryData, use attachments array if present
      const entryData = {
        text: finalText,
        createdAt: new Date(),
        userId: currentUserId,
        tags
      };
      if (attachments.length > 0) {
        entryData.attachments = attachments;
      }

      // Stricter prompt extraction and validation
      const promptElement = document.getElementById("generatedPrompt");
      const promptTextRaw = promptElement?.textContent?.trim();
      const promptText = promptTextRaw?.replace(/^Sophy suggests:\s*/, "").replace(/^"|"$/g, "").trim();

      const isValidPrompt =
        promptText &&
        promptText.toLowerCase() !== "undefined" &&
        promptText.toLowerCase() !== "sophy is thinking..." &&
        promptText.length > 5;

      if (document.getElementById("autoInsertPrompt")?.checked && isValidPrompt) {
        entryData.promptUsed = promptText;
      } else if (document.getElementById("autoInsertPrompt")?.checked) {
        console.log("â„¹ï¸ No valid Sophy prompt to save â€” continuing without one.");
      }

      if (document.getElementById("coachReviewCheckbox")?.checked) {
        entryData.coachReview = true;
      }
      if (document.getElementById("postSaveActions")?.checked) {
        entryData.maybeReviewLater = true;
      }
      if (journalMode === "manifest") {
        tags.push("manifest");
        const manifestText = document.getElementById("manifestInput").value.trim();
        const today = new Date().toISOString().split("T")[0];
        tags.push(`manifestDate:${today}`);
        entryData.contextManifest = manifestText;
      }
      // Add to Firestore and get the new doc ref
      // Always set userId field, and ensure queries always filter by userId
      console.log("Attachments array about to be saved:", attachments);
      console.log("entryData about to be saved:", entryData);
      console.log("ðŸ§ª FINAL entryData before saving:", entryData);
      const docRef = await addDoc(collection(db, "journalEntries"), entryData);
      console.log("ðŸ“˜ Created entry ID:", docRef.id);
      if (entryData.coachReview) {
        try {
          console.log("ðŸ“¨ Notifying coach with entryId:", docRef.id);
          const response = await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/notifyCoachOfTaggedEntry", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ entryId: docRef.id, userId: currentUserId })
          });
          if (!response.ok) {
            throw new Error("Coach notification failed: " + (await response.text()));
          }
          console.log("ðŸ“¬ Coach notified successfully.");
        } catch (notifyErr) {
          console.error("âŒ Failed to notify coach:", notifyErr);
        }
      }

      // Call embedding function via HTTPS endpoint with fetch
      try {
        const token = await auth.currentUser.getIdToken(true);
        await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/embedAndStoreEntry", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ text, entryId: docRef.id })
        });
      } catch (embedErr) {
        console.warn("Embedding error (non-blocking):", embedErr);
      }

      // Show saved confirmation
      saveStatus.innerHTML = "âœ… Saved!";
      setTimeout(() => saveStatus.innerHTML = "", 3000);
      document.getElementById("entryStatus").textContent = "Great work! Youâ€™ve added another reflection to your journey.";
      // Flash confirmation animation on textarea
      textarea.classList.add("flash-confirmation");
      setTimeout(() => textarea.classList.remove("flash-confirmation"), 1000);

      textarea.value = "";
      fileInput.value = "";
      previewDiv.innerHTML = "";
      if (document.getElementById("tags")) document.getElementById("tags").value = "";
    } catch (e) {
      console.error("Error saving entry: ", e);
      const saveStatus = document.getElementById("saveStatus");
      saveStatus.innerHTML = "âŒ Save failed.";
      setTimeout(() => saveStatus.innerHTML = "", 4000);
    }
  };
};

    async function generatePrompt() {
      const topicInput = document.getElementById("promptTopic").value.trim();
      const manifestText = document.getElementById("manifestInput").value.trim();
      let topic = topicInput;

      if (journalMode === "manifest") {
        if (topicInput && manifestText) {
          topic = `My manifest is: "${manifestText}". Please base the prompt on this and also consider: "${topicInput}".`;
        } else if (manifestText) {
          topic = `Please generate a prompt based on my Manifest Statement: "${manifestText}"`;
        } else {
          topic = topicInput || "manifesting";
        }
      }

      const promptElement = document.getElementById("generatedPrompt");
      // Set "Sophy is thinking..." in white color for dark mode, italic before fetching
      promptElement.textContent = "Sophy is thinking...";
      promptElement.style.color = "#FDF7F1";
      promptElement.style.fontStyle = "italic";
      try {
        const response = await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/generatePrompt", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ topic })
        });
        if (response.ok) {
          const data = await response.json();
          const prompt = data.prompt.trim();
          promptElement.textContent = `Sophy suggests: "${prompt}"`;
          document.getElementById("autoInsertPrompt").checked = true;
          // if (document.getElementById("autoInsertPrompt")?.checked) {
          //   const textarea = document.getElementById("journal");
          //   textarea.value = `"${prompt}"\n\n` + textarea.value;
          // }
        } else {
          promptElement.textContent = "Sorry, something went wrong fetching the prompt.";
        }
      } catch (e) {
        promptElement.textContent = "Sorry, something went wrong fetching the prompt.";
      }
    }
    import { query, where, orderBy, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    window.replaceWithSuggestion = function () {
      const suggestion = document.getElementById("manifestSuggestion")?.value;
      if (suggestion) {
        document.getElementById("manifestInput").value = suggestion;
      }
    };
    // --- SMART SEARCH LOGIC ---
    // Only one import for getFunctions, httpsCallable at the top.
    // Define runSmartSearch globally and attach it to window.
    async function runSmartSearch() {
      const queryText = document.getElementById("searchQuery").value.trim();
      const resultsContainer = document.getElementById("searchResults");
      window.showSpinner && showSpinner("searchResults", "Searching...");

      
      const user = window.auth?.currentUser;
      if (!queryText) {
        resultsContainer.innerHTML = "<p>Please enter a search phrase.</p>";
        return;
      }
      if (!user) {
        resultsContainer.innerHTML = "<p>You must be logged in to use Smart Search.</p>";
        return;
      }

      try {
        // Log the search query with HTTPS endpoint before embedding
        const idToken = await user.getIdToken();

        await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/logSearchQuery", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${idToken}`,
          },
          body: JSON.stringify({ query: queryText })
        });

        // 1. Embed the query using HTTPS endpoint directly, with ID token
        const embedResp = await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/embedAndStoreEntry", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${idToken}`
          },
          body: JSON.stringify({ text: queryText, entryId: "search-query" })
        });
        if (!embedResp.ok) {
          throw new Error("Failed to get embedding for query.");
        }
        const embedResult = await embedResp.json();
        const queryEmbedding = embedResult.embedding;
        if (!queryEmbedding || !Array.isArray(queryEmbedding)) {
          throw new Error("Failed to get embedding for query.");
        }
        // 2. Fetch all user's journal entries with embeddings (use modular Firestore)
        const db = window.db;
        const currentUserId = window.currentUserId;
        const entriesRef = collection(db, "journalEntries");
        const q = query(entriesRef, where("userId", "==", currentUserId));
        const snapshot = await getDocs(q);
        const entries = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          // Only consider entries with an embedding array
          if (Array.isArray(data.embedding)) {
            entries.push({
              id: docSnap.id,
              text: data.text,
              tags: data.tags,
              createdAt: data.createdAt,
              embedding: data.embedding,
              contextManifest: data.contextManifest
            });
          }
        });
        if (entries.length === 0) {
          resultsContainer.innerHTML = "<p>No entries with embeddings found. Try saving a new entry first.</p>";
          return;
        }
        // 3. Calculate cosine similarity for each entry
        function cosineSimilarity(a, b) {
          let dot = 0, normA = 0, normB = 0;
          for (let i = 0; i < a.length; i++) {
            dot += a[i] * b[i];
            normA += a[i] * a[i];
            normB += b[i] * b[i];
          }
          if (normA === 0 || normB === 0) return 0;
          return dot / (Math.sqrt(normA) * Math.sqrt(normB));
        }
        for (const entry of entries) {
          entry.sim = cosineSimilarity(queryEmbedding, entry.embedding);
        }
        // 4. Sort by similarity descending, pick top 5
        const top = entries.sort((a, b) => b.sim - a.sim).slice(0, 5);
        // 5. Render results
        if (top.length === 0) {
          resultsContainer.innerHTML = "<p>No similar entries found.</p>";
          return;
        }
        let html = "";
        for (const entry of top) {
          const dateObj = entry.createdAt?.toDate?.();
          let dateStr = "";
          if (dateObj && typeof dateObj.toLocaleDateString === "function") {
            // Format as: May 1, 2025
            const options = { year: "numeric", month: "long", day: "numeric" };
            dateStr = dateObj.toLocaleDateString(undefined, options);
          }
          const similarity = (entry.sim * 100).toFixed(1);
          // Show only first 200 chars as snippet
          const snippet = entry.text ? entry.text.slice(0, 200) + (entry.text.length > 200 ? "..." : "") : "";
          // Full text (HTML-escaped for safety)
          const fullText = entry.text || "";
          html += `
<div class="search-result" onclick="toggleExpand(this)" style="cursor:pointer; margin-bottom:1em; border-bottom:1px solid #ccc; padding-bottom:0.5em;">
  <div class="entry-header" style="font-weight:bold;">${dateStr}${similarity ? " â€“ Similarity: " + similarity + "%" : ""}</div>
  ${entry.contextManifest ? `<div style="font-size:0.85em; color:#2A6D6D;">âœ¨ Manifest: "${entry.contextManifest}"</div>` : ""}
  <div class="entry-snippet">${snippet}</div>
  <div class="entry-full" style="display:none; margin-top:0.5em;">${fullText.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>")}</div>
  ${entry.tags ? `<div style="font-size:0.8em; color:#666;">Tags: ${entry.tags.join(", ")}</div>` : ""}
</div>
`;
        }

        resultsContainer.innerHTML = html;
      } catch (err) {
        console.error("Smart search error:", err);
        document.getElementById("searchResults").innerHTML = "<p>Sorry, something went wrong with smart search.</p>";
      }
    }
    window.runSmartSearch = runSmartSearch;


   async function loadPastEntries() {
      const pastEntriesContainer = document.getElementById("pastEntries");
      pastEntriesContainer.innerHTML = "<p>Loading entries...</p>";
      const entriesRef = collection(db, "journalEntries");
      const q = query(entriesRef, where("userId", "==", currentUserId), orderBy("createdAt", "desc"));
      let snapshot;
      try {
        snapshot = await getDocs(q);
      } catch (e) {
        pastEntriesContainer.innerHTML = "<p>Weâ€™re setting things up behind the scenes. This feature will be available shortly â€” please check back soon.</p>";
        return;
      }
      if (snapshot.empty) {
        pastEntriesContainer.innerHTML = "<p>No journal entries yet. Try your first reflection â€” it doesnâ€™t have to be perfect.</p>";
        return;
      }

      function getFileNameFromUrl(url) {
        try {
          const decoded = decodeURIComponent(url.split("?")[0]);
          const parts = decoded.split("/");
          return parts[parts.length - 1] || null;
        } catch {
          return null;
        }
      }
      function getFileExtension(filename) {
        if (!filename) return "";
        const dot = filename.lastIndexOf(".");
        if (dot === -1) return "";
        return filename.substring(dot + 1).toLowerCase();
      }
      function isImageExtension(ext) {
        return ["jpg", "jpeg", "png", "gif", "webp", "bmp"].includes(ext);
      }

      const entriesHtml = [];
      for (const doc of snapshot.docs) {
        const entry = doc.data();
        console.log("Entry in Past Entries render:", entry);
        // Skip entries with missing or invalid createdAt
        if (!entry.createdAt?.toDate) {
          console.warn("Skipping entry with missing or invalid createdAt:", entry);
          continue;
        }

        // Only entries with valid createdAt reach here
        const date = entry.createdAt.toDate().toLocaleString();
        const tags = entry.tags ? `<p style="font-size: 0.85em; color: #666;">Tags: ${entry.tags.join(", ")}</p>` : "";
        // Highlight Manifest-tagged entries
        const isManifest = entry.tags?.includes("manifest");
        const manifestBadge = isManifest
          ? `<p style="font-size: 0.85em; color: #2A6D6D; font-style: italic;">âœ¨ Reflecting on Manifest: "${entry.contextManifest || ''}"</p>`
          : "";
        const coachTag = entry.coachReview
          ? `<p style="font-size: 0.85em; color: #2A6D6D;">ðŸ”“ Shared with coach</p>`
          : "";

        const futureFlag = entry.maybeReviewLater
        const coachReplyNotice = entry.newCoachReply
          ? `<p style="font-size: 0.85em; color: #FFA76D;">ðŸ’¬ New coach reply</p>`
          : "";

        // --- Attachment rendering logic: start ---
        let attachmentHtml = "";
        if (Array.isArray(entry.attachments) && entry.attachments.length > 0) {
          attachmentHtml = `<div style="margin-top:0.5em; display: flex; flex-wrap: wrap; gap: 0.5em;">`;
          for (const file of entry.attachments) {
            const filename = file.name || getFileNameFromUrl(file.url);
            const ext = getFileExtension(filename);
            if (isImageExtension(ext)) {
              // Image: thumbnail + link
              attachmentHtml += `
                <div style="display:inline-block; text-align:center;">
                  <a href="${file.url}" target="_blank" title="Click to view full image">
                    <img src="${file.url}" alt="${filename}" style="max-width:80px; max-height:80px; border-radius:4px; border:1px solid #ddd; display:block; margin-bottom:0.25em;" />
                  </a>
                  <a href="${file.url}" target="_blank" style="font-size:0.85em; color:#2A6D6D; text-decoration:underline;">${filename}</a>
                </div>
              `;
            } else {
              // Other file: icon + link
              attachmentHtml += `
                <div style="display:inline-block; text-align:center;">
                  <span style="font-size:2em;">ðŸ“„</span>
                  <a href="${file.url}" target="_blank" style="font-size:0.85em; color:#2A6D6D; text-decoration:underline;" title="Click to download/view">${filename}</a>
                </div>
              `;
            }
          }
          attachmentHtml += `</div>`;
        } else if (entry.attachmentUrl) {
          // Legacy single attachment
          let filename = getFileNameFromUrl(entry.attachmentUrl);
          // If filename is missing or looks like a generic storage token, fallback to label
          if (!filename || filename.match(/^(\d+_)?[a-z0-9]{6,}(\.[a-z0-9]+)?$/i) === null && !filename.includes('.')) {
            filename = null;
          }
          const ext = getFileExtension(filename);
          if (isImageExtension(ext)) {
            // Display image thumbnail
            attachmentHtml = `<div style="margin-top:0.5em;">
                <a href="${entry.attachmentUrl}" target="_blank" title="Click to view full image">
                  <img src="${entry.attachmentUrl}" alt="${filename || 'Attachment'}" style="max-width:80px; max-height:80px; border-radius:4px; border:1px solid #ddd; display:block; margin-bottom:0.25em;" />
                </a>
                <a href="${entry.attachmentUrl}" target="_blank" style="font-size:0.85em; color:#2A6D6D; text-decoration:underline;">${filename || 'View Full Image'}</a>
              </div>`;
          } else {
            // Display download link with filename if possible, fallback to "Download Attachment"
            const label = filename || "Download Attachment";
            attachmentHtml = `<div style="margin-top:0.5em;">
                <span style="font-size:2em;">ðŸ“„</span>
                <a href="${entry.attachmentUrl}" target="_blank" style="font-size:0.95em; color:#2A6D6D; text-decoration:underline;">${label}</a>
              </div>`;
          }
        }
        // --- Attachment rendering logic: end ---

        entriesHtml.push(`
  <div style="margin-bottom: 1em; padding: 1em; border: 1px solid #ccc; border-radius: 5px;">
    <p style="font-size: 0.9em; color: #999;">${date}</p>
    ${manifestBadge}
    ${coachTag}
    ${futureFlag}
    ${coachReplyNotice}
    <div class="entry-preview">${entry.text}</div>
    <button class="btn" style="margin-top: 0.5em;" onclick="
      const preview = this.previousElementSibling;
      preview.classList.toggle('expanded');
      this.textContent = this.textContent === 'Read more' ? 'Collapse' : 'Read more';
    ">Read more</button>
    ${attachmentHtml}
    ${tags}
    ${(entry.coachResponse?.text) ? `
      <div class="coach-reply" style="margin-top: 1em; padding: 0.75em; border-left: 4px solid var(--accent-dark); background-color: var(--accent); color: var(--accent-dark); font-size: 0.95em; border-radius:5px; font-style:italic;">
        <strong>Coach replied:</strong>
        <p>${entry.coachResponse.text}</p>
      </div>
    ` : ""}
    <button class="btn" onclick="editEntry('${doc.id}', \`${entry.text.replace(/`/g, "\\`")}\`)">Edit</button>
    <button class="btn" onclick="deleteEntry('${doc.id}')">Delete</button>
  </div>
`);
      }

      pastEntriesContainer.innerHTML = entriesHtml.join("");
    
    }
 window.loadPastEntries = loadPastEntries;
    window.deleteEntry = async function (docId) {
      if (!confirm("Are you sure you want to delete this entry?")) return;
      try {
        // Only allow deleting if the entry belongs to the current user
        const entryRef = doc(db, "journalEntries", docId);
        const entrySnap = await getDoc(entryRef);
        if (!entrySnap.exists() || entrySnap.data().userId !== currentUserId) {
          alert("You do not have permission to delete this entry.");
          return;
        }
        await deleteDoc(entryRef);
        loadPastEntries(); // Refresh view
      } catch (err) {
        console.error("Error deleting entry:", err);
      }
    };

    window.editEntry = async function (docId, currentText) {
      const newText = prompt("Edit your entry:", currentText);
      if (!newText) return;
      try {
        // Only allow editing if the entry belongs to the current user
        const entryRef = doc(db, "journalEntries", docId);
        const entrySnap = await getDoc(entryRef);
        if (!entrySnap.exists() || entrySnap.data().userId !== currentUserId) {
          alert("You do not have permission to edit this entry.");
          return;
        }
        await updateDoc(entryRef, { text: newText });
        loadPastEntries(); // Refresh view
      } catch (err) {
        console.error("Error updating entry:", err);
      }
    };

    // async function loadJournalTimeline() {
    //   // Disabled: #journalTimeline element no longer exists in HTML.
    //   // This function is commented out to prevent console errors.
    //   // If needed in the future, restore and provide a corresponding HTML element.
    // }


    async function signUp() {
      setTimeout(async () => {
        const email = document.querySelector('input[name="email"]')?.value?.trim();
        const password = document.querySelector('input[name="password"]')?.value || "";
        console.log("ðŸ“§ Email:", email);
        console.log("ðŸ”’ Password:", password ? "â—â—â—â—â—" : "(empty)");

        if (!email || !password) {
          alert("Please enter both email and password.");
          return;
        }

        try {
          await createUserWithEmailAndPassword(auth, email, password);
          await setDoc(doc(db, "users", auth.currentUser.uid), {
            email: auth.currentUser.email,
            userRole: "journaler",
            agreementAccepted: false
          });
          document.getElementById("loginModal").style.display = "none";
          document.getElementById("userStatus").textContent = `Journaling as: ${auth.currentUser.email}`;
        } catch (err) {
          alert("Error signing up: " + err.message);
        }
      }, 100); // allow autofill to populate fields
    }

    // Helper for autofill: waits for both email and password to be filled by browser autofill or user
    function waitForAutofill(resolve) {
      const emailInput = document.querySelector('input[name="email"]');
      const passwordInput = document.querySelector('input[name="password"]');
      let attempts = 0;

      const interval = setInterval(() => {
        const email = emailInput?.value?.trim();
        const password = passwordInput?.value?.trim();
        if (email && password) {
          clearInterval(interval);
          resolve({ email, password });
        } else if (++attempts > 20) {
          clearInterval(interval);
          resolve({ email: email || '', password: password || '' });
        }
      }, 100);
    }

    // Helper to normalize login input (removes ZW chars, trims, smart quotes, outer quotes, Unicode normalization)
    function normalizeInput(str) {
      return String(str)
        .trim()
        .replace(/\u200B/g, '') // remove zero-width characters
        .replace(/[\u2018\u2019]/g, "'") // smart single quotes
        .replace(/[\u201C\u201D]/g, '"') // smart double quotes
        .replace(/^["']|["']$/g, '') // outer quotes
        .normalize("NFKC");
    }

// Expose signIn globally, now wrapped with reCAPTCHA v2 invisible
window.signIn = function signIn() {
  grecaptcha.ready(async () => {  // â† make this async
    const rawEmail = document.getElementById("emailInput").value;
    const rawPassword = document.getElementById("passwordInput").value;

    const email = normalizeInput(rawEmail);
    const password = normalizeInput(rawPassword);

    console.log("âœ… Cleaned Email (normalized):", email);
    console.log("âœ… Cleaned Password (normalized):", password);

    try {
      await signInWithEmailAndPassword(auth, email, password);
      console.log("âœ… Login successful");
      document.getElementById("loginModal").style.display = "none";
    } catch (error) {
      console.error("âŒ Login failed:", error.code, error.message);
      if (error.code === "auth/invalid-credential") {
        alert("Login failed: Invalid credentials.\nIf you're using autofill, please retype your email and password manually.");
      } else {
        alert(`Login failed: ${error.code}`);
      }
    }
  });
};
    
    let journalMode = 'manifest';

window.setJournalMode = function (mode) {
  journalMode = mode;
  const manifestBtn = document.getElementById("manifestModeButton");
  const freeBtn = document.getElementById("freeModeButton");

  if (mode === "manifest") {
    manifestBtn.style.backgroundColor = "#2A6D6D";
    manifestBtn.style.color = "white";
    freeBtn.style.backgroundColor = "#ccc";
    freeBtn.style.color = "#333";
  } else {
    freeBtn.style.backgroundColor = "#2A6D6D";
    freeBtn.style.color = "white";
    manifestBtn.style.backgroundColor = "#ccc";
    manifestBtn.style.color = "#333";
  }
};

    function showTab(tabId) {
      const tabs = ["journalTab", "calendarTab"];
      const buttons = {
        journalTab: document.getElementById("journalTabButton"),
        calendarTab: document.getElementById("calendarTabButton")
      };

      // Find the currently active tab
      let activeTab = null;
      tabs.forEach(id => {
        if (document.getElementById(id).style.display !== "none") {
          activeTab = id;
        }
      });

      // Only switch if not already on this tab
      if (activeTab === tabId) {
        // Already active, do nothing
        return;
      }

      tabs.forEach(id => {
        document.getElementById(id).style.display = (id === tabId ? "block" : "none");
        
      });

      // Remove all active classes from tab buttons, then set active on the selected
      document.getElementById("journalTabButton").classList.remove("active");
      document.getElementById("calendarTabButton").classList.remove("active");
      if (tabId === "journalTab") {
        document.getElementById("journalTabButton").classList.add("active");
      } else if (tabId === "calendarTab") {
        document.getElementById("calendarTabButton").classList.add("active");
      }
      if (tabId === "calendarTab") {
        // Always build calendar when switching to calendarTab
        buildCalendar();
        // Always refresh Past Entries UI using loadPastEntries
        loadPastEntries();
        document.getElementById("calendarEntries") && (document.getElementById("calendarEntries").innerHTML = "<p>Click a calendar date to view entries.</p>");
        document.getElementById("searchResults") && (document.getElementById("searchResults").innerHTML = "<p>Use Smart Search to explore your journal history.</p>");
      } else if (tabId === "journalTab") {
        const manifestInput = document.getElementById("manifestInput");
        if (manifestInput && window.currentUserId) {
          // Always read manifest using the user's UID as the doc ID
          getDoc(doc(db, "manifests", window.currentUserId))
            .then(manifestDoc => {
              if (manifestDoc.exists()) {
                manifestInput.value = manifestDoc.data().statement || "";
                console.log("âœ… Manifest loaded from showTab.");
              } else {
                console.log("â„¹ï¸ No manifest found for this user.");
              }
            })
            .catch(err => {
              console.error("âŒ Error loading manifest:", err);
            });
        }
      }
    }


    // (showTab('journalTab') is now only called in onAuthStateChanged after UI is shown)

// Make calendar month/year globals so they persist and are accessible
window.displayedMonth = new Date().getMonth();
window.displayedYear = new Date().getFullYear();

// Calendar build function
async function buildCalendar() {
  const container = document.getElementById("calendarContainer");
  container.innerHTML = "";

  // Fetch journal entry dates for current month/year
  // Only fetch entries for the current user
  const snapshot = await getDocs(query(
    collection(db, "journalEntries"),
    where("userId", "==", currentUserId)
  ));

  const markedDates = new Set();
  snapshot.forEach(doc => {
    const createdAt = doc.data().createdAt?.toDate?.();
    if (createdAt &&
        createdAt.getFullYear() === window.displayedYear &&
        createdAt.getMonth() === window.displayedMonth) {
      const key = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')}`;
      markedDates.add(key);
    }
  });

  // Month/Year heading
  const currentMonthHeading = document.createElement("h3");
  const tempDate = new Date(window.displayedYear, window.displayedMonth, 1);
  currentMonthHeading.textContent = `${tempDate.toLocaleString('default', { month: 'long' })} ${window.displayedYear}`;
  currentMonthHeading.style.textAlign = "center";
  currentMonthHeading.style.color = "#2A6D6D";
  currentMonthHeading.style.marginTop = "1em";

  container.appendChild(currentMonthHeading);

  const calendarTable = document.createElement("table");
  calendarTable.style.width = "100%";
  calendarTable.style.textAlign = "center";
  calendarTable.style.borderCollapse = "collapse";
  calendarTable.style.marginTop = "1em";

  const headerRow = document.createElement("tr");
  const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
  days.forEach(day => {
    const th = document.createElement("th");
    th.textContent = day;
    th.style.padding = "0.5em";
    headerRow.appendChild(th);
  });
  calendarTable.appendChild(headerRow);

  const firstDay = new Date(window.displayedYear, window.displayedMonth, 1).getDay();
  const daysInMonth = new Date(window.displayedYear, window.displayedMonth + 1, 0).getDate();

  let row = document.createElement("tr");
  for (let i = 0; i < firstDay; i++) {
    row.appendChild(document.createElement("td"));
  }

  for (let day = 1; day <= daysInMonth; day++) {
    if ((row.children.length % 7) === 0) {
      calendarTable.appendChild(row);
      row = document.createElement("tr");
    }
    const td = document.createElement("td");
    td.textContent = day;
    td.style.cursor = "pointer";
    td.style.padding = "0.5em";
    td.style.border = "1px solid #ccc";
    // Add highlight if this day has a journal entry
    const key = `${window.displayedYear}-${String(window.displayedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    if (markedDates.has(key)) {
  // Use theme variable for primary highlight (brand-secondary)
  td.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-secondary').trim();
  td.style.color = '#fff';
  td.title = "Journal entry";
}
td.onclick = () => {
  // Option 1: just always reload full past entries (easiest, consistent)
  loadPastEntries();
  // Option 2: pass a date to a new, filtered version of loadPastEntries if desired
  // loadPastEntries({ year: window.displayedYear, month: window.displayedMonth, day });
};    row.appendChild(td);
  }
  calendarTable.appendChild(row);
  container.appendChild(calendarTable);
}

// Ensure changeMonth is in global scope and updates displayedMonth/year, then calendar
window.changeMonth = function(offset) {
  window.displayedMonth += offset;
  if (window.displayedMonth < 0) {
    window.displayedMonth = 11;
    window.displayedYear--;
  } else if (window.displayedMonth > 11) {
    window.displayedMonth = 0;
    window.displayedYear++;
  }
  buildCalendar();
};

async function showPromptsByDate(year, month, day) {
  const container = document.getElementById("pastEntries");
  const selectedDate = new Date(year, month, day).toDateString();
  container.innerHTML = `<p><strong>Entries from ${selectedDate}:</strong></p>`;

  const journalRef = collection(db, "journalEntries");
  // Only fetch entries for the current user
  const snapshot = await getDocs(query(journalRef, where("userId", "==", currentUserId)));

  const matches = [];
  snapshot.forEach((doc) => {
    const data = doc.data();
    const savedDate = data.createdAt?.toDate().toDateString();
    if (savedDate === selectedDate) {
      const hasReply = !!data.coachResponse?.text;
      const replyBlock = hasReply
        ? `<div style="margin-top:0.5em; font-size:0.9em; background:#fff3ea; border-left:4px solid #FFA76D; padding:0.5em;">
             <strong>Coach replied:</strong> ${data.coachResponse.text}
           </div>`
        : "";
      matches.push({
        text: data.text,
        contextManifest: data.contextManifest,
        replyBlock,
        createdAt: data.createdAt?.toDate?.() || null
      });
    }
  });

  if (matches.length === 0) {
    container.innerHTML += "<p>No entries found.</p>";
  } else {
    const ul = document.createElement("ul");
   matches.forEach(entry => {
  const li = document.createElement("li");
  li.innerHTML = `
    ${entry.contextManifest ? 'âœ¨ ' : ''}
    <div class="entry-preview"><em>${entry.text}</em></div>
    ${entry.replyBlock || ""}
    <button class="btn" style="margin-top: 0.5em;" onclick="this.previousElementSibling.classList.toggle('entry-preview'); this.textContent = this.textContent === 'Read more' ? 'Collapse' : 'Read more';">Read more</button>
  `;
  ul.appendChild(li);
});
    container.appendChild(ul);
  }
}


    // Expose functions for UI onclick attributes
    window.generatePrompt = generatePrompt;
    window.signUp = signUp;
    window.signIn = signIn;

// Modal close function for login modal
window.loginModalClose = function () {
  document.getElementById("loginModal").style.display = "none";
  document.querySelector("main").style.display = "none";

  // Optional toast-like feedback
  const toast = document.createElement("div");
  toast.textContent = "You must log in to access the journal.";
  toast.style.position = "fixed";
  toast.style.bottom = "20px";
  toast.style.left = "50%";
  toast.style.transform = "translateX(-50%)";
  toast.style.backgroundColor = "#FFA76D";
  toast.style.color = "#fff";
  toast.style.padding = "1em 1.5em";
  toast.style.borderRadius = "5px";
  toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
  toast.style.zIndex = "9999";
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.remove();
  }, 4000);
};

window.showLoginModal = function () {
  document.getElementById("goodbyeModal").style.display = "none";
  document.getElementById("loginModal").style.display = "flex";
  document.getElementById("emailInput").value = "";
  document.getElementById("passwordInput").value = "";
};

window.showSpinner = function (targetId, message = "Working...") {
  const el = document.getElementById(targetId);
  if (el) {
    el.innerHTML = `<span class="spinner"></span> ${message}`;
  }
};

window.logOutUser = async function () {
  console.log("Logout started.");
  try {
    localStorage.setItem("userJustLoggedOut", "true");
    await auth.signOut();
    document.querySelector("main").style.display = "none";
    
    document.getElementById("embeddedAgreementNotice").style.display = "none";
    setTimeout(() => {
      const modal = document.getElementById("goodbyeModal");
      if (modal) {
        modal.style.display = "flex";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100vw";
        modal.style.height = "100vh";
        modal.style.background = "rgba(0,0,0,0.8)";
        modal.style.color = "#2A6D6D";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = "9999";
      }
    }, 100);
    const searchInput = document.getElementById("searchQuery");
if (searchInput) searchInput.value = "";
  } catch (err) {
    console.error("Logout failed:", err);
    alert("Logout failed.");
  }
};
async function askSophyAboutEntry() {
  const journalText = document.getElementById("journal").value.trim();
  const sophyInsight = document.getElementById("sophyInsight");

  if (!journalText) {
    sophyInsight.textContent = "Please write something in your journal first.";
    return;
  }
  sophyInsight.textContent = "Sophy is thinking...";
  try {
    const response = await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/askSophy", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ entry: journalText })
    });

    if (!response.ok) throw new Error("Failed to fetch insight.");

    const data = await response.json();
    const insight = data.insight?.trim?.() || "Sophy couldn't generate a reflection right now.";
    sophyInsight.textContent = insight;

  } catch (err) {
    console.error("Error fetching Sophy insight:", err);
    sophyInsight.textContent = "Sorry, Sophy couldn't reflect right now.";
  }
}

    window.askSophyAboutEntry = askSophyAboutEntry;

    // Manifest save function
    window.saveManifest = async function () {
      // Always use current user's UID for manifest doc
      let user = null;
      try {
        user = auth.currentUser;
      } catch (e) {
        user = null;
      }
      const text = document.getElementById("manifestInput").value.trim();
      const status = document.getElementById("manifestStatus");

      if (!user || !text) {
        status.textContent = "You must be logged in and enter a statement to save.";
        status.style.color = "red";
        return;
      }

      window.showSpinner("manifestStatus", "Saving...");

      try {
        // Always use user's UID as doc ID for manifests
        await setDoc(doc(db, "manifests", user.uid), {
          statement: text,
          timestamp: serverTimestamp()
        });
        status.innerHTML = "âœ… Vision saved. You're building something meaningful.";
        status.style.color = "#2A6D6D";
      } catch (error) {
        console.error("Error saving manifest:", error);
        status.textContent = "Failed to save manifest.";
        status.style.color = "red";
      }
    };

    // Refine Manifest with Sophy
window.askSophyToRefineManifest = async function () {
  const text = document.getElementById("manifestInput").value.trim();
  const status = document.getElementById("manifestStatus");
  if (!text) {
    status.textContent = "Please write something first for Sophy to refine.";
    status.style.color = "red";
    return;
  }

  // Set Sophy "thinking" status before making the request
  status.textContent = "Sophy is thinking...";
  status.style.color = "#2A6D6D";

  try {
    const res = await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/askSophy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ entry: `Help me improve this personal guiding statement: "${text}"` })
    });
    const data = await res.json();
    if (data.insight) {
      document.getElementById("manifestSuggestion").value = data.insight;
      status.textContent = "Sophy's ideas are available.";
      status.style.color = "#2A6D6D";
    } else {
      throw new Error(data.insight || "No insight returned.");
    }
  } catch (err) {
    console.error("Error fetching refinement:", err);
    status.textContent = "Failed to get Sophy's help.";
    status.style.color = "red";
  }
};
// Ensure calendar is built after defining all functions
// (Note: initial buildCalendar and showTab('journalTab') are called by auth listener after login)
    // --- Password Reset Handler ---
    document.addEventListener("DOMContentLoaded", () => {
      const forgotBtn = document.getElementById("forgotPasswordBtn");
      if (forgotBtn) {
        forgotBtn.onclick = async () => {
          const email = document.getElementById("emailInput").value.trim();
          const msgBox = document.getElementById("passwordResetMsg");

          if (!email) {
            msgBox.textContent = "Please enter your email above first.";
            return;
          }

          try {
            await sendPasswordResetEmail(auth, email);
            msgBox.textContent = "âœ… Password reset email sent!";
          } catch (error) {
            msgBox.textContent = "âš ï¸ " + error.message;
          }
        };
      }
    });
  </script>
</head>
<body>
  <header>
    <div id="goodbyeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; z-index: 9999;">
      <div class="card-block" style="max-width: 500px; width: 90%; text-align: center;">
        <h2 class="section-header">See You Soon!</h2>
        <p>Thanks for journaling with InkWell today.</p>
        <p>Take care, and donâ€™t forget to stay positive.</p>
        <button class="btn" onclick="showLoginModal()" style="margin-top: 1.5em;">Return to Login</button>
      </div>
    </div>
    <div class="logo-hero">
      <img 
        src="/InkWell Logo.png" 
        alt="InkWell Logo" 
        class="logo-image"
      />
    </div>
    <p style="margin-top: -0.7em; margin-bottom: 1.62em; font-size: 1.13em; color: var(--info-muted); letter-spacing: 0.02em; text-align: center;">
      Your space to reflect, write, and grow.
    </p>
    <div style="display: flex; justify-content: center; margin-bottom: 1em;">
      <button class="btn" id="aboutInkwellBtn" style="font-size:0.97em; font-weight:500;">What is InkWell?</button>
    </div>
  </header>
  <div id="userStatus" style="font-size: 0.9em; margin-bottom: 1em;"></div>

<div id="colorModeToggle" style="margin-bottom:1em;">
  <label for="themeModeSelect" style="font-size:0.9em;">Theme:</label>
  <select id="themeModeSelect" style="margin-left:0.5em;">
    <option value="default">Default</option>
    <option value="light">Light</option>
    <option value="dark">Dark</option>
  </select>
</div>

  <div id="embeddedAgreementNotice">
    <div class="card-block">
      <h3 class="section-header" style="color: var(--brand-primary);">Action Required: Accept Alpha Testing Agreement</h3>
      <p style="font-size: 0.9em;">Before you can use InkWell, please review and agree to the following:</p>
      <div style="display: flex; flex-direction: column; gap: 0.5em; align-items: center; margin-bottom: 1em;">
  <a href="https://www.pegasusrealm.com/terms-conditions/" target="_blank" style="text-align: center; color: #388b97;">Terms & Conditions</a>
  <a href="https://www.pegasusrealm.com/privacy-policy/" target="_blank" style="text-align: center; color: #388b97;">Privacy Policy</a>
  <a href="https://www.pegasusrealm.com/alpha-beta-testers/" target="_blank" style="text-align: center; color: #388b97;">Alpha/Beta Tester Agreement</a>
</div>
      <label style="display: block; margin-top: 1em;">
        <input type="checkbox" id="embeddedAgreementCheckbox" />
        I have read and agree to all three terms listed above.
      </label>
      <div style="display: flex; justify-content: center; margin-top: 1em;">
        <button class="btn" onclick="acceptEmbeddedAgreement()" id="acceptEmbeddedAgreementButton" disabled style="margin-left: auto; margin-right: auto;">Accept & Continue</button>
      </div>
      <div style="font-size: 0.81em; color: #7B6047; text-align: center; line-height: 1.5; margin-top: 1.2em;">
        <strong>Disclaimer:</strong> InkWell Alpha is an experimental platform for journaling and manifesting. It is not a substitute for professional mental health or medical advice. By using InkWell, you agree that your data will be handled in accordance with our <a href="https://www.pegasusrealm.com/privacy-policy/" target="_blank" style="color: #388b97; text-decoration: underline;">Privacy Policy</a>, and you accept all risks associated with participating in an early-stage alpha release.
      </div>
    </div>
  </div>

  <div id="loginModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; z-index: 9999;">
    <div class="card-block" style="max-width: 400px; width: 90%;">
      <h3 class="section-header" style="text-align: center;">Login or Sign Up</h3>
      <input type="email" id="emailInput" name="email" placeholder="Email" autocomplete="email" />
      <input type="password" id="passwordInput" name="password" placeholder="Password" autocomplete="current-password" />
      <button id="forgotPasswordBtn" style="margin-top:0.5em; background:none; color:#2A6972; border:none; font-size:0.9em; text-decoration:underline; cursor:pointer;">
        Forgot password?
      </button>
      <div id="passwordResetMsg" style="font-size:0.85em; color:#2A6972; text-align:center; margin-top:0.5em;"></div>
      <div class="g-recaptcha"
     data-sitekey="6LeCel0rAAAAAJVIplFBKgyy0oO-bYd2wr2_wqxI"
     data-theme="light">
</div>

<button id="loginBtn" class="btn login-btn-signin" onclick="signIn()" style="width: 100%; margin-bottom: 0.5em;">Login</button>
      <button class="btn login-btn-signup" onclick="signUp()" style="width: 100%;">Sign Up</button>
      <button class="btn" onclick="loginModalClose()" style="width: 100%; margin-top: 1em;">Close</button>
    </div>
  </div>
  <main style="display: block;">
    <div id="tabButtons" style="display: flex; gap: 1em; margin-bottom: 1em;">
        <button class="btn tab-btn active" id="journalTabButton" onclick="showTab('journalTab')" style="flex: 1;">Journal</button>
        <button class="btn tab-btn" id="calendarTabButton" onclick="showTab('calendarTab')" style="flex: 1;">Past Entries</button>
      </div>
    <div id="journalTab">
      <div class="card-block">
        <h3 class="section-header" style="text-align: center;">Your Manifest Statement</h3>
        <p style="font-size: 1em; line-height: 1.6; margin-top: 1em;">
          This Manifest Statement is your personal guiding goal or vision. It is visible to your coach and to Sophy so they can help you stay aligned and work toward it. You can ask Sophy or a coach to help you write or refine this statement at any time.
        </p>
        <textarea id="manifestInput" placeholder="Write your personal guiding statement..." style="width: 100%; height: 100px; margin-bottom: 0.5em; padding: 0.5em; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; max-width: 100%;"></textarea>
        
        <p id="manifestStatus" style="margin-top: 0.5em; font-style: italic;"></p>
        <button class="btn btn-sophy" onclick="askSophyToRefineManifest()">Refine with Sophy</button>
        <p id="manifestSuggestionLabel" class="subtext-muted" style="font-weight: bold; margin-top: 1em;">
          Sophyâ€™s Suggested Refinement: <span style="font-weight: normal;">It wonâ€™t overwrite your original statement unless you click "Use This Suggestion".</span>
        </p>
        <textarea id="manifestSuggestion" readonly style="width: 100%; height: 100px; margin-bottom: 0.5em; padding: 0.75em 1em; border-radius: 5px; border-left: 4px solid var(--accent-dark); background-color: var(--accent); color: var(--accent-dark); font-style: italic; box-sizing: border-box; max-width: 100%;"></textarea>
        <button class="btn" onclick="replaceWithSuggestion()">Use This Suggestion</button>
        <button class="btn" onclick="saveManifest()">Save</button>
      </div>
      <div class="card-block">

        <!-- (Sophy prompt block moved below) -->
      </div>
      <div class="card-block">
        <h3 class="section-header" style="text-align: center;">Your Journal</h3>
        <p>
          Use this space to reflect on your Manifest Statement or free journal. Below, you'll find optional tools to enhance your entry â€” you can ask Sophy for a writing prompt or upload images and files to enrich your thoughts or support your manifesting process.
        </p>
      <div id="journalModeToggle" style="display: flex; justify-content: center; gap: 1em; margin-bottom: 2em; padding-bottom: 0.5em;">
        <button class="btn" id="manifestModeButton" onclick="setJournalMode('manifest')" style="flex: 1;">Focus on Manifesting</button>
        <button class="btn" id="freeModeButton" onclick="setJournalMode('free')" style="flex: 1;">Free Journal</button>
      </div>
        <!-- (Attachment input and preview moved below) -->
            <p class="subtext-muted" style="margin-top: 1em;">If you want a topic or some inspiration, <strong>Sophy</strong> can suggest ideas â€” you can even give her a topic to focus on.</p>
      <input type="text" id="promptTopic" placeholder="Enter a topic, mood, or leave blank" style="width: 100%; margin-bottom: 0.5em; padding: 0.5em; border-radius: 5px; border: 1px solid #ccc;" />
      <button class="btn btn-sophy" onclick="generatePrompt()" style="color: #ffffff;">Ask Sophy for a Prompt</button>
      <p id="generatedPrompt" class="sophy-info" style="color: #FDF7F1 !important;"></p>
      <label style="font-size: 0.85em; display: block; margin-top: 0.5em; margin-bottom: 0.5em;">
        <input type="checkbox" id="autoInsertPrompt" />
        Save this Prompt in my Journal Entry
      </label>

      
<button id="voiceBtn" class="btn" style="margin-bottom: 0.5em;">
  ðŸŽ™ï¸ Try InkOutLoud
</button>
<div id="voiceStatus" style="font-size:0.85em; color:#2A6972; margin-bottom:1em;"></div>
<label for="journal" style="margin-top:1em; display:block; font-weight:600;">Journal Entry:</label>
<textarea id="journal" placeholder="Write your thoughts here..." style="width: 100%; box-sizing: border-box; margin-bottom: 0.5em;"></textarea>
<label style="font-size: 0.85em; display: block; margin-top: 0.5em;">
  <input type="checkbox" id="autoInsertReflection" checked />
  Save this Reflection in my Journal Entry
</label>

<div id="entryStatus" style="font-size: 0.85em; margin-top: 0.5em;"></div>

<button class="btn btn-sophy" onclick="askSophyAboutEntry()">Ask Sophy for Reflection</button>
<div id="sophyInsight" class="sophy-info" style="white-space: pre-wrap;"></div>
<button class="btn" onclick="replaceJournalWithReflection()">Use This Reflection</button>

<script>
  window.replaceJournalWithReflection = function () {
    const insight = document.getElementById("sophyInsight")?.textContent;
    if (
      insight &&
      !insight.includes("Sophy's Reflection will appear here") &&
      !insight.includes("Please write something in your journal")
    ) {
      document.getElementById("journal").value = insight;
    }
  };
</script>

<p style="font-size: 1em; line-height: 1.6; margin-top: 1em;">
  Attach one or more photos or files to enrich your journal entry. Multiple files can be selected before saving. Take your time; every small detail counts in your growth journey.
</p>
<label for="attachment" style="display: block; font-weight: 600;">
  Select files to upload:
</label>
<input type="file" id="attachment" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,image/*" style="margin-bottom: 1em;" multiple />
<div id="attachmentPreview" style="margin-bottom: 1em;"></div>

<!-- Move coach review checkbox here, above Save button -->
<label class="coach-tag-label">
  <input type="checkbox" id="coachReviewCheckbox" />
  Tag this entry for my coach
</label>

<button class="btn" onclick="saveJournalEntry()" style="margin-top: 0.5em;">Save Journal Entry</button>
<span id="saveStatus" style="margin-left: 10px; font-style: italic;"></span>
      </div>
    </div>
<div id="calendarTab" style="display: none;">
  <div class="card-block">
    <h3 class="section-header" style="text-align: center;">Journal Calendar</h3>
    <div id="calendarControls" style="text-align: center; margin-bottom: 1em;">
      <button class="btn" onclick="changeMonth(-1)">â† Previous</button>
      <button class="btn" onclick="changeMonth(1)">Next â†’</button>
    </div>
    <div id="calendarContainer"></div>
    

<!-- Smart Search Bar UI -->
    <div class="card-block" style="margin-top: 2em;">
      <h3 class="section-header">Smart Search Your Journal</h3>
      <input type="text" id="searchQuery" placeholder="e.g., burnout last week, goals, feeling stuck" style="width: 100%; margin-bottom: 0.5em;" />
      <button class="btn" id="searchBtn" onclick="runSmartSearch()" disabled>Search</button>
      <div id="searchResults" style="margin-top: 1em;"></div>
    </div>

    <div id="pastEntries" style="margin-top: 1em;"></div>

    

    
  </div>
</div>
  </main>
  <div style="text-align: center; margin-top: 2em;">
    <button class="btn" onclick="logOutUser()">Logout</button>
  </div>
  <div style="text-align: center; margin: 2em 0 1em 0; font-size: 1em; color: var(--info-muted); font-style: italic;">
    InkWell is still in its design and growth phase â€” your feedback truly matters!<br/>
    If you have comments, questions, concerns, or upgrade ideas,<br/>
    please email us at the support address below.<br/>
    We're committed to making InkWell the most intuitive and supportive journaling and manifesting app possible.
  </div>
  <footer style="margin-top: 2em; font-size: 0.85em; text-align: center;">
    <span style="display: block; margin-bottom: 0.2em;">
      Â© 2025 Pegasus Realm LLC.
    </span>
    <span style="display: block; margin-bottom: 0.2em;">
      InkWell is your trusted journaling companion, designed with evidence-based positive psychology principles to foster well-being, focus, and productivity.
    </span>
    <span style="display: block;">
      Especially mindful of neurodivergent-friendly UI efficiency and clarity.
    </span>
    <p>
      <a href="https://www.inkwelljournal.io/privacy-policy/" target="_blank" style="text-decoration: underline;">Privacy Policy</a> |
      <a href="https://www.inkwelljournal.io/terms-conditions/" target="_blank" style="text-decoration: underline;">Terms and Conditions</a> |
      <a href="https://www.inkwelljournal.io/alpha-beta-testers/" target="_blank" style="text-decoration: underline;">Alpha/Beta Tester Agreement</a>
    </p>
    <div style="display: flex; justify-content: center; align-items: flex-start; gap: 4em; margin-bottom: 1.3em;">
      <!-- Pegasus Realm block -->
      <div style="display:flex; flex-direction:column; align-items:center;">
        <img src="/PR Logo WHITE.svg" alt="Pegasus Realm Logo" width="54" height="54" style="margin-bottom: 0.5em;"/>
        <div style="display:flex; gap:10px; margin-top:0;">
          <!-- PR IG -->
          <a href="https://www.instagram.com/pegasus.realm/" target="_blank" aria-label="Pegasus Realm Instagram">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24" style="vertical-align:middle;">
              <rect x="3" y="3" width="18" height="18" rx="5" fill="none" stroke="currentColor"/>
              <circle cx="12" cy="12" r="5" stroke="currentColor"/>
              <circle cx="17" cy="7" r="1.3" fill="currentColor"/>
            </svg>
          </a>
          <!-- PR LI -->
          <a href="https://www.linkedin.com/company/pegasus-realm" target="_blank" aria-label="Pegasus Realm LinkedIn">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align:middle;">
              <rect x="2" y="2" width="20" height="20" rx="4" fill="none" stroke="currentColor" stroke-width="1.4"/>
              <rect x="6" y="9.5" width="2.5" height="7.5" rx="1.1"/>
              <circle cx="7.25" cy="7" r="1.3"/>
              <rect x="11" y="11.2" width="2.5" height="5.8" rx="1.1"/>
              <path d="M13.25 13.1c0-1.32 2.5-1.42 2.5 0v4.2" fill="none" stroke="currentColor" stroke-width="1.2"/>
            </svg>
          </a>
        </div>
      </div>
      <!-- Adam Grimm block -->
      <div style="display:flex; flex-direction:column; align-items:center;">
        <img src="/AG Silhouette.svg" alt="Adam Grimm Logo" width="54" height="54" style="margin-bottom: 0.5em;"/>
        <div style="display:flex; gap:10px; margin-top:0;">
          <!-- AG IG -->
          <a href="https://www.instagram.com/gestaltinsight/" target="_blank" aria-label="Adam Grimm Instagram">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24" style="vertical-align:middle;">
              <rect x="3" y="3" width="18" height="18" rx="5" fill="none" stroke="currentColor"/>
              <circle cx="12" cy="12" r="5" stroke="currentColor"/>
              <circle cx="17" cy="7" r="1.3" fill="currentColor"/>
            </svg>
          </a>
          <!-- AG LI -->
          <a href="https://www.linkedin.com/in/adamgrimm808/" target="_blank" aria-label="Adam Grimm LinkedIn">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align:middle;">
              <rect x="2" y="2" width="20" height="20" rx="4" fill="none" stroke="currentColor" stroke-width="1.4"/>
              <rect x="6" y="9.5" width="2.5" height="7.5" rx="1.1"/>
              <circle cx="7.25" cy="7" r="1.3"/>
              <rect x="11" y="11.2" width="2.5" height="5.8" rx="1.1"/>
              <path d="M13.25 13.1c0-1.32 2.5-1.42 2.5 0v4.2" fill="none" stroke="currentColor" stroke-width="1.2"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
    <p>Contact support: <a href="mailto:support@inkwelljournal.io" style="text-decoration: underline;">support@inkwelljournal.io</a></p>
    </footer>
  <div id="aboutInkwellModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(21,54,58,0.86); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#2A6972; padding:2em 1.3em 1.5em 1.3em; border-radius:10px; max-width:560px; width:92%; max-height:86vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.13);">
      <h2 style="margin-top:0; text-align:center;">About InkWell</h2>
      <div style="font-size:1em; line-height:1.65; margin-bottom:1.2em;">
        <strong>InkWell</strong> is part of the Pegasus Realm wellness ecosystemâ€”designed for individuals, coaches, counselors, and mental health practitioners seeking science-backed, intuitive tools for growth.
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">Why Manifest Statements?</h3>
        At the heart of InkWell is your Manifest Statement: a personal guiding vision. This method draws on <strong>goal-setting theory</strong> and positive psychology, helping you translate intentions into action through evidence-based habit building and self-reflection.<br/>
        <span style="font-size:0.98em; color:#388b97;">
          <em>Research shows written goals and expressive journaling increase achievement, resilience, and emotional well-being.</em>
        </span>
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">The Power of Journaling</h3>
        Journaling improves clarity, well-being, and positive behavior change. Itâ€™s linked to increased self-awareness, reduced anxiety, and improved coping skills.<br/>
        <span style="font-size:0.98em; color:#388b97;">
          <em>References: Pennebaker & Smyth (2016), Baikie & Wilhelm (2005), Locke & Latham (2002)</em>
        </span>
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">Sophy: Your AI Guide</h3>
        Sophy supports you with <b>positive psychology</b> strategies, evidence-based habit support, and guidance from both Western and Hawaiian models of wellness.<br/>
        <ul style="font-size:0.97em; margin:0.5em 0 0 1em;">
          <li><b>SAMHSAâ€™s 8 Dimensions of Wellness</b> â€“ holistic, practical, and evidence-based.</li>
          <li><b>KÅ«kulu Kumuhana</b> â€“ rooted in Native Hawaiian wisdom, emphasizing collective well-being, connectedness, and purpose through culture and community.</li>
        </ul>
        Sophy motivates and supports you as you work toward your goals, blending proven frameworks with the spirit of aloha.
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">Feeling Overwhelmed?</h3>
        Try the <strong>Aloha Wellness Guideâ„¢</strong> at <a href="https://www.alohawellness.guide" target="_blank" style="color:#2A6972;text-decoration:underline;">alohawellness.guide</a> for simple, beginner-friendly wellness tips. InkWell is best for those ready to deepen their journey and set actionable goals.
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">About the Founder</h3>
        <div style="font-size: 0.98em; line-height:1.55; margin:0.7em 0;">
        Adam Grimmâ€™s journey into wellness began during a transformative period in his life, leading to a 20-year career in the U.S. Air Force. As an Explosive Ordnance Disposal (EOD) Technician, Adam served in active war zones and led the response team at Daniel K. Inouye (Honolulu) International Airport, developing resilience and leadership skills under intense pressure. Following his medical retirement in 2021, Adam channeled his experiences into advancing mental health and wellness initiatives in Hawaiâ€˜i.<br/><br/>
        Adam earned his Bachelorâ€™s degree in Psychology from the University of Hawaiâ€˜i at MÄnoa, where he contributed to the CDC-funded Overdose Data to Action (OD2A)-Care Coordination and Capacity Building (C3) Project. His work focused on combating the opioid epidemic across Oâ€˜ahu, Kauaâ€˜i, and Molokaâ€˜i by fostering collaboration among law enforcement, educational institutions, and local organizations.<br/><br/>
        Adam also served as a research assistant for three years, delving into organizational wellness, lived experience, and preventative care within Hawaiâ€˜iâ€™s non-profit sector. Now pursuing his Doctorate in Clinical Psychology at the Hawaiâ€˜i School of Professional Psychology at Chaminade University, Adam balances his academic pursuits with his role at Hawaiâ€˜i Neuropsychology, where he supports patients with diverse mental health needs.<br/><br/>
        He has begun in-person psychoeducation sessions about wellness and action at the Present Mind Institute Hawaii, in Kaneohe, that you can participate in.<br/><br/>
        In addition, Adam is the founder of Pegasus Realm, a wellness research and consulting company dedicated to improving well-being through innovative, evidence-based practices. His work focuses on creating holistic wellness strategies for individuals and organizations, blending research, coaching, and a deep understanding of lived experience to enhance quality of life and foster adaptability and equity.
        </div>
        <hr style="margin:1em 0;"/>
        <div style="font-size:0.96em; text-align:center; color:#2A6972;">
          <b>For questions, feedback, or upgrade ideas:<br/>
          <a href="mailto:support@inkwelljournal.io" style="color:#2A6972; text-decoration:underline;">support@inkwelljournal.io</a></b>
        </div>
      </div>
      <button class="btn" onclick="document.getElementById('aboutInkwellModal').style.display='none'">Close</button>
    </div>
  </div>
<script>
  document.getElementById("aboutInkwellBtn").onclick = function() {
    document.getElementById("aboutInkwellModal").style.display = "flex";
  };
</script>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
  // Safari autofill workaround: force field re-evaluation on focus
  document.querySelectorAll("input").forEach((input) => {
    input.addEventListener("focus", () => {
      input.value = input.value; // nudges Safari to reprocess autofill
    });
  });
</script>
<script>
  document.getElementById("aboutInkwellBtn").onclick = function() {
    document.getElementById("aboutInkwellModal").style.display = "flex";
  };

  // Safari autofill workaround: force field re-evaluation on focus
  document.querySelectorAll("input").forEach((input) => {
    input.addEventListener("focus", () => {
      input.value = input.value;
    });
  });

  // --- Expand/collapse handler for search results ---
  function toggleExpand(el) {
    const full = el.querySelector(".entry-full");
    if (!full) return;
    full.style.display = full.style.display === "none" ? "block" : "none";
  }
</script>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
</script>
</body>
</html>

