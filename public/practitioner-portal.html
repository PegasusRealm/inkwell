<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InkWell - Coach Portal</title>
    <style>
        :root {
            --brand-primary: #2A6972;
            --brand-secondary: #388b97;
            --brand-light: #4A9BA8;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --danger-red: #ef4444;
            --font-main: #374151;
            --font-secondary: #6b7280;
            --font-muted: #9ca3af;
            --bg-primary: #f5f7fa;
            --bg-card: #ffffff;
            --bg-muted: #f9fafb;
            --border-light: #e5e7eb;
            --border-medium: #d1d5db;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --brand-primary: #4A9BA8;
                --brand-secondary: #7BB8C4;
                --brand-light: #9FD3E0;
                --font-main: #f3f4f6;
                --font-secondary: #d1d5db;
                --font-muted: #9ca3af;
                --bg-primary: #1f2937;
                --bg-card: #374151;
                --bg-muted: #4b5563;
                --border-light: #4b5563;
                --border-medium: #6b7280;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-muted) 100%);
            min-height: 100vh;
            color: var(--font-main);
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
            color: white;
            padding: 1.5em 2em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 1em;
        }
        
        .header-logo img {
            height: 50px;
            filter: brightness(0) invert(1);
        }
        
        .header-user {
            display: flex;
            align-items: center;
            gap: 1em;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.6em 1.2em;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Tabs */
        .tabs {
            background: var(--bg-card);
            border-bottom: 2px solid var(--border-light);
            padding: 0 2em;
            display: flex;
            gap: 2em;
            overflow-x: auto;
        }
        
        .tab {
            padding: 1em 1.5em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--font-secondary);
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: var(--brand-primary);
        }
        
        .tab.active {
            color: var(--brand-primary);
            border-bottom-color: var(--brand-primary);
        }
        
        /* Content */
        .content {
            max-width: 1200px;
            margin: 2em auto;
            padding: 0 2em;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5em;
        }
        
        .card-title {
            font-size: 1.5em;
            color: var(--brand-primary);
            margin-bottom: 1em;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
        
        .form-group {
            margin-bottom: 1.5em;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: var(--font-main);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75em;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
            background: var(--bg-card);
            color: var(--font-main);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
        }
        
        .btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 0.75em 1.5em;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #1e5055;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: var(--danger-red);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .alert {
            padding: 1em;
            border-radius: 8px;
            margin-bottom: 1em;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success-green);
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning-yellow);
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger-red);
        }
        
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 0.75em;
            padding: 1em;
            background: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-top: 0.25em;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5em;
            margin-bottom: 2em;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
            color: white;
            padding: 1.5em;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 0.25em;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .gift-code-display {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
            color: white;
            padding: 1.25em 1.5em;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            letter-spacing: 0.15em;
            margin: 1em 0;
            user-select: all;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(42, 105, 114, 0.3);
        }
        
        .gift-code-display:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 16px rgba(42, 105, 114, 0.4);
        }
        
        #giftCodeResult .form-group {
            margin-bottom: 1.5em;
        }
        
        #giftCodeResult input[readonly] {
            background: var(--bg-card);
            color: var(--font-main);
            font-family: monospace;
            border: 2px solid var(--border-light);
        }
        
        #giftCodeResult .btn {
            margin-top: 0.5em;
        }
        
        /* Client Management Styles */
        .client-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            margin-bottom: 1em;
            transition: box-shadow 0.2s;
            overflow: hidden;
        }
        
        .client-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1em 1.25em;
            cursor: pointer;
            user-select: none;
        }
        
        .client-card-header:hover {
            background: var(--bg-primary);
        }
        
        .client-header-left {
            display: flex;
            align-items: center;
            gap: 1em;
        }
        
        .client-header-left h3 {
            margin: 0;
            color: var(--font-main);
            font-size: 1.05em;
        }
        
        .expand-icon {
            color: var(--font-muted);
            font-size: 1.2em;
            transition: transform 0.2s;
        }
        
        .client-card.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .client-card-body {
            display: none;
            padding: 0 1.25em 1.25em;
            border-top: 1px solid var(--border-light);
        }
        
        .client-card.expanded .client-card-body {
            display: block;
        }
        
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1em;
        }
        
        .client-info h3 {
            margin: 0 0 0.25em 0;
            color: var(--font-main);
            font-size: 1.1em;
        }
        
        .client-info .client-email {
            color: var(--font-muted);
            font-size: 0.9em;
        }
        
        .client-stats {
            text-align: right;
            font-size: 0.85em;
            color: var(--font-secondary);
        }
        
        .client-summary-badge {
            font-size: 0.85em;
            padding: 0.2em 0.6em;
            border-radius: 12px;
            margin-left: 0.5em;
        }
        
        .badge-danger {
            background: var(--danger-red);
            color: white;
        }
        
        .badge-success {
            background: var(--success-green);
            color: white;
        }
        
        .needs-reply-badge {
            background: var(--danger-red);
            color: white;
            padding: 0.25em 0.75em;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 0.5em;
        }
        
        .pending-entries {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 0.75em 1em;
            margin: 0.75em 0;
        }
        
        .pending-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5em 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .pending-entry:last-child {
            border-bottom: none;
        }
        
        .pending-entry-text {
            flex: 1;
            color: var(--font-main);
            font-size: 0.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 1em;
        }
        
        .pending-entry-date {
            color: var(--font-muted);
            font-size: 0.8em;
            white-space: nowrap;
        }
        
        .reply-btn {
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 0.4em 0.8em;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            margin-left: 0.5em;
        }
        
        .reply-btn:hover {
            background: #1e5055;
        }
        
        .coach-notes {
            margin-top: 1em;
            padding-top: 1em;
            border-top: 1px solid var(--border-light);
        }
        
        .coach-notes label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--font-secondary);
            margin-bottom: 0.5em;
        }
        
        .coach-notes textarea {
            width: 100%;
            min-height: 60px;
            padding: 0.75em;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 0.9em;
            resize: vertical;
            background: var(--bg-card);
            color: var(--font-main);
        }
        
        .coach-notes .save-notes-btn {
            background: var(--brand-secondary);
            color: white;
            border: none;
            padding: 0.4em 1em;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            margin-top: 0.5em;
        }
        
        .coach-notes .save-notes-btn:hover {
            background: #3a8a94;
        }
        
        .no-clients-message {
            text-align: center;
            padding: 2em;
            color: var(--font-muted);
        }

        .loading {
            text-align: center;
            padding: 3em;
            color: #6b7280;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top-color: var(--brand-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .info-box {
            background: var(--bg-primary);
            border-left: 4px solid var(--brand-primary);
            padding: 1em;
            border-radius: 8px;
            margin-bottom: 1.5em;
            color: var(--font-main);
        }
        
        .revenue-model {
            background: var(--bg-card);
            border: 2px solid var(--brand-primary);
            border-radius: 12px;
            padding: 1.5em;
            margin-bottom: 2em;
        }
        
        @media (max-width: 768px) {
            .tabs {
                padding: 0 1em;
                gap: 0.5em;
            }
            
            .tab {
                padding: 0.75em 1em;
                font-size: 0.9em;
            }
            
            .content {
                padding: 0 1em;
            }
            
            .card {
                padding: 1.5em;
            }
        }
        
        /* Login Screen Styles */
        #loginScreen {
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 2em;
        }
        
        #loginScreen.hidden {
            display: none;
        }
        
        #loginScreen.visible {
            display: flex;
        }
        
        .login-container {
            background: white;
            border-radius: 16px;
            padding: 3em;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 2em;
        }
        
        .login-logo img {
            max-height: 80px;
            margin-bottom: 1em;
        }
        
        .login-logo h1 {
            color: var(--brand-primary);
            font-size: 1.8em;
            margin-bottom: 0.3em;
        }
        
        .login-logo p {
            color: #6b7280;
            font-size: 0.95em;
        }
        
        .social-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75em;
            margin-bottom: 1.5em;
        }
        
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75em;
            padding: 0.9em;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .social-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        
        .social-btn img {
            width: 20px;
            height: 20px;
        }
        
        .divider {
            text-align: center;
            margin: 1.5em 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: #e5e7eb;
        }
        
        .divider span {
            background: white;
            padding: 0 1em;
            color: #9ca3af;
            font-size: 0.9em;
            position: relative;
        }
        
        .login-form input {
            width: 100%;
            padding: 0.9em;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95em;
            margin-bottom: 0.75em;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(42, 105, 114, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: 0.9em;
            background: var(--brand-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .login-btn:hover {
            background: #1e5055;
        }
        
        .login-error {
            color: var(--danger-red);
            font-size: 0.9em;
            margin-top: 0.75em;
            text-align: center;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 0.9em;
        }
        
        .login-footer a {
            color: var(--brand-primary);
            text-decoration: none;
        }
        
        .login-footer a:hover {
            text-decoration: underline;
        }
        
        #portalContent.hidden {
            display: none;
        }
        
        #portalContent.visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="visible">
        <div class="login-container">
            <div class="login-logo">
                <img src="InkWell-Logo.png" alt="InkWell">
                <h1>Coach Portal</h1>
                <p>Sign in to access your dashboard</p>
            </div>
            
            <div class="social-buttons">
                <button class="social-btn" onclick="handleGoogleLogin()">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>
                
                <button class="social-btn" onclick="handleAppleLogin()">
                    <svg width="20" height="20" viewBox="0 0 24 24"><path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z" fill="currentColor"/></svg>
                    Continue with Apple
                </button>
            </div>
            
            <div class="divider">
                <span>or sign in with email</span>
            </div>
            
            <form class="login-form" onsubmit="handleEmailLogin(event)">
                <input 
                    type="email" 
                    id="loginEmail" 
                    placeholder="Email address" 
                    required 
                    autocomplete="email"
                >
                <input 
                    type="password" 
                    id="loginPassword" 
                    placeholder="Password" 
                    required 
                    autocomplete="current-password"
                >
                <button type="submit" class="login-btn">Sign In</button>
                <div id="loginError" class="login-error"></div>
            </form>
            
            <div class="login-footer">
                <p>Don't have coach access?</p>
                <p><a href="mailto:support@inkwelljournal.io">Contact Support</a> to apply</p>
            </div>
        </div>
    </div>
    
    <!-- Portal Content (shown after login) -->
    <div id="portalContent" class="hidden">
    <!-- Header -->
    <div class="header">
        <div class="header-logo">
            <img src="InkWell-Logo.png" alt="InkWell">
            <div>
                <h1 style="font-size: 1.5em;">Coach Portal</h1>
                <p style="font-size: 0.9em; opacity: 0.9;" id="headerUserInfo">Loading...</p>
            </div>
        </div>
        <div class="header-user">
            <button class="logout-btn" onclick="handleLogout()">üö™ Log Out</button>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="showTab('dashboard')">üìä Dashboard</div>
        <div class="tab" onclick="showTab('profile')">üë§ Profile</div>
        <div class="tab" onclick="showTab('tax-info')">üìã Tax Information</div>
        <div class="tab" onclick="showTab('revenue')">üí∞ Revenue</div>
        <div class="tab" onclick="showTab('gifts')">üéÅ Gift Codes</div>
        <div class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</div>
    </div>
    
    <!-- Content -->
    <div class="content">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-clients">0</div>
                    <div class="stat-label">Active Clients</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-revenue">$0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-gifts">0</div>
                    <div class="stat-label">Gift Codes Issued</div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">ÔøΩ Client Management</h2>
                <div id="clientManagement" class="loading">
                    <div class="spinner"></div>
                    <p>Loading clients...</p>
                </div>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="tab-profile" class="tab-content">
            <div class="card">
                <h2 class="card-title">üë§ Profile Information</h2>
                <div id="profileForm">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="profileName" placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="profileEmail" readonly style="background: #f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>Professional Credentials</label>
                        <input type="text" id="profileCredentials" placeholder="e.g., LCSW, PhD, LPC">
                    </div>
                    <div class="form-group">
                        <label>Practice Location</label>
                        <input type="text" id="profileLocation" placeholder="City, State">
                    </div>
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea id="profileBio" rows="4" maxlength="200" placeholder="Tell potential clients about yourself, your approach, and what you specialize in..." style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; resize: vertical;" oninput="document.getElementById('profileBioCount').textContent = this.value.length"></textarea>
                        <small style="color: #6b7280;">This bio will be visible to users when they're choosing a coach. <span id="profileBioCount">0</span>/200 characters</small>
                    </div>
                    <button class="btn" onclick="saveProfile()">üíæ Save Profile</button>
                    <div id="profileStatus"></div>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">üîê Change Password</h2>
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password">
                </div>
                <button class="btn" onclick="changePassword()">üîÑ Update Password</button>
                <div id="passwordStatus"></div>
            </div>
            
            <div class="card">
                <h2 class="card-title">‚ö†Ô∏è Delete Account</h2>
                <div class="alert alert-warning">
                    <strong>Warning:</strong> Deleting your account is permanent and cannot be undone. All your data will be removed after 30 days.
                </div>
                <button class="btn btn-danger" onclick="requestAccountDeletion()">üóëÔ∏è Request Account Deletion</button>
                <div id="deleteStatus"></div>
            </div>
        </div>
        
        <!-- Tax Information Tab -->
        <div id="tab-tax-info" class="tab-content">
            <div class="card">
                <h2 class="card-title">üìã W-9 Information (US Contractors)</h2>
                <div class="info-box">
                    <strong>Why we need this:</strong> As an independent contractor earning revenue through InkWell, we're required to collect your tax information for IRS 1099 reporting if you earn over $600/year.
                </div>
                
                <div id="taxInfoForm">
                    <div class="form-group">
                        <label>Legal Full Name <span style="color: red;">*</span></label>
                        <input type="text" id="taxLegalName" placeholder="As it appears on tax returns">
                    </div>
                    
                    <div class="form-group">
                        <label>Business Name (if different from above)</label>
                        <input type="text" id="taxBusinessName" placeholder="DBA or business entity name">
                    </div>
                    
                    <div class="form-group">
                        <label>Tax Classification <span style="color: red;">*</span></label>
                        <select id="taxClassification">
                            <option value="">Select classification...</option>
                            <option value="individual">Individual/Sole Proprietor</option>
                            <option value="llc">LLC (Single Member)</option>
                            <option value="llc_multi">LLC (Multi Member)</option>
                            <option value="c_corp">C Corporation</option>
                            <option value="s_corp">S Corporation</option>
                            <option value="partnership">Partnership</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Social Security Number or EIN <span style="color: red;">*</span></label>
                        <input type="text" id="taxSSN" placeholder="XXX-XX-XXXX or XX-XXXXXXX" maxlength="11">
                        <small style="color: #6b7280;">üîí Encrypted and stored securely. Never shared with third parties.</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Address <span style="color: red;">*</span></label>
                        <input type="text" id="taxAddress" placeholder="Street address">
                    </div>
                    
                    <div class="form-group">
                        <label>City <span style="color: red;">*</span></label>
                        <input type="text" id="taxCity" placeholder="City">
                    </div>
                    
                    <div class="form-group">
                        <label>State <span style="color: red;">*</span></label>
                        <input type="text" id="taxState" placeholder="State/Province">
                    </div>
                    
                    <div class="form-group">
                        <label>ZIP Code <span style="color: red;">*</span></label>
                        <input type="text" id="taxZip" placeholder="ZIP/Postal Code" maxlength="10">
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="taxCertify" required>
                        <label for="taxCertify">
                            <strong>I certify</strong> that the information provided is true, correct, and complete. I understand that falsifying this information may subject me to penalties under federal law.
                        </label>
                    </div>
                    
                    <button class="btn" onclick="saveTaxInfo()">üíæ Save Tax Information</button>
                    <div id="taxInfoStatus"></div>
                </div>
            </div>
        </div>
        
        <!-- Revenue Tab -->
        <div id="tab-revenue" class="tab-content">
            <div class="revenue-model">
                <h3 style="color: var(--brand-primary); margin-bottom: 1em;">üí° How You Earn Money with InkWell</h3>
                <p style="margin-bottom: 1em; line-height: 1.6; color: var(--font-main);">
                    You earn <strong>60% of the Connect subscription fee</strong> ($29.99/month) for each client who maintains an active subscription while connected to you. That's <strong>$18/month per client</strong>.
                </p>
                <div style="background: var(--bg-muted); padding: 1em; border-radius: 8px; margin-bottom: 1em;">
                    <strong style="color: var(--brand-primary);">Revenue Split:</strong>
                    <ul style="margin: 0.5em 0 0 1.5em; line-height: 1.8; color: var(--font-main);">
                        <li><strong>60%</strong> to you ($18/client/month)</li>
                        <li><strong>30%</strong> to InkWell platform</li>
                        <li><strong>10%</strong> Stripe processing fees</li>
                    </ul>
                </div>
                <p style="margin: 0; font-size: 0.9em; color: var(--font-secondary);">
                    Payments are processed monthly via Stripe and deposited directly to your linked bank account.
                </p>
            </div>
            
            <div class="card">
                <h2 class="card-title">üí∞ Revenue Dashboard</h2>
                <div id="revenueStats" class="loading">
                    <div class="spinner"></div>
                    <p>Loading revenue data...</p>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">üè¶ Stripe Connect Setup</h2>
                <div class="info-box">
                    <strong>Setup required:</strong> Connect your bank account via Stripe to receive payments. This is a one-time setup process.
                </div>
                <div id="stripeConnectStatus">
                    <button class="btn" onclick="setupStripeConnect()">üîó Connect Bank Account</button>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">üìä Tax Documents</h2>
                <p style="margin-bottom: 1em; color: #6b7280;">
                    1099 forms and annual tax summaries will be available here each January for the previous tax year.
                </p>
                <div id="taxDocuments">
                    <p style="color: #9ca3af;">No tax documents available yet.</p>
                </div>
            </div>
        </div>
        
        <!-- Gift Codes Tab -->
        <div id="tab-gifts" class="tab-content">
            <div class="card">
                <h2 class="card-title">üéÅ Gift Subscription Codes</h2>
                <div class="info-box">
                    <strong>Help your clients get started!</strong> Generate discount codes to share with clients when they subscribe to InkWell Connect.
                </div>
                
                <div style="background: var(--bg-primary); padding: 1.5em; border-radius: 8px; margin-bottom: 1.5em; border: 1px solid var(--border-light);">
                    <h4 style="color: var(--brand-primary); margin: 0 0 1em 0;">üìã How It Works</h4>
                    <ol style="margin: 0; padding-left: 1.5em; line-height: 1.8; color: var(--font-main);">
                        <li><strong>Generate a code</strong> below with your chosen discount</li>
                        <li><strong>Share it</strong> with your client via email (use the form below) or copy it to send however you like</li>
                        <li><strong>Client enters the code</strong> when subscribing to InkWell Connect</li>
                        <li><strong>They get the discounted rate</strong> for 3 months while paired with you</li>
                    </ol>
                    
                    <div style="margin-top: 1em; padding: 1em; background: var(--bg-card); border-radius: 6px; border-left: 4px solid var(--warning-yellow);">
                        <strong style="color: var(--font-main);">üí° Important:</strong>
                        <ul style="margin: 0.5em 0 0 1em; padding: 0; list-style: disc; color: var(--font-secondary); font-size: 0.95em;">
                            <li><strong>100% Off</strong> = Free for <strong>1 month</strong>, then converts to regular rate</li>
                            <li><strong>50% Off</strong> = Half price for <strong>3 months</strong>, then regular rate</li>
                            <li>Each client can only use <strong>one free month code ever</strong> ‚Äî additional 100% codes are automatically converted to 50% off</li>
                            <li>Discount applies only while client remains connected to you</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Discount Amount</label>
                    <select id="giftDiscount">
                        <option value="50">50% Off ($14.99/month for 3 months)</option>
                        <option value="100">100% Off (Free for 1 month ‚Äî one per client)</option>
                    </select>
                    <small style="color: var(--font-muted);">100% codes give clients a free trial month. 50% codes give 3 months at half price.</small>
                </div>
                
                <div class="form-group">
                    <label>Recipient Email (Optional)</label>
                    <input type="email" id="giftRecipientEmail" placeholder="client@example.com">
                    <small style="color: var(--font-muted);">If provided, we'll send them an email with the code and instructions.</small>
                </div>
                
                <button class="btn" onclick="generateGiftCode()">üéÅ Generate Gift Code</button>
                
                <div id="giftCodeResult" style="display: none; margin-top: 2em;">
                    <div class="alert alert-success">
                        <strong>‚úÖ Gift Code Created!</strong>
                    </div>
                    
                    <div class="form-group">
                        <label>Redemption Code</label>
                        <div class="gift-code-display" id="giftCodeDisplay">LOADING...</div>
                        <button class="btn btn-secondary" onclick="copyGiftCode()">üìã Copy Code</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Redemption Link</label>
                        <input type="text" id="giftLinkDisplay" readonly style="background: #f3f4f6;">
                        <button class="btn btn-secondary" onclick="copyGiftLink()">üîó Copy Link</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Send via Email</label>
                        <input type="email" id="giftSendEmail" placeholder="Enter client email">
                        <button class="btn" onclick="sendGiftEmail()">üìß Send Email</button>
                    </div>
                </div>
                
                <div id="giftStatus"></div>
            </div>
            
            <div class="card">
                <h2 class="card-title">üìú Issued Gift Codes</h2>
                <div id="giftCodesList" class="loading">
                    <div class="spinner"></div>
                    <p>Loading gift codes...</p>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
            <!-- Public Profile Opt-In Card (Prominent) -->
            <div class="card" style="border: 3px solid var(--brand-primary); background: linear-gradient(135deg, #f0f9fa 0%, #e8f4f8 100%);">
                <h2 class="card-title" style="font-size: 1.6em;">üåü Grow Your Practice with InkWell</h2>
                <p style="font-size: 1.1em; color: #374151; margin-bottom: 1.5em; line-height: 1.6;">
                    By default, you're only visible to clients you directly invite. <strong>Opt in below</strong> to appear in our public coach directory and let any InkWell user discover and connect with you!
                </p>
                
                <div style="background: white; border-radius: 12px; padding: 1.5em; box-shadow: 0 2px 8px rgba(42, 105, 114, 0.15);">
                    <label for="freeAgentOptIn" style="display: flex; align-items: flex-start; gap: 1em; cursor: pointer;">
                        <input type="checkbox" id="freeAgentOptIn" style="width: 24px; height: 24px; margin-top: 2px; accent-color: var(--brand-primary);">
                        <div>
                            <span style="font-size: 1.2em; font-weight: 700; color: var(--brand-primary);">
                                ‚ú® Yes! I'd like to be available to any InkWell user
                            </span>
                            <p style="margin: 0.5em 0 0 0; color: #6b7280; font-size: 0.95em;">
                                You'll appear in the in-app coach directory. New clients can browse your profile and select you as their coach. Grow your practice organically!
                            </p>
                        </div>
                    </label>
                </div>
                
                <div id="freeAgentProfile" style="display: none; margin-top: 1.5em; padding: 1.5em; background: #f9fafb; border-radius: 8px;">
                    <h3 style="color: var(--brand-primary); margin-bottom: 1em;">üìù Public Profile (visible in directory)</h3>
                    <div class="form-group">
                        <label>Specialties</label>
                        <input type="text" id="practiceSpecialties" placeholder="e.g., Anxiety, Depression, Trauma, Life Coaching">
                    </div>
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea id="practiceBio" rows="4" maxlength="200" placeholder="Tell potential clients about your approach and experience..." oninput="document.getElementById('practiceBioCount').textContent = this.value.length"></textarea>
                        <small style="color: #6b7280;"><span id="practiceBioCount">0</span>/200 characters</small>
                    </div>
                    <div class="form-group">
                        <label>Accepting New Clients?</label>
                        <select id="acceptingClients">
                            <option value="yes">Yes - Accepting new clients</option>
                            <option value="limited">Limited availability</option>
                            <option value="no">Not accepting new clients</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="saveSettings()" style="margin-top: 1.5em;">üíæ Save Settings</button>
                <div id="settingsStatus"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getAuth, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, onAuthStateChanged, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, OAuthProvider } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, where, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDivYKnp_SinGjL7iVVwSyQH-RnFHMFDM0",
            authDomain: "inkwelljournal.io",
            projectId: "inkwell-alpha",
            storageBucket: "inkwell-alpha.appspot.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'us-central1');

        let currentUser = null;
        let practitionerData = null;

        // Show/hide sections
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginScreen').classList.add('visible');
            document.getElementById('portalContent').classList.remove('visible');
            document.getElementById('portalContent').classList.add('hidden');
        }

        function showPortal() {
            document.getElementById('loginScreen').classList.remove('visible');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('portalContent').classList.remove('hidden');
            document.getElementById('portalContent').classList.add('visible');
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                showLoginScreen();
                return;
            }

            currentUser = user;

            try {
                // Wait a moment for auth token to propagate
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Load practitioner data
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                // Check if user is an approved practitioner
                if (!userDoc.exists()) {
                    alert('User account not found. Please contact support.');
                    await signOut(auth);
                    showLoginScreen();
                    return;
                }

                const userData = userDoc.data();
                
                // Check if user has coach role (approved practitioner)
                // Check both accountType and userRole for backwards compatibility
                const isCoach = userData.accountType === 'coach' || userData.userRole === 'coach';
                
                if (!isCoach) {
                    // Check if they have a pending application
                    try {
                        const appDoc = await getDoc(doc(db, 'practitionerApplications', user.uid));
                        if (appDoc.exists() && appDoc.data().status === 'pending') {
                            alert('Your coach application is pending approval. You will receive an email when approved (typically within 72 hours).');
                        } else {
                            alert('You do not have coach access. Please apply to become a coach first.');
                        }
                    } catch (appError) {
                        console.error('Error checking application:', appError);
                        alert('You do not have coach access.');
                    }
                    await signOut(auth);
                    showLoginScreen();
                    return;
                }

                practitionerData = userData;
                showPortal();
                initializeDashboard();
            } catch (error) {
                console.error('Error loading practitioner data:', error);
                alert('Error loading your account: ' + error.message + '\n\nPlease try logging in again or contact support.');
                await signOut(auth);
                showLoginScreen();
            }
        });

        // Email/Password Login
        window.handleEmailLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                return;
            }
            
            try {
                errorDiv.textContent = 'Signing in...';
                await signInWithEmailAndPassword(auth, email, password);
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Email login error:', error);
                let message = 'Login failed: ';
                if (error.code === 'auth/user-not-found') {
                    message += 'No account found with this email';
                } else if (error.code === 'auth/wrong-password') {
                    message += 'Incorrect password';
                } else if (error.code === 'auth/invalid-email') {
                    message += 'Invalid email address';
                } else if (error.code === 'auth/too-many-requests') {
                    message += 'Too many failed attempts. Please try again later';
                } else {
                    message += error.message;
                }
                errorDiv.textContent = message;
            }
        };

        // Google Sign In
        window.handleGoogleLogin = async () => {
            const errorDiv = document.getElementById('loginError');
            try {
                errorDiv.textContent = 'Opening Google sign-in...';
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Google login error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    errorDiv.textContent = 'Sign-in cancelled';
                } else {
                    errorDiv.textContent = 'Google sign-in failed: ' + error.message;
                }
            }
        };

        // Apple Sign In
        window.handleAppleLogin = async () => {
            const errorDiv = document.getElementById('loginError');
            try {
                errorDiv.textContent = 'Opening Apple sign-in...';
                const provider = new OAuthProvider('apple.com');
                await signInWithPopup(auth, provider);
                errorDiv.textContent = '';
            } catch (error) {
                console.error('Apple login error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    errorDiv.textContent = 'Sign-in cancelled';
                } else {
                    errorDiv.textContent = 'Apple sign-in failed: ' + error.message;
                }
            }
        };

        function initializeDashboard() {
            document.getElementById('headerUserInfo').textContent = practitionerData.displayName || practitionerData.email;
            loadDashboardStats();
            loadProfileData();
            loadTaxInfo();
            loadSettings();
            loadGiftCodesList(); // Load issued gift codes
            checkConnectStatusOnLoad(); // Check Stripe Connect status
        }

        async function loadDashboardStats() {
            try {
                // Query by connectedPractitioner.practitionerId (established field)
                let clientsQuery = query(
                    collection(db, 'users'),
                    where('connectedPractitioner.practitionerId', '==', currentUser.uid)
                );
                let clientsSnapshot = await getDocs(clientsQuery);
                let activeClientsCount = clientsSnapshot.size;
                
                // If no results, try fallback query by email
                if (activeClientsCount === 0 && currentUser.email) {
                    console.log('No results by practitionerId, trying email query...');
                    const emailQuery = query(
                        collection(db, 'users'),
                        where('connectedPractitioner.email', '==', currentUser.email)
                    );
                    clientsSnapshot = await getDocs(emailQuery);
                    activeClientsCount = clientsSnapshot.size;
                }
                
                document.getElementById('stat-clients').textContent = activeClientsCount.toString();
                console.log(`Found ${activeClientsCount} active clients`);
                
                // Revenue - placeholder for now (would need to query earnings)
                document.getElementById('stat-revenue').textContent = '$0';
                
                // Gift codes count
                document.getElementById('stat-gifts').textContent = '0';
                
                // Load client management (replaces old Recent Activity)
                await loadClientManagement(clientsSnapshot);
                
                // Revenue Stats - show empty state
                document.getElementById('revenueStats').innerHTML = `
                    <div style="text-align: center; padding: 2em; color: var(--font-secondary);">
                        <p style="font-size: 1.1em; margin-bottom: 0.5em;">‚ú® Your revenue journey starts here</p>
                        <p style="color: var(--font-muted); font-size: 0.95em;">When clients subscribe through your gift codes or connect with you, your earnings will appear here.</p>
                    </div>
                `;
                
                // Gift codes list is loaded separately by loadGiftCodesList()
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        async function loadClientManagement(clientsSnapshot) {
            const container = document.getElementById('clientManagement');
            
            try {
                if (!clientsSnapshot || clientsSnapshot.empty) {
                    container.innerHTML = `
                        <div class="no-clients-message">
                            <p style="font-size: 1.1em; margin-bottom: 0.5em;">üë• No clients connected yet</p>
                            <p style="font-size: 0.95em;">When users connect with you, they'll appear here. Share your gift codes to grow your practice!</p>
                        </div>
                    `;
                    return;
                }
                
                // Build client data with pending entries count
                const clientsData = [];
                
                for (const clientDoc of clientsSnapshot.docs) {
                    const clientData = clientDoc.data();
                    const clientId = clientDoc.id;
                    
                    // Get entries shared with this coach (ONLY shared entries - privacy first)
                    const sharedEntriesQuery = query(
                        collection(db, 'journalEntries'),
                        where('userId', '==', clientId),
                        where('coachId', '==', currentUser.uid),
                        orderBy('createdAt', 'desc'),
                        limit(5)
                    );
                    
                    let sharedEntries = [];
                    let needsReplyCount = 0;
                    
                    try {
                        const entriesSnapshot = await getDocs(sharedEntriesQuery);
                        sharedEntries = entriesSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        // Count entries that need reply (shared but no coachReply)
                        needsReplyCount = sharedEntries.filter(e => !e.coachReply || e.coachReply.trim() === '').length;
                    } catch (queryError) {
                        console.warn('Could not load shared entries for client:', clientId, queryError);
                    }
                    
                    // Get coach notes for this client
                    let coachNotes = '';
                    try {
                        const notesDoc = await getDoc(doc(db, 'coachNotes', `${currentUser.uid}_${clientId}`));
                        if (notesDoc.exists()) {
                            coachNotes = notesDoc.data().notes || '';
                        }
                    } catch (notesError) {
                        console.warn('Could not load coach notes:', notesError);
                    }
                    
                    clientsData.push({
                        id: clientId,
                        name: clientData.signupUsername || clientData.displayName || 'Unknown',
                        email: clientData.email || '',
                        connectedAt: clientData.connectedPractitioner?.connectedAt,
                        sharedEntries,
                        needsReplyCount,
                        coachNotes
                    });
                }
                
                // Sort by needs reply (most urgent first)
                clientsData.sort((a, b) => b.needsReplyCount - a.needsReplyCount);
                
                // Build HTML
                let html = '';
                
                for (const client of clientsData) {
                    const statusBadge = client.needsReplyCount > 0 
                        ? `<span class="client-summary-badge badge-danger">üîî ${client.needsReplyCount}</span>`
                        : `<span class="client-summary-badge badge-success">‚úì</span>`;
                    
                    html += `
                        <div class="client-card" data-client-id="${client.id}">
                            <div class="client-card-header" onclick="toggleClientCard('${client.id}')">
                                <div class="client-header-left">
                                    <h3>üë§ ${escapeHtml(client.name)}</h3>
                                    ${statusBadge}
                                </div>
                                <span class="expand-icon">‚ñº</span>
                            </div>
                            <div class="client-card-body">
                                <div class="client-header">
                                    <div class="client-info">
                                        <span class="client-email">${escapeHtml(client.email)}</span>
                                    </div>
                                    <div class="client-stats">
                                        ${client.sharedEntries.length} shared entries
                                    </div>
                                </div>
                                
                                ${client.needsReplyCount > 0 ? `
                                    <div class="needs-reply-badge">üîî ${client.needsReplyCount} Needs Reply</div>
                                    <div class="pending-entries">
                                        ${client.sharedEntries
                                            .filter(e => !e.coachReply || e.coachReply.trim() === '')
                                            .slice(0, 3)
                                            .map(entry => {
                                                const preview = (entry.content || entry.text || 'Voice entry').substring(0, 50);
                                                const entryDate = entry.createdAt?.toDate ? entry.createdAt.toDate().toLocaleDateString() : 'Unknown date';
                                                return `
                                                    <div class="pending-entry">
                                                        <span class="pending-entry-text">${escapeHtml(preview)}${preview.length >= 50 ? '...' : ''}</span>
                                                        <span class="pending-entry-date">${entryDate}</span>
                                                        <button class="reply-btn" onclick="event.stopPropagation(); window.open('/coach?entryId=${entry.id}', '_blank')">Reply</button>
                                                    </div>
                                                `;
                                            }).join('')}
                                    </div>
                                ` : `
                                    <p style="color: var(--success-green); font-size: 0.9em;">‚úÖ All caught up!</p>
                                `}
                                
                                <div class="coach-notes">
                                    <label>üìù Private Notes (only you can see)</label>
                                    <textarea 
                                        id="notes-${client.id}" 
                                        placeholder="Add notes about this client..."
                                        oninput="markNotesUnsaved('${client.id}')"
                                        onclick="event.stopPropagation()"
                                    >${escapeHtml(client.coachNotes)}</textarea>
                                    <button class="save-notes-btn" id="save-notes-btn-${client.id}" onclick="event.stopPropagation(); saveCoachNotes('${client.id}')">Save Notes</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html || '<div class="no-clients-message"><p>No clients found.</p></div>';
                
            } catch (error) {
                console.error('Error loading client management:', error);
                container.innerHTML = '<p style="color: var(--font-muted);">Unable to load client data. Please refresh the page.</p>';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        window.toggleClientCard = (clientId) => {
            const card = document.querySelector(`.client-card[data-client-id="${clientId}"]`);
            if (card) {
                card.classList.toggle('expanded');
            }
        };
        
        function markNotesUnsaved(clientId) {
            const btn = document.getElementById(`save-notes-btn-${clientId}`);
            if (btn) {
                btn.textContent = 'Save Notes *';
                btn.style.background = 'var(--warning-yellow)';
                btn.style.color = '#333';
            }
        }
        
        window.saveCoachNotes = async (clientId) => {
            const textarea = document.getElementById(`notes-${clientId}`);
            const btn = document.getElementById(`save-notes-btn-${clientId}`);
            const notes = textarea?.value || '';
            
            try {
                btn.textContent = 'Saving...';
                btn.disabled = true;
                
                await setDoc(doc(db, 'coachNotes', `${currentUser.uid}_${clientId}`), {
                    coachId: currentUser.uid,
                    clientId: clientId,
                    notes: notes,
                    updatedAt: new Date()
                });
                
                btn.textContent = 'Saved ‚úì';
                btn.style.background = 'var(--success-green)';
                btn.style.color = 'white';
                
                setTimeout(() => {
                    btn.textContent = 'Save Notes';
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error saving notes:', error);
                btn.textContent = 'Error - Retry';
                btn.style.background = 'var(--danger-red)';
                btn.disabled = false;
            }
        };
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function loadProfileData() {
            try {
                document.getElementById('profileName').value = practitionerData.displayName || '';
                document.getElementById('profileEmail').value = practitionerData.email || '';
                document.getElementById('profileCredentials').value = practitionerData.credentials || '';
                document.getElementById('profileLocation').value = practitionerData.practiceLocation || '';
                document.getElementById('profileBio').value = practitionerData.bio || '';
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        async function loadTaxInfo() {
            try {
                const taxDoc = await getDoc(doc(db, 'practitionerTaxInfo', currentUser.uid));
                if (taxDoc.exists()) {
                    const data = taxDoc.data();
                    document.getElementById('taxLegalName').value = data.legalName || '';
                    document.getElementById('taxBusinessName').value = data.businessName || '';
                    document.getElementById('taxClassification').value = data.taxClassification || '';
                    // Don't display SSN for security
                    document.getElementById('taxAddress').value = data.address || '';
                    document.getElementById('taxCity').value = data.city || '';
                    document.getElementById('taxState').value = data.state || '';
                    document.getElementById('taxZip').value = data.zip || '';
                }
            } catch (error) {
                console.error('Error loading tax info:', error);
                // Silently fail - tax info might not exist yet
            }
        }

        function loadSettings() {
            try {
                document.getElementById('freeAgentOptIn').checked = practitionerData.freeAgentOptIn || false;
                
                if (practitionerData.freeAgentOptIn) {
                    document.getElementById('freeAgentProfile').style.display = 'block';
                    document.getElementById('practiceSpecialties').value = practitionerData.specialties || '';
                    document.getElementById('practiceBio').value = practitionerData.bio || '';
                    document.getElementById('acceptingClients').value = practitionerData.acceptingClients || 'yes';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Tab switching
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        };

        // Profile functions
        window.saveProfile = async function() {
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    displayName: document.getElementById('profileName').value,
                    credentials: document.getElementById('profileCredentials').value,
                    practiceLocation: document.getElementById('profileLocation').value,
                    bio: document.getElementById('profileBio').value,
                    updatedAt: serverTimestamp()
                });
                
                document.getElementById('profileStatus').innerHTML = '<div class="alert alert-success">‚úÖ Profile updated successfully!</div>';
                setTimeout(() => document.getElementById('profileStatus').innerHTML = '', 3000);
            } catch (error) {
                document.getElementById('profileStatus').innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        };

        window.changePassword = async function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                document.getElementById('passwordStatus').innerHTML = '<div class="alert alert-error">‚ùå Passwords do not match</div>';
                return;
            }

            if (newPassword.length < 6) {
                document.getElementById('passwordStatus').innerHTML = '<div class="alert alert-error">‚ùå Password must be at least 6 characters</div>';
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                await updatePassword(currentUser, newPassword);
                
                document.getElementById('passwordStatus').innerHTML = '<div class="alert alert-success">‚úÖ Password updated successfully!</div>';
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                setTimeout(() => document.getElementById('passwordStatus').innerHTML = '', 3000);
            } catch (error) {
                document.getElementById('passwordStatus').innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        };

        window.requestAccountDeletion = async function() {
            if (!confirm('Are you sure you want to delete your account? This cannot be undone and all your data will be removed after 30 days.')) {
                return;
            }

            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    deletionRequested: true,
                    deletionScheduledFor: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                    deletionRequestedAt: serverTimestamp()
                });

                document.getElementById('deleteStatus').innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Account deletion scheduled for 30 days from now. Log in again to cancel.</div>';
            } catch (error) {
                document.getElementById('deleteStatus').innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        };

        // Tax info function
        window.saveTaxInfo = async function() {
            if (!document.getElementById('taxCertify').checked) {
                document.getElementById('taxInfoStatus').innerHTML = '<div class="alert alert-error">‚ùå Please certify the information is correct</div>';
                return;
            }

            try {
                await setDoc(doc(db, 'practitionerTaxInfo', currentUser.uid), {
                    practitionerId: currentUser.uid,
                    legalName: document.getElementById('taxLegalName').value,
                    businessName: document.getElementById('taxBusinessName').value,
                    taxClassification: document.getElementById('taxClassification').value,
                    ssnEin: document.getElementById('taxSSN').value, // Will be encrypted server-side
                    address: document.getElementById('taxAddress').value,
                    city: document.getElementById('taxCity').value,
                    state: document.getElementById('taxState').value,
                    zip: document.getElementById('taxZip').value,
                    certifiedAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                document.getElementById('taxInfoStatus').innerHTML = '<div class="alert alert-success">‚úÖ Tax information saved securely!</div>';
                setTimeout(() => document.getElementById('taxInfoStatus').innerHTML = '', 3000);
            } catch (error) {
                document.getElementById('taxInfoStatus').innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        };

        // Settings function
        window.saveSettings = async function() {
            const freeAgentOptIn = document.getElementById('freeAgentOptIn').checked;

            const updates = {
                freeAgentOptIn: freeAgentOptIn,
                updatedAt: serverTimestamp()
            };

            if (freeAgentOptIn) {
                updates.specialties = document.getElementById('practiceSpecialties').value;
                updates.bio = document.getElementById('practiceBio').value;
                updates.acceptingClients = document.getElementById('acceptingClients').value;
            }

            try {
                await updateDoc(doc(db, 'users', currentUser.uid), updates);
                document.getElementById('settingsStatus').innerHTML = '<div class="alert alert-success">‚úÖ Settings saved successfully!</div>';
                setTimeout(() => document.getElementById('settingsStatus').innerHTML = '', 3000);
            } catch (error) {
                document.getElementById('settingsStatus').innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
            }
        };

        // Gift code functions - Real Implementation
        window.generateGiftCode = async function() {
            const btn = event.target;
            const statusDiv = document.getElementById('giftStatus');
            const resultDiv = document.getElementById('giftCodeResult');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Generating...';
                statusDiv.innerHTML = '';
                
                const discountSelect = document.getElementById('giftDiscount');
                const recipientEmail = document.getElementById('giftRecipientEmail').value.trim();
                
                // Convert 50/100 to 0.5/1.0
                const discountPercent = parseInt(discountSelect.value) / 100;
                
                const createGiftMembership = httpsCallable(functions, 'createGiftMembership');
                const result = await createGiftMembership({
                    discountPercent: discountPercent,
                    maxUses: 1,
                    recipientEmail: recipientEmail || null
                });
                
                const data = result.data;
                
                // Show result
                resultDiv.style.display = 'block';
                document.getElementById('giftCodeDisplay').textContent = data.giftCode;
                document.getElementById('giftLinkDisplay').value = `https://inkwelljournal.io/redeem?code=${data.giftCode}`;
                
                statusDiv.innerHTML = `
                    <div class="alert alert-success" style="margin-top: 1em;">
                        ‚úÖ Gift code created! Valid for 3 months from redemption.
                        ${recipientEmail ? `<br>üìß Email will be sent to ${recipientEmail}` : ''}
                    </div>
                `;
                
                // Refresh gift codes list
                loadGiftCodesList();
                
            } catch (error) {
                console.error('Error generating gift code:', error);
                statusDiv.innerHTML = `<div class="alert alert-error">‚ùå Error: ${error.message}</div>`;
                resultDiv.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üéÅ Generate Gift Code';
            }
        };
        
        // Load list of issued gift codes
        async function loadGiftCodesList() {
            const listDiv = document.getElementById('giftCodesList');
            
            try {
                const giftCodesQuery = query(
                    collection(db, 'giftMemberships'),
                    where('createdBy', '==', currentUser.uid),
                    orderBy('createdAt', 'desc'),
                    limit(20)
                );
                
                const snapshot = await getDocs(giftCodesQuery);
                
                // Update the gift codes count on dashboard
                document.getElementById('stat-gifts').textContent = snapshot.size.toString();
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `
                        <div style="text-align: center; padding: 2em; color: var(--font-secondary);">
                            <p style="font-size: 1.1em; margin-bottom: 0.5em;">üéÅ No gift codes issued yet</p>
                            <p style="color: var(--font-muted); font-size: 0.95em;">Generate your first gift code above to share with clients and grow your practice.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 1em;">';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const createdAt = data.createdAt?.toDate();
                    const expiresAt = data.expiresAt?.toDate();
                    const isExpired = expiresAt && expiresAt < new Date();
                    const isRedeemed = data.redeemedBy && data.redeemedBy.length > 0;
                    
                    let statusBadge = '';
                    if (isRedeemed) {
                        statusBadge = '<span style="background: var(--success-green); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">Redeemed</span>';
                    } else if (isExpired) {
                        statusBadge = '<span style="background: var(--danger-red); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">Expired</span>';
                    } else {
                        statusBadge = '<span style="background: var(--brand-primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">Active</span>';
                    }
                    
                    html += `
                        <div style="background: var(--bg-muted); padding: 1em; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5em;">
                            <div>
                                <strong style="font-family: monospace; font-size: 1.1em; color: var(--brand-primary);">${data.code}</strong>
                                <br><span style="font-size: 0.85em; color: var(--font-secondary);">${Math.round(data.discountPercent * 100)}% off ‚Ä¢ Created ${createdAt ? createdAt.toLocaleDateString() : 'Unknown'}</span>
                                ${data.recipientEmail ? `<br><span style="font-size: 0.85em; color: var(--font-muted);">For: ${data.recipientEmail}</span>` : ''}
                            </div>
                            <div>${statusBadge}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                listDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading gift codes:', error);
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 2em; color: var(--font-secondary);">
                        <p style="font-size: 1.1em; margin-bottom: 0.5em;">üéÅ No gift codes issued yet</p>
                        <p style="color: var(--font-muted); font-size: 0.95em;">Generate your first gift code above to share with clients and grow your practice.</p>
                    </div>
                `;
            }
        }

        window.copyGiftCode = function() {
            navigator.clipboard.writeText(document.getElementById('giftCodeDisplay').textContent);
            showToast('Code copied to clipboard!');
        };

        window.copyGiftLink = function() {
            navigator.clipboard.writeText(document.getElementById('giftLinkDisplay').value);
            showToast('Link copied to clipboard!');
        };

        window.sendGiftEmail = async function() {
            const email = document.getElementById('giftSendEmail').value.trim();
            const code = document.getElementById('giftCodeDisplay').textContent;
            
            if (!email) {
                showToast('Please enter an email address', 'error');
                return;
            }
            
            try {
                // TODO: Implement email sending via Cloud Function
                showToast('üìß Email feature coming soon! For now, copy the code and send it manually.', 'info');
            } catch (error) {
                showToast('Error sending email: ' + error.message, 'error');
            }
        };
        
        // Simple toast function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? 'var(--danger-red)' : type === 'info' ? 'var(--brand-primary)' : 'var(--success-green)'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 10000;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Stripe Connect - Real Implementation
        window.setupStripeConnect = async function() {
            const button = event.target;
            const statusDiv = document.getElementById('stripeConnectStatus');
            
            try {
                button.disabled = true;
                button.textContent = '‚è≥ Setting up...';
                
                // First check if account already exists and is complete
                const checkStatus = httpsCallable(functions, 'checkStripeConnectStatus');
                const statusResult = await checkStatus();
                
                if (statusResult.data.isComplete) {
                    statusDiv.innerHTML = `
                        <div style="padding: 12px; background: #d4edda; color: #155724; border-radius: 8px; margin: 10px 0;">
                            ‚úÖ Bank account connected! You're all set to receive payments.
                        </div>
                    `;
                    button.textContent = '‚úÖ Connected';
                    return;
                }
                
                // Create Connect account if it doesn't exist
                const createAccount = httpsCallable(functions, 'createStripeConnectAccount');
                const accountResult = await createAccount();
                
                if (!accountResult.data.success) {
                    throw new Error('Failed to create Connect account');
                }
                
                // Generate onboarding link
                const createLink = httpsCallable(functions, 'createStripeConnectOnboardingLink');
                const linkResult = await createLink();
                
                if (!linkResult.data.success || !linkResult.data.url) {
                    throw new Error('Failed to create onboarding link');
                }
                
                // Open Stripe onboarding in new window
                statusDiv.innerHTML = `
                    <div style="padding: 12px; background: #fff3cd; color: #856404; border-radius: 8px; margin: 10px 0;">
                        ‚è≥ Complete setup in the Stripe window that just opened. Return here when done.
                    </div>
                `;
                
                window.open(linkResult.data.url, '_blank');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = 'üîÑ Refresh Status';
                }, 3000);
                
            } catch (error) {
                console.error('Error setting up Stripe Connect:', error);
                statusDiv.innerHTML = `
                    <div style="padding: 12px; background: #f8d7da; color: #721c24; border-radius: 8px; margin: 10px 0;">
                        ‚ùå Error: ${error.message}. Please try again.
                    </div>
                `;
                button.disabled = false;
                button.textContent = 'üîó Connect Bank Account';
            }
        };
        
        // Check Stripe Connect status on page load
        async function checkConnectStatusOnLoad() {
            try {
                const checkStatus = httpsCallable(functions, 'checkStripeConnectStatus');
                const result = await checkStatus();
                
                const statusDiv = document.getElementById('stripeConnectStatus');
                const button = statusDiv.querySelector('button');
                
                if (result.data.isComplete) {
                    statusDiv.innerHTML = `
                        <div style="padding: 12px; background: #d4edda; color: #155724; border-radius: 8px; margin: 10px 0;">
                            ‚úÖ Bank account connected and verified! You can receive payments.
                        </div>
                    `;
                    if (button) button.remove();
                } else if (result.data.hasAccount) {
                    statusDiv.innerHTML = `
                        <div style="padding: 12px; background: #fff3cd; color: #856404; border-radius: 8px; margin: 10px 0;">
                            ‚è≥ Setup in progress. Click below to continue where you left off.
                        </div>
                        <button class="btn" onclick="setupStripeConnect()">üîó Continue Setup</button>
                    `;
                }
            } catch (error) {
                console.error('Error checking Connect status:', error);
            }
        }

        // Logout
        window.handleLogout = async function() {
            if (confirm('Are you sure you want to log out?')) {
                await signOut(auth);
                window.location.href = 'index.html';
            }
        };

        // Free agent toggle
        document.getElementById('freeAgentOptIn').addEventListener('change', function() {
            document.getElementById('freeAgentProfile').style.display = this.checked ? 'block' : 'none';
        });
    </script>
    </div> <!-- End portalContent -->
</body>
</html>
