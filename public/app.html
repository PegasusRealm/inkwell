<!DOCTYPE html>
<html lang="en">
  <head>
    
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InkWell - Your Digital Sanctuary for Reflection</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet" />
  
  <style>
    :root {
      /* Modern Brand Colors - Calming Teal Palette */
      --brand-primary: #2A6972;
      --brand-secondary: #388b97;
      --brand-alt: #4A9BA8;
      --brand-light: #7BB8C4;
      --brand-outline: #4f4f4f;
      --brand-primary-rgba: rgba(42, 105, 114, 0.3);
      
      /* Typography Colors */
      --font-main: #2D3748;
      --font-secondary: #4A5568;
      --font-muted: #718096;
      --font-accent: #2A6972;
      --font-white: #ffffff;
      
      /* Modern Font Stack */
      --title-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --body-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --serif-font: 'Crimson Text', Georgia, serif;

      /* Calm-inspired Backgrounds */
      --bg-primary: linear-gradient(135deg, #E6FFFA 0%, #F0FDF4 100%);
      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-card-hover: rgba(255, 255, 255, 0.95);
      --bg-muted: #F7FAFC;
      --bg-overlay: rgba(255, 255, 255, 0.8);

      /* Gentle Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.03), 0 2px 4px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.04), 0 4px 6px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.06), 0 10px 10px rgba(0, 0, 0, 0.04);

      /* Mindful Accent Colors */
      --accent-wisdom: #D69E2E;
      --accent-growth: #38A169;
      --accent-reflection: #805AD5;
      --accent-warm: #E53E3E;

      /* Interactive States */
      --btn-primary: #2A6972;
      --btn-primary-hover: #1A4B52;
      --btn-secondary: #E2E8F0;
      --btn-secondary-hover: #CBD5E0;
      
      /* Borders */
      --border-light: #E2E8F0;
      --border-medium: #CBD5E0;
      --border-accent: #4A9BA8;
    }

    html[data-theme='dark'] {
      --bg-primary: linear-gradient(135deg, #0D1B2A 0%, #1B263B 100%);
      --bg-card: rgba(26, 32, 44, 0.9);
      --bg-card-hover: rgba(26, 32, 44, 0.95);
      --bg-muted: #1A202C;
      --bg-overlay: rgba(26, 32, 44, 0.8);
      
      --font-main: #F7FAFC;
      --font-secondary: #E2E8F0;
      --font-muted: #A0AEC0;
      --font-accent: #4A9BA8;
      
      --brand-primary: #4A9BA8;
      --brand-secondary: #7BB8C4;
      --brand-light: #9FD3E0;
      
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.3), 0 4px 6px rgba(0, 0, 0, 0.2);
      
      --border-light: #2D3748;
      --border-medium: #4A5568;
      --border-accent: #4A9BA8;
      
      --btn-primary: #4A9BA8;
      --btn-primary-hover: #7BB8C4;
      --btn-secondary: #2D3748;
      --btn-secondary-hover: #4A5568;
    }

    html[data-theme='light'] {
      --bg-primary: url('watercolor-teal-bg.png'), linear-gradient(135deg, #89C9D4 0%, #7BB8C4 100%);
      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-muted: #F7FAFC;
      --font-main: #2D3748;
      --font-secondary: #4A5568;
      --brand-primary: #2A6972;
      --brand-secondary: #388b97;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-primary: linear-gradient(135deg, #0D1B2A 0%, #1B263B 100%);
        --bg-card: rgba(26, 32, 44, 0.9);
        --bg-muted: #1A202C;
        --font-main: #F7FAFC;
        --font-secondary: #E2E8F0;
        --font-accent: #4A9BA8;
        --brand-primary: #4A9BA8;
        --border-light: #2D3748;
      }
    }

    /* Global Reset & Base Styling */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg-primary);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: var(--font-main);
      font-family: var(--body-font);
      font-size: 16px;
      line-height: 1.6;
      font-weight: 400;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      min-height: 100vh;
    }

    main {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-light);
      color: var(--font-main);
      border-radius: 24px;
      box-shadow: var(--shadow-xl);
      padding: 3rem;
      max-width: 800px;
      width: 75%;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      margin: 0 auto;
    }

    main::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--brand-light), transparent);
      opacity: 0.6;
    }

    header {
      text-align: center;
      margin-bottom: 3rem;
      color: var(--font-main);
    }

    /* Modern Typography */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--title-font);
      color: var(--brand-primary);
      font-weight: 600;
      line-height: 1.2;
      margin-top: 0;
      letter-spacing: -0.01em;
    }

    h1 {
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
    }

    h2 {
      font-size: clamp(1.5rem, 3vw, 2rem);
      margin-bottom: 1rem;
    }

    h3 {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }

    p, label, input, textarea, button {
      font-family: var(--body-font);
      color: var(--font-main);
    }

    p {
      margin-bottom: 1rem;
      color: var(--font-secondary);
    }

    .section-header {
      font-size: 1.2em;
      color: var(--brand-primary);
      margin-top: 0;
      margin-bottom: 0.5em;
    }

    /* Override section-header color in dark mode for readability */
    @media (prefers-color-scheme: dark) {
      .section-header {
        color: #FDF7F1; /* soft off-white for readability */
      }
    }
    html[data-theme='dark'] .section-header {
      color: #FDF7F1 !important;
    }

    .subtext-muted {
      font-size: 0.85em;
      color: var(--info-muted);
      font-style: italic;
      margin-top: 0.25em;
    }

 .sophy-info {
  background-color: var(--accent);
  color: var(--btn-font); /* light text on pink */
  font-style: italic;
  font-size: 0.95em;
  padding: 0.75em 1em;
  border-radius: 5px;
  box-shadow: inset 0 0 0 4px var(--accent-dark);
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  white-space: pre-wrap;
}

    .card-block {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .card-block:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--border-medium);
    }

    .card-block p {
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: 1rem;
    }

    /* Content card for better semantic structure */
    .content-card {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 1em;
      margin-bottom: 2em;
    }

    /* WISH Section Cards */
    .wish-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5em;
      margin: 1.5em 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: box-shadow 0.2s ease;
    }
    .wish-section:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    .wish-section h2 {
      margin-top: 0;
      margin-bottom: 1.2em;
      padding-bottom: 0.5em;
      border-bottom: 2px solid var(--brand-primary);
      color: var(--brand-primary);
      font-size: 1.4em;
    }

    footer, footer p, footer a {
      color: var(--font-secondary) !important;
    }

    /* Social media icons styling */
    footer svg {
      color: var(--brand-primary);
      transition: color 0.3s ease;
    }

    footer a:hover svg {
      color: var(--brand-secondary);
    }

    /* Adaptive logo styling - creates beautiful theme-aware visibility */
    footer img[src*="WHITE.svg"], 
    footer img[src*="Silhouette.svg"] {
      filter: brightness(0) saturate(100%) invert(27%) sepia(18%) saturate(1351%) hue-rotate(154deg) brightness(94%) contrast(87%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    footer img[src*="WHITE.svg"]:hover, 
    footer img[src*="Silhouette.svg"]:hover {
      filter: brightness(0) saturate(100%) invert(70%) sepia(31%) saturate(446%) hue-rotate(154deg) brightness(96%) contrast(87%);
      transform: scale(1.05);
    }

    /* Dark theme - keep logos white with subtle glow */
    html[data-theme='dark'] footer img[src*="WHITE.svg"], 
    html[data-theme='dark'] footer img[src*="Silhouette.svg"] {
      filter: brightness(0) saturate(100%) invert(100%);
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
    }

    html[data-theme='dark'] footer img[src*="WHITE.svg"]:hover, 
    html[data-theme='dark'] footer img[src*="Silhouette.svg"]:hover {
      filter: brightness(0) saturate(100%) invert(70%) sepia(31%) saturate(446%) hue-rotate(154deg) brightness(96%) contrast(87%);
      box-shadow: 0 0 12px rgba(137, 201, 212, 0.4);
      transform: scale(1.05);
    }

    /* Modern Button Styling */
    .btn {
      background: var(--brand-primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.875rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      font-family: var(--body-font);
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: var(--shadow-sm);
      text-decoration: none;
      letter-spacing: 0.01em;
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      background: var(--brand-secondary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .btn:disabled {
      background: var(--font-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Secondary button style for less important actions */
    .btn-gray, .btn-secondary {
      background: var(--btn-secondary);
      color: var(--font-main);
      border: 2px solid var(--border-light);
    }

    .btn-gray:hover, .btn-secondary:hover {
      background: var(--btn-secondary-hover);
      border-color: var(--border-medium);
    }

    .btn-gray:active, .btn-gray:focus, .btn-secondary:active, .btn-secondary:focus {
      outline: 2px solid var(--brand-primary);
    }

    /* Tab active and inactive styles: shades of primary brand color */
    .tab-btn {
      background-color: var(--brand-primary);
      color: var(--font-white);
      border: none;
      border-radius: 5px 5px 0 0;
      padding: 0.5em 1em;
      font-size: 1em;
      margin-bottom: -1px;
      transition: background 0.2s;
      position: relative;
      z-index: 1;
      font-weight: 500;
      flex: 1;
      min-width: 0;
      text-align: center;
    }
    .tab-btn.active {
      background-color: var(--brand-secondary);
      color: var(--font-white);
      font-weight: bold;
      z-index: 2;
    }

    /* Sophy-themed button: accent color with modern styling */
    .btn-sophy {
      background: linear-gradient(135deg, #D49489 0%, #E6A497 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.875rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .btn-sophy:hover,
    .btn-sophy:focus {
      background: linear-gradient(135deg, #C2867D 0%, #D49489 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-sophy:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    /* Theme-specific Sophy button styling */
    html[data-theme='light'] .btn-sophy {
      color: white;
    }

    html[data-theme='dark'] .btn-sophy {
      color: white;
    }

    /* Sign In/Sign Up button styles for login modal */
    .login-btn-signin {
      background-color: var(--brand-secondary) !important;
      color: var(--btn-font) !important;
    }
    .login-btn-signin:hover,
    .login-btn-signin:focus {
      background-color: #5bb7c8 !important;
      color: var(--btn-font) !important;
      filter: brightness(1.09);
    }
    .login-btn-signup {
      background-color: var(--btn-bg) !important;
      color: var(--btn-font) !important;
    }
    .login-btn-signup:hover,
    .login-btn-signup:focus {
      background-color: var(--brand-secondary) !important;
      color: var(--btn-font) !important;
      filter: brightness(1.07);
    }

    /* Modern Form Elements */
    input, textarea, select {
      background: var(--bg-muted);
      border: 2px solid var(--border-light);
      border-radius: 12px;
      padding: 0.875rem 1rem;
      font-size: 0.875rem;
      font-family: var(--body-font);
      color: var(--font-main);
      transition: all 0.2s ease;
      width: 100%;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(74, 155, 168, 0.1);
      background: var(--bg-card);
    }

    input::placeholder, textarea::placeholder {
      color: var(--font-muted);
    }

    /* Login modal specific placeholder styling for better visibility */
    #loginEmail::placeholder, #loginPassword::placeholder,
    #signupEmail::placeholder, #signupPassword::placeholder {
      color: #2A6972 !important;
      opacity: 0.8;
    }

    textarea {
      height: 200px;
      resize: vertical;
      line-height: 1.6;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--font-secondary);
      font-size: 0.875rem;
    }

    /* WISH Timeline Components - Theme Compatible */
    .wish-timeline-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1rem 0;
      box-shadow: 0 4px 12px rgba(42, 105, 114, 0.1);
      border-left: 4px solid var(--brand-primary);
    }

    .wish-timeline-title {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--brand-primary);
      font-size: 1rem;
      font-weight: 600;
    }

    .wish-timeline-input-group {
      margin-bottom: 1.5rem;
    }

    .wish-timeline-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--font-main);
      font-weight: 500;
      font-size: 0.95rem;
    }

    .wish-timeline-select {
      width: 200px;
      padding: 0.5rem;
      border-radius: 8px;
      border: 2px solid var(--border-light);
      background: var(--bg-muted);
      color: var(--font-main);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .wish-timeline-select:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 3px rgba(42, 105, 114, 0.1);
    }

    /* Enhanced Dark theme for WISH Timeline - Match Calendar Theme */
    html[data-theme='dark'] .wish-timeline-container {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%) !important;
      border: 1px solid rgba(137, 201, 212, 0.25) !important;
      color: #89C9D4 !important;
      box-shadow: 0 0 20px rgba(137, 201, 212, 0.15), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
      backdrop-filter: blur(5px) !important;
    }

    html[data-theme='dark'] .wish-timeline-title {
      color: #89C9D4 !important;
      text-shadow: 0 0 10px rgba(137, 201, 212, 0.3) !important;
    }

    html[data-theme='dark'] .wish-timeline-label {
      color: rgba(137, 201, 212, 0.9) !important;
    }

    html[data-theme='dark'] .wish-timeline-select {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.08) 0%, rgba(30, 80, 85, 0.12) 100%) !important;
      border: 2px solid rgba(137, 201, 212, 0.3) !important;
      color: #89C9D4 !important;
      box-shadow: 0 0 10px rgba(137, 201, 212, 0.1) !important;
      backdrop-filter: blur(3px) !important;
    }

    html[data-theme='dark'] .wish-timeline-select:focus {
      border-color: rgba(137, 201, 212, 0.6) !important;
      box-shadow: 0 0 15px rgba(137, 201, 212, 0.25) !important;
    }

    /* Enhanced Timeline Progress Bar for Dark Mode */
    html[data-theme='dark'] #wishProgressBar {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.12) 0%, rgba(30, 80, 85, 0.18) 100%) !important;
      border: 1px solid rgba(137, 201, 212, 0.2) !important;
      border-radius: 12px !important;
      backdrop-filter: blur(3px) !important;
    }

    html[data-theme='dark'] #wishProgressFill {
      background: linear-gradient(90deg, rgba(137, 201, 212, 0.8) 0%, rgba(42, 105, 114, 0.9) 100%) !important;
      box-shadow: 0 0 10px rgba(137, 201, 212, 0.3) !important;
    }

    html[data-theme='dark'] #wishProgressMessage {
      color: rgba(137, 201, 212, 0.9) !important;
    }

    /* Enhanced Growth Stages for Dark Mode */
    html[data-theme='dark'] #growthStages,
    html[data-theme='dark'] #timelineLabels {
      color: #89C9D4 !important;
    }

    html[data-theme='dark'] #growthStages .growth-stage,
    html[data-theme='dark'] #timelineLabels .timeline-label {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.1) 0%, rgba(30, 80, 85, 0.15) 100%) !important;
      border: 1px solid rgba(137, 201, 212, 0.2) !important;
      color: #89C9D4 !important;
      border-radius: 8px !important;
      padding: 0.5em !important;
      margin: 0.25em !important;
      backdrop-filter: blur(2px) !important;
    }

    /* Settings Labels - Theme Compatible */
    .settings-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--font-main);
      font-size: 0.9rem;
    }

    html[data-theme='dark'] .settings-label {
      color: var(--font-secondary);
    }

    /* Accent and AI highlight (Sophy, coach) */
    #generatedPrompt,
    #sophyInsight,
    .coach-reply,
    .ai-highlight,
    .sophy-accent {
      color: var(--accent-dark);
      background: var(--accent);
      border-left: 4px solid var(--accent-dark);
      padding: 0.75em 1em;
      border-radius: 5px;
      font-style: italic;
    }

    /* Modals and overlays */
    #embeddedAgreementNotice,
    #loginModal,
    #signupModal,
    #goodbyeModal,
    #manifestDataModal,
    #reflectionDataModal {
      background-color: var(--bg-light-alt);
      color: var(--font-main);
    }
    
    /* Fix signup modal for light theme */
    #signupModal .card-block {
      background: white !important;
      color: #2D3748 !important;
    }
    
    /* Fix login modal for light theme */
    #loginModal .card-block {
      background: white !important;
      color: #2D3748 !important;
    }
    #loginModal::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  backdrop-filter: blur(4px);
  background: rgba(0, 0, 0, 0.4);
  z-index: -1;
}
    html[data-theme='dark'] #embeddedAgreementNotice,
    html[data-theme='dark'] #loginModal,
    html[data-theme='dark'] #signupModal,
    html[data-theme='dark'] #goodbyeModal,
    html[data-theme='dark'] #userSettingsModal,
    html[data-theme='dark'] #manifestDataModal,
    html[data-theme='dark'] #reflectionDataModal,
    html[data-theme='dark'] #aboutInkwellModal {
      background-color: rgba(21, 54, 58, 0.85);
      color: var(--font-white);
    }

    /* Enhanced Dark Theme for Signup Modal */
    html[data-theme='dark'] #signupModal .card-block {
      background: rgba(21, 54, 58, 0.95) !important;
      color: #ffffff !important;
      border: 1px solid rgba(42,105,114,0.3) !important;
      backdrop-filter: blur(10px) !important;
    }

    /* Enhanced Dark Theme for Goodbye Modal */
    html[data-theme='dark'] #goodbyeModal .card-block {
      background: rgba(21, 54, 58, 0.95) !important;
      color: #ffffff !important;
      border: 1px solid rgba(42,105,114,0.3) !important;
      backdrop-filter: blur(10px) !important;
    }

    html[data-theme='dark'] #goodbyeModal h2 {
      color: #7BB8C4 !important;
    }

    html[data-theme='dark'] #goodbyeModal p {
      color: rgba(137, 201, 212, 0.9) !important;
    }

    html[data-theme='dark'] #goodbyeModal .btn {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.8) 0%, rgba(30, 80, 85, 0.9) 100%) !important;
      color: #ffffff !important;
      border: 1px solid rgba(137, 201, 212, 0.4) !important;
      box-shadow: 0 2px 8px rgba(137, 201, 212, 0.2) !important;
    }

    html[data-theme='dark'] #goodbyeModal .btn:hover {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 1) 100%) !important;
      box-shadow: 0 0 12px rgba(137, 201, 212, 0.4) !important;
      transform: translateY(-1px) !important;
    }

    html[data-theme='dark'] #signupModal h2 {
      color: #7BB8C4 !important;
    }

    html[data-theme='dark'] #signupModal p {
      color: rgba(137, 201, 212, 0.9) !important;
    }

    html[data-theme='dark'] #signupModal input {
      background: linear-gradient(135deg, rgba(42, 54, 58, 0.9) 0%, rgba(30, 42, 48, 0.95) 100%) !important;
      color: #89C9D4 !important;
      border: 2px solid rgba(137, 201, 212, 0.3) !important;
      box-shadow: 0 0 15px rgba(137, 201, 212, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
      caret-color: #89C9D4 !important;
    }

    html[data-theme='dark'] #signupModal input:focus {
      border-color: #89C9D4 !important;
      box-shadow: 0 0 20px rgba(137, 201, 212, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
      outline: none !important;
    }

    html[data-theme='dark'] #signupModal input::placeholder {
      color: rgba(137, 201, 212, 0.7) !important;
      opacity: 1 !important;
    }

    html[data-theme='dark'] #signupModal .btn {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.8) 0%, rgba(30, 80, 85, 0.9) 100%) !important;
      color: #ffffff !important;
      border: 1px solid rgba(137, 201, 212, 0.4) !important;
      box-shadow: 0 2px 8px rgba(137, 201, 212, 0.2) !important;
    }

    html[data-theme='dark'] #signupModal .btn:hover {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 1) 100%) !important;
      box-shadow: 0 0 12px rgba(137, 201, 212, 0.4) !important;
      transform: translateY(-1px) !important;
    }

    html[data-theme='dark'] #signupModal a {
      color: #89C9D4 !important;
    }

    html[data-theme='dark'] #signupModal a:hover {
      color: #7BB8C4 !important;
    }

    /* Enhanced Dark Theme for Login Modal */
    html[data-theme='dark'] #loginModal .card-block {
      background: rgba(21, 54, 58, 0.95) !important;
      color: #ffffff !important;
      border: 1px solid rgba(42,105,114,0.3) !important;
      backdrop-filter: blur(10px) !important;
    }

    html[data-theme='dark'] #loginModal h2 {
      color: #7BB8C4 !important;
    }

    html[data-theme='dark'] #loginModal p {
      color: rgba(137, 201, 212, 0.9) !important;
    }

    html[data-theme='dark'] #loginModal input {
      background: linear-gradient(135deg, rgba(42, 54, 58, 0.9) 0%, rgba(30, 42, 48, 0.95) 100%) !important;
      color: #89C9D4 !important;
      border: 2px solid rgba(137, 201, 212, 0.3) !important;
      box-shadow: 0 0 15px rgba(137, 201, 212, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
      caret-color: #89C9D4 !important;
    }

    html[data-theme='dark'] #loginModal input:focus {
      border-color: #89C9D4 !important;
      box-shadow: 0 0 20px rgba(137, 201, 212, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
      outline: none !important;
    }

    html[data-theme='dark'] #loginModal input::placeholder {
      color: rgba(137, 201, 212, 0.7) !important;
      opacity: 1 !important;
    }

    html[data-theme='dark'] #loginModal .btn {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.8) 0%, rgba(30, 80, 85, 0.9) 100%) !important;
      color: #ffffff !important;
      border: 1px solid rgba(137, 201, 212, 0.4) !important;
      box-shadow: 0 2px 8px rgba(137, 201, 212, 0.2) !important;
    }

    html[data-theme='dark'] #loginModal .btn:hover {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 1) 100%) !important;
      box-shadow: 0 0 12px rgba(137, 201, 212, 0.4) !important;
      transform: translateY(-1px) !important;
    }

    html[data-theme='dark'] #loginModal a {
      color: #89C9D4 !important;
    }

    html[data-theme='dark'] #loginModal a:hover {
      color: #7BB8C4 !important;
    }

    /* Enhanced Dark Theme for About InkWell Modal */
    html[data-theme='dark'] #aboutInkwellModal > div {
      background: rgba(21, 54, 58, 0.95) !important;
      color: #ffffff !important;
      border: 1px solid rgba(42,105,114,0.3) !important;
      backdrop-filter: blur(10px) !important;
    }

    html[data-theme='dark'] #aboutInkwellModal h2 {
      color: #7BB8C4 !important;
    }

    html[data-theme='dark'] #aboutInkwellModal h3 {
      color: #89C9D4 !important;
    }

    html[data-theme='dark'] #aboutInkwellModal p,
    html[data-theme='dark'] #aboutInkwellModal div {
      color: rgba(137, 201, 212, 0.9) !important;
    }

    html[data-theme='dark'] #aboutInkwellModal strong {
      color: #7BB8C4 !important;
    }

    html[data-theme='dark'] #aboutInkwellModal span {
      color: rgba(137, 201, 212, 0.8) !important;
    }

    html[data-theme='dark'] #aboutInkwellModal em {
      color: rgba(137, 201, 212, 0.7) !important;
    }

    html[data-theme='dark'] #aboutInkwellModal hr {
      border-color: rgba(137, 201, 212, 0.3) !important;
    }

    html[data-theme='dark'] #aboutInkwellModal .btn {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.8) 0%, rgba(30, 80, 85, 0.9) 100%) !important;
      color: #ffffff !important;
      border: 1px solid rgba(137, 201, 212, 0.4) !important;
      box-shadow: 0 2px 8px rgba(137, 201, 212, 0.2) !important;
    }

    html[data-theme='dark'] #aboutInkwellModal .btn:hover {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 1) 100%) !important;
      box-shadow: 0 0 12px rgba(137, 201, 212, 0.4) !important;
      transform: translateY(-1px) !important;
    }

    /* Dark mode instruction sections - white background for readability */
    html[data-theme='dark'] .instruction-section {
      background: #ffffff !important;
      color: #333 !important;
      border-left-color: #2A6972 !important;
    }
    html[data-theme='dark'] .instruction-section h4 {
      color: #2A6972 !important;
    }
    html[data-theme='dark'] .instruction-section p {
      color: #333 !important;
    }
    html[data-theme='dark'] .instruction-section div {
      color: #333 !important;
    }
    html[data-theme='dark'] .instruction-section span {
      color: #333 !important;
    }
    
    /* Also override with prefers-color-scheme for users without manual theme setting */
    @media (prefers-color-scheme: dark) {
      .instruction-section {
        background: #ffffff !important;
        color: #333 !important;
        border-left-color: #2A6972 !important;
      }
      .instruction-section h4 {
        color: #2A6972 !important;
      }
      .instruction-section p {
        color: #333 !important;
      }
      .instruction-section div {
        color: #333 !important;
      }
      .instruction-section span {
        color: #333 !important;
      }
    }

    #embeddedAgreementNotice .card-block,
    #loginModal .card-block,
    #goodbyeModal .card-block {
      background: var(--bg-card);
      color: var(--font-main);
      border: 2px dashed var(--brand-primary);
    }

    /* Calendar overrides */
    #calendarTab th,
    #calendarTab td,
    #calendarTab p,
    #calendarTab h2,
    #calendarTab h3 {
      color: var(--font-main);
    }

    #calendarContainer {
  width: calc(100% - 1em);
  max-width: 100%;
  margin: 1em auto;
  box-sizing: border-box;
}
    
    #calendarContainer table {
      width: 100%;
      max-width: none;
    }
    
    /* DEBUG: Force tab buttons container to full width */
    /* ✨ MODERN TAB SYSTEM - Clean slate CSS */
    
    /* Remove old tab styling since we're using the new modern system */
    
    /* Ensure all .card-block elements inside tabs are consistent */
    #journalTab .card-block,
    #manifestTab .card-block,
    #calendarTab .card-block {
      background: var(--bg-muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1em;
      margin: 0 0 1em 0;                          /* give inner sections consistent spacing */
      width: 100%;
      box-sizing: border-box;
    }
    
    /* ✨ MODERN TAB SYSTEM STYLING */
    .modern-tab-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    .modern-tab-btn:hover:not(.active) {
      background: rgba(42,105,114,0.1) !important;
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(42,105,114,0.15) !important;
    }
    
    .modern-tab-btn.active {
      background: linear-gradient(135deg, #2A6972 0%, #1e5055 100%) !important;
      color: white !important;
      box-shadow: 0 6px 20px rgba(42,105,114,0.4) !important;
      transform: translateY(-1px);
    }
    
    .modern-tab-content {
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    
    .modern-tab-content[style*="display: block"] {
      opacity: 1;
      transform: translateY(0);
    }
  .tab-inner {
  width: 100% !important;
  box-sizing: border-box !important;
  padding: 0 1em !important;
  max-width: 100% !important;
}

    /* ✨ MODERN CONTENT AREA STYLING - Visual Workflow Sections */
    
    /* Main instruction sections with better visual hierarchy */
    .instruction-section {
      background: linear-gradient(135deg, rgba(42,105,114,0.08) 0%, rgba(42,105,114,0.12) 100%) !important;
      border: 1px solid rgba(42,105,114,0.2) !important;
      border-radius: 12px !important;
      padding: 1.5em !important;
      margin: 1.5em 0 !important;
      border-left: 4px solid #2A6972 !important;
      backdrop-filter: blur(5px);
      position: relative;
      overflow: hidden;
    }
    
    .instruction-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #2A6972, rgba(42,105,114,0.3), #2A6972);
      border-radius: 12px 12px 0 0;
    }
    
    /* Modern input areas with visual grouping */
    .ai-input,
    textarea,
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="url"] {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%) !important;
      border: 2px solid rgba(42,105,114,0.15) !important;
      border-radius: 10px !important;
      padding: 1em 1.2em !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      backdrop-filter: blur(3px);
      box-shadow: 0 2px 8px rgba(42,105,114,0.08) !important;
      font-family: var(--body-font);
    }
    
    .ai-input:focus,
    textarea:focus,
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    input[type="url"]:focus {
      border-color: #2A6972 !important;
      box-shadow: 0 4px 16px rgba(42,105,114,0.2), 0 0 0 3px rgba(42,105,114,0.1) !important;
      transform: translateY(-1px);
      outline: none !important;
    }
    /* =================================
   CONSOLIDATED PLACEHOLDER STYLING
   ================================= */

/* Override ALL placeholder styling with maximum specificity */
#promptTopic::placeholder,
#searchQuery::placeholder,
#promptTopic::-webkit-input-placeholder,
#searchQuery::-webkit-input-placeholder,
#promptTopic::-moz-placeholder,
#searchQuery::-moz-placeholder {
  color: rgba(0, 0, 0, 0.35) !important;
  opacity: 1 !important;
  -webkit-text-fill-color: rgba(0, 0, 0, 0.35) !important;
}

/* Section removed - was causing black placeholders in dark mode */

/* System dark mode preference */
@media (prefers-color-scheme: dark) {
  ::placeholder,
  ::-webkit-input-placeholder,
  ::-moz-placeholder,
  :-ms-input-placeholder {
    color: rgba(255, 255, 255, 0.35) !important;
    opacity: 1 !important;
  }
}


    /* Modern button styling with workflow colors */
    .btn {
      background: linear-gradient(135deg, #2A6972 0%, #1e5055 100%) !important;
      border: none !important;
      border-radius: 8px !important;
      padding: 0.75em 1.5em !important;
      color: white !important;
      font-weight: 500 !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      box-shadow: 0 3px 12px rgba(42,105,114,0.3) !important;
      cursor: pointer !important;
    }
    
    .btn:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(42,105,114,0.4) !important;
      background: linear-gradient(135deg, #1e5055 0%, #2A6972 100%) !important;
    }
    
    .btn-sophy {
      background: linear-gradient(135deg, #d97d7b 0%, #c46562 100%) !important;
      box-shadow: 0 3px 12px rgba(217,125,123,0.3) !important;
    }
    
    .btn-sophy:hover {
      background: linear-gradient(135deg, #c46562 0%, #d97d7b 100%) !important;
      box-shadow: 0 6px 20px rgba(217,125,123,0.4) !important;
    }
    
    .btn-gray {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
      box-shadow: 0 3px 12px rgba(107,114,128,0.3) !important;
    }
    
    .btn-gray:hover {
      background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%) !important;
      box-shadow: 0 6px 20px rgba(107,114,128,0.4) !important;
    }
    
    /* Workflow section headers with color coding */
    .journal-heading,
    .manifest-heading,
    h2, h3 {
      color: #2A6972 !important;
      font-weight: 600 !important;
      margin-bottom: 1.5em !important;
      position: relative;
    }
    
    .journal-heading::after,
    .manifest-heading::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, transparent, #2A6972, transparent);
      border-radius: 2px;
    }
    
    /* Wish section styling for better workflow separation */
    .wish-section {
      background: linear-gradient(135deg, rgba(42,105,114,0.05) 0%, rgba(42,105,114,0.08) 100%);
      border: 1px solid rgba(42,105,114,0.15);
      border-radius: 12px;
      padding: 1.5em;
      margin: 2em 0;
      position: relative;
      overflow: hidden;
    }
    
    .wish-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #2A6972, rgba(42,105,114,0.5));
    }
    
    /* ✨ DARK MODE ENHANCEMENTS - Softer, More Visual */
    html[data-theme='dark'] body {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%) !important;
    }
    
    html[data-theme='dark'] .modern-tab-container {
      background: linear-gradient(135deg, rgba(45,45,45,0.95) 0%, rgba(30,30,30,0.98) 100%) !important;
      border: 1px solid rgba(42,105,114,0.3) !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important;
    }
    
    html[data-theme='dark'] .tab-nav {
      background: rgba(20,20,20,0.8) !important;
      border: 1px solid rgba(42,105,114,0.4) !important;
    }
    
    html[data-theme='dark'] .tab-content-wrapper {
      background: rgba(30,30,30,0.95) !important;
      border: 1px solid rgba(42,105,114,0.2) !important;
    }
    
    /* Dark theme tab button styling with updated teal colors */
    html[data-theme='dark'] .modern-tab-btn {
      background: rgba(45,45,45,0.8) !important;
      color: #89C9D4 !important;
      border: 1px solid rgba(137, 201, 212, 0.3) !important;
    }
    
    html[data-theme='dark'] .modern-tab-btn:hover:not(.active) {
      background: rgba(42,105,114,0.2) !important;
      color: #89C9D4 !important;
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(137, 201, 212, 0.25) !important;
    }
    
    html[data-theme='dark'] .modern-tab-btn.active {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 0.95) 100%) !important;
      color: white !important;
      box-shadow: 0 6px 20px rgba(137, 201, 212, 0.4), 0 0 15px rgba(137, 201, 212, 0.3) !important;
      transform: translateY(-1px);
      border: 1px solid rgba(137, 201, 212, 0.5) !important;
    }
    
    html[data-theme='dark'] .instruction-section {
      background: linear-gradient(135deg, rgba(42,105,114,0.15) 0%, rgba(42,105,114,0.20) 100%) !important;
      border: 1px solid rgba(42,105,114,0.4) !important;
      color: #e0e7eb !important;
    }
    
    /* Fix text contrast in dark mode instruction sections */
    html[data-theme='dark'] .instruction-section h4 {
      color: #4fb3d9 !important;
    }
    
    html[data-theme='dark'] .instruction-section div,
    html[data-theme='dark'] .instruction-section span,
    html[data-theme='dark'] .instruction-section p {
      color: #e0e7eb !important;
    }
    
    html[data-theme='dark'] .ai-input,
    html[data-theme='dark'] textarea,
    html[data-theme='dark'] input[type="text"] {
      background: linear-gradient(135deg, rgba(40,40,40,0.9) 0%, rgba(50,50,50,0.95) 100%) !important;
      border: 2px solid rgba(42,105,114,0.3) !important;
      color: #e0e7eb !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
    }
    
    html[data-theme='dark'] .ai-input:focus,
    html[data-theme='dark'] textarea:focus,
    html[data-theme='dark'] input[type="text"]:focus {
      border-color: #4fb3d9 !important;
      box-shadow: 0 4px 16px rgba(79,179,217,0.3), 0 0 0 3px rgba(79,179,217,0.1) !important;
    }
    
    html[data-theme='dark'] .btn {
      background: linear-gradient(135deg, #4fb3d9 0%, #2A6972 100%) !important;
      box-shadow: 0 3px 12px rgba(79,179,217,0.4) !important;
    }
    
    html[data-theme='dark'] .btn:hover {
      background: linear-gradient(135deg, #2A6972 0%, #4fb3d9 100%) !important;
      box-shadow: 0 6px 20px rgba(79,179,217,0.5) !important;
    }
    
    html[data-theme='dark'] .btn-sophy {
      background: linear-gradient(135deg, #e394a1 0%, #d97d7b 100%) !important;
      box-shadow: 0 3px 12px rgba(227,148,161,0.4) !important;
    }
    
    html[data-theme='dark'] .btn-sophy:hover {
      background: linear-gradient(135deg, #d97d7b 0%, #e394a1 100%) !important;
      box-shadow: 0 6px 20px rgba(227,148,161,0.5) !important;
    }
    
    html[data-theme='dark'] .journal-heading,
    html[data-theme='dark'] .manifest-heading,
    html[data-theme='dark'] h2,
    html[data-theme='dark'] h3 {
      color: #89C9D4 !important;
      text-shadow: 0 0 10px rgba(137, 201, 212, 0.3) !important;
    }
    
    html[data-theme='dark'] .wish-section {
      background: linear-gradient(135deg, rgba(42,105,114,0.12) 0%, rgba(42,105,114,0.18) 100%) !important;
      border: 1px solid rgba(42,105,114,0.3) !important;
    }
    
    html[data-theme='dark'] .wish-section::before {
      background: linear-gradient(180deg, #4fb3d9, rgba(79,179,217,0.5)) !important;
    }
    
    /* ✨ DARK MODE TEXT CONTRAST FIXES */
    
    /* Fix general text colors in dark mode */
    html[data-theme='dark'] body,
    html[data-theme='dark'] p,
    html[data-theme='dark'] div,
    html[data-theme='dark'] span,
    html[data-theme='dark'] label {
      color: #e0e7eb !important;
    }
    
    /* Fix section headers and text in dark mode */
    html[data-theme='dark'] .section-sub {
      color: rgba(224,231,235,0.8) !important;
    }
    
    /* Fix text inside wish sections */
    html[data-theme='dark'] .wish-section h2,
    html[data-theme='dark'] .wish-section p,
    html[data-theme='dark'] .wish-section div {
      color: #e0e7eb !important;
    }
    
    /* Fix Sophy info text */
    html[data-theme='dark'] .sophy-info,
    html[data-theme='dark'] .sophy-info p {
      color: #e0e7eb !important;
    }
  
    
    /* Fix divider text */
    html[data-theme='dark'] .workflow-divider::after {
      background: var(--bg-muted) !important;
      color: #4fb3d9 !important;
    }
    
    /* Fix calendar and search area text */
    html[data-theme='dark'] #calendarContainer,
    html[data-theme='dark'] #calendarContainer *,
    html[data-theme='dark'] #searchResults,
    html[data-theme='dark'] #searchResults * {
      color: #89C9D4 !important;
    }
    
    /* Fix calendar table cells and numbers specifically */
    html[data-theme='dark'] #calendarContainer table,
    html[data-theme='dark'] #calendarContainer td,
    html[data-theme='dark'] #calendarContainer th {
      color: #89C9D4 !important;
    }
    
    /* Calendar dates with entries (highlighted) */
    html[data-theme='dark'] #calendarContainer td[style*="background-color"] {
      color: white !important;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5) !important;
    }
    
    /* Fix status and italic text */
    html[data-theme='dark'] #entryStatus,
    html[data-theme='dark'] #manifestSaveStatus,
    html[data-theme='dark'] #voiceStatus {
      color: #89C9D4 !important;
    }
    
    /* Fix modern tab content text in dark mode */
    html[data-theme='dark'] .modern-tab-content,
    html[data-theme='dark'] .modern-tab-content *,
    html[data-theme='dark'] .tab-inner,
    html[data-theme='dark'] .tab-inner * {
      color: #89C9D4 !important;
    }
    
    /* Ensure headings still have the right color */
    html[data-theme='dark'] .modern-tab-content h2,
    html[data-theme='dark'] .modern-tab-content h3,
    html[data-theme='dark'] .tab-inner h2,
    html[data-theme='dark'] .tab-inner h3 {
      color: #89C9D4 !important;
      text-shadow: 0 0 10px rgba(137, 201, 212, 0.3) !important;
    }
    
    /* Fix button text colors */
    html[data-theme='dark'] .btn,
    html[data-theme='dark'] .btn-sophy,
    html[data-theme='dark'] .btn-gray {
      color: white !important;
    }
    
    /* Fix checkbox and form element text */
    html[data-theme='dark'] .coach-tag-toggle label {
      color: #e0e7eb !important;
    }
    
    /* ✨ LIGHT MODE TEXT CONTRAST IMPROVEMENTS */
    
    /* Ensure good contrast in light mode */
    .modern-tab-content,
    .tab-inner {
      color: #1f2937 !important;
    }
    
    .instruction-section {
      color: #1f2937 !important;
    }
    
    .instruction-section h4 {
      color: #2A6972 !important;
    }
    
    .wish-section {
      color: #1f2937 !important;
    }
    
    .sophy-info {
      color: #1f2937 !important;
    }
    
    .section-sub {
      color: rgba(31,41,55,0.7) !important;
    }
    
    
    /* Fix status text in light mode */
    #entryStatus,
    #manifestSaveStatus,
    #voiceStatus {
      color: #2A6972 !important;
    }
    
    /* ✨ CALENDAR STYLING FIXES */
    
    /* Ensure calendar text is visible in light mode */
    #calendarContainer,
    #calendarContainer table,
    #calendarContainer td,
    #calendarContainer th {
      color: #1f2937 !important;
    }
    
    /* Calendar dates with entries (highlighted) should have white text */
    #calendarContainer td[style*="background-color"] {
      color: white !important;
    }
    
    /* ✨ AUTO-RESIZING TEXTAREAS */
    
    /* Make manifest textareas auto-resize */
    #manifestInput,
    #wishInput,
    #outcomeInput,
    #oppositionInput,
    #planInput {
      min-height: 133px !important;
      height: auto !important;
      resize: vertical !important;
      overflow-y: hidden !important;
      transition: height 0.2s ease !important;
    }
    
    /* ✨ WORKFLOW VISUAL SEPARATORS & SECTIONS */
    
    /* Add visual workflow dividers */
    .workflow-divider {
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(42,105,114,0.3), transparent);
      margin: 2.5em 0;
      position: relative;
    }
    
    .workflow-divider::after {
      content: '✦';
      position: absolute;
      left: 50%;
      top: -8px;
      transform: translateX(-50%);
      background: var(--bg-card, #fff);
      color: #2A6972;
      padding: 0 10px;
      font-size: 12px;
    }
    
    /* Enhanced Sophy suggestion areas */
    .sophy-info {
      background: linear-gradient(135deg, rgba(217,125,123,0.08) 0%, rgba(217,125,123,0.12) 100%) !important;
      border: 1px solid rgba(217,125,123,0.25) !important;
      border-radius: 10px !important;
      padding: 1.2em !important;
      margin: 1em 0 !important;
      border-left: 4px solid #d97d7b !important;
      backdrop-filter: blur(3px);
    }
    
    html[data-theme='dark'] .sophy-info {
      background: linear-gradient(135deg, rgba(227,148,161,0.12) 0%, rgba(227,148,161,0.18) 100%) !important;
      border: 1px solid rgba(227,148,161,0.3) !important;
      border-left: 4px solid #e394a1 !important;
    }
    
    /* Status and feedback areas */
    .subtext-muted {
      color: rgba(42,105,114,0.7) !important;
      font-style: italic;
      font-size: 0.9em;
      margin: 0.5em 0;
    }
    
    html[data-theme='dark'] .subtext-muted {
      color: rgba(79,179,217,0.7) !important;
    }
    
    /* Section headers with better visual weight */
    .section-header h2,
    .section-title {
      background: linear-gradient(135deg, #2A6972 0%, #4fb3d9 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700 !important;
    }
    
    html[data-theme='dark'] .section-header h2,
    html[data-theme='dark'] .section-title {
      background: linear-gradient(135deg, #4fb3d9 0%, #7dd3fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    #calendarContainer {
  background: linear-gradient(135deg, rgba(248,250,252,0.8) 0%, rgba(255,255,255,0.9) 100%);
  border: 1px solid rgba(42,105,114,0.15);
  border-radius: 12px;
  padding: 0.5em;
  margin: 1em auto;
  backdrop-filter: blur(5px);
  width: calc(100% - 1em);
  box-sizing: border-box;
}

#searchResults {
  background: linear-gradient(135deg, rgba(248,250,252,0.8) 0%, rgba(255,255,255,0.9) 100%);
  border: 1px solid rgba(42,105,114,0.15);
  border-radius: 12px;
  padding: 0.5em;
  margin: 1em auto;
  backdrop-filter: blur(5px);
  width: 100%;
  box-sizing: border-box;
}
    
    html[data-theme='dark'] #calendarContainer,
    html[data-theme='dark'] #searchResults {
      background: linear-gradient(135deg, rgba(40,40,40,0.8) 0%, rgba(50,50,50,0.9) 100%);
      border: 1px solid rgba(42,105,114,0.3);
    }
    
    /* Pop-up and toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 1em 1.5em;
      border-radius: 5px;
      font-weight: 500;
      max-width: 400px;
      text-align: center;
      z-index: 9999;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      animation: toastSlideIn 0.3s ease-out;
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

/* ========================================= */
/* Past Entries – Dark Mode Readability Fix  */
/* ========================================= */

html[data-theme='dark'] .entry-card {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%) !important;
  color: #89C9D4 !important;
  border-radius: 12px;
  padding: 1.25em;
  margin-bottom: 1.5em;
  box-shadow: 0 0 20px rgba(137, 201, 212, 0.15), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
  border: 1px solid rgba(137, 201, 212, 0.25) !important;
  backdrop-filter: blur(5px) !important;
}

html[data-theme='dark'] .entry-card.journal-entry {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%) !important;
  color: #89C9D4 !important;
}

/* Force override inline styles with maximum specificity */
html[data-theme='dark'] #calendarTab .entry-card,
html[data-theme='dark'] #calendarTab .entry-card.journal-entry,
html[data-theme='dark'] [id*="calendarTab"] .entry-card,
html[data-theme='dark'] [class*="modern-tab-content"] .entry-card {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%) !important;
  color: #89C9D4 !important;
  border: 1px solid rgba(137, 201, 212, 0.25) !important;
  box-shadow: 0 0 20px rgba(137, 201, 212, 0.15), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
}

/* Entry text content */
html[data-theme='dark'] .entry-card .entry-text,
html[data-theme='dark'] .entry-card p:not(.entry-date) {
  color: #89C9D4 !important;
}

/* Entry date styling */
html[data-theme='dark'] .entry-card .entry-date,
html[data-theme='dark'] .entry-card .fixed-dark-date {
  color: rgba(137, 201, 212, 0.8) !important;
}

/* Nuclear option: Ultra-high specificity to override inline styles */
html[data-theme='dark'] div.entry-card[style*="background"],
html[data-theme='dark'] div.entry-card.journal-entry[style*="background"],
html[data-theme='dark'] [id="calendarTab"] div.entry-card[style],
html[data-theme='dark'] [class*="modern-tab-content"] div.entry-card[style] {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%) !important;
  color: #89C9D4 !important;
  border: 1px solid rgba(137, 201, 212, 0.25) !important;
  box-shadow: 0 0 20px rgba(137, 201, 212, 0.15), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
}

/* Override any nested content that may have inline styles */
html[data-theme='dark'] .entry-card[style] * {
  color: #89C9D4 !important;
}

html[data-theme='dark'] .entry-card[style] .entry-date,
html[data-theme='dark'] .entry-card[style] .fixed-dark-date {
  color: rgba(137, 201, 212, 0.8) !important;
}

/* Add spacing and subtle elevation between entries */
.entry-card.journal-entry {
  position: relative;
  margin-bottom: 2em;
  padding: 1.5em;
  border-radius: 14px;
  border: 1px solid #ddd;
  background: linear-gradient(180deg, #ffffff 0%, #f2f2f2 100%) !important;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
  transition: box-shadow 0.3s ease, transform 0.2s ease;
}

.entry-card.journal-entry:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transform: translateY(-1px);
}

/* Add divider lines between sections */
.entry-card.journal-entry > * + * {
  border-top: 1px solid #e0e0e0;
  padding-top: 0.75em;
  margin-top: 0.75em;
}

/* Avoid line above the first item (date) */
.entry-card.journal-entry > .entry-date {
  border-top: none !important;
  padding-top: 0 !important;
  margin-top: 0 !important;
}

.entry-card .entry-btn {
  padding: 0.4em 0.85em;
  font-size: 0.95em;
  line-height: 1.2;
  height: auto;
}

html[data-theme='dark'] .entry-card .meta,
html[data-theme='dark'] .entry-card .tags,
html[data-theme='dark'] .entry-card .shared-with-coach {
  color: rgba(137, 201, 212, 0.8) !important;
  font-size: 0.95em;
  font-style: italic;
}

html[data-theme='dark'] .entry-card h3,
html[data-theme='dark'] .entry-card p:not(.entry-date) {
  color: #89C9D4 !important;
}

html[data-theme='dark'] .entry-card:hover {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.25) 0%, rgba(30, 80, 85, 0.30) 100%) !important;
  box-shadow: 0 0 25px rgba(137, 201, 212, 0.25), 0 6px 20px rgba(0, 0, 0, 0.3) !important;
  transform: translateY(-2px) !important;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

/* Enhanced entry buttons for dark mode */
html[data-theme='dark'] .entry-btn {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.8) 0%, rgba(30, 80, 85, 0.9) 100%) !important;
  color: #ffffff !important;
  border: 1px solid rgba(137, 201, 212, 0.4) !important;
  box-shadow: 0 2px 8px rgba(137, 201, 212, 0.2) !important;
  transition: all 0.3s ease !important;
}

html[data-theme='dark'] .entry-btn:hover {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 1) 100%) !important;
  box-shadow: 0 0 12px rgba(137, 201, 212, 0.4) !important;
  transform: translateY(-1px) !important;
}

/* Enhanced Past Entries Tab Background for Dark Mode */
html[data-theme='dark'] #calendarTab.modern-tab-content {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.08) 0%, rgba(30, 80, 85, 0.12) 100%) !important;
  border: 1px solid rgba(137, 201, 212, 0.15) !important;
  border-radius: 16px !important;
  backdrop-filter: blur(8px) !important;
}

/* Enhanced styling for the Past Entries container */
html[data-theme='dark'] #calendarTab .tab-inner {
  background: transparent !important;
  border-radius: 12px !important;
  padding: 1.5em !important;
}

/* Enhanced Calendar Container for Dark Mode */
html[data-theme='dark'] #calendarContainer {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%) !important;
  border-radius: 16px !important;
  padding: 1.5em !important;
  margin: 1em 0 !important;
  box-shadow: 0 0 20px rgba(137, 201, 212, 0.15), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
  border: 1px solid rgba(137, 201, 212, 0.25) !important;
  backdrop-filter: blur(5px) !important;
}

/* Enhanced Search Results and Calendar Entries for Dark Mode */
html[data-theme='dark'] #searchResults,
html[data-theme='dark'] #calendarEntries {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.12) 0%, rgba(30, 80, 85, 0.18) 100%) !important;
  border-radius: 14px !important;
  padding: 1.25em !important;
  margin: 1em 0 !important;
  box-shadow: 0 0 15px rgba(137, 201, 212, 0.12), 0 3px 12px rgba(0, 0, 0, 0.2) !important;
  border: 1px solid rgba(137, 201, 212, 0.2) !important;
  backdrop-filter: blur(3px) !important;
}

/* Enhanced Search Input for Dark Mode */
html[data-theme='dark'] #searchQuery.ai-input {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.08) 0%, rgba(30, 80, 85, 0.12) 100%) !important;
  color: #89C9D4 !important;
  border: 1px solid rgba(137, 201, 212, 0.3) !important;
  border-radius: 12px !important;
  padding: 1em 1.2em !important;
  box-shadow: 0 0 10px rgba(137, 201, 212, 0.1) !important;
  backdrop-filter: blur(3px) !important;
}

html[data-theme='dark'] #searchQuery.ai-input:focus {
  border-color: rgba(137, 201, 212, 0.6) !important;
  box-shadow: 0 0 15px rgba(137, 201, 212, 0.25) !important;
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%) !important;
}

html[data-theme='dark'] #searchQuery.ai-input::placeholder {
  color: rgba(137, 201, 212, 0.6) !important;
}

/* Enhanced Calendar Controls for Dark Mode */
html[data-theme='dark'] #calendarControls .btn {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.8) 0%, rgba(30, 80, 85, 0.9) 100%) !important;
  color: #ffffff !important;
  border: 1px solid rgba(137, 201, 212, 0.4) !important;
  box-shadow: 0 2px 8px rgba(137, 201, 212, 0.2) !important;
  backdrop-filter: blur(3px) !important;
}

html[data-theme='dark'] #calendarControls .btn:hover {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 1) 100%) !important;
  box-shadow: 0 0 12px rgba(137, 201, 212, 0.4) !important;
  transform: translateY(-1px) !important;
}

/* Enhanced Past Entries Title and Headers for Dark Mode */
html[data-theme='dark'] #calendarTab .section-header,
html[data-theme='dark'] #calendarTab .journal-heading {
  color: #89C9D4 !important;
  text-shadow: 0 0 10px rgba(137, 201, 212, 0.3) !important;
}

/* Enhanced Empty Messages for Dark Mode */
html[data-theme='dark'] #emptyPastEntriesMessage,
html[data-theme='dark'] #pastEntries p {
  color: rgba(137, 201, 212, 0.8) !important;
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.05) 0%, rgba(30, 80, 85, 0.08) 100%) !important;
  padding: 1em !important;
  border-radius: 10px !important;
  border: 1px solid rgba(137, 201, 212, 0.15) !important;
}

/* Enhanced Search Button for Dark Mode */
html[data-theme='dark'] #searchBtn {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.8) 0%, rgba(30, 80, 85, 0.9) 100%) !important;
  color: #ffffff !important;
  border: 1px solid rgba(137, 201, 212, 0.4) !important;
  box-shadow: 0 2px 8px rgba(137, 201, 212, 0.2) !important;
}

html[data-theme='dark'] #searchBtn:hover:not(:disabled) {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 1) 100%) !important;
  box-shadow: 0 0 12px rgba(137, 201, 212, 0.4) !important;
  transform: translateY(-1px) !important;
}
html[data-theme='light'] .entry-card .entry-date {
  color: var(--font-main);
  font-size: 0.95em;
  font-style: italic;
}

html[data-theme='dark'] .entry-card .entry-date,
html[data-theme='dark'] .entry-card .fixed-dark-date {
  color: rgba(137, 201, 212, 0.9) !important;
  font-size: 0.95em;
  font-style: italic;
  text-shadow: 0 0 8px rgba(137, 201, 212, 0.3) !important;
}


    /* Flash confirmation animation for journal entry */
    .flash-confirmation {
      animation: flashHighlight 1s ease-in-out;
    }
    @keyframes flashHighlight {
      0% { background-color: #D4F5D0; }
      50% { background-color: #A1E3A1; }
      100% { background-color: transparent; }
    }

    .spinner {
      display: inline-block;
      width: 1em;
      height: 1em;
      border: 2px solid rgba(49, 122, 133, 0.15);
      border-top-color: var(--btn-bg);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5em;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Theme Selector Styles */
    .theme-select {
      background-color: var(--bg-card);
      color: var(--font-main);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 0.3em 0.5em;
      font-size: 0.9em;
      font-family: var(--body-font);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .theme-select:hover {
      border-color: var(--brand-primary);
    }

    .theme-select:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 2px var(--brand-primary-20);
    }

    .theme-select option {
      background-color: var(--bg-card);
      color: var(--font-main);
      padding: 0.5em;
    }

    .entry-preview {
      max-height: 4.5em;
      overflow: hidden;
      position: relative;
    }
    .entry-preview::after {
      content: "...";
      position: absolute;
      bottom: 0;
      right: 0;
      background: linear-gradient(to right, transparent, var(--bg-card) 50%);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      main {
        padding: 1.5rem;
        border-radius: 16px;
        width: 85%;
        max-width: none;
      }

      h1 {
        font-size: 2rem;
      }

      .btn-large {
        width: 100%;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }

      main {
        padding: 1rem;
        width: 100%;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
      }

      textarea {
        height: 150px;
      }

      button {
        width: 100%;
        font-size: 0.95em;
        padding: 0.5em;
      }

      header img {
        max-width: 100%;
        height: auto;
      }

      input[type="text"],
      input[type="date"],
      input[type="file"],
      textarea {
        font-size: 1em;
      }
    }
    /* Tighter file upload UI for mobile */
    @media (max-width: 600px) {
      .card-block {
        padding: 0.5em !important;
      }
      label[for="attachment"] {
        font-size: 1em;
        margin-bottom: 0.5em;
      }
      #attachment {
        width: 100% !important;
        min-width: 0 !important;
        max-width: 100% !important;
        box-sizing: border-box;
      }
      #attachmentPreview {
        max-width: 100% !important;
      }
      .card-block {
        max-width: 100vw;
        box-sizing: border-box;
        overflow-x: auto;
      }
    }
    html {
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Theme select dropdown styling */
    .theme-select {
      background-color: var(--bg-muted);
      color: var(--font-main);
      border: 1px solid var(--border);
      padding: 0.5em;
      border-radius: 4px;
      font-size: 1em;
    }
/* User theme override (takes priority over prefers-color-scheme) */
html[data-theme='light'] {
  color-scheme: light;
}
html[data-theme='dark'] {
  color-scheme: dark;
}


    /* Custom colors for dark mode past entries text (not all) */
html[data-theme='dark'] .entry-card a {
  color: #7BB8C4 !important; /* lighter teal for links */
  text-shadow: 0 0 5px rgba(123, 184, 196, 0.3) !important;
}

html[data-theme='dark'] .entry-card a:hover {
  color: #89C9D4 !important;
  text-shadow: 0 0 8px rgba(137, 201, 212, 0.5) !important;
  text-decoration: underline !important;
}



    /* Brand-harmonious checkboxes using CSS variables */
    input[type="checkbox"] {
      accent-color: var(--brand-primary);
      width: 1.2em;
      height: 1.2em;
      vertical-align: middle;
      margin-right: 0.5em;
      border-radius: 4px;
      transition: all 0.2s ease;
      border: 2px solid var(--border-accent);
      background-color: transparent;
    }

    input[type="checkbox"]:checked {
      accent-color: var(--brand-primary);
      background-color: var(--brand-primary);
      border-color: var(--brand-primary);
    }

    input[type="checkbox"]:hover {
      border-color: var(--brand-secondary);
      transform: scale(1.05);
    }

    input[type="checkbox"]:focus {
      outline: 2px solid var(--brand-primary-rgba);
      outline-offset: 2px;
      border-color: var(--brand-primary);
    }

    /* Dark theme checkbox adjustments */
    html[data-theme='dark'] input[type="checkbox"] {
      border-color: var(--brand-secondary);
      accent-color: var(--brand-secondary);
    }

    html[data-theme='dark'] input[type="checkbox"]:checked {
      background-color: var(--brand-secondary);
      border-color: var(--brand-secondary);
      accent-color: var(--brand-secondary);
    }

    /* Checkbox labels using CSS variables */
    label:has(input[type="checkbox"]) {
      color: var(--brand-primary) !important;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    label:has(input[type="checkbox"]):hover {
      color: var(--brand-secondary) !important;
    }
    
    html[data-theme='dark'] label:has(input[type="checkbox"]) {
      color: var(--brand-light) !important;
    }

    html[data-theme='dark'] label:has(input[type="checkbox"]):hover {
      color: var(--brand-alt) !important;
    }

    /* File attachment text styling for dark theme */
    html[data-theme='dark'] #journalTab p,
    html[data-theme='dark'] #journalTab label[for="attachment"] {
      color: #ffffff !important;
    }

    /* Smart Search text visibility in dark theme */
    html[data-theme='dark'] #searchResults,
    html[data-theme='dark'] #searchResults *,
    html[data-theme='dark'] #searchResults p,
    html[data-theme='dark'] #searchResults div {
      color: #89C9D4 !important;
    }
    
    html[data-theme='dark'] .section-header {
      color: #89C9D4 !important;
      text-shadow: 0 0 10px rgba(137, 201, 212, 0.3) !important;
    }

    /* Enhanced Smart Search container styling for dark theme */
    html[data-theme='dark'] #searchResults {
      background: linear-gradient(135deg, rgba(42, 105, 114, 0.1) 0%, rgba(30, 80, 85, 0.15) 100%) !important;
      border-radius: 12px !important;
      padding: 1.5em !important;
      border: 1px solid rgba(137, 201, 212, 0.2) !important;
      box-shadow: 0 0 15px rgba(137, 201, 212, 0.1) !important;
      backdrop-filter: blur(5px) !important;
    }

    /* Fix Ask Sophy for a Prompt text in dark theme */
    html[data-theme='dark'] #generatedPrompt {
      color: #ffffff !important;
    }


/* Updated Settings Modal Dark Theme - Matches Login Modal Style */
html[data-theme='dark'] #userSettingsModal .card-block {
  background: rgba(21, 54, 58, 0.95) !important;
  color: #ffffff !important;
  border: 1px solid rgba(42,105,114,0.3) !important;
}

/* Dark theme styles for all container sections - More specific selectors */
html[data-theme='dark'] #userSettingsModal div[style*="background: #f8f9fa"],
html[data-theme='dark'] #userSettingsModal div[style*="background: #fff9f0"],
html[data-theme='dark'] #userSettingsModal div[style*="background: #f0f8ff"],
html[data-theme='dark'] #userSettingsModal div[style*="background: #fff5f5"] {
  background: rgba(42, 105, 114, 0.15) !important;
  border-color: rgba(42, 105, 114, 0.3) !important;
}

/* Specific targeting for practitioner section - highest specificity */
html[data-theme='dark'] #userSettingsModal div[style*="#f0f8ff"] {
  background: rgba(42, 105, 114, 0.15) !important;
  border: 1px solid rgba(42, 105, 114, 0.3) !important;
}

/* Specific targeting for appearance section */
html[data-theme='dark'] #userSettingsModal div[style*="#fff5f5"] {
  background: rgba(42, 105, 114, 0.15) !important;
  border: 1px solid rgba(42, 105, 114, 0.3) !important;
}

/* Dark theme styles for the new visual containers - keeping as fallback */
html[data-theme='dark'] #userSettingsModal > .card-block > div:nth-child(3) {
  background: rgba(42, 105, 114, 0.15) !important;
  border-color: rgba(42, 105, 114, 0.3) !important;
}

html[data-theme='dark'] #userSettingsModal > .card-block > div:nth-child(4) {
  background: rgba(42, 105, 114, 0.12) !important;
  border-color: rgba(42, 105, 114, 0.25) !important;
}

html[data-theme='dark'] #userSettingsModal > .card-block > div:nth-child(5) {
  background: rgba(42, 105, 114, 0.1) !important;
  border-color: rgba(42, 105, 114, 0.2) !important;
}

html[data-theme='dark'] #userSettingsModal > .card-block > div:nth-child(6) {
  background: rgba(42, 105, 114, 0.08) !important;
  border-color: rgba(42, 105, 114, 0.18) !important;
}

html[data-theme='dark'] #userSettingsModal > .card-block > div:nth-child(7) {
  background: rgba(42, 105, 114, 0.12) !important;
  border-color: rgba(42, 105, 114, 0.25) !important;
}

html[data-theme='dark'] #userSettingsModal h2,
html[data-theme='dark'] #userSettingsModal h3 {
  color: #2A6972 !important;
}

html[data-theme='dark'] #userSettingsModal label {
  color: #89C9D4 !important;
}

html[data-theme='dark'] #userSettingsModal input,
html[data-theme='dark'] #userSettingsModal select {
  background: rgba(21, 54, 58, 0.8) !important;
  color: #89C9D4 !important;
  border: 1px solid rgba(42, 105, 114, 0.4) !important;
}

html[data-theme='dark'] #userSettingsModal input:focus,
html[data-theme='dark'] #userSettingsModal select:focus {
  border-color: #2A6972 !important;
  outline: none !important;
  box-shadow: 0 0 0 2px rgba(42, 105, 114, 0.2) !important;
}

html[data-theme='dark'] #userSettingsModal #settingsCurrentUser {
  background: rgba(21, 54, 58, 0.6) !important;
  color: #89C9D4 !important;
  border: 1px solid rgba(42, 105, 114, 0.3) !important;
}

html[data-theme='dark'] #userSettingsModal p {
  color: #89C9D4 !important;
}

html[data-theme='dark'] #userSettingsModal a {
  color: #2A6972 !important;
}

html[data-theme='dark'] #userSettingsModal div[style*="background: #f8f9fa"] {
  background: rgba(42, 105, 114, 0.15) !important;
  border: 1px solid rgba(42, 105, 114, 0.3) !important;
}

/* Additional specific selectors for buttons within sections */
html[data-theme='dark'] #userSettingsModal button[style*="background: #f8f9fa"] {
  background: rgba(42, 105, 114, 0.2) !important;
  color: #89C9D4 !important;
  border: 1px solid rgba(42, 105, 114, 0.4) !important;
}

/* Edit Entry Modal Dark Theme */
html[data-theme='dark'] #editEntryModal .card-block {
  background: rgba(21, 54, 58, 0.95) !important;
  color: #ffffff !important;
  border: 1px solid rgba(42,105,114,0.3) !important;
}

html[data-theme='dark'] #editEntryModal h2 {
  color: #7BB8C4 !important;
}

html[data-theme='dark'] #editEntryModal label {
  color: #e0e7eb !important;
}

html[data-theme='dark'] #editEntryModal textarea {
  background: rgba(30,30,30,0.8) !important;
  color: #ffffff !important;
  border: 1px solid rgba(123,184,196,0.3) !important;
}

html[data-theme='dark'] #editEntryModal textarea:focus {
  border-color: #7BB8C4 !important;
  outline: none !important;
}
  .coach-tag-label {
      display: block;
      margin-top: 1em;
      margin-bottom: 0.5em;
      font-size: 1em;
      font-weight: 600;
      border-left: 3px solid var(--accent);
      padding-left: 0.75em;
      color: var(--accent-dark);
      background: rgba(212,148,137,0.08);
      border-radius: 3px;
      transition: background 0.2s;
    }
    .coach-tag-label:hover {
      background: rgba(212,148,137,0.18);
    }

/* ===============================
   LAYERING SYSTEM: Z-INDEX POLICY
   ===============================
   0 — Decorative (::before, gradients)
   1 — Hidden layers (logo/avatar base)
   2 — Active layers (visible img in swap)
   3+ — Interactive (modals, tooltips)
================================== */


    
    /* Override default text selection color to match theme */
    ::selection {
      background: var(--brand-secondary);
      color: #ffffff;
    }
    ::-moz-selection {
      background: var(--brand-secondary);
      color: #ffffff;
    }

    /* Custom override for system dark mode: keep manifest/journal areas light */
    @media (prefers-color-scheme: dark) {
      #manifestInput,
      #wishInput,
      #outcomeInput,
      #oppositionInput,
      #planInput,
      #journal,
      .reflectionNotes {
        background-color: #f8f8f8 !important;
        color: rgb(34, 34, 34) !important;
      }
    }

    /* Header Logos and Transitions */
  .logo-hero {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 2.6em auto;
    width: 324px;
    height: 324px;
    position: relative;
    /* Deep/wide drop shadow for logo container */
    box-shadow: 0 8px 44px 0 rgba(255,255,255,0.135), 0 12px 60px 0 rgba(137,201,212,0.07);
    border-radius: 28px;
    background: none;
    margin-bottom: 2.6em;
  }
  .logo-hero-inner {
  width: 240px;
  height: 240px;
  border-radius: 50%;
  overflow: hidden;
  position: relative;
  background-color: transparent;
  box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
  transform: translateZ(0); /* Enable hardware acceleration */
}
.logo-img,
.avatar-img {
  width: 240px;
  height: 240px;
  object-fit: cover;
  position: absolute;
  top: 0;
  left: 0;
  border-radius: 50%;
  transition: opacity 1s ease-in-out;
  border-radius: 50%;
  opacity: 0;
  z-index: 2;
  transition: opacity 1.25s cubic-bezier(0.4, 0, 0.2, 1);
  will-change: opacity;
}

html[data-theme='dark'] .logo-hero-inner::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: radial-gradient(circle, #ffffff 70%, rgba(255,255,255,0.05) 100%);
  z-index: 1;
  pointer-events: none;
}

html[data-theme='light'] .logo-hero-inner::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: radial-gradient(circle, #ffffff 75%, rgba(255,255,255,0.05) 100%);
  z-index: 1;
  pointer-events: none;
}

.logo-img.show,
.avatar-img.show {
  opacity: 1;
  z-index: 2;
}
.logo-hero-inner::before {
  pointer-events: none;
}

  /* Unified soft radial background for logo - ALL THEMES */
  .logo-hero::before,
  html[data-theme='light'] .logo-hero::before,
  html[data-theme='dark'] .logo-hero::before,
  :root:not([data-theme='dark']):not([data-theme='light']) .logo-hero::before {
    content: "";
    position: absolute;
    left: 50%;
    top: 50%;
    width: 240px;
    height: 240px;
    transform: translate(-50%, -50%);
    background: radial-gradient(circle, rgba(255,255,255,0.92) 80%, rgba(137,201,212,0.17) 100%);
    border-radius: 50%;
    z-index: 0;
    pointer-events: none;
  }

  /* Drop shadow for logo-hero in dark and light theme overrides */
html[data-theme='dark'] .logo-hero {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.9) 0%, rgba(30, 80, 85, 0.95) 100%) !important;
  border: 2px solid rgba(42, 105, 114, 0.4) !important;
  box-shadow: 0 6px 20px rgba(42, 105, 114, 0.4), 0 0 0 1px rgba(42, 105, 114, 0.2) !important;
}
  html[data-theme='light'] .logo-hero {
    border: 2px solid rgba(42, 105, 114, 0.3);
    box-shadow: 0 6px 20px rgba(42, 105, 114, 0.25), 0 0 0 1px rgba(42, 105, 114, 0.1);
  }
  :root:not([data-theme='light']) .logo-hero {
    border: 2px solid rgba(42, 105, 114, 0.3);
    box-shadow: 0 6px 20px rgba(42, 105, 114, 0.25), 0 0 0 1px rgba(42, 105, 114, 0.1);
  }

    /* Attachment image sizing */
#attachment {
  width: 90%;
  max-width: 330px;
  min-width: 140px;
}

#animatedImage,
#avatarImage {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
  transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0;
  z-index: 1;
  will-change: opacity;
}

/* FIXED: Make sure logo shows by default */
#animatedImage {
  opacity: 1 !important;
}

#animatedImage.show {
  opacity: 1 !important;
  z-index: 2;
}

#avatarImage.show {
  opacity: 1 !important;
  z-index: 2;
}

#animatedImage.show,
#avatarImage.show {
  opacity: 1;
  z-index: 2;
}
/* ✅ ELEGANT Dark Theme Styling for Ask Sophy + Smart Search */
html[data-theme='dark'] input#promptTopic,
html[data-theme='dark'] input#searchQuery,
html[data-theme='dark'] .ai-input {
  color: #89C9D4 !important;
  background: linear-gradient(135deg, rgba(42, 54, 58, 0.9) 0%, rgba(30, 42, 48, 0.95) 100%) !important;
  border: 2px solid rgba(137, 201, 212, 0.3) !important;
  box-shadow: 0 0 15px rgba(137, 201, 212, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  caret-color: #89C9D4 !important;
  -webkit-text-fill-color: #89C9D4 !important;
  padding: 0.75em 1em !important;
  border-radius: 10px !important;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

/* Placeholder styling for Ask Sophy and Search inputs - Dark Mode */
html[data-theme='dark'] input#promptTopic::placeholder,
html[data-theme='dark'] input#promptTopic::-webkit-input-placeholder,
html[data-theme='dark'] input#promptTopic::-moz-placeholder,
html[data-theme='dark'] input#searchQuery::placeholder,
html[data-theme='dark'] input#searchQuery::-webkit-input-placeholder,
html[data-theme='dark'] input#searchQuery::-moz-placeholder,
html[data-theme='dark'] .ai-input::placeholder,
html[data-theme='dark'] .ai-input::-webkit-input-placeholder,
html[data-theme='dark'] .ai-input::-moz-placeholder,
html[data-theme='dark'] input.ai-input::placeholder,
html[data-theme='dark'] input.ai-input::-webkit-input-placeholder,
html[data-theme='dark'] input.ai-input::-moz-placeholder {
  color: rgba(137, 201, 212, 0.7) !important;
  opacity: 1 !important;
  -webkit-text-fill-color: rgba(137, 201, 212, 0.7) !important;
}

/* Focus state with enhanced teal glow */
html[data-theme='dark'] input#promptTopic:focus,
html[data-theme='dark'] input#searchQuery:focus,
html[data-theme='dark'] .ai-input:focus {
  border-color: #89C9D4 !important;
  box-shadow: 0 0 20px rgba(137, 201, 212, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  outline: none !important;
}

/* Additional dark mode input text fix with higher specificity */
html[data-theme='dark'] .ai-input#promptTopic,
html[data-theme='dark'] .ai-input#searchQuery {
  color: #89C9D4 !important;
  background: linear-gradient(135deg, rgba(42, 54, 58, 0.9) 0%, rgba(30, 42, 48, 0.95) 100%) !important;
  border: 2px solid rgba(137, 201, 212, 0.3) !important;
  box-shadow: 0 0 15px rgba(137, 201, 212, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  caret-color: #89C9D4 !important;
  -webkit-text-fill-color: #89C9D4 !important;
}

/* Additional placeholder styling with ai-input class */
html[data-theme='dark'] .ai-input#promptTopic::placeholder,
html[data-theme='dark'] .ai-input#promptTopic::-webkit-input-placeholder,
html[data-theme='dark'] .ai-input#promptTopic::-moz-placeholder,
html[data-theme='dark'] .ai-input#searchQuery::placeholder,
html[data-theme='dark'] .ai-input#searchQuery::-webkit-input-placeholder,
html[data-theme='dark'] .ai-input#searchQuery::-moz-placeholder {
  color: rgba(137, 201, 212, 0.7) !important;
  opacity: 1 !important;
}

/* Dark theme styling for main journal textarea */
html[data-theme='dark'] #journal {
  color: #89C9D4 !important;
  background: linear-gradient(135deg, rgba(42, 54, 58, 0.9) 0%, rgba(30, 42, 48, 0.95) 100%) !important;
  border: 2px solid rgba(137, 201, 212, 0.3) !important;
  box-shadow: 0 0 15px rgba(137, 201, 212, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  caret-color: #89C9D4 !important;
  -webkit-text-fill-color: #89C9D4 !important;
}

html[data-theme='dark'] #journal:focus {
  border-color: #89C9D4 !important;
  box-shadow: 0 0 20px rgba(137, 201, 212, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  outline: none !important;
}

html[data-theme='dark'] #journal::placeholder {
  color: rgba(137, 201, 212, 0.7) !important;
  opacity: 1 !important;
}

/* Dark theme styling for WISH textareas - Match Journal Entry styling */
html[data-theme='dark'] #wishInput,
html[data-theme='dark'] #outcomeInput,
html[data-theme='dark'] #oppositionInput,
html[data-theme='dark'] #planInput {
  color: #89C9D4 !important;
  background: linear-gradient(135deg, rgba(42, 54, 58, 0.9) 0%, rgba(30, 42, 48, 0.95) 100%) !important;
  border: 2px solid rgba(137, 201, 212, 0.3) !important;
  box-shadow: 0 0 15px rgba(137, 201, 212, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  caret-color: #89C9D4 !important;
  -webkit-text-fill-color: #89C9D4 !important;
}

html[data-theme='dark'] #wishInput:focus,
html[data-theme='dark'] #outcomeInput:focus,
html[data-theme='dark'] #oppositionInput:focus,
html[data-theme='dark'] #planInput:focus {
  border-color: #89C9D4 !important;
  box-shadow: 0 0 20px rgba(137, 201, 212, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.1) !important;
  outline: none !important;
}

html[data-theme='dark'] #wishInput::placeholder,
html[data-theme='dark'] #outcomeInput::placeholder,
html[data-theme='dark'] #oppositionInput::placeholder,
html[data-theme='dark'] #planInput::placeholder {
  color: rgba(137, 201, 212, 0.7) !important;
  opacity: 1 !important;
}

/* Force dark placeholder styling for JavaScript-managed elements */
.force-dark-placeholder::placeholder,
.force-dark-placeholder::-webkit-input-placeholder,
.force-dark-placeholder::-moz-placeholder,
.force-dark-placeholder:-ms-input-placeholder,
.force-dark-placeholder:-moz-placeholder {
  color: rgba(137, 201, 212, 0.7) !important;
  opacity: 1 !important;
  -webkit-text-fill-color: rgba(137, 201, 212, 0.7) !important;
}

/* Sub-elements: tags, date, text, buttons */
html[data-theme='dark'] .entry-card .entry-tags {
  color: var(--brand-primary) !important;
  font-style: italic;
}

html[data-theme='dark'] .entry-card .entry-date.fixed-dark-date {
  color: var(--font-main) !important;
  font-style: italic;
  font-size: 0.95em;
  display: block;
}

html[data-theme='dark'] .entry-card p.entry-text {
  color: #222222 !important;
  font-size: 1em !important;
  line-height: 1.6 !important;
  background-color: transparent !important;
  display: block;
}

html[data-theme='dark'] .entry-card button {
  color: var(--font-main);
  background-color: #eee;
  border: 1px solid #ccc;
}

#emptyPastEntriesMessage {
  display: none;
  text-align: center;
  color: var(--info-muted);
  font-style: italic;
  padding: 2em;
}
  button.btn:hover {
    filter: brightness(1.1);
    cursor: pointer;
    transition: filter 0.2s ease-in-out;
  }


  button.btn-sophy {
  background-color: #d49489; /* Coral base */
  color: white;
  border: none;
  transition: background-color 0.2s ease-in-out;
}
.btn-sophy:hover {
  background-color: #c07e74; 
  cursor: pointer;
  filter: brightness(1.05); 
}

details summary strong.section-label {
  color: var(--font-accent);
  font-size: 1.1em;
  font-weight: 600;
  letter-spacing: 0.2px;
}

.coach-tag-toggle {
  background: linear-gradient(135deg, rgba(137, 201, 212, 0.08) 0%, rgba(42, 105, 114, 0.05) 100%);
  border: 2px solid #89C9D4;
  border-radius: 12px;
  padding: 1rem 1.25rem;
  margin: 1.5rem 0;
  font-size: 0.95em;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: #2A6972;
  box-shadow: 0 3px 12px rgba(42, 105, 114, 0.08);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.coach-tag-toggle::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(180deg, #2A6972 0%, #4A9BA8 100%);
}

.coach-tag-toggle:hover {
  border-color: #2A6972;
  box-shadow: 0 4px 16px rgba(42, 105, 114, 0.12);
  transform: translateY(-1px);
}

.coach-tag-toggle label {
  font-weight: 500;
  color: #2A6972;
  cursor: pointer;
  user-select: none;
  line-height: 1.4;
  margin: 0;
}

html[data-theme='dark'] .coach-tag-toggle {
  background: linear-gradient(135deg, rgba(74, 155, 168, 0.1) 0%, rgba(42, 105, 114, 0.08) 100%);
  border-color: #4A9BA8;
  color: #89C9D4;
  box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
}

html[data-theme='dark'] .coach-tag-toggle::before {
  background: linear-gradient(180deg, #4A9BA8 0%, #7BB8C4 100%);
}

html[data-theme='dark'] .coach-tag-toggle label {
  color: #89C9D4;
}

html[data-theme='dark'] .coach-tag-toggle:hover {
  border-color: #7BB8C4;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.coach-tag-toggle input[type="checkbox"] {
  width: 1.3em;
  height: 1.3em;
  accent-color: var(--brand-primary);
  border: 2px solid var(--brand-light);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.coach-tag-toggle input[type="checkbox"]:checked {
  background-color: var(--brand-primary);
  border-color: var(--brand-primary);
}

.coach-tag-toggle input[type="checkbox"]:hover {
  border-color: var(--brand-primary);
  transform: scale(1.05);
}

html[data-theme='dark'] .coach-tag-toggle input[type="checkbox"] {
  accent-color: var(--brand-alt);
  border-color: var(--brand-alt);
}

html[data-theme='dark'] .coach-tag-toggle input[type="checkbox"]:checked {
  background-color: var(--brand-alt);
  border-color: var(--brand-alt);
}

/* AI Input Styling */
.ai-input {
  display: block;
  width: 100%;
  padding: 0.6em 1em;
  border-radius: 6px;
  border: 1px solid var(--accent);
  background-color: #fef9f8;
    color: #000000;
  font-size: 1em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  transition: all 0.2s ease-in-out;
}

.ai-input:focus {
  outline: none;
  border-color: var(--accent-dark);
  background-color: #fff;
  box-shadow: 0 0 0 2px rgba(212, 148, 137, 0.2);
}

/* Dark theme AI inputs */
html[data-theme='dark'] .ai-input {
  color: #000000;
  color: #f5e6e3;
  border-color: var(--accent);
}

html[data-theme='dark'] .ai-input:focus {
  background-color: #3a2720;
  border-color: var(--accent-dark);
  box-shadow: 0 0 0 2px rgba(212, 148, 137, 0.3);
}

/* Auto dark mode support */
@media (prefers-color-scheme: dark) {
  :root .ai-input {
    background-color: #2d1f1c;
    color: #000000;
    border-color: var(--accent);
  }
  
  :root .ai-input:focus {
    background-color: #3a2720;
    border-color: var(--accent-dark);
    box-shadow: 0 0 0 2px rgba(212, 148, 137, 0.3);
  }
}
/* Simple, clean dropdown styling */
#approvedPractitionerSelect {
  transition: border-color 0.2s ease;
}

#approvedPractitionerSelect:focus {
  outline: none;
  border-color: #2A6972;
  box-shadow: 0 0 0 2px rgba(42, 105, 114, 0.2);
}

#approvedPractitionerSelect option {
  padding: 8px 12px;
  background-color: white;
  color: #333;
}

#approvedPractitionerSelect option:hover {
  background-color: #f0f8ff;
}
</style>



  <script type="module">
    // Firebase initialization moved to auth.js
    // Functions will be available via window.functions from auth.js

    // 🔐 SECURITY: Helper function for authenticated AI endpoint calls
    async function secureAIFetch(endpoint, payload) {
      // Ensure user is authenticated
      if (!auth.currentUser) {
        throw new Error("User must be authenticated to use AI features");
      }

      // Get Firebase ID token
      const idToken = await auth.currentUser.getIdToken();
      
      // Add payload size limit (1MB max)
      const payloadSize = JSON.stringify(payload).length;
      if (payloadSize > 1048576) { // 1MB limit
        throw new Error("Request payload too large");
      }

      // Make authenticated request
      const response = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${idToken}`
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        // Try to get the error message from the response body
        let errorMessage = `AI request failed: ${response.status}`;
        try {
          const errorData = await response.json();
          if (errorData.error) {
            errorMessage = errorData.error;
          }
        } catch (parseError) {
          // If we can't parse the error response, use the generic message
          errorMessage = `AI request failed: ${response.status} ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      return response.json();
    }

    // Helper: Get current user's name for Sophy personalization
    async function getCurrentUserName() {
      try {
        const currentUserId = window.currentUserId || window.auth?.currentUser?.uid;
        if (!currentUserId) return null;
        
        const userDoc = await getDoc(doc(db, "users", currentUserId));
        if (userDoc.exists) {
          const userData = userDoc.data();
          return userData.signupUsername || userData.displayName || null;
        }
      } catch (error) {
        console.log("Could not fetch username for Sophy:", error);
      }
      return null;
    }

    // Helper: Check if running on localhost
    function isLocalhost() {
      return location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname === '';
    }

    // Helper: Safe function calls for localhost development
    async function safeCloudFunctionCall(fn, fallbackMessage = "Feature disabled in development") {
      if (isLocalhost()) {
        console.warn("Cloud Function call skipped in localhost:", fn.name);
        return { message: fallbackMessage };
      }
      return await fn();
    }

    // Theme handling is in auth.js

    // Initialize theme system when DOM is loaded (safe loader)
// - Waits briefly for auth.js to define window.initThemeSystem()
// - Never blocks the rest of the page if it isn't present
document.addEventListener('DOMContentLoaded', () => {
  let tries = 0;
  const MAX_TRIES = 150; // ~3 seconds total at 20ms per try

  (function waitForThemeInit() {
    const init = window.initThemeSystem;
    if (typeof init === 'function') {
      try {
        init();
      } catch (e) {
        console.warn('Theme system failed to initialize:', e);
      }
    } else if (tries++ < MAX_TRIES) {
      return setTimeout(waitForThemeInit, 20);
    } else {
      console.warn('initThemeSystem() not found after waiting. Continuing without it.');
    }
  })();

  // Set up edit entry form handler (unchanged)
  const editForm = document.getElementById('editEntryForm');
  if (editForm) {
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const docId = document.getElementById('editEntryId').value;
      const newText = document.getElementById('editEntryText').value;

      try {
        // Check if user is authenticated
        if (!auth.currentUser) {
          throw new Error("User not authenticated");
        }
        
        console.log("🔄 Updating entry:", docId, "by user:", auth.currentUser.uid);
        console.log("📝 New text length:", newText.length);
        
        const entryRef = doc(db, "journalEntries", docId);
        
        // First check if we can read the entry to verify ownership
        console.log("🔍 Checking entry ownership...");
        const entryDoc = await getDoc(entryRef);
        if (!entryDoc.exists()) {
          throw new Error("Entry not found");
        }
        
        const entryData = entryDoc.data();
        console.log("📋 Entry data userId:", entryData.userId, "Current user:", auth.currentUser.uid);
        
        if (entryData.userId !== auth.currentUser.uid) {
          throw new Error("You can only edit your own entries");
        }
        
        console.log("✅ Ownership verified, updating entry...");
        await updateDoc(entryRef, {
          text: newText,
          lastEdited: serverTimestamp()
        });
        
        console.log("✅ Entry updated successfully");
        closeEditModal();
        loadPastEntries(); // Refresh view
        showToast("Entry updated successfully!", "success");
      } catch (err) {
        console.error("Error updating entry:", err);
        console.error("Error code:", err.code);
        console.error("Error message:", err.message);
        showToast(`Failed to update entry: ${err.message}`, "error");
      }
    });
  }
});




// ✅ Unified tab switching — supports Journal, Manifest, Past Entries (CLEAN)
window.showTab = function(tabId) {
  // 🔧 PATCH: support "Past Entries" IDs by aliasing to Calendar tab
  const tabAlias = {
    pastEntriesTab: "calendarTab",
  };
  const buttonAlias = {
    pastEntriesTabButton: "calendarTabButton",
  };

  // Normalize incoming tabId if caller uses "pastEntriesTab"
  if (tabAlias[tabId]) {
    tabId = tabAlias[tabId];
  }

  const tabs = ["journalTab", "manifestTab", "calendarTab"];
  const buttons = {
    journalTab: document.getElementById("journalTabButton"),
    manifestTab: document.getElementById("manifestTabButton"),
    calendarTab:
      document.getElementById("calendarTabButton") ||
      document.getElementById("pastEntriesTabButton"),
  };

  // Hide/show tab content
  tabs.forEach((id) => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === tabId ? "block" : "none");
  });

  // Update active button styling
  Object.values(buttons).forEach(btn => btn && btn.classList.remove("active"));
  if (buttons[tabId]) buttons[tabId].classList.add("active");

  // When opening Manifest, load saved manifest into all textareas
  if (tabId === "manifestTab") {
    // Load from localStorage first (more recent saves)
    const loadedFromLocalStorage = loadManifestData();
    
    // If localStorage didn't have data, try loading from Firestore
    if (!loadedFromLocalStorage && window.currentUserId && typeof getDoc === "function" && typeof doc === "function") {
      console.log("🔄 No localStorage data found, attempting to load from Firestore...");
      
      const manifestInput = document.getElementById("manifestInput");
      const wishInput = document.getElementById("wishInput");
      const outcomeInput = document.getElementById("outcomeInput");
      const oppositionInput = document.getElementById("oppositionInput");
      const planInput = document.getElementById("planInput");
      
      getDoc(doc(window.db, "manifests", window.currentUserId))
        .then(manifestDoc => {
          if (manifestDoc.exists) {
            const data = manifestDoc.data();
            console.log("📋 Loading manifest data from Firestore:", data);
            
           // Populate all 4 text fields from localStorage
if (manifestInput) manifestInput.value = data.statement || "";
if (wishInput) wishInput.value = data.wish || "";
if (outcomeInput) outcomeInput.value = data.outcome || "";
if (oppositionInput) oppositionInput.value = data.opposition || "";
if (planInput) planInput.value = data.plan || "";

// Restore days selector from localStorage
const wishTimelineSelect = document.getElementById("wishTimelineSelect");
if (wishTimelineSelect) {
  const savedDays = localStorage.getItem(`wishTimeline_${currentUserId}`);
  if (savedDays) {
    wishTimelineSelect.value = savedDays;
    // Update the visualization to match
    if (typeof window.updateWishTimeline === "function") {
      setTimeout(() => window.updateWishTimeline(), 50);
    }
  }
}
            
            // Also save to localStorage for next time
            const localStorageData = {
              statement: data.statement || "",
              wish: data.wish || "",
              outcome: data.outcome || "",
              opposition: data.opposition || "",
              plan: data.plan || ""
            };
            localStorage.setItem(`manifest_${window.currentUserId}`, JSON.stringify(localStorageData));
            
            // Ensure start date is set if manifest data exists
            const wishStartKey = `wishStart_${window.currentUserId}`;
            if (!localStorage.getItem(wishStartKey) && (data.wish || data.outcome || data.opposition || data.plan)) {
              localStorage.setItem(wishStartKey, new Date().toISOString());
              console.log("🎯 Set timeline start date for loaded manifest data");
            }
            
            console.log("✅ Manifest loaded from Firestore and saved to localStorage for current user.");
            
            // Show indicator that data was loaded from Firestore
            const manifestSaveStatus = document.getElementById("manifestSaveStatus");
            if (manifestSaveStatus) {
              manifestSaveStatus.innerHTML = "📋 Loaded manifest from cloud";
              manifestSaveStatus.style.color = "#4A8B8B";
              manifestSaveStatus.style.fontStyle = "italic";
              setTimeout(() => {
                manifestSaveStatus.innerHTML = "";
                manifestSaveStatus.style.color = "";
                manifestSaveStatus.style.fontStyle = "";
              }, 3000);
            }
          } else {
            // Clear any Sophy suggestions when loading new data
const manifestSuggestion = document.getElementById("manifestSuggestion");
const wishSuggestion = document.getElementById("wishSuggestion");
const outcomeSuggestion = document.getElementById("outcomeSuggestion");
const oppositionSuggestion = document.getElementById("oppositionSuggestion");
const planSuggestion = document.getElementById("planSuggestion");

if (manifestSuggestion) manifestSuggestion.textContent = "";
if (wishSuggestion) wishSuggestion.textContent = "";
if (outcomeSuggestion) outcomeSuggestion.textContent = "";
if (oppositionSuggestion) oppositionSuggestion.textContent = "";
if (planSuggestion) planSuggestion.textContent = "";
            console.log("ℹ️ No saved manifest in Firestore.");
          }
        })
        .catch(err => console.error("❌ Error loading manifest from Firestore:", err));
    }
    
    // Initialize timeline visualization when manifest tab opens
setTimeout(() => {
  // Restore saved timeline selection first
  const userId = window.currentUserId || window.auth?.currentUser?.uid;
  if (userId) {
    const timelineKey = `wishTimeline_${userId}`;
    const savedDays = localStorage.getItem(timelineKey);
    const timelineSelect = document.getElementById("wishTimelineSelect");
    
    if (savedDays && timelineSelect) {
      console.log(`🎯 Restoring timeline on manifest tab switch: ${savedDays} days`);
      timelineSelect.value = savedDays;
    }
  }
  
  // Then update timeline visualization and progress
  if (typeof window.updateWishTimeline === "function") {
    window.updateWishTimeline();
  }
  if (typeof window.updateWishProgress === "function") {
    window.updateWishProgress();
  }
}, 100);
  }

  // When opening Past Entries (calendarTab), reset panels and build calendar
  if (tabId === "calendarTab") {
    const emptyMsg     = document.getElementById("emptyPastEntriesMessage");
    const pastEntries  = document.getElementById("pastEntries");
    const calEntries   = document.getElementById("calendarEntries");
    const searchResults= document.getElementById("searchResults");

    if (emptyMsg)     emptyMsg.style.display = "none"; // Changed from "block" to "none"
    if (pastEntries)  pastEntries.innerHTML = "";
    if (calEntries)   calEntries.innerHTML = "<p>Click a calendar date to view entries.</p>";
  // Removed default Smart Search hint text

    if (typeof window.buildCalendar === "function") {
      try { window.buildCalendar(); } catch (e) { console.warn("buildCalendar failed:", e); }
    }
  }
};

// Initial hints for the calendar-related areas (safe if elements don’t exist yet)
(() => {
  const emptyMsg = document.getElementById("emptyPastEntriesMessage");
  const pastEntries = document.getElementById("pastEntries");
  const calEntries  = document.getElementById("calendarEntries");
  const searchResults = document.getElementById("searchResults");

  if (emptyMsg)      emptyMsg.style.display = "block";
  if (pastEntries)   pastEntries.innerHTML = "";
  if (calEntries)    calEntries.innerHTML = "<p>Click a calendar date to view entries.</p>";
  // Removed default Smart Search hint text
})();

// ✨ AUTO-RESIZE TEXTAREAS FUNCTIONALITY
function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = Math.max(100, textarea.scrollHeight) + 'px';
}

// Initialize auto-resize for manifest textareas
function initAutoResizeTextareas() {
  const manifestTextareas = [
    'manifestInput',
    'wishInput', 
    'outcomeInput',
    'oppositionInput',
    'planInput'
  ];
  
  manifestTextareas.forEach(id => {
    const textarea = document.getElementById(id);
    if (textarea) {
      // Auto-resize on input
      textarea.addEventListener('input', () => autoResizeTextarea(textarea));
      
      // Auto-resize on paste
      textarea.addEventListener('paste', () => {
        setTimeout(() => autoResizeTextarea(textarea), 10);
      });
      
      // Initial resize for pre-existing content
      setTimeout(() => autoResizeTextarea(textarea), 100);
    }
  });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initAutoResizeTextareas);

// Also reinitialize when manifest tab is opened
const originalShowTab = window.showTab;
window.showTab = function(tabId) {
  originalShowTab(tabId);
  
  // If switching to manifest tab, ensure textareas are properly sized
  if (tabId === 'manifestTab') {
    setTimeout(initAutoResizeTextareas, 200);
  }
};


// Handle embedded agreement button logic
window.acceptEmbeddedAgreement = async function () {
  const embeddedCheckbox = document.getElementById("embeddedAgreementCheckbox");
  const acceptEmbeddedBtn = document.getElementById("acceptEmbeddedAgreementButton");

  if (!embeddedCheckbox.checked || !window.currentUserId) return;

  try {
    localStorage.setItem("alphaAgreementAccepted", "true");

    await setDoc(doc(db, "users", window.currentUserId), {
      agreementAccepted: true
    }, { merge: true });

    {
      const el = document.getElementById("embeddedAgreementNotice");
      if (el) el.style.display = "none";
    }

    document.getElementById("journalTab").style.display = "block";
    document.getElementById("tabButtons").style.display = "flex";
    document.querySelector("main").style.display = "block";
  } catch (err) {
    showToast("Error saving agreement: " + err.message, "error");
    console.error("Detailed agreement save error:", err);
  }
};


// Enable the Accept button only when checkbox is checked
document.addEventListener("DOMContentLoaded", () => {
  const embeddedCheckbox = document.getElementById("embeddedAgreementCheckbox");
  const acceptEmbeddedBtn = document.getElementById("acceptEmbeddedAgreementButton");

  embeddedCheckbox?.addEventListener("change", () => {
    acceptEmbeddedBtn.disabled = !embeddedCheckbox.checked;
  });

  // Disable search button by default (safer inside DOMContentLoaded)
  const searchBtn = document.getElementById("searchBtn");
  const searchQuery = document.getElementById("searchQuery");
  
  if (searchBtn) searchBtn.disabled = true;
  
  // Enable search button when user types in search query
  if (searchQuery && searchBtn) {
    searchQuery.addEventListener("input", () => {
      const hasText = searchQuery.value.trim().length > 0;
      searchBtn.disabled = !hasText;
    });
    
    // Allow Enter key to trigger search
    searchQuery.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !searchBtn.disabled) {
        runSmartSearch();
      }
    });
  }

  // Add Enter key support for all Sophy functions
  
  // Journal Tab - Ask Sophy for Prompt
  const promptTopic = document.getElementById("promptTopic");
  if (promptTopic) {
    promptTopic.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && promptTopic.value.trim().length > 0) {
        e.preventDefault(); // Prevent form submission if in a form
        generatePrompt();
      }
    });
  }

  // Journal Tab - Ask Sophy for Reflection  
  const journal = document.getElementById("journal");
  if (journal) {
    journal.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && e.ctrlKey && journal.value.trim().length > 0) {
        e.preventDefault(); // Prevent newline when Ctrl+Enter
        askSophyToReflect();
      }
    });
  }

  // Manifest Tab - Refine Wish with Sophy
  const wishInput = document.getElementById("wishInput");
  if (wishInput) {
    wishInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && e.ctrlKey && wishInput.value.trim().length > 0) {
        e.preventDefault();
        askSophyToRefine('wish');
      }
    });
  }

  // Manifest Tab - Refine Imagine with Sophy
  const outcomeInput = document.getElementById("outcomeInput");
  if (outcomeInput) {
    outcomeInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && e.ctrlKey && outcomeInput.value.trim().length > 0) {
        e.preventDefault();
        askSophyToRefine('outcome');
      }
    });
  }

  // Manifest Tab - Refine Snags with Sophy
  const oppositionInput = document.getElementById("oppositionInput");
  if (oppositionInput) {
    oppositionInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && e.ctrlKey && oppositionInput.value.trim().length > 0) {
        e.preventDefault();
        askSophyToRefine('opposition');
      }
    });
  }

  // Manifest Tab - Refine How with Sophy
  const planInput = document.getElementById("planInput");
  if (planInput) {
    planInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && e.ctrlKey && planInput.value.trim().length > 0) {
        e.preventDefault();
        askSophyToRefine('plan');
      }
    });
  }
});

// Authentication now handled by auth.js - currentUserId is available as window.currentUserId

  setTimeout(() => showTab('journalTab'), 20);

// Coach reply checking moved to auth.js

window.onload = function () {
  // === InkOutLoud Voice Input Integration ===
  const voiceBtn = document.getElementById("voiceBtn");
  const voiceStatus = document.getElementById("voiceStatus");
  const journalEntry = document.getElementById("journal");

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    if (voiceBtn) voiceBtn.disabled = true;
    if (voiceStatus) voiceStatus.textContent = "InkOutLoud requires Chrome or Edge.";
  } else {
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    let isListening = false;
    let stopTimeout = null;

    recognition.onstart = () => {
      if (voiceStatus) voiceStatus.textContent = "🎤 Listening... Tap again to stop.";
      if (voiceBtn) voiceBtn.textContent = "🛑 Stop InkOutLoud";
    };

    recognition.onresult = async (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript;
      if (voiceStatus) voiceStatus.textContent = "🧠 Cleaning up your voice entry...";

      try {
        const user = auth?.currentUser;
        if (!user) {
          console.warn("User not signed in. Cannot clean transcript.");
          if (voiceStatus) voiceStatus.textContent = "⚠️ You must be logged in to use voice journaling.";
          return;
        }

        const idToken = await user.getIdToken();

        // 📝 Call the correct cleanVoiceTranscript endpoint
        const cleanEndpoint = location.hostname === 'localhost' 
          ? 'http://localhost:5001/inkwell-alpha/us-central1/cleanVoiceTranscript'
          : 'https://us-central1-inkwell-alpha.cloudfunctions.net/cleanVoiceTranscript';
        const response = await fetch(cleanEndpoint, {
           method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${idToken}`
          },
          body: JSON.stringify({ 
            transcript: transcript
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        if (data.cleanedText) {
          const journalEntry = document.getElementById("journal");
          if (journalEntry) {
            journalEntry.value += (journalEntry.value ? " " : "") + data.cleanedText;
          }
          if (voiceStatus) voiceStatus.textContent = "✅ Voice entry added.";
        } else {
          throw new Error("No cleaned text received.");
        }
      } catch (err) {
        console.error("🛑 Error cleaning voice transcript:", err);
        if (voiceStatus) voiceStatus.textContent = "❌ Failed to clean voice input.";
      }
    };

    recognition.onerror = (event) => {
      if (voiceStatus) voiceStatus.textContent = "❌ Error: " + event.error;
    };

    recognition.onend = () => {
      if (isListening) {
        recognition.start(); // Auto-restart if session ends prematurely
      }
    };

    if (voiceBtn) {
      voiceBtn.onclick = () => {
        if (!isListening) {
          recognition.start();
          isListening = true;
          voiceBtn.textContent = "🛑 Stop InkOutLoud";

          stopTimeout = setTimeout(() => {
            recognition.stop();
            isListening = false;
            voiceBtn.textContent = "🎙️ InkOutLoud";
          }, 90000); // 90 seconds
        } else {
          recognition.stop();
          isListening = false;
          voiceBtn.textContent = "🎙️ InkOutLoud";
          if (stopTimeout) clearTimeout(stopTimeout);
        }
      };
    }
  }
  window.saveJournalEntry = async function () {
    const textarea = document.getElementById("journal");
    const text = textarea.value.trim();
    
    // Get current user ID - check multiple sources
    const currentUserId = window.currentUserId || window.auth?.currentUser?.uid;
    if (!currentUserId) {
      showToast("User not authenticated. Please log in again.", "error");
      return;
    }
    
   const finalText = text;
    if (!text) {
      const saveStatus = document.getElementById("saveStatus");
      saveStatus.innerHTML = "⚠️ Please enter something before saving";
      saveStatus.style.color = "#D4A574";
      setTimeout(() => {
        saveStatus.innerHTML = "";
        saveStatus.style.color = "";
      }, 3000);
      return;
    }
    showSpinner("saveStatus", "Saving entry...");

    try {
      // Multiple file upload support
      const fileInput = document.getElementById("attachment");
      const files = Array.from(fileInput.files || []);
      const maxFileSizeMB = 10;
      const previewDiv = document.getElementById("attachmentPreview");
      previewDiv.innerHTML = ""; // Clear previous preview

      // Validate all files for size
      for (const file of files) {
        if (file && file.size > maxFileSizeMB * 1024 * 1024) {
          const saveStatus = document.getElementById("saveStatus");
          saveStatus.innerHTML = `⚠️ File "${file.name}" is too large (max ${maxFileSizeMB}MB)`;
          saveStatus.style.color = "#D4A574";
          setTimeout(() => {
            saveStatus.innerHTML = "";
            saveStatus.style.color = "";
          }, 4000);
          return;
        }
      }

      // Preview all files
      for (const file of files) {
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.alt = file.name;
            img.style.maxWidth = "100px";
            img.style.marginRight = "10px";
            img.style.borderRadius = "5px";
            previewDiv.appendChild(img);
          };
          reader.readAsDataURL(file);
        } else {
          const span = document.createElement("span");
          span.textContent = file.name;
          span.style.display = "inline-block";
          span.style.padding = "0.5em";
          span.style.background = "#eee";
          span.style.borderRadius = "5px";
          previewDiv.appendChild(span);
        }
      }

      // Upload all files via Cloud Function instead of direct Storage access
      let attachments = [];
      for (const file of files) {
        try {
          // Create FormData for file upload
          const formData = new FormData();
          formData.append('file', file);
          
          // Get auth token
          if (!window.auth?.currentUser) {
            throw new Error("User not authenticated for file upload");
          }
          const idToken = await window.auth.currentUser.getIdToken();
          
          // Upload via Cloud Function
          const endpoint = location.hostname === "localhost"
            ? "http://localhost:5001/inkwell-alpha/us-central1/uploadFile"
            : "https://us-central1-inkwell-alpha.cloudfunctions.net/uploadFile";
          
          const uploadResponse = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${idToken}`
            },
            body: formData
          });
          
          if (!uploadResponse.ok) {
            throw new Error(`Upload failed: ${uploadResponse.statusText}`);
          }
          
          const uploadResult = await uploadResponse.json();
          attachments.push({ url: uploadResult.url, name: uploadResult.name });
          
        } catch (uploadError) {
          console.error("File upload error:", uploadError);
          // Continue without this file attachment - show subtle warning
          const saveStatus = document.getElementById("saveStatus");
          if (saveStatus) {
            const currentText = saveStatus.innerHTML;
            saveStatus.innerHTML = `⚠️ ${file.name} upload failed, saving without file`;
            saveStatus.style.color = "#D4A574";
            setTimeout(() => {
              saveStatus.innerHTML = currentText;
              saveStatus.style.color = "#4A8B8B";
            }, 3000);
          }
        }
      }

      const tagsInput = document.getElementById("tags")?.value.trim?.() || "";
      const tags = tagsInput ? tagsInput.split(",").map(tag => tag.trim()) : [];

      // Check for manifest data in the manifest tab fields and auto-include if present
      const wishText = document.getElementById("wishInput")?.value.trim() || "";
      const outcomeText = document.getElementById("outcomeInput")?.value.trim() || "";
      const oppositionText = document.getElementById("oppositionInput")?.value.trim() || "";
      const planText = document.getElementById("planInput")?.value.trim() || "";
      
      // If any manifest fields have content, automatically include manifest data
      const hasManifestData = wishText || outcomeText || oppositionText || planText;
      
      // Build entryData, use attachments array if present
      const entryData = {
        text: finalText,
        createdAt: new Date(),
        userId: currentUserId,
        tags
      };
      
      // Auto-include manifest data if any fields are filled
      if (hasManifestData) {
        const manifestData = {
          wish: wishText,
          outcome: outcomeText,
          opposition: oppositionText,
          plan: planText
        };
        
        entryData.manifestData = manifestData;
        entryData.contextManifest = `${wishText} | ${outcomeText} | ${oppositionText} | ${planText}`;
        
        // Add manifest-specific tags
        tags.push("manifest", "manifesting");
        const today = new Date().toISOString().split("T")[0];
        tags.push(`manifestDate:${today}`);
        
        console.log("✨ Auto-included manifest data from fields:", manifestData);
      }
      
      if (attachments.length > 0) {
        entryData.attachments = attachments;
      }

// Clear Ask Sophy for Prompt fields
const promptTopic = document.getElementById("promptTopic");
if (promptTopic) {
  promptTopic.value = "";
}

const generatedPrompt = document.getElementById("generatedPrompt");
if (generatedPrompt) {
  generatedPrompt.textContent = "";
}

      // Stricter prompt extraction and validation
      const promptElement = document.getElementById("generatedPrompt");
      const promptText = promptElement?.textContent?.trim();

      const isValidPrompt =
        promptText &&
        promptText.toLowerCase() !== "undefined" &&
        promptText.toLowerCase() !== "sophy is thinking..." &&
        promptText.length > 5;

      if (document.getElementById("autoInsertPrompt")?.checked && isValidPrompt) {
        entryData.promptUsed = promptText;
      } else if (document.getElementById("autoInsertPrompt")?.checked) {
        console.log("ℹ️ No valid Sophy prompt to save — continuing without one.");
      }

      // Save Sophy's reflection data if available
      const reflectionElement = document.getElementById("sophyInsight");
      const reflectionText = reflectionElement?.textContent?.trim();
      
      const isValidReflection = 
        reflectionText &&
        reflectionText.toLowerCase() !== "undefined" &&
        reflectionText.toLowerCase() !== "sophy is thinking..." &&
        reflectionText.toLowerCase() !== "please write something in your journal first." &&
        reflectionText.toLowerCase() !== "sorry, sophy couldn't reflect right now." &&
        reflectionText.length > 5;

      if (isValidReflection) {
        entryData.reflectionUsed = reflectionText;
      }

      if (document.getElementById("coachReviewCheckbox")?.checked) {
        entryData.coachReview = true;
      }
      if (document.getElementById("postSaveActions")?.checked) {
        entryData.maybeReviewLater = true;
      }
      if (journalMode === "manifest") {
        tags.push("manifest");
        const manifestText = document.getElementById("manifestInput")?.value?.trim() || "";
        const today = new Date().toISOString().split("T")[0];
        tags.push(`manifestDate:${today}`);
        entryData.contextManifest = manifestText;
      }
      // Add to Firestore and get the new doc ref
      // Always set userId field, and ensure queries always filter by userId
      console.log("Attachments array about to be saved:", attachments);
      console.log("entryData about to be saved:", entryData);
      console.log("🧪 FINAL entryData before saving:", entryData);
      const docRef = await addDoc(collection(db, "journalEntries"), entryData);
      console.log("📘 Created entry ID:", docRef.id);
      
      // Update spinner with progress
      showSpinner("saveStatus", "Processing...");
      
      if (entryData.coachReview) {
        try {
          console.log("📨 Notifying coach with entryId:", docRef.id);
          showSpinner("saveStatus", "Notifying practitioner...");

          // Start coach notification as non-blocking operation
          const coachNotification = (async () => {
            try {
              const idToken = await auth.currentUser.getIdToken(true);
              const endpoint = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
                ? "http://localhost:5001/inkwell-alpha/us-central1/notifyCoachOfTaggedEntry"
                : "https://us-central1-inkwell-alpha.cloudfunctions.net/notifyCoachOfTaggedEntry";

              const payload = {
                entryId: docRef.id,
                userId: currentUserId,
                isManifest: hasManifestData // Set based on whether manifest data was included
              };

              const response = await fetch(endpoint, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${idToken}`
                },
                body: JSON.stringify(payload)
              });

              if (!response.ok) {
                console.error("❌ Coach notify failed", response.status);
                return false;
              } else {
                console.log("📬 Coach notify OK");
                return true;
              }
            } catch (notifyErr) {
              console.error("❌ Coach notification threw:", notifyErr);
              return false;
            }
          })();

          // Wait for coach notification to complete
          const notificationSuccess = await coachNotification;
          
          const saveStatus = document.getElementById("saveStatus");
          if (saveStatus) {
            if (notificationSuccess) {
              saveStatus.innerHTML = "✅ Entry saved • Coach notified";
              saveStatus.style.color = "#4A8B8B";
            } else {
              saveStatus.innerHTML = "✅ Entry saved • Coach notification pending";
              saveStatus.style.color = "#D4A574";
            }
          }
          console.log("📬 Entry saved with coach review flag.");
          
        } catch (outerErr) {
          console.error("❌ Coach notification section failed:", outerErr);
          const saveStatus = document.getElementById("saveStatus");
          if (saveStatus) {
            saveStatus.innerHTML = "✅ Entry saved • Coach notification failed";
            saveStatus.style.color = "#D4A574";
          }
        }
      } else {
        // Non-coach entries: show immediate success
        const saveStatus = document.getElementById("saveStatus");
        if (saveStatus) {
          saveStatus.innerHTML = "✅ Entry saved";
          saveStatus.style.color = "#4A8B8B";
        }
      }

      // Call embedding function as background operation (non-blocking)
      const embeddingOperation = (async () => {
        try {
          const token = await auth.currentUser.getIdToken(true);
          await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/embedAndStoreEntry", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ text: finalText, entryId: docRef.id })
          });
        } catch (embedErr) {
          console.warn("Embedding error (non-blocking):", embedErr);
        }
      })();

      // Start embedding in background - don't wait for it
      embeddingOperation;

      // Show final saved confirmation (only if not already set by coach notification)
      setTimeout(() => {
        const saveStatus = document.getElementById("saveStatus");
        if (saveStatus && !saveStatus.innerHTML.includes("Coach")) {
          saveStatus.innerHTML = "✅ Saved!";
          saveStatus.style.color = "#4A8B8B";
          saveStatus.style.fontWeight = "500";
        }
      }, 100);
      
      setTimeout(() => {
        const saveStatus = document.getElementById("saveStatus");
        if (saveStatus) {
          saveStatus.innerHTML = "";
          saveStatus.style.color = "";
          saveStatus.style.fontWeight = "";
        }
      }, 3000);
      document.getElementById("entryStatus").textContent = "Great work! You’ve added another reflection to your journey.";
      // Flash confirmation animation on textarea
      textarea.classList.add("flash-confirmation");
      setTimeout(() => textarea.classList.remove("flash-confirmation"), 1000);
      
      // Show success toast notification
      const toastMessage = hasManifestData 
        ? "✨ Journal entry saved with manifest data!" 
        : "✨ Journal entry saved successfully!";
      window.showToast(toastMessage, "success", 4000);
      // Add inline status message (like Save My WISH style)
      const saveStatus = document.getElementById("saveStatus");
      if (saveStatus) {
        const statusMessage = hasManifestData 
          ? "✅ Journal entry saved with manifest data!" 
          : "✅ Journal entry saved successfully!";
        saveStatus.innerHTML = statusMessage;
        saveStatus.style.color = "#4A8B8B";
        saveStatus.style.fontWeight = "500";
        
        // Clear the message after 4 seconds (same duration as toast)
        setTimeout(() => {
          saveStatus.innerHTML = "";
          saveStatus.style.color = "";
          saveStatus.style.fontWeight = "";
        }, 4000);
      }


      // Refresh calendar to show new entry date highlight
      if (typeof window.buildCalendar === "function") {
        try { 
          window.buildCalendar(); 
          console.log("📅 Calendar refreshed after journal entry save");
        } catch (e) { 
          console.warn("buildCalendar refresh failed:", e); 
        }
      }

      // Save manifest data to localStorage if it was auto-included
      if (hasManifestData && currentUserId) {
        const manifestData = {
          wish: wishText,
          outcome: outcomeText,
          opposition: oppositionText,
          plan: planText
        };
        localStorage.setItem(`manifest_${currentUserId}`, JSON.stringify(manifestData));
        console.log("💾 Auto-saved manifest data to localStorage for user:", currentUserId);
      }

      textarea.value = "";
      fileInput.value = "";
      previewDiv.innerHTML = "";
      if (document.getElementById("tags")) document.getElementById("tags").value = "";
      
      // Clear Sophy reflection content and success message
      const sophyInsight = document.getElementById("sophyInsight");
      if (sophyInsight) {
        sophyInsight.textContent = "";
      }
      
      // Clear the entry status message that shows "Great work! You've added another reflection..."
      const entryStatus = document.getElementById("entryStatus");
      if (entryStatus) {
        entryStatus.textContent = "";
      }
      
      // Uncheck the auto-insert checkboxes
      const autoInsertPrompt = document.getElementById("autoInsertPrompt");
      if (autoInsertPrompt) {
        autoInsertPrompt.checked = false;
      }
      const autoInsertReflection = document.getElementById("autoInsertReflection");
      if (autoInsertReflection) {
        autoInsertReflection.checked = false;
      }
      
      // Uncheck the coach review checkbox
      const coachReviewCheckbox = document.getElementById("coachReviewCheckbox");
      if (coachReviewCheckbox) {
        coachReviewCheckbox.checked = false;
      }
    } catch (e) {
      console.error("Error saving entry: ", e);
      const saveStatus = document.getElementById("saveStatus");
      if (saveStatus) {
        saveStatus.innerHTML = "❌ Save failed.";
        setTimeout(() => saveStatus.innerHTML = "", 4000);
      }
    }
  };
};

// Function to replace journal content with Sophy's reflection
window.replaceJournalWithReflection = function() {
  const journalTextarea = document.getElementById("journal");
  const sophyInsightDiv = document.getElementById("sophyInsight");
  
  if (!journalTextarea || !sophyInsightDiv) {
    console.error("Could not find journal textarea or Sophy insight div");
    return;
  }
  
  const sophyText = sophyInsightDiv.textContent?.trim();
  if (!sophyText || sophyText === "Thinking...") {
    alert("No reflection available to use. Please ask Sophy for a reflection first.");
    return;
  }
  
  // Replace the journal content with Sophy's reflection
  journalTextarea.value = sophyText;
  
  // Flash the textarea to show the change
  journalTextarea.classList.add("flash-confirmation");
  setTimeout(() => journalTextarea.classList.remove("flash-confirmation"), 1000);
  
  // Show confirmation message
  const entryStatus = document.getElementById("entryStatus");
  if (entryStatus) {
    entryStatus.textContent = "✨ Journal replaced with Sophy's reflection!";
    setTimeout(() => entryStatus.textContent = "", 3000);
  }
};

// Load saved manifest data for the current user
window.loadManifestData = function() {
  const currentUserId = window.currentUserId || window.auth?.currentUser?.uid;
  if (!currentUserId) {
    console.log("No user authenticated, skipping manifest data load");
    return;
  }
  
  try {
    const savedManifest = localStorage.getItem(`manifest_${currentUserId}`);
    if (savedManifest) {
      const manifestData = JSON.parse(savedManifest);
      
      // Populate the manifest fields
      const manifestInput = document.getElementById("manifestInput"); // Legacy field
      const wishInput = document.getElementById("wishInput");
      const outcomeInput = document.getElementById("outcomeInput");
      const oppositionInput = document.getElementById("oppositionInput");
      const planInput = document.getElementById("planInput");
      
      if (manifestInput && manifestData.statement) manifestInput.value = manifestData.statement;
      if (wishInput && manifestData.wish) wishInput.value = manifestData.wish;
      if (outcomeInput && manifestData.outcome) outcomeInput.value = manifestData.outcome;
      if (oppositionInput && manifestData.opposition) oppositionInput.value = manifestData.opposition;
      if (planInput && manifestData.plan) planInput.value = manifestData.plan;
      
      console.log("✅ Loaded saved manifest data from localStorage for user:", currentUserId);
      
      // Ensure start date is set if manifest data exists
      const wishStartKey = `wishStart_${currentUserId}`;
      if (!localStorage.getItem(wishStartKey) && (manifestData.wish || manifestData.outcome || manifestData.opposition || manifestData.plan)) {
        localStorage.setItem(wishStartKey, new Date().toISOString());
        console.log("🎯 Set timeline start date for localStorage manifest data");
      }
      
      // Show a subtle indicator that data was loaded
      const manifestSaveStatus = document.getElementById("manifestSaveStatus");
      if (manifestSaveStatus) {
        manifestSaveStatus.innerHTML = "📋 Loaded saved manifest";
        manifestSaveStatus.style.color = "#4A8B8B";
        manifestSaveStatus.style.fontStyle = "italic";
        setTimeout(() => {
          manifestSaveStatus.innerHTML = "";
          manifestSaveStatus.style.color = "";
          manifestSaveStatus.style.fontStyle = "";
        }, 3000);
      }
      return true; // Indicate that data was loaded from localStorage
    } else {
      console.log("ℹ️ No manifest data in localStorage for user:", currentUserId);
      return false; // Indicate that no data was found in localStorage
    }
  } catch (error) {
    console.error("Error loading manifest data from localStorage:", error);
    return false;
  }
};

// Clear manifest data for current user
window.clearManifestData = function() {
  const currentUserId = window.currentUserId || window.auth?.currentUser?.uid;
  if (!currentUserId) return;
  
  localStorage.removeItem(`manifest_${currentUserId}`);
  
  // Clear the form fields
  const manifestInput = document.getElementById("manifestInput"); // Legacy field
  const wishInput = document.getElementById("wishInput");
  const outcomeInput = document.getElementById("outcomeInput");
  const oppositionInput = document.getElementById("oppositionInput");
  const planInput = document.getElementById("planInput");
  
  if (manifestInput) manifestInput.value = "";
  if (wishInput) wishInput.value = "";
  if (outcomeInput) outcomeInput.value = "";
  if (oppositionInput) oppositionInput.value = "";
  if (planInput) planInput.value = "";
  
// Clear all Sophy suggestion boxes
const manifestSuggestion = document.getElementById("manifestSuggestion");
const wishSuggestion = document.getElementById("wishSuggestion");
const outcomeSuggestion = document.getElementById("outcomeSuggestion");
const oppositionSuggestion = document.getElementById("oppositionSuggestion");
const planSuggestion = document.getElementById("planSuggestion");

if (manifestSuggestion) manifestSuggestion.textContent = "";
if (wishSuggestion) wishSuggestion.textContent = "";
if (outcomeSuggestion) outcomeSuggestion.textContent = "";
if (oppositionSuggestion) oppositionSuggestion.textContent = "";
if (planSuggestion) planSuggestion.textContent = "";

  console.log("✅ Cleared manifest data for user:", currentUserId);
  // Also clear progress tracking
  const wishStartKey = `wishStart_${currentUserId}`;
  localStorage.removeItem(wishStartKey);

  // Hide progress bar
  const progressBar = document.getElementById("wishProgressBar");
  if (progressBar) {
    progressBar.style.display = "none";
  }

  // Show confirmation
  const manifestSaveStatus = document.getElementById("manifestSaveStatus");
  if (manifestSaveStatus) {
    manifestSaveStatus.innerHTML = "✨ Ready for your next WISH";
    manifestSaveStatus.style.color = "#2A6972";
    setTimeout(() => {
      manifestSaveStatus.innerHTML = "";
      manifestSaveStatus.style.color = "";
    }, 2000);
  }
};



    async function generatePrompt() {
      // Get elements with null checking
      const topicInputElement = document.getElementById("promptTopic");
      const manifestInputElement = document.getElementById("manifestInput");
      const promptElement = document.getElementById("generatedPrompt");
      
      // Show "Sophy is thinking..." immediately
      if (promptElement) {
        promptElement.textContent = "Sophy is thinking...";
        promptElement.style.color = "#FDF7F1";
        promptElement.style.fontStyle = "italic";
      }
      
      // Safely get values with fallbacks
      const topicInput = topicInputElement ? topicInputElement.value.trim() : "";
      const manifestText = manifestInputElement ? manifestInputElement.value.trim() : "";
      let topic = topicInput;

      if (journalMode === "manifest") {
        if (topicInput && manifestText) {
          topic = `My manifest is: "${manifestText}". Please base the prompt on this and also consider: "${topicInput}".`;
        } else if (manifestText) {
          topic = `Please generate a prompt based on my Manifest Statement: "${manifestText}"`;
        } else {
          topic = topicInput || "manifesting";
        }
      }
      try {
        // Occasionally include username for personalization (25% chance)
        let payload = { topic };
        if (Math.random() < 0.25) {
          const userName = await getCurrentUserName();
          if (userName) {
            payload.userName = userName;
          }
        }
        
        // 🔐 SECURITY FIX: Use authenticated request
        const data = await secureAIFetch(
          "https://us-central1-inkwell-alpha.cloudfunctions.net/generatePrompt",
          payload
        );
        
        const prompt = data.prompt?.trim() || "Sorry, couldn't generate a prompt right now.";
        if (promptElement) {
          promptElement.textContent = prompt;
          promptElement.style.fontStyle = "normal";
        }
        const autoInsertCheckbox = document.getElementById("autoInsertPrompt");
        if (autoInsertCheckbox) autoInsertCheckbox.checked = true;
      } catch (e) {
        console.error("Generate prompt error:", e);
        if (promptElement) {
          if (isLocalhost()) {
            promptElement.textContent = "💻 AI prompts are not available in development mode. Try writing your own prompt!";
          } else {
            // Use the specific error message from the API if available
            promptElement.textContent = e.message.includes("authenticated") 
              ? "Please log in to use AI features."
              : e.message || "Sorry, something went wrong fetching the prompt.";
          }
          promptElement.style.fontStyle = "normal";
        }
      }
    }

    // --- SMART SEARCH LOGIC ---
    // Updated to use Anthropic-based semantic search instead of OpenAI embeddings
    async function runSmartSearch() {
      const queryText = document.getElementById("searchQuery").value.trim();
      const resultsContainer = document.getElementById("searchResults");
      const searchBtn = document.getElementById("searchBtn");
      
      // Show loading state
      if (searchBtn) {
        searchBtn.disabled = true;
        searchBtn.textContent = "Searching...";
      }
      
      if (window.showSpinner) {
        showSpinner("searchResults", "🔍 Searching your journal entries...");
      } else {
        resultsContainer.innerHTML = "<p>🔍 Searching your journal entries...</p>";
      }
      
      const user = window.auth?.currentUser;
      if (!queryText) {
        resultsContainer.innerHTML = "<p>Please enter a search phrase.</p>";
        resetSearchButton();
        return;
      }
      if (!user) {
        resultsContainer.innerHTML = "<p>You must be logged in to use Smart Search.</p>";
        resetSearchButton();
        return;
      }

      try {
        console.log("🔍 Starting semantic search for:", queryText);
        
        // Get the authentication token
        const idToken = await user.getIdToken();

        // Log the search query
        try {
          await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/logSearchQuery", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${idToken}`,
            },
            body: JSON.stringify({ query: queryText })
          });
        } catch (logErr) {
          console.warn("Failed to log search query:", logErr);
          // Continue with search even if logging fails
        }

        console.log("🧠 Using Anthropic for semantic search...");
        
        // Use new semantic search function
        const searchResp = await fetch("https://us-central1-inkwell-alpha.cloudfunctions.net/semanticSearch", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${idToken}`
          },
          body: JSON.stringify({ query: queryText })
        });
        
        if (!searchResp.ok) {
          throw new Error(`Search failed: ${searchResp.status} ${searchResp.statusText}`);
        }
        
        const searchResult = await searchResp.json();
        const entries = searchResult.results || [];
        
        console.log(`📊 Found ${entries.length} relevant entries`);
        
        if (entries.length === 0) {
          resultsContainer.innerHTML = "<p>No relevant entries found for your search. Try different keywords or write more journal entries!</p>";
          resetSearchButton();
          return;
        }
        
        // Clear search results container and use past entries container instead
        resultsContainer.innerHTML = "";
        
        // Clear calendar entries when showing search results  
        const calendarEntriesElement = document.getElementById("calendarEntries");
        if (calendarEntriesElement) calendarEntriesElement.innerHTML = "";
        
        // Use the past entries container for consistent display
        const pastEntriesContainer = document.getElementById("pastEntries");
        if (!pastEntriesContainer) {
          console.error("❌ Past entries container not found");
          resetSearchButton();
          return;
        }
        
        // Show search header in results container
        resultsContainer.innerHTML = `<h4 style="margin-bottom: 1em; color: var(--brand-primary);">� Found ${entries.length} relevant entries:</h4>`;
        
        // Clear past entries container
        pastEntriesContainer.innerHTML = "";
        
        // Create the same container structure as showPromptsByDate for consistent width
        const container = document.createElement("div");
        container.className = "entries-container";
        container.style.cssText = `
          display: flex;
          flex-direction: column;
          gap: 1em;
          width: 100%;
          box-sizing: border-box;
          padding: 0 0.5em;
          max-width: 100%;
          overflow-x: hidden;
        `;

        // Fetch full entry data for each search result
        for (const entry of entries) {
          if (!entry.text || entry.text.trim() === "") continue;
          
          try {
            // Get the full entry data from Firestore using the entry ID
            const docRef = window.doc(window.db, "journalEntries", entry.id);
            const docSnap = await window.getDoc(docRef);
            
            if (docSnap.exists()) {
              const fullData = docSnap.data();
              const fullEntry = {
                id: entry.id,
                text: fullData.text,
                contextManifest: fullData.contextManifest,
                manifestData: fullData.manifestData,
                reflectionNote: fullData.reflectionNote,
                reflectionUsed: fullData.reflectionUsed,
                coachResponse: fullData.coachResponse,
                promptUsed: fullData.promptUsed || "",
                tags: fullData.tags || [],
                attachments: fullData.attachments || [],
                newCoachReply: fullData.newCoachReply || false,
                createdAt: fullData.createdAt?.toDate?.() || new Date()
              };
              
              // Use the exact same function as calendar date clicks
              const card = window.createPastEntryCard(fullEntry);
              container.appendChild(card);
              console.log("✅ Created search result card using full Firestore data for:", entry.id);
            } else {
              console.warn("Entry not found in Firestore:", entry.id);
            }
          } catch (error) {
            console.error("Error fetching full entry data:", error);
          }
        }

        pastEntriesContainer.appendChild(container);
        
        // Hide empty message and clear past entries
        const emptyMsg = document.getElementById("emptyPastEntriesMessage");
        if (emptyMsg) emptyMsg.style.display = "none";

        // Clear calendar entries container when showing search results
        const calendarEntries = document.getElementById("calendarEntries");
        if (calendarEntries) calendarEntries.innerHTML = "";
        
        console.log("✅ Semantic search completed successfully");
        
      } catch (err) {
        console.error("❌ Semantic search error:", err);
        resultsContainer.innerHTML = `
          <div style="color: #D32F2F; padding: 1em; background: #FFEBEE; border-radius: 4px;">
            <strong>Search Error:</strong> ${err.message}<br>
            <small>Please try again or check your connection.</small>
          </div>`;
      } finally {
        resetSearchButton();
      }
      
      function resetSearchButton() {
        if (searchBtn) {
          searchBtn.disabled = false;
          searchBtn.textContent = "Search";
        }
      }
    }
    window.runSmartSearch = runSmartSearch;

    // Toggle functions for dropdown content in search results
    window.toggleManifest = function(entryId) {
      const content = document.getElementById(`manifest-${entryId}`);
      const button = content.previousElementSibling;
      if (content.style.display === "none") {
        content.style.display = "block";
        button.textContent = "📜 Hide Manifest";
      } else {
        content.style.display = "none";
        button.textContent = "📜 Show Manifest";
      }
    };

    window.togglePrompt = function(entryId) {
      const content = document.getElementById(`prompt-${entryId}`);
      const button = content.previousElementSibling;
      if (content.style.display === "none") {
        content.style.display = "block";
        button.textContent = "📝 Hide Prompt";
      } else {
        content.style.display = "none";
        button.textContent = "📝 Show Prompt";
      }
    };

    window.toggleReflection = function(entryId) {
      const content = document.getElementById(`reflection-${entryId}`);
      const button = content.previousElementSibling;
      if (content.style.display === "none") {
        content.style.display = "block";
        button.textContent = "💭 Hide Reflection";
      } else {
        content.style.display = "none";
        button.textContent = "💭 Show Reflection";
      }
    };


   async function loadPastEntries() {
    console.log("🚀 === LOADPASTENTRIES FUNCTION CALLED ===");
    console.trace("⚠️ loadPastEntries() was called!");

    // 🛡️ GUARD: Only load past entries if the calendar tab is actually visible
    const calendarTab = document.getElementById("calendarTab");
    if (!calendarTab || calendarTab.style.display === "none") {
      console.log("🚫 Calendar tab not visible, skipping loadPastEntries()");
      return;
    }

      console.log("✅ Calendar tab is visible, proceeding with loadPastEntries");
      const pastEntriesContainer = document.getElementById("pastEntries");
      
      // Check if we're on localhost - show development message
      if (isLocalhost()) {
        pastEntriesContainer.innerHTML = `
          <div style="text-align: center; padding: 2em; color: var(--info-muted);">
            <h3>🚧 Development Mode</h3>
            <p>Past entries are not available in localhost development mode.</p>
            <p>This feature requires a live Firebase connection.</p>
            <p><small>To test this feature, deploy to a live environment or use the Firebase emulator suite.</small></p>
          </div>
        `;
        return;
      }

      pastEntriesContainer.innerHTML = "<p>Loading entries...</p>";
      
      // Ensure Firebase is properly initialized
      if (!window.db || !window.currentUserId) {
        pastEntriesContainer.innerHTML = "<p>Please log in to view your entries.</p>";
        return;
      }

      const entriesRef = collection(db, "journalEntries");
      const q = query(entriesRef, where("userId", "==", currentUserId), orderBy("createdAt", "desc"));
      let snapshot;
      try {
        snapshot = await getDocs(q);
        console.log("📥 Query successful, found", snapshot.size, "entries");
      } catch (e) {
        pastEntriesContainer.innerHTML = "<p>We’re setting things up behind the scenes. This feature will be available shortly — please check back soon.</p>";
        return;
      }
      if (snapshot.empty) {
        pastEntriesContainer.innerHTML = "<p>No journal entries yet. Try your first reflection — it doesn’t have to be perfect.</p>";
        return;
      }

      function getFileNameFromUrl(url) {
        try {
          const decoded = decodeURIComponent(url.split("?")[0]);
          const parts = decoded.split("/");
          return parts[parts.length - 1] || null;
        } catch {
          return null;
        }
      }
      function getFileExtension(filename) {
        if (!filename) return "";
        const dot = filename.lastIndexOf(".");
        if (dot === -1) return "";
        return filename.substring(dot + 1).toLowerCase();
      }
      function isImageExtension(ext) {
        return ["jpg", "jpeg", "png", "gif", "webp", "bmp"].includes(ext);
      }

      const entriesHtml = [];
      let hasNewCoachReplies = false; // Track if there are new coach replies
      
      console.log("🔍 DEBUGGING: Starting to process", snapshot.docs.length, "entries for coach replies");
      
      for (const doc of snapshot.docs) {
        const entry = doc.data();
        
        console.log("📄 PROCESSING ENTRY:", doc.id);
        console.log("Entry in Past Entries render:", entry);
        console.log("Entry ID:", doc.id, "newCoachReply:", entry.newCoachReply);
        console.log("🔍 DROPDOWN DATA CHECK:");
        console.log("  - manifestData:", entry.manifestData);
        console.log("  - contextManifest:", entry.contextManifest);
        console.log("  - promptUsed:", entry.promptUsed);
        console.log("  - reflectionUsed:", entry.reflectionUsed);

  if (!entry.createdAt?.toDate) {
    console.warn("Skipping entry with missing or invalid createdAt:", entry);
    continue;
  }

const date = entry.createdAt.toDate().toLocaleString();
const isManifest = entry.tags?.includes("manifest");
const manifestBadge = isManifest
  ? `<p class="entry-reflection" style="color: var(--brand-primary) !important; font-style: italic; display: block; margin: 0.5em 0;">✨ Reflecting on Manifest: "${entry.contextManifest || ''}"</p>`
  : "";


  
const coachTag = entry.coachReview
  ? `<p class="shared-with-coach" style="color: var(--brand-secondary); font-style: italic;">🔓 Shared with practitioner</p>`
  : "";

const manifestDateRaw = entry.manifestDate;
const manifestDate = manifestDateRaw
  ? new Date(manifestDateRaw).toLocaleDateString()
  : null;

const tagLine = manifestDate
  ? `Tags: ${entry.tags.join(", ")}, manifestDate: ${manifestDate}`
  : `Tags: ${entry.tags.join(", ")}`;

const tags = `<p class="entry-tags" style="color: var(--brand-primary); font-style: italic;">${tagLine}</p>`;

const text = entry.text
  ? `<p class="entry-text" style="color: #222222 !important; font-size: 1em; line-height: 1.6;">${entry.text}</p>`
  : "";

// Add dropdown toggles for manifest, prompt, and reflection data
let manifestToggleHtml = "";
if (entry.manifestData || entry.contextManifest) {
  console.log("✅ MANIFEST DROPDOWN: Will be generated for entry", doc.id);
  const manifestText = entry.manifestData ? 
    `Want: ${entry.manifestData.wish || 'Not specified'}<br/>
     Imagine: ${entry.manifestData.outcome || 'Not specified'}<br/>
     Snags: ${entry.manifestData.opposition || 'Not specified'}<br/>
     How: ${entry.manifestData.plan || 'Not specified'}` : 
    entry.contextManifest;
  
  manifestToggleHtml = `
    <button onclick="toggleManifest('${doc.id}')" style="background: transparent; color: var(--brand-primary); border: none; cursor: pointer; font-size: 0.85em; margin-bottom: 0.25em;">📜 Show Manifest</button>
    <div id="manifest-${doc.id}" style="display: none; font-size: 0.9em; color: #555; font-style: italic; margin-bottom: 0.5em; background: #f8f9fa; padding: 0.75em; border-radius: 5px; border-left: 4px solid var(--brand-primary); border: 1px solid #e9ecef;">
      <strong>Manifest Data:</strong><br/>${manifestText}
    </div>
  `;
} else {
  console.log("❌ NO MANIFEST DROPDOWN: No manifestData or contextManifest for entry", doc.id);
}

let promptToggleHtml = "";
if (entry.promptUsed) {
  console.log("✅ PROMPT DROPDOWN: Will be generated for entry", doc.id);
  promptToggleHtml = `
    <button onclick="togglePrompt('${doc.id}')" style="background: transparent; color: var(--brand-primary); border: none; cursor: pointer; font-size: 0.85em; margin-bottom: 0.25em;">📝 Show Prompt</button>
    <div id="prompt-${doc.id}" style="display: none; font-size: 0.9em; color: #555; font-style: italic; margin-bottom: 0.5em; background: #f8f9fa; padding: 0.75em; border-radius: 5px; border-left: 4px solid var(--brand-primary); border: 1px solid #e9ecef;">
      <strong>Prompt Used:</strong><br/>${entry.promptUsed}
    </div>
  `;
} else {
  console.log("❌ NO PROMPT DROPDOWN: No promptUsed for entry", doc.id);
}

let reflectionToggleHtml = "";
if (entry.reflectionUsed) {
  console.log("✅ REFLECTION DROPDOWN: Will be generated for entry", doc.id);
  reflectionToggleHtml = `
    <button onclick="toggleReflection('${doc.id}')" style="background: transparent; color: var(--brand-primary); border: none; cursor: pointer; font-size: 0.85em; margin-bottom: 0.25em;">💭 Show Reflection</button>
    <div id="reflection-${doc.id}" style="display: none; font-size: 0.9em; color: #555; font-style: italic; margin-bottom: 0.5em; background: #f8f9fa; padding: 0.75em; border-radius: 5px; border-left: 4px solid var(--brand-primary); border: 1px solid #e9ecef;">
      <strong>Sophy's Reflection:</strong><br/>${entry.reflectionUsed}
    </div>
  `;
} else {
  console.log("❌ NO REFLECTION DROPDOWN: No reflectionUsed for entry", doc.id);
}

 const images = (entry.attachments || []).map(file => {
  const url = file.url;
  const ext = url?.split('.').pop().toLowerCase();
  return ["jpg", "jpeg", "png", "gif", "webp", "bmp"].includes(ext)
    ? `<img src="${url}" alt="Attached image" style="max-width: 100px; margin-right: 0.5em;">`
    : `<a href="${url}" target="_blank">${file.name || url}</a>`;
}).join("");

// Check for coach replies
let coachRepliesHtml = "";
console.log("Checking coach replies for entry:", doc.id, "newCoachReply flag:", entry.newCoachReply);
if (entry.newCoachReply) {
  hasNewCoachReplies = true;
  console.log("Entry has newCoachReply=true, loading replies...");
  try {
    // Load coach replies for this entry
    const repliesRef = collection(db, "journalEntries", doc.id, "coachReplies");
    const repliesSnapshot = await getDocs(repliesRef);
    
    console.log("Coach replies snapshot size:", repliesSnapshot.size);
    
    if (!repliesSnapshot.empty) {
      const replies = [];
      repliesSnapshot.forEach(replyDoc => {
        const replyData = replyDoc.data();
        console.log("Found coach reply:", replyData);
        const replyDate = replyData.timestamp?.toDate?.()?.toLocaleString() || "Recent";
        replies.push({
          text: replyData.replyText,
          date: replyDate
        });
      });
      
      if (replies.length > 0) {
        coachRepliesHtml = `
          <div style="background: linear-gradient(135deg, #ffe8e8 0%, #ffd4d4 100%); border-left: 4px solid #ff6b6b; padding: 1em; margin: 1em 0; border-radius: 8px; position: relative;">
            <div style="position: absolute; top: 8px; right: 8px;">
              <span style="background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold;">NEW</span>
            </div>
            <h4 style="margin: 0 0 0.5em 0; color: #d63384; font-size: 0.9em; font-weight: 600;">💬 New Coach Reply${replies.length > 1 ? 'ies' : ''}</h4>
            ${replies.map(reply => `
              <div style="background: white; padding: 0.75em; margin: 0.5em 0; border-radius: 6px; border: 1px solid #ffb3ba;">
                <p style="margin: 0 0 0.5em 0; color: #333; line-height: 1.5;">${reply.text}</p>
                <p style="margin: 0; font-size: 0.8em; color: #666; font-style: italic;">${reply.date}</p>
              </div>
            `).join('')}
            <button onclick="handleMarkAsRead('${doc.id}')" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 0.8em; margin-top: 0.5em; cursor: pointer;">
  ✓ Mark as Read
</button>
          </div>
        `;
      }
    }
  } catch (error) {
    console.error("Error loading coach replies for entry:", doc.id, error);
  }
} else {
  // Show read coach replies with different styling
  try {
    const repliesRef = collection(db, "journalEntries", doc.id, "coachReplies");
    const repliesSnapshot = await getDocs(repliesRef);
    
    if (!repliesSnapshot.empty) {
      const replies = [];
      repliesSnapshot.forEach(replyDoc => {
        const replyData = replyDoc.data();
        const replyDate = replyData.timestamp?.toDate?.()?.toLocaleString() || "Recent";
        replies.push({
          text: replyData.replyText,
          date: replyDate
        });
      });
      
      if (replies.length > 0) {
        coachRepliesHtml = `
          <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edd4 100%); border-left: 4px solid #2A6972; padding: 1em; margin: 1em 0; border-radius: 8px;">
            <h4 style="margin: 0 0 0.5em 0; color: #2A6972; font-size: 0.9em; font-weight: 600;">💬 Coach Reply${replies.length > 1 ? 'ies' : ''}</h4>
            ${replies.map(reply => `
              <div style="background: white; padding: 0.75em; margin: 0.5em 0; border-radius: 6px; border: 1px solid #c8e6c9;">
                <p style="margin: 0 0 0.5em 0; color: #333; line-height: 1.5;">${reply.text}</p>
                <p style="margin: 0; font-size: 0.8em; color: #666; font-style: italic;">${reply.date}</p>
              </div>
            `).join('')}
          </div>
        `;
      }
    }
  } catch (error) {
    console.error("Error loading coach replies for entry:", doc.id, error);
  }
}

  // Check if dark theme is enabled
  const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
  
  // Define background and text colors based on theme
  const backgroundColors = isDarkTheme ? 
    (entry.newCoachReply ? 
      'linear-gradient(135deg, rgba(42, 105, 114, 0.25) 0%, rgba(30, 80, 85, 0.35) 100%)' :
      'linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%)'
    ) : 
    (entry.newCoachReply ? 
      'linear-gradient(180deg, #fff3cd 0%, #ffeaa7 100%)' :
      'linear-gradient(180deg, #ffffff 0%, #f2f2f2 100%)'
    );
  
  const textColor = isDarkTheme ? '#89C9D4' : '#222';
  const borderStyle = isDarkTheme ?
    (entry.newCoachReply ?
      'border: 1px solid rgba(137, 201, 212, 0.4); box-shadow: 0 0 25px rgba(137, 201, 212, 0.25), 0 6px 20px rgba(0, 0, 0, 0.3);' :
      'border: 1px solid rgba(137, 201, 212, 0.25); box-shadow: 0 0 20px rgba(137, 201, 212, 0.15), 0 4px 16px rgba(0, 0, 0, 0.25);'
    ) :
    (entry.newCoachReply ? 
      'border-left: 5px solid var(--accent, #d49489); box-shadow: 0 0 10px rgba(212, 148, 137, 0.3);' :
      'border-left: 4px solid var(--brand-secondary, #7BB8C4);'
    );

  const entryHtml = `
  <div class="entry-card journal-entry" style="background: ${backgroundColors}; color: ${textColor}; ${borderStyle}">
<span class="entry-date fixed-dark-date">${date}</span>
    ${entry.newCoachReply ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--accent, #d49489); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold;">NEW REPLY</div>' : ''}
      ${manifestBadge}
      ${coachTag}
      ${manifestToggleHtml}
      ${promptToggleHtml}
      ${reflectionToggleHtml}
      ${text}
      ${coachRepliesHtml}
      <div class="entry-images">${images}</div>
      ${tags}
     <button class="entry-btn" onclick="editEntry('${doc.id}', \`${entry.text?.replace(/`/g, '\\`') || ''}\`)" style="background-color: #2A6972; color: white; border: 1px solid #2A6972; padding: 6px 12px; font-size: 0.8em;">✏️ Edit</button>
<button class="entry-btn" onclick="deleteEntry('${doc.id}')" style="background-color: #6b7280; color: white; border: 1px solid #6b7280; padding: 6px 12px; font-size: 0.8em;">🗑️ Delete</button>
${entry.manifestData ? `<button class="entry-btn" onclick="showManifestData('${doc.id}')" style="background-color: var(--accent); color: var(--btn-font); border: 1px solid var(--border);">Show Manifest</button>` : ""}
${entry.reflectionUsed ? `<button class="entry-btn" onclick="showReflectionData('${doc.id}')" style="background-color: #7BB8C4; color: var(--btn-font); border: 1px solid var(--border);">Show Reflection</button>` : ""}
    </div>
  `;
  
  console.log("🎨 ENTRY HTML for", doc.id, "newCoachReply:", entry.newCoachReply);
  console.log("Generated HTML includes NEW REPLY badge:", entryHtml.includes('NEW REPLY'));
  
  entriesHtml.push(entryHtml);
} // ✅ closes for-loop

// Show toast notification if there are new coach replies
if (hasNewCoachReplies) {
  setTimeout(() => {
    window.showToast("💬 You have new coach replies! Look for entries with the 'NEW REPLY' badge.", "success", 8000);
  }, 1000);
}

if (entriesHtml.length === 0) {
  const emptyMsg = document.getElementById("emptyPastEntriesMessage");
  if (emptyMsg) emptyMsg.style.display = "block";
  pastEntriesContainer.innerHTML = ""; // clear past entries
  return;
} else {
  const emptyMsg = document.getElementById("emptyPastEntriesMessage");
  if (emptyMsg) emptyMsg.style.display = "none";
  
  // Create the same container structure as showPromptsByDate for consistent width
const container = document.createElement("div");
container.className = "entries-container";
container.style.cssText = `
  display: flex;
  flex-direction: column;
  gap: 1em;
  width: 100%;
  box-sizing: border-box;
  padding: 0 0.5em;
  max-width: 100%;
  overflow-x: hidden;
`;
  container.innerHTML = entriesHtml.join("");
  
  pastEntriesContainer.innerHTML = "";
  pastEntriesContainer.appendChild(container);
  
  // Force refresh theme styling for entries after they're added to DOM
  setTimeout(() => {
    if (typeof window.refreshPastEntriesTheme === 'function') {
      window.refreshPastEntriesTheme();
    }
  }, 50);
}
} 

 window.loadPastEntries = loadPastEntries;
    // Delete Entry Modal Functions
    window.closeDeleteModal = function() {
      const modal = document.getElementById('deleteConfirmModal');
      modal.style.display = 'none';
    };

    // Manifest Data Modal Functions
    window.showManifestData = async function(docId) {
      try {
        // Fetch the entry data from Firestore
        const entryRef = doc(db, "journalEntries", docId);
        const entrySnap = await getDoc(entryRef);
        
        if (!entrySnap.exists) {
          showToast("Entry not found.", "error");
          return;
        }
        
        const entryData = entrySnap.data();
        
        // Check if this entry has manifest data
        if (!entryData.manifestData) {
          showToast("This entry doesn't contain manifest data.", "warning");
          return;
        }
        
        // Populate the modal with manifest data
        const manifestData = entryData.manifestData;
        const contentDiv = document.getElementById('manifestDataContent');
        
        contentDiv.innerHTML = `
          <div style="margin-bottom: 1.5em;">
            <h3 style="color: var(--brand-primary); border-bottom: 2px solid var(--brand-primary); padding-bottom: 0.5em; margin-bottom: 1em;">🎯 Wish</h3>
            <p style="background: var(--bg-muted); padding: 1em; border-radius: 8px; margin: 0;">${manifestData.wish || 'Not specified'}</p>
          </div>
          
          <div style="margin-bottom: 1.5em;">
            <h3 style="color: var(--brand-primary); border-bottom: 2px solid var(--brand-primary); padding-bottom: 0.5em; margin-bottom: 1em;">✨ Outcome</h3>
            <p style="background: var(--bg-muted); padding: 1em; border-radius: 8px; margin: 0;">${manifestData.outcome || 'Not specified'}</p>
          </div>
          
          <div style="margin-bottom: 1.5em;">
            <h3 style="color: var(--brand-primary); border-bottom: 2px solid var(--brand-primary); padding-bottom: 0.5em; margin-bottom: 1em;">🚧 Opposition</h3>
            <p style="background: var(--bg-muted); padding: 1em; border-radius: 8px; margin: 0;">${manifestData.opposition || 'Not specified'}</p>
          </div>
          
          <div style="margin-bottom: 1.5em;">
            <h3 style="color: var(--brand-primary); border-bottom: 2px solid var(--brand-primary); padding-bottom: 0.5em; margin-bottom: 1em;">📋 Plan</h3>
            <p style="background: var(--bg-muted); padding: 1em; border-radius: 8px; margin: 0;">${manifestData.plan || 'Not specified'}</p>
          </div>
          
          <div style="margin-top: 2em; padding-top: 1em; border-top: 1px solid var(--border); font-style: italic; color: var(--info-muted);">
            <p style="margin: 0; text-align: center;">Entry created: ${entryData.createdAt?.toDate ? entryData.createdAt.toDate().toLocaleDateString() : 'Unknown date'}</p>
          </div>
        `;
        
        // Show the modal
        const modal = document.getElementById('manifestDataModal');
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error("Error loading manifest data:", error);
        showToast("Failed to load manifest data.", "error");
      }
    };

    window.closeManifestModal = function() {
      const modal = document.getElementById('manifestDataModal');
      modal.style.display = 'none';
    };

    // Reflection Data Modal Functions
    window.showReflectionData = async function(docId) {
      try {
        // Fetch the entry data from Firestore
        const entryRef = doc(db, "journalEntries", docId);
        const entrySnap = await getDoc(entryRef);
        
        if (!entrySnap.exists) {
          showToast("Entry not found.", "error");
          return;
        }
        
        const entryData = entrySnap.data();
        
        // Check if this entry has reflection data
        if (!entryData.reflectionUsed) {
          showToast("This entry doesn't contain reflection data.", "warning");
          return;
        }
        
        // Populate the modal with reflection data
        const reflectionData = entryData.reflectionUsed;
        const contentDiv = document.getElementById('reflectionDataContent');
        
        contentDiv.innerHTML = `
          <div style="margin-bottom: 1.5em;">
            <h3 style="color: #7BB8C4; border-bottom: 2px solid #7BB8C4; padding-bottom: 0.5em; margin-bottom: 1em; display: flex; align-items: center;">
              💭 <span style="margin-left: 0.5rem;">Sophy's Reflection</span>
            </h3>
            <div style="background: var(--bg-muted); padding: 1.5em; border-radius: 8px; margin: 0; white-space: pre-wrap; line-height: 1.6; font-style: italic; border-left: 4px solid #7BB8C4;">${reflectionData}</div>
          </div>
          
          <div style="margin-top: 2em; padding-top: 1em; border-top: 1px solid var(--border); font-style: italic; color: var(--info-muted);">
            <p style="margin: 0; text-align: center;">Entry created: ${entryData.createdAt?.toDate ? entryData.createdAt.toDate().toLocaleDateString() : 'Unknown date'}</p>
          </div>
        `;
        
        // Show the modal
        const modal = document.getElementById('reflectionDataModal');
        modal.style.display = 'flex';
        
      } catch (error) {
        console.error("Error loading reflection data:", error);
        showToast("Failed to load reflection data.", "error");
      }
    };

    window.closeReflectionModal = function() {
      const modal = document.getElementById('reflectionDataModal');
      modal.style.display = 'none';
    };

    window.deleteEntry = async function(docId) {
      try {
        // Check permissions first
        const entryRef = doc(db, "journalEntries", docId);
        const entrySnap = await getDoc(entryRef);
        
        if (!entrySnap.exists || entrySnap.data().userId !== currentUserId) {
          showToast("You do not have permission to delete this entry.", "error");
          return;
        }

        // Show confirmation modal
        const modal = document.getElementById('deleteConfirmModal');
        const idInput = document.getElementById('deleteEntryId');
        idInput.value = docId;
        modal.style.display = 'flex';
      } catch (err) {
        console.error("Error preparing to delete entry:", err);
        showToast("Error accessing entry. Please try again.", "error");
      }
    };






   window.markCoachRepliesAsRead = async function(entryId) {
  console.log("🔄 Mark as read clicked for entry:", entryId);
  
  try {
    const user = auth.currentUser;
    if (!user) {
      console.error("No authenticated user");
      return;
    }

    // Update the database first
    const entryRef = window.doc(window.db, "journalEntries", entryId);
    await window.updateDoc(entryRef, { newCoachReply: false });
    
    console.log("✅ Database updated successfully");
    
    // Immediately update the visual styling of the entry card
    const entryCard = event.target.closest('.entry-card');
    if (entryCard) {
      // Reset border to teal
      entryCard.style.borderLeft = '4px solid var(--brand-secondary, #7BB8C4)';
      entryCard.style.boxShadow = '';
      
      // Reset background to normal theme-appropriate color
      const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDarkTheme) {
        entryCard.style.background = 'linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%)';
      } else {
        entryCard.style.background = 'linear-gradient(180deg, #ffffff 0%, #f2f2f2 100%)';
      }
      
      // Remove NEW REPLY badge/sticker
      const newReplyBadge = entryCard.querySelector('.new-reply-badge, [style*="NEW REPLY"], .coach-reply-badge');
      if (newReplyBadge) {
        newReplyBadge.remove();
        console.log("✅ NEW REPLY badge removed");
      }
      
      // Also check for and remove any "NEW REPLY" text spans
      const newReplySpans = entryCard.querySelectorAll('span');
      newReplySpans.forEach(span => {
        if (span.textContent.includes('NEW REPLY')) {
          span.remove();
          console.log("✅ NEW REPLY span removed");
        }
      });
      
      console.log("✅ Entry card styling updated immediately");
    }
    
    // Update the clicked button immediately
    const clickedButton = event.target;
    if (clickedButton) {
      clickedButton.innerHTML = "✅ Read";
      clickedButton.style.background = "#6c757d";
      clickedButton.style.cursor = "default";
      clickedButton.disabled = true;
      clickedButton.onclick = null;
    }
    
    console.log("✅ Button updated");
    
    // Check if this was the last unread reply for this date and update calendar
    setTimeout(async () => {
      console.log("🔄 Checking for remaining unread replies on this date...");
      
      // Get the date of this entry to check if there are other unread replies
      const entrySnapshot = await window.getDoc(entryRef);
      if (entrySnapshot.exists()) {
        const entryData = entrySnapshot.data();
        const createdAt = entryData.createdAt?.toDate?.();
        
        if (createdAt) {
          const dateKey = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')}`;
          
          // Check if any other entries on this date still have unread replies
          const snapshot = await window.getDocs(window.query(
            window.collection(window.db, "journalEntries"),
            window.where("userId", "==", user.uid),
            window.where("newCoachReply", "==", true)
          ));
          
          let hasUnreadOnThisDate = false;
          snapshot.forEach(doc => {
            const otherCreatedAt = doc.data().createdAt?.toDate?.();
            if (otherCreatedAt) {
              const otherDateKey = `${otherCreatedAt.getFullYear()}-${String(otherCreatedAt.getMonth() + 1).padStart(2, '0')}-${String(otherCreatedAt.getDate()).padStart(2, '0')}`;
              if (otherDateKey === dateKey) {
                hasUnreadOnThisDate = true;
              }
            }
          });
          
          // Update calendar cell for this specific date if it's the last unread
          if (!hasUnreadOnThisDate) {
            const calendarCell = document.querySelector(`[data-date="${dateKey}"]`);
            if (calendarCell) {
              // Reset to normal teal journal entry styling
              const tealColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-secondary').trim() || '#7BB8C4';
              calendarCell.style.border = '1px solid #ccc';
              calendarCell.style.backgroundColor = tealColor;
              calendarCell.style.color = '#fff';
              calendarCell.style.fontWeight = 'normal';
              calendarCell.title = 'Journal entry';
              calendarCell.style.boxShadow = '';
              calendarCell.style.animation = ''; // Remove any pulsing animation
              
              console.log(`✅ Calendar cell ${dateKey} reset to teal - no more unread replies on this date`);
            }
            
            // Also update any coral highlighting back to teal
            const allCalendarCells = document.querySelectorAll(`[data-date="${dateKey}"]`);
            allCalendarCells.forEach(cell => {
              if (cell.style.backgroundColor.includes('coral') || cell.style.borderColor.includes('coral')) {
                cell.style.backgroundColor = tealColor;
                cell.style.borderColor = '#ccc';
                cell.style.color = '#fff';
                console.log(`✅ Additional calendar cell updated from coral to teal`);
              }
            });
          }
        }
      }
      
      // Also trigger the general calendar highlighting update
      if (window.updateCalendarHighlighting && typeof window.updateCalendarHighlighting === 'function') {
        window.updateCalendarHighlighting();
      }
      
    }, 500);
    
  } catch (error) {
    console.error("❌ Error marking as read:", error);
    alert("Failed to mark as read. Please try again.");
  }
};

// Create alias for handleMarkAsRead (used in Past Entries)
window.handleMarkAsRead = window.markCoachRepliesAsRead;

// Helper function to directly update calendar cells
function updateCalendarCellsDirectly() {
  console.log("🎨 Updating calendar cells directly...");
  
  const calendarCells = document.querySelectorAll('[data-date]');
  console.log("Found", calendarCells.length, "calendar cells");
  
  calendarCells.forEach(cell => {
    // Check if this cell has coral/red styling (indicating coach reply)
    const bgColor = cell.style.backgroundColor;
    const borderColor = cell.style.border;
    
    if (bgColor.includes('#d49489') || bgColor.includes('rgb(212, 148, 137)') || 
        borderColor.includes('#d49489') || borderColor.includes('rgb(212, 148, 137)')) {
      
      // Change to teal
      cell.style.backgroundColor = '#7BB8C4';
      cell.style.border = '1px solid #ccc';
      cell.style.boxShadow = '';
      cell.style.fontWeight = 'normal';
      cell.title = 'Journal entry';
      
      console.log("✅ Updated calendar cell for date:", cell.getAttribute('data-date'));
    }
  });
}

// Function to update calendar highlighting based on remaining coach replies
async function updateCalendarHighlighting() {
  try {
    const user = auth.currentUser;
    if (!user) return;
    
    console.log("🔄 Starting calendar highlighting update...");
    
    // Get all entries with unread coach replies
    const snapshot = await window.getDocs(window.query(
      window.collection(window.db, "journalEntries"),
      window.where("userId", "==", user.uid),
      window.where("newCoachReply", "==", true)
    ));
    
    const datesWithUnreadReplies = new Set();
    snapshot.forEach(doc => {
      const createdAt = doc.data().createdAt?.toDate?.();
      if (createdAt) {
        const dateKey = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')}`;
        datesWithUnreadReplies.add(dateKey);
      }
    });
    
    // Get all entries to know which dates have entries
    const allEntriesSnapshot = await window.getDocs(window.query(
      window.collection(window.db, "journalEntries"),
      window.where("userId", "==", user.uid)
    ));
    
    const datesWithEntries = new Set();
    allEntriesSnapshot.forEach(doc => {
      const createdAt = doc.data().createdAt?.toDate?.();
      if (createdAt) {
        const dateKey = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')}`;
        datesWithEntries.add(dateKey);
      }
    });
    
    console.log("📊 Dates with unread replies:", datesWithUnreadReplies.size);
    console.log("📊 Dates with entries:", datesWithEntries.size);
    
    // Store this data globally so buildCalendar can use it
    window.globalDatesWithUnreadReplies = datesWithUnreadReplies;
    window.globalDatesWithEntries = datesWithEntries;
    
    // Update calendar highlighting
    const calendarDates = document.querySelectorAll('[data-date]');
    calendarDates.forEach(dateElement => {
      const dateKey = dateElement.getAttribute('data-date');
      
      if (datesWithUnreadReplies.has(dateKey)) {
        // Keep coral highlighting - still has unread replies
        dateElement.style.border = '2px solid var(--accent, #d49489)';
        dateElement.style.backgroundColor = 'var(--accent, #d49489)';
        dateElement.style.color = '#fff';
        dateElement.style.fontWeight = 'bold';
        dateElement.title = 'New coach reply available!';
        dateElement.style.boxShadow = '0 0 4px rgba(212, 148, 137, 0.5)';
      } else if (datesWithEntries.has(dateKey)) {
        // Revert to teal highlighting - has entries but no unread replies
        const tealColor = getComputedStyle(document.documentElement).getPropertyValue('--brand-secondary').trim() || '#7BB8C4';
        dateElement.style.border = '1px solid #ccc';
        dateElement.style.backgroundColor = tealColor;
        dateElement.style.color = '#fff';
        dateElement.style.fontWeight = 'normal';
        dateElement.title = 'Journal entry';
        dateElement.style.boxShadow = '';
      } else {
        // No entries - reset to default
        dateElement.style.border = '1px solid #ccc';
        dateElement.style.backgroundColor = '';
        dateElement.style.color = '';
        dateElement.style.fontWeight = 'normal';
        dateElement.title = '';
        dateElement.style.boxShadow = '';
      }
    });
    
    console.log("✅ Calendar highlighting updated successfully");
  } catch (error) {
    console.error("Error updating calendar highlighting:", error);
  }
}

    // Edit and Delete functionality moved to auth.js

    // Edit Entry Modal Functions
    window.closeEditModal = function() {
      const modal = document.getElementById('editEntryModal');
      modal.style.display = 'none';
    };

    window.closeDeleteModal = function() {
      const modal = document.getElementById('deleteConfirmModal');
      modal.style.display = 'none';
    };

    window.confirmDelete = async function() {
      const docId = document.getElementById('deleteEntryId').value;
      try {
        console.log("🗑️ Starting delete process for entry:", docId);
        
        // First, check if we have permission
        const entryRef = doc(db, "journalEntries", docId);
        const entrySnap = await getDoc(entryRef);
        
        if (!entrySnap.exists() || entrySnap.data().userId !== currentUserId) {
          showToast("You do not have permission to delete this entry.", "error");
          closeDeleteModal();
          return;
        }

        const entryData = entrySnap.data();

        // Delete attachments from Firebase Storage if they exist
        if (entryData.attachments && entryData.attachments.length > 0) {
          console.log(`🗑️ Deleting ${entryData.attachments.length} attachments`);
          
          for (const attachment of entryData.attachments) {
            try {
              if (attachment.url) {
                // Extract the file path from the storage URL
                const url = new URL(attachment.url);
                const pathMatch = url.pathname.match(/\/o\/(.+)\?/);
                
                if (pathMatch) {
                  const filePath = decodeURIComponent(pathMatch[1]);
                  console.log("🗑️ Deleting storage file:", filePath);
                  
                  // Delete via Cloud Function to avoid client-side storage permissions
                  try {
                    const idToken = await auth.currentUser.getIdToken();
                    const deleteResponse = await fetch(
                      location.hostname === "localhost" 
                        ? "http://localhost:5001/inkwell-alpha/us-central1/deleteFile"
                        : "https://us-central1-inkwell-alpha.cloudfunctions.net/deleteFile",
                      {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                          'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({ filePath: filePath })
                      }
                    );
                    
                    if (deleteResponse.ok) {
                      console.log("✅ Attachment deleted successfully:", filePath);
                    } else {
                      console.warn("⚠️ Failed to delete attachment:", filePath, deleteResponse.status);
                    }
                  } catch (deleteErr) {
                    console.warn("⚠️ Error deleting attachment (continuing with entry deletion):", deleteErr);
                  }
                }
              }
            } catch (attachmentErr) {
              console.warn("⚠️ Error processing attachment for deletion:", attachmentErr);
              // Continue with other attachments
            }
          }
        }

        // Delete coach replies subcollection first (if any exist)
        try {
          const coachRepliesRef = collection(db, "journalEntries", docId, "coachReplies");
          const coachRepliesSnapshot = await getDocs(coachRepliesRef);
          
          for (const replyDoc of coachRepliesSnapshot.docs) {
            console.log("🗑️ Deleting coach reply:", replyDoc.id);
            await deleteDoc(replyDoc.ref);
          }
          
          console.log(`🗑️ Deleted ${coachRepliesSnapshot.docs.length} coach replies`);
        } catch (coachDeleteErr) {
          console.error("Error deleting coach responses:", coachDeleteErr);
          // Continue with entry deletion even if coach replies fail
        }

        // Now delete the main entry
        console.log("🗑️ Deleting main entry:", docId);
        await deleteDoc(entryRef);
        
        closeDeleteModal();
        loadPastEntries(); // Refresh the entries list
        showToast("Entry deleted successfully.", "success");
        console.log("✅ Entry deletion completed successfully");
        
      } catch (err) {
        console.error("Error deleting entry:", err);
        closeDeleteModal();
        showToast("Failed to delete entry. Please try again.", "error");
      }
    };

    window.editEntry = async function (docId, currentText) {
      
      try {
        // Only allow editing if the entry belongs to the current user
        const entryRef = doc(db, "journalEntries", docId);
        const entrySnap = await getDoc(entryRef);
        if (!entrySnap.exists || entrySnap.data().userId !== currentUserId) {
          showToast("You do not have permission to edit this entry.", "error");
          return;
        }

        // Show edit modal
        const modal = document.getElementById('editEntryModal');
        const textarea = document.getElementById('editEntryText');
        const idInput = document.getElementById('editEntryId');
        
        textarea.value = currentText;
        idInput.value = docId;
        modal.style.display = 'flex';

        // Focus textarea and place cursor at end
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
      } catch (err) {
        console.error("Error preparing to edit entry:", err);
      }
    };


    // signUp function moved to auth.js

    // Helper for autofill: waits for both email and password to be filled by browser autofill or user
    function waitForAutofill(resolve) {
      const emailInput = document.querySelector('input[name="email"]');
      const passwordInput = document.querySelector('input[name="password"]');
      let attempts = 0;

      const interval = setInterval(() => {
        const email = emailInput?.value?.trim();
        const password = passwordInput?.value?.trim();
        if (email && password) {
          clearInterval(interval);
          resolve({ email, password });
        } else if (++attempts > 20) {
          clearInterval(interval);
          resolve({ email: email || '', password: password || '' });
        }
      }, 100);
    }

    // Helper to normalize login input (removes ZW chars, trims, smart quotes, outer quotes, Unicode normalization)
    function normalizeInput(str) {
      return String(str)
        .trim()
        .replace(/\u200B/g, '') // remove zero-width characters
        .replace(/[\u2018\u2019]/g, "'") // smart single quotes
        .replace(/[\u201C\u201D]/g, '"') // smart double quotes
        .replace(/^["']|["']$/g, '') // outer quotes
        .normalize("NFKC");
    }

// Authentication functions moved to auth.js
    
    let journalMode = 'manifest';

window.setJournalMode = function (mode) {
  journalMode = mode;
  const manifestBtn = document.getElementById("manifestModeButton");
  const freeBtn = document.getElementById("freeModeButton");

  if (mode === "manifest") {
    manifestBtn.style.backgroundColor = "#2A6D6D";
    manifestBtn.style.color = "white";
    freeBtn.style.backgroundColor = "#ccc";
    freeBtn.style.color = "#333";
  } else {
    freeBtn.style.backgroundColor = "#2A6D6D";
    freeBtn.style.color = "white";
    manifestBtn.style.backgroundColor = "#ccc";
    manifestBtn.style.color = "#333";
  }
};





    // Expose functions for UI onclick attributes
    window.generatePrompt = generatePrompt;
    // Authentication functions now handled by auth.js

// Modal close function for login modal
window.loginModalClose = function () {
  document.getElementById("loginModal").style.display = "none";
  document.querySelector("main").style.display = "none";

  // Optional toast-like feedback
  const toast = document.createElement("div");
  toast.textContent = "You must log in to access the journal.";
  toast.style.position = "fixed";
  toast.style.bottom = "20px";
  toast.style.left = "50%";
  toast.style.transform = "translateX(-50%)";
  toast.style.backgroundColor = "#FFA76D";
  toast.style.color = "#fff";
  toast.style.padding = "1em 1.5em";
  toast.style.borderRadius = "5px";
  toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
  toast.style.zIndex = "9999";
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.remove();
  }, 4000);
};

window.showLoginModal = function () {
  document.getElementById("goodbyeModal").style.display = "none";
  document.getElementById("loginModal").style.display = "flex";
  document.getElementById("loginEmail").value = "";
  document.getElementById("loginPassword").value = "";
};

// Global handler for return to login button (backup method)
window.handleReturnToLogin = function() {
  console.log("🔄 Global handleReturnToLogin called");
  
  // Hide goodbye modal
  const goodbyeModal = document.getElementById("goodbyeModal");
  if (goodbyeModal) {
    goodbyeModal.style.display = "none";
  }
  
  // Clear logout state and fast-login class
  localStorage.removeItem("userJustLoggedOut");
  document.body.classList.remove("fast-login-active");
  
  // Show login modal immediately
  const loginModal = document.getElementById("loginModal");
  if (loginModal) {
    loginModal.style.display = "flex";
    // Clear login form
    const emailInput = document.getElementById("loginEmail");
    const passwordInput = document.getElementById("loginPassword");
    if (emailInput) emailInput.value = "";
    if (passwordInput) passwordInput.value = "";
    console.log("✅ Login modal displayed");
  } else {
    console.error("❌ Login modal not found");
  }
};

// returnToLoginBtn handler moved to auth.js

window.showSpinner = function (targetId, message = "Working...") {
  const el = document.getElementById(targetId);
  if (el) {
    el.innerHTML = `<span class="spinner"></span> ${message}`;
  }
};

window.showToast = function (message, type = "info", duration = 4000) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = message;
  
  // Style the toast
  toast.style.position = "fixed";
  toast.style.top = "20px";
  toast.style.left = "50%";
  toast.style.transform = "translateX(-50%)";
  toast.style.padding = "1em 1.5em";
  toast.style.borderRadius = "5px";
  toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
  toast.style.zIndex = "9999";
  toast.style.fontWeight = "500";
  toast.style.maxWidth = "400px";
  toast.style.textAlign = "center";
  
  // Set color based on type - InkWell themed colors
  switch (type) {
    case "error":
      toast.style.backgroundColor = "#B85450"; // Muted red to match InkWell's earthy palette
      toast.style.color = "#fff";
      toast.style.border = "2px solid #A0453F";
      break;
    case "success":
      toast.style.backgroundColor = "#4A8B8B"; // InkWell's teal/turquoise color
      toast.style.color = "#fff";
      toast.style.border = "2px solid #3A6B6B";
      break;
    case "warning":
      toast.style.backgroundColor = "#D4A574"; // Warmer orange to match InkWell's palette
      toast.style.color = "#2C3E50"; // Dark text for better contrast
      toast.style.border = "2px solid #B8955F";
      break;
    default:
      toast.style.backgroundColor = "#FFA76D"; // InkWell's signature orange
      toast.style.color = "#2C3E50"; // Dark text for better contrast
      toast.style.border = "2px solid #E6935A";
  }
  
  // Add to page
  document.body.appendChild(toast);
  
  // Remove after duration
  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, duration);
};

window.logOutUser = async function () {
  console.log("Logout started.");
  try {
    localStorage.setItem("userJustLoggedOut", "true");
    await auth.signOut();
    document.querySelector("main").style.display = "none";
    {
      const el = document.getElementById("embeddedAgreementNotice");
      if (el) el.style.display = "none";
    }
    setTimeout(() => {
      const modal = document.getElementById("goodbyeModal");
      if (modal) {
        modal.style.display = "flex";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100vw";
        modal.style.height = "100vh";
        modal.style.background = "rgba(0,0,0,0.8)";
        modal.style.color = "#2A6D6D";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = "9999";
      }
    }, 100);
    const searchInput = document.getElementById("searchQuery");
    if (searchInput) searchInput.value = "";
  } catch (err) {
    console.error("Logout failed:", err);
    showToast("Logout failed.", "error");
  }
};
async function askSophyAboutEntry() {
  const journalText = document.getElementById("journal").value.trim();
  const sophyInsight = document.getElementById("sophyInsight");

  if (!journalText) {
    sophyInsight.textContent = "Please write something in your journal first.";
    return;
  }
  sophyInsight.textContent = "Sophy is thinking...";
  try {
    // Occasionally include username for personalization (30% chance)
    let payload = { entry: journalText };
    if (Math.random() < 0.3) {
      const userName = await getCurrentUserName();
      if (userName) {
        payload.userName = userName;
      }
    }
    
    const data = await secureAIFetch("https://us-central1-inkwell-alpha.cloudfunctions.net/askSophy", payload);
    
    const insight = data.insight?.trim?.() || "Sophy couldn't generate a reflection right now.";
    sophyInsight.textContent = insight;

  } catch (err) {
    console.error("Error fetching Sophy insight:", err);
    sophyInsight.textContent = "Sorry, Sophy couldn't reflect right now.";
  }
}

    window.askSophyAboutEntry = askSophyAboutEntry;

    // Manifest save function
    window.saveManifest = async function () {
      // Always use current user's UID for manifest doc
      let user = null;
      try {
        user = auth.currentUser;
      } catch (e) {
        user = null;
      }
      
      // Get all four section values
      const manifestText = document.getElementById("manifestInput")?.value.trim() || "";
      const wishText = document.getElementById("wishInput")?.value.trim() || "";
      const outcomeText = document.getElementById("outcomeInput")?.value.trim() || "";
      const oppositionText = document.getElementById("oppositionInput")?.value.trim() || "";
      const planText = document.getElementById("planInput")?.value.trim() || "";
      
      const status = document.getElementById("manifestSaveStatus");

      if (!user) {
        status.textContent = "You must be logged in to save.";
        status.style.color = "red";
        return;
      }

      // Check if at least one section has content
      if (!manifestText && !wishText && !outcomeText && !oppositionText && !planText) {
        status.textContent = "Please write something in at least one section to save.";
        status.style.color = "red";
        return;
      }

      window.showSpinner("manifestSaveStatus", "Saving vision...");

      try {
        // Always use user's UID as doc ID for manifests, now saving all sections
        const manifestData = {
          statement: manifestText, // Keep original for backward compatibility
          wish: wishText,
          outcome: outcomeText,
          opposition: oppositionText,
          plan: planText,
          timestamp: serverTimestamp(),
          userId: user.uid
        };

        await setDoc(doc(db, "manifests", user.uid), manifestData);

        // Also save to localStorage for faster loading
        const localStorageData = {
          statement: manifestText, // Keep for backwards compatibility with manifestInput
          wish: wishText,
          outcome: outcomeText,
          opposition: oppositionText,
          plan: planText
        };
        localStorage.setItem(`manifest_${user.uid}`, JSON.stringify(localStorageData));
        console.log("✅ Manifest also saved to localStorage for user:", user.uid);

        // Show success message
        status.innerHTML = "✅ Vision saved. You're building something meaningful.";
        status.style.color = "#2A6D6D";
        window.showToast("🎯 Your WISH vision has been saved!", "success", 4000);
        updateWishProgress();
// Set start date for progress tracking (only on first save)
        const wishStartKey = `wishStart_${user.uid}`;
        if (!localStorage.getItem(wishStartKey)) {
          localStorage.setItem(wishStartKey, new Date().toISOString());
        }

        updateWishProgress(); // Update progress display
        setTimeout(() => status.innerHTML = "", 5000);
        
        // Reload manifest data to confirm it was saved properly
        setTimeout(() => {
          console.log("🔄 Reloading manifest data after save to confirm persistence...");
          loadManifestData();
        }, 1000);
        
        // Note: This saves manifest data only, not a journal entry, so calendar refresh isn't needed
        // But we could add it here if manifest saves should also appear in calendar
      } catch (error) {
        console.error("Error saving manifest:", error);
        status.textContent = "Failed to save manifest.";
        status.style.color = "red";
        setTimeout(() => status.innerHTML = "", 4000);
      }
    };

    // Refine Manifest with Sophy (original version kept above for reference)

// --- New: askSophyToRefineManifest using getSophyResponse and new UI logic ---
window.askSophyToRefineManifest = async function () {
  const input = document.getElementById("manifestInput")?.value.trim();
  const suggestionBox = document.getElementById("manifestSuggestion");
  const label = document.getElementById("manifestSuggestionLabel");

  if (!input) {
    suggestionBox.textContent = "Please write something in your Manifest Statement first.";
    if (label) label.style.display = "block";
    return;
  }

  suggestionBox.textContent = "Refining your Manifest Statement with Sophy...";
  if (label) label.style.display = "block";

  try {
    const prompt = `
You are Sophy, an encouraging journaling assistant trained in motivational psychology and goal-setting.

Here is a user's Manifest Statement, which is their personal guiding focus or intention.

Your task is to rewrite it using more powerful, emotionally motivating, and positively framed language while preserving their original intention.

IMPORTANT: Return ONLY the revised version without any explanations, comments, or follow-up questions. Do not include phrases like "Let me know if you'd like to discuss further" or "Would you like me to help with..." Just provide the improved version.

---
Original:
${input}
---
Rewritten:
`;

    // Helper to call Sophy endpoint with prompt and get only the text response
    async function getSophyResponse(prompt) {
      // Occasionally include username for personalization (20% chance) 
      let payload = { entry: prompt };
      if (Math.random() < 0.2) {
        const userName = await getCurrentUserName();
        if (userName) {
          payload.userName = userName;
        }
      }
      
      const data = await secureAIFetch("https://us-central1-inkwell-alpha.cloudfunctions.net/askSophy", payload); 
      // Try to use .insight, fallback to full response
      return data.insight || data.response || "";
    }

   const response = await getSophyResponse(prompt);
    
    // Clean up the response by removing surrounding quotes and internal prompting
let cleanResponse = response?.trim() || "Something went wrong.";

// Remove surrounding quotes if they exist (more robust checking)
if (cleanResponse && cleanResponse !== "Something went wrong.") {
  // Remove double quotes
  if (cleanResponse.startsWith('"') && cleanResponse.endsWith('"')) {
    cleanResponse = cleanResponse.slice(1, -1);
  }
  // Remove single quotes
  else if (cleanResponse.startsWith("'") && cleanResponse.endsWith("'")) {
    cleanResponse = cleanResponse.slice(1, -1);
  }
  
  // Clean up stage directions and internal prompting
  cleanResponse = cleanResponse
    .replace(/^\*[^*]*\*\s*/g, '') // Remove opening stage directions
    .replace(/\*[^*]*\*$/g, '') // Remove ending stage directions  
    .replace(/\*[^*]*\*/g, '') // Remove any remaining stage directions
    .replace(/^\*with\s+warmth\s+and\s+empathy\*\s*/gi, '') // Remove specific empathy stage direction
    .replace(/^\*[^*]*warmth[^*]*\*\s*/gi, '') // Remove warmth-related stage directions
    .replace(/^\*[^*]*empathy[^*]*\*\s*/gi, '') // Remove empathy-related stage directions
    .replace(/I\s+sense\s+there\s+is\s+an\s+important\s+wish/gi, '') // Remove specific AI prompt leakage
    .replace(/Let's\s+take\s+a\s+moment\s+to\s+vividly\s+imagine/gi, '') // Remove prompt instruction leakage
    .replace(/Envision\s+yourself\s+feeling/gi, '') // Remove visualization prompt leakage
    .replace(/Picture\s+yourself\s+with/gi, '') // Remove picture prompt leakage
    .trim();
}

suggestionBox.textContent = cleanResponse;

    
  } catch (err) {
    console.error("Error refining manifest:", err);
    suggestionBox.textContent = "Something went wrong.";
  }
};

// --- New: General askSophyToRefine function for all four sections ---
window.askSophyToRefine = async function (section) {
  const inputId = section + "Input";
  const suggestionId = section + "Suggestion";
  const labelId = section + "SuggestionLabel";
  
  const input = document.getElementById(inputId)?.value.trim();
  const suggestionBox = document.getElementById(suggestionId);
  const label = document.getElementById(labelId);

  if (!input) {
    suggestionBox.textContent = `Please write something in your ${section} first.`;
    if (label) label.style.display = "block";
    return;
  }

  // Map section names to proper WISH terminology for display
  const sectionDisplayNames = {
    'wish': 'Want',
    'outcome': 'Imagine', 
    'opposition': 'Snags',
    'plan': 'How'
  };
  const displayName = sectionDisplayNames[section] || section;

  suggestionBox.textContent = `Refining your ${displayName} with Sophy...`;
  if (label) label.style.display = "block";

  try {
    let prompt = "";
    
    // Customize prompt based on section
    switch(section) {
      case 'wish':
        prompt = `You are Sophy, a supportive journaling assistant and WISH coach. Analyze this user's Wish and provide guidance on how well it aligns with effective WISH principles:

WISH EVALUATION CRITERIA:

1. BE SPECIFIC AND REALISTIC - Is it concrete rather than vague? Achievable with current abilities?
2. PERSONAL AND INSPIRING - Does it resonate personally? Is it challenging but possible?
3. FOCUS ON ONE PRIORITY - Is it singular and focused rather than multiple goals?
4. IMMEDIATE AND ACTIONABLE - Can it be acted on in the next few weeks/months?

User's Wish: ${input}

Please evaluate their wish against these criteria and provide specific, actionable advice on how to strengthen it. Consider:
- What's working well in their current wish?
- Which criteria could be improved and how?
- Specific suggestions to make it more effective for WISH

Provide your guidance as helpful coaching advice, not a rewrite. Help them understand what makes a strong wish and how they can refine theirs.

IMPORTANT: Provide coaching guidance and advice only. Do not rewrite their wish for them. Help them understand how to improve it themselves.`;
        break;
      case 'outcome':
        prompt = `You are Sophy, a supportive journaling assistant and WISH coach. Analyze this user's Imagine and provide guidance on how well it aligns with effective WISH principles:

IMAGINE EVALUATION CRITERIA:

1. VISUALIZE VIVIDLY - Does it include detailed imagery of what life will look like and how success will feel?
2. MAKE IT PERSONAL - Does it deeply matter to them and reflect their values?
3. BE CONCRETE AND SPECIFIC - Is it tangible and observable rather than abstract?
4. SAVOR THE FEELING - Does it capture emotions, sensations, and achievement feelings?

User's Imagine: ${input}

Please evaluate their imagination against these criteria and provide specific, actionable advice on how to strengthen it. Consider:
- What vivid details are already present vs. missing?
- How could they make it more personally meaningful?
- Where could they add concrete, observable elements?
- How might they better capture the emotional experience of success?

Provide coaching guidance to help them create a more motivating and compelling vision of their success.

IMPORTANT: Provide coaching guidance and advice only. Do not rewrite their imagination for them. Help them understand how to make it more vivid and motivating themselves.`;
        break;
      case 'opposition':
        prompt = `You are Sophy, a supportive journaling assistant and WISH coach. Analyze this user's Snags and provide guidance on how well it aligns with effective WISH principles:

SNAGS EVALUATION CRITERIA:

1. BE HONEST AND REFLECTIVE - Does it focus on internal roadblocks (self-doubt, procrastination, habits) rather than external circumstances?
2. MAKE IT SPECIFIC AND CLEAR - Is it concrete and specific rather than vague generalities?
3. FOCUS ON THE MOST RELEVANT OBSTACLE - Is it the one most likely to derail progress?
4. CONNECT EMOTION AND BEHAVIOR - Does it describe patterns, triggers, or how the obstacle typically manifests?

User's Snags: ${input}

Please evaluate their snags against these criteria and provide specific, actionable advice on how to strengthen them. Consider:
- Are they focusing on internal vs. external snags?
- How could they be more specific about the snag's pattern?
- Is this truly the most likely barrier to derail their progress?
- How might they better describe when and how this snag shows up?

Provide coaching guidance to help them identify the most relevant internal snag they can actually address.

IMPORTANT: Provide coaching guidance and advice only. Do not rewrite their snags for them. Help them understand how to identify and articulate their most critical internal barrier.`;
        break;
      case 'plan':
        prompt = `You are Sophy, a supportive journaling assistant and WISH coach. Analyze this user's How and provide guidance on how well it aligns with effective WISH principles:

HOW EVALUATION CRITERIA:

1. USE "IF-THEN" IMPLEMENTATION INTENTIONS - Is it structured as "If [snag] happens, then I will [specific action]"?
2. MAKE IT SPECIFIC AND FEASIBLE - Is it one clear, realistic action they can do in their daily context?
3. KEEP IT SIMPLE - Is it concise and focused on one main coping strategy?
4. PREPARE TO EXECUTE IMMEDIATELY - Can they visualize and immediately act when the snag appears?

User's How: ${input}

Please evaluate their plan against these criteria and provide specific, actionable advice on how to strengthen it. Consider:
- Does it follow the if-then format linking snag to action?
- Is the planned action specific, realistic, and doable for them?
- Is it simple enough to remember and execute in the moment?
- How could they make it more immediately actionable?

Provide coaching guidance to help them create a more effective implementation intention that will actually work when they encounter their snag.

IMPORTANT: Provide coaching guidance and advice only. Do not rewrite their plan for them. Help them understand how to create a stronger if-then implementation strategy themselves.`;
        break;
    }

    // Helper to call Sophy endpoint with prompt and get only the text response
    async function getSophyResponse(prompt) {
      // Occasionally include username for personalization (20% chance)
      let payload = { entry: prompt };
      if (Math.random() < 0.2) {
        const userName = await getCurrentUserName();
        if (userName) {
          payload.userName = userName;
        }
      }
      
      const data = await secureAIFetch("https://us-central1-inkwell-alpha.cloudfunctions.net/askSophy", payload);
      // Try to use .insight, fallback to full response
      return data.insight || data.response || "";
    }

    const response = await getSophyResponse(prompt);
    
    // Clean the response to remove any internal prompting or stage directions
    let cleanedResponse = response?.trim() || "Something went wrong.";
    if (cleanedResponse !== "Something went wrong.") {
      cleanedResponse = cleanedResponse
        .replace(/^\*[^*]*\*\s*/g, '') // Remove opening stage directions
        .replace(/\*[^*]*\*$/g, '') // Remove ending stage directions  
        .replace(/\*[^*]*\*/g, '') // Remove any remaining stage directions
        .replace(/^\*with\s+warmth\s+and\s+empathy\*\s*/gi, '') // Remove specific empathy stage direction
        .replace(/^\*[^*]*warmth[^*]*\*\s*/gi, '') // Remove warmth-related stage directions
        .replace(/^\*[^*]*empathy[^*]*\*\s*/gi, '') // Remove empathy-related stage directions
        .replace(/I\s+sense\s+there\s+is\s+an\s+important\s+wish/gi, '') // Remove specific AI prompt leakage
        .replace(/Let's\s+take\s+a\s+moment\s+to\s+vividly\s+imagine/gi, '') // Remove prompt instruction leakage
        .replace(/Envision\s+yourself\s+feeling/gi, '') // Remove visualization prompt leakage
        .replace(/Picture\s+yourself\s+with/gi, '') // Remove picture prompt leakage
        .trim();
    }
    
    suggestionBox.textContent = cleanedResponse;
  } catch (err) {
    console.error(`Error refining ${section}:`, err);
    suggestionBox.textContent = "Something went wrong.";
  }
};

// --- Updated replaceWithSuggestion function to handle all sections ---
window.replaceWithSuggestion = function (section) {
  if (section) {
    // Handle the new four-section version
    const suggestionId = section + "Suggestion";
    const inputId = section + "Input";
    
    const suggestion = document.getElementById(suggestionId)?.textContent;
    if (suggestion) {
      document.getElementById(inputId).value = suggestion;
    }
  } else {
    // Handle the original manifest section (for backward compatibility)
    const suggestion = document.getElementById("manifestSuggestion")?.textContent;
    if (suggestion) {
      document.getElementById("manifestInput").value = suggestion;
    }
  }
};







// --- ENHANCED WISH Timeline with Progress Animation ---
window.updateWishTimeline = function() {
  const timelineSelect = document.getElementById("wishTimelineSelect");
  const growthStages = document.getElementById("growthStages");
  const timelineLabels = document.getElementById("timelineLabels");
  
  if (!timelineSelect || !growthStages || !timelineLabels) return;
  
  const days = parseInt(timelineSelect.value);
  const quarterDays = days / 4;
  
  // Growth emoji progression
  const emojis = ["🪏", "🌱", "🍀", "🌿", "🌳"];
  const labels = ["Start", `${quarterDays} days`, `${quarterDays * 2} days`, `${quarterDays * 3} days`, `${days} days`];
  
  // Clear and populate growth stages
  growthStages.innerHTML = "";
  for (let i = 0; i < 4; i++) {
    const stage = document.createElement("div");
    stage.style.cssText = `
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    `;
    
    const emoji = document.createElement("div");
    emoji.style.cssText = `
      font-size: 2em;
      margin-bottom: 0.5em;
      transition: transform 0.3s ease;
      z-index: 2;
      position: relative;
    `;
    emoji.textContent = emojis[i];
    emoji.onmouseover = () => emoji.style.transform = "scale(1.2)";
    emoji.onmouseout = () => emoji.style.transform = "scale(1)";
    
    stage.appendChild(emoji);
    
    // Add connecting line (except for last stage)
    if (i < 3) {
      const connector = document.createElement("div");
      connector.style.cssText = `
        position: absolute;
        top: 1em;
        left: 50%;
        width: 100%;
        height: 2px;
        background: linear-gradient(to right, #2A6972, #4A8B8B);
        z-index: 1;
      `;
      stage.appendChild(connector);
    }
    
    growthStages.appendChild(stage);
  }
  
  // Clear and populate timeline labels
  timelineLabels.innerHTML = "";
  for (let i = 0; i < 5; i++) {
    const label = document.createElement("div");
    label.style.cssText = `
      flex: 1;
      text-align: center;
      font-weight: 500;
      color: #2A6972;
      font-size: 0.8em;
      padding: 0 0.25em;
    `;
    label.textContent = labels[i];
    timelineLabels.appendChild(label);
  }
  
  // Save timeline selection to localStorage
  if (window.currentUserId || window.auth?.currentUser?.uid) {
    const userId = window.currentUserId || window.auth?.currentUser?.uid;
    const key = `wishTimeline_${userId}`;
    localStorage.setItem(key, days.toString());
    console.log(`💾 Timeline saved: ${days} days for user ${userId}`);
    
    // If user has manifest data but no start date, set it now
    const savedManifest = localStorage.getItem(`manifest_${userId}`);
    const wishStartKey = `wishStart_${userId}`;
    const startDate = localStorage.getItem(wishStartKey);
    
    if (savedManifest && !startDate) {
      // User has manifest data but no start date - set it now
      localStorage.setItem(wishStartKey, new Date().toISOString());
      console.log("🎯 Set timeline start date for existing manifest data");
    }
  } else {
    console.warn("⚠️ Cannot save timeline - no user ID available");
  }
  
  // Update progress bar if WISH is active
  updateWishProgress();
};

// --- NEW: Progress Calculation & Animation ---
window.updateWishProgress = function() {
  const progressBar = document.getElementById("wishProgressBar");
  
  if (!progressBar) return;
  
  const currentUserId = window.currentUserId || window.auth?.currentUser?.uid;
  if (!currentUserId) return;
  
  // Check if user has saved WISH data AND has a start date (only starts after Save My WISH)
  const savedManifest = localStorage.getItem(`manifest_${currentUserId}`);
  const wishStartKey = `wishStart_${currentUserId}`;
  const startDate = localStorage.getItem(wishStartKey);
  
  if (!savedManifest || !startDate) {
    // No saved WISH or no start date - hide progress bar and show timeline input
    progressBar.style.display = "none";
    const timelineInputGroup = document.querySelector(".wish-timeline-input-group");
    if (timelineInputGroup) {
      timelineInputGroup.style.display = "block";
    }
    return;
  }
  
  const manifestData = JSON.parse(savedManifest);
  const hasWishContent = manifestData.wish && manifestData.wish.trim();
  
  if (!hasWishContent) {
    // No WISH content - hide progress bar and show timeline input
    progressBar.style.display = "none";
    const timelineInputGroup = document.querySelector(".wish-timeline-input-group");
    if (timelineInputGroup) {
      timelineInputGroup.style.display = "block";
    }
    return;
  }
  
  // Calculate progress
  const start = new Date(startDate);
  const now = new Date();
  const daysElapsed = Math.floor((now - start) / (1000 * 60 * 60 * 24));
  
  const timelineSelect = document.getElementById("wishTimelineSelect");
  const totalDays = timelineSelect ? parseInt(timelineSelect.value) : 60;
  
  const progressPercent = Math.min((daysElapsed / totalDays) * 100, 100);
  
  // Show subtle progress bar
  progressBar.style.display = "block";
  
  // Hide the timeline input section when progress bar is active
  const timelineInputGroup = document.querySelector(".wish-timeline-input-group");
  if (timelineInputGroup) {
    timelineInputGroup.style.display = "none";
  }
  
  // Update progress bar with calming colors
  const progressFill = document.getElementById("wishProgressFill");
  const progressMessage = document.getElementById("wishProgressMessage");
  
  if (progressFill) {
    progressFill.style.width = `${progressPercent}%`;
    
    // Gentle color progression - always calming teal tones
    if (progressPercent <= 25) {
      progressFill.style.background = "linear-gradient(90deg, rgba(42,105,114,0.4), rgba(42,105,114,0.6))";
    } else if (progressPercent <= 50) {
      progressFill.style.background = "linear-gradient(90deg, rgba(42,105,114,0.6), rgba(74,139,139,0.6))";
    } else if (progressPercent <= 75) {
      progressFill.style.background = "linear-gradient(90deg, rgba(74,139,139,0.6), rgba(74,139,139,0.8))";
    } else {
      progressFill.style.background = "linear-gradient(90deg, rgba(74,139,139,0.8), rgba(42,105,114,0.9))";
    }
  }
  
  // Only show encouraging message, no countdown pressure
  if (progressMessage) {
    if (progressPercent <= 25) {
      progressMessage.textContent = `Taking your first steps - you've begun something meaningful`;
    } else if (progressPercent <= 50) {
      progressMessage.textContent = `Building momentum - your consistency is creating change`;
    } else if (progressPercent <= 75) {
      progressMessage.textContent = `Making solid progress - you're developing new patterns`;
    } else if (progressPercent < 100) {
      progressMessage.textContent = `Approaching your timeline - notice how far you've come`;
    } else {
      progressMessage.innerHTML = `<strong>Timeline reached - Time for New WISH!</strong> <button onclick="resetWishTimeline()" style="margin-left: 10px; padding: 4px 8px; background: #2A6972; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Reset Timeline</button>`;
    }
  }
};

// --- NEW: Reset WISH Timeline Function ---
window.resetWishTimeline = function() {
  const userId = window.currentUserId || window.auth?.currentUser?.uid;
  if (!userId) {
    console.warn("⚠️ Cannot reset timeline - no user ID available");
    return;
  }
  
  // Reset the start date to today
  const wishStartKey = `wishStart_${userId}`;
  localStorage.setItem(wishStartKey, new Date().toISOString());
  
  console.log("🔄 WISH timeline reset - new start date set");
  
  // Update progress display immediately
  if (typeof window.updateWishProgress === 'function') {
    window.updateWishProgress();
  }
  
  // Show feedback
  if (window.showToast && typeof window.showToast === 'function') {
    window.showToast("Timeline reset! Your WISH journey starts fresh today.", "success", 3000);
  }
};

// --- ENHANCED: Update saveManifestData to trigger progress ---
// This should be added to your existing saveManifestData function after the successful save
// Add this line after the "Vision saved" success message:
// updateWishProgress();

// Initialize timeline on page load (ENHANCED VERSION)
document.addEventListener("DOMContentLoaded", () => {
  // Restore saved timeline selection
  if (window.currentUserId) {
    const key = `wishTimeline_${window.currentUserId}`;
    const savedDays = localStorage.getItem(key);
    if (savedDays) {
      const timelineSelect = document.getElementById("wishTimelineSelect");
      if (timelineSelect) {
        timelineSelect.value = savedDays;
      }
    }
  }
  
  // Initialize timeline visualization with progress
  setTimeout(() => {
    updateWishTimeline();
    updateWishProgress();
  }, 100);
});

// --- Integration with tab switching ---
// Add this to your showTab function for manifestTab
// setTimeout(() => {
//   if (typeof window.updateWishTimeline === "function") {
//     window.updateWishTimeline();
//   }
//   if (typeof window.updateWishProgress === "function") {
//     window.updateWishProgress();
//   }
// }, 100);





// Ensure calendar is built after defining all functions
// (Note: initial buildCalendar and showTab('journalTab') are called by auth listener after login)

// Function to refresh Past Entries display when theme changes
window.refreshPastEntriesTheme = function() {
  const entries = document.querySelectorAll('.entry-card');
  const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
  
  entries.forEach(entry => {
    if (isDarkTheme) {
      // Force remove inline background styles that override CSS
      entry.style.removeProperty('background');
      entry.style.removeProperty('color');
      
      // Add class to ensure dark theme styles apply
      entry.classList.add('dark-theme-entry');
      
      // Force reflow to ensure styles are applied
      entry.offsetHeight;
    } else {
      entry.classList.remove('dark-theme-entry');
    }
  });
};

// Add CSS for the dark theme class
const themeStyle = document.createElement('style');
themeStyle.textContent = `
html[data-theme='dark'] .entry-card.dark-theme-entry {
  background: linear-gradient(135deg, rgba(42, 105, 114, 0.15) 0%, rgba(30, 80, 85, 0.20) 100%) !important;
  color: #89C9D4 !important;
  border: 1px solid rgba(137, 201, 212, 0.25) !important;
  box-shadow: 0 0 20px rgba(137, 201, 212, 0.15), 0 4px 16px rgba(0, 0, 0, 0.25) !important;
}
html[data-theme='dark'] .entry-card.dark-theme-entry * {
  color: #89C9D4 !important;
}
html[data-theme='dark'] .entry-card.dark-theme-entry .entry-date,
html[data-theme='dark'] .entry-card.dark-theme-entry .fixed-dark-date {
  color: rgba(137, 201, 212, 0.8) !important;
}
`;
document.head.appendChild(themeStyle);

    // --- Password Reset Handler ---
    document.addEventListener("DOMContentLoaded", () => {
      const forgotBtn = document.getElementById("forgotPasswordBtn");
      if (forgotBtn) {
        forgotBtn.onclick = async () => {
          const email = document.getElementById("loginEmail").value.trim();
          const msgBox = document.getElementById("passwordResetMsg");

          if (!email) {
            msgBox.textContent = "Please enter your email above first.";
            return;
          }

          try {
            await sendPasswordResetEmail(auth, email);
            msgBox.textContent = "✅ Password reset email sent!";
          } catch (error) {
            msgBox.textContent = "⚠️ " + error.message;
          }
        };
      }
    });
  </script>
</head>


<body>
<!-- 🔐 Login Modal -->
<div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); overflow-y: auto; padding: 2em 0; box-sizing: border-box; z-index: 9999;">
  <div class="card-block" style="max-width: 400px; width: 90%; background: white; padding: 2em; border-radius: 8px; text-align: center; margin: 0 auto; min-height: fit-content;">
    <img src="InkWell-Logo.png" alt="InkWell Logo" style="max-height: 175px; margin-bottom: 1em;" />
    <form id="loginForm">
  <input type="email" id="loginEmail" placeholder="Email" required
        style="width: 90%; padding: 1em 1.2em; margin-bottom: 1em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font);" />
  <input type="password" id="loginPassword" placeholder="Password" required
        style="width: 90%; padding: 1em 1.2em; margin-bottom: 1em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font);" />
      <div class="g-recaptcha" data-sitekey="6LeCel0rAAAAAJVIplFBKgyy0oO-bYd2wr2_wqxI"
        style="margin: 0 auto 1em auto; width: 90%; display: flex; justify-content: flex-start;"></div>
      <button type="submit" class="btn"
        style="width: 90%; padding: 0.6em; background-color: #2A6972; color: white; border: none; border-radius: 5px;">Log In</button>
    </form>
    <div style="display: flex; justify-content: space-between; margin-top: 0.8em; font-size: 0.9em; width: 90%; margin-left: auto; margin-right: auto;">
      <a href="#" id="forgotPassword" style="color: #2A6972; text-decoration: underline;">Forgot password?</a>
      <a href="#" id="toggleSignup" style="color: #6A1B9A; text-decoration: underline; font-weight: 500;">Sign up</a>
    </div>
    <div style="text-align: center; font-size: 0.75em; color: #999; margin-top: 1em;">
      v2.25.190
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 9999;">
  <div class="card-block" style="max-width: 400px; width: 90%; background: var(--bg-card); padding: 2em; border-radius: 8px; text-align: center;">
    <h2 style="color: #d9534f; margin-bottom: 1em;">Delete Entry</h2>
    <p style="margin-bottom: 1.5em; color: var(--font-main);">Are you sure you want to delete this entry? This action cannot be undone.</p>
    <input type="hidden" id="deleteEntryId">
    <div style="display: flex; justify-content: center; gap: 1em;">
      <button onclick="closeDeleteModal()" class="btn" style="background-color: var(--bg-muted); color: var(--font-main);">Cancel</button>
      <button onclick="confirmDelete()" class="btn" style="background-color: #d9534f;">Delete</button>
    </div>
  </div>
</div>

<!-- Edit Entry Modal -->
<div id="editEntryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 9999;">
  <div class="card-block" style="max-width: 500px; width: 90%; background: white; padding: 2em; border-radius: 8px; text-align: center;">
    <img src="InkWell-Logo.png" alt="InkWell Logo" style="max-height: 100px; margin-bottom: 1.5em;" />
    
    <h2 style="margin-top: 0; margin-bottom: 1.5em; color: #2A6972; font-size: 1.3em;">
      ✏️ Edit Entry
    </h2>
    
    <form id="editEntryForm">
      <input type="hidden" id="editEntryId">
      
      <div style="text-align: left; margin-bottom: 1.5em;">
        <label for="editEntryText" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">Entry Text:</label>
        <textarea id="editEntryText" placeholder="Edit your journal entry..." 
          style="width: 100%; min-height: 200px; padding: 0.75em; border: 1px solid #ccc; border-radius: 5px; background-color: white; color: #0D3F45; font-size: 0.95em; box-sizing: border-box; resize: vertical; font-family: inherit; line-height: 1.5;"></textarea>
      </div>
      
      <div style="display: flex; gap: 0.5em; justify-content: center;">
        <button type="submit" class="btn" 
          style="flex: 1; padding: 0.6em; background-color: #2A6972; color: white; border: none; border-radius: 5px; font-weight: 500; cursor: pointer;">
          💾 Save Changes
        </button>
       <button type="button" onclick="closeEditModal()" class="btn btn-gray" 
  style="flex: 1;">
  Cancel
</button>
      </div>
    </form>
    
    <div style="text-align: center; font-size: 0.75em; color: #999; margin-top: 1.5em;">
      v2.25.190
    </div>
  </div>
</div>

<!-- ✨ Signup Modal (moved here to be with other modals and before </body>) -->
<div id="signupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); overflow-y: auto; padding: 2em 0; box-sizing: border-box; z-index: 9999;">
  <div class="card-block" style="max-width: 400px; width: 90%; background: white; padding: 2em; border-radius: 8px; text-align: center; margin: 0 auto; min-height: fit-content;">
    <img src="InkWell-Logo.png" alt="InkWell Logo" style="max-height: 175px; margin-bottom: 1em;" />
    <form id="signupForm">
      <input type="text" id="signupUsername" name="username" placeholder="User Name (optional)" 
        style="width: 90%; padding: 1em 1.2em; margin-bottom: 1em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font);" />
      <input type="url" id="signupAvatar" name="avatar" placeholder="Avatar/Profile Picture URL (optional)" 
        style="width: 90%; padding: 1em 1.2em; margin-bottom: 0.5em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font);" />
      <p style="font-size: 0.85em; color: #000000; margin: 0 0 1em 0; padding: 0 1em; text-align: left;">
        💡 <strong>Tip:</strong> Upload your image to a free service like <a href="https://imgur.com" target="_blank" style="color: #2A6972;">Imgur</a> or <a href="https://postimages.org" target="_blank" style="color: #2A6972;">PostImages</a>, then copy the direct image URL here.
      </p>
      <input type="email" id="signupEmail" name="email" placeholder="Email" required
        style="width: 90%; padding: 1em 1.2em; margin-bottom: 1em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font);" />
      <input type="password" id="signupPassword" name="password" placeholder="Password" required
        style="width: 90%; padding: 1em 1.2em; margin-bottom: 1em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font);" />
      
      <!-- Agreement Checkboxes -->
      <div style="width: 90%; margin: 1em auto; text-align: left;">
        <label style="display: block; margin-bottom: 0.5em; font-size: 0.9em; color: #2A6972;">
          <input type="checkbox" id="termsAgreement" name="termsAgreement" checked style="margin-right: 0.5em;">
          I agree to the <a href="https://pegasusrealm.com/terms-conditions/" target="_blank" style="color: #2A6972; text-decoration: underline;">Terms & Conditions</a>
        </label>
        <label style="display: block; margin-bottom: 0.5em; font-size: 0.9em; color: #2A6972;">
          <input type="checkbox" id="privacyAgreement" name="privacyAgreement" checked style="margin-right: 0.5em;">
          I agree to the <a href="https://pegasusrealm.com/privacy-policy/" target="_blank" style="color: #2A6972; text-decoration: underline;">Privacy Policy</a>
        </label>
        <label style="display: block; margin-bottom: 1em; font-size: 0.9em; color: #2A6972;">
          <input type="checkbox" id="betaAgreement" name="betaAgreement" checked style="margin-right: 0.5em;">
          I agree to the <a href="https://pegasusrealm.com/alpha-beta-testers/" target="_blank" style="color: #2A6972; text-decoration: underline;">Beta Testing Agreement</a>
        </label>
      </div>
      
      <div class="g-recaptcha" data-sitekey="6LeCel0rAAAAAJVIplFBKgyy0oO-bYd2wr2_wqxI"
        style="margin: 0 auto 1em auto; width: 90%; display: flex; justify-content: flex-start;"></div>
      <button type="submit" class="btn"
        style="width: 90%; padding: 0.6em; background-color: #2A6972; color: white; border: none; border-radius: 5px;">Sign Up</button>
      </form>
    <div style="margin-top: 0.8em;">
      <a href="#" id="toggleLogin" style="color: #2A6972; text-decoration: underline;">Already have an account?</a>
    </div>
  </div>
</div>




<!-- ✨ Header (Refined Avatar/Logo Container) -->
<header>
 <div class="logo-hero" style="
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 3.5em auto 2em auto;
  max-width: 320px;
  height: 140px;
  padding: 0.5em 2em;
  background: linear-gradient(135deg, #2A6972 0%, #1e5055 100%);
  border-radius: 20px;
  box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
  position: relative;
">
  
<div class="logo-hero-inner" aria-hidden="true">
  <img id="animatedImage"
    src="/InkWell-Logo.png"
    alt="InkWell Logo"
    class="logo-img"
  />
  <img id="avatarImage"
    src=""
    alt="User Avatar"
    class="avatar-img"
    onerror="this.src='/LOGO_SQ_Lg_Border_2024.png'; console.warn('Avatar image failed to load, using fallback');"
  />
</div>



</div>

<p style="margin-top: 3em; margin-bottom: 1em; font-size: 1.79em; color: var(--info-muted); letter-spacing: 0.02em; text-align: center; position: relative; z-index: 1;">
  For the thinkers and the forgetters.
  </p>
  <p style="margin-top: 1em; margin-bottom: 1.62em; font-size: 1.13em; color: var(--info-muted); letter-spacing: 0.02em; text-align: center; position: relative; z-index: 1;">
Life is messy. InkWell™ holds your ideas, plans, and dreams so you can come back to them anytime.
</p>


</header>

<div id="goodbyeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; z-index: 9999; background: rgba(0,0,0,0.7);">
  <div class="card-block" style="max-width: 400px; width: 90%; background: white; padding: 2em; border-radius: 8px; text-align: center;">
    <img src="InkWell-Logo.png" alt="InkWell Logo" style="max-height: 120px; margin-bottom: 1.5em;" />
    
    <h2 style="margin-top: 0; margin-bottom: 1em; color: #2A6972; font-size: 1.3em;">
      See You Soon! 👋
    </h2>
    
    <p style="color: #000000; margin-bottom: 0.5em; font-size: 1em;">
      Thanks for journaling with InkWell today.
    </p>
    
    <p style="color: #000000; margin-bottom: 2em; font-size: 0.95em;">
      Take care, and don't forget to stay positive.
    </p>
    
    <button id="returnToLoginBtn" class="btn" onclick="handleReturnToLogin()" 
      style="width: 80%; padding: 0.6em; background-color: #2A6972; color: white; border: none; border-radius: 5px; font-weight: 500; cursor: pointer;">
      Return to Login
    </button>
    
    <div style="text-align: center; font-size: 0.75em; color: #999; margin-top: 1.5em;">
      v2.25.190
    </div>
  </div>
</div>


<div id="mainUI" style="visibility:hidden;opacity:0;transition:opacity 0.3s, visibility 0.3s;">
  <!-- ✨ Main UI Container) -->
    <main id="mainAppContainer" style="
  display: none;
  width: 75%;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
  padding-left: 2em;
  padding-right: 2em;
  box-sizing: border-box;
">
<div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1em;">
  <button class="btn btn-gray" onclick="openUserSettingsModal()" style="font-size: 0.85em; padding: 0.4em 0.8em;">
    ⚙️ Settings
  </button>
</div>


<!-- ✨ MODERN TAB UI - Clean Design with Better Visual Separation -->
<div class="modern-tab-container" style="
  background: linear-gradient(135deg, #f8fafb 0%, #e9ecef 100%);
  border-radius: 16px;
  padding: 1.5em;
  margin: 2em auto;
  max-width: 1200px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.08);
  border: 1px solid rgba(255,255,255,0.2);
">
  
  <style>
    .modern-tab-btn.active {
      background: linear-gradient(135deg, #2A6972 0%, #1e5055 100%) !important;
      color: white !important;
      font-weight: 600 !important;
      box-shadow: 0 6px 20px rgba(42,105,114,0.4) !important;
      border: none !important;
      transform: translateY(-1px) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    /* Force all tab buttons to have identical dimensions */
    .modern-tab-btn {
      flex: none !important;
      width: 160px !important;
      min-width: 160px !important;
      max-width: 160px !important;
      padding: 0.75em 1em !important;
      box-sizing: border-box !important;
    }
    
    /* Force tab navigation container to maintain consistent layout */
    .tab-nav {
      display: flex !important;
      justify-content: center !important;
      gap: 0.5em !important;
      width: 100% !important;
      flex-wrap: nowrap !important;
    }
    
    /* Ensure tab content doesn't affect tab button sizing */
    .modern-tab-container {
      contain: layout !important;
    }
  </style>
  <!-- Modern Tab Navigation -->
  <nav class="tab-nav" style="
    display: flex;
    gap: 0.5em;
    margin-bottom: 2em;
    background: rgba(255,255,255,0.7);
    padding: 0.5em;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    justify-content: center;
  ">
    <button 
      class="modern-tab-btn" 
      id="journalTabButton" 
      onclick="showTab('journalTab')"
      data-tab="journal"
      style="
        flex: none;
        width: 160px;
        padding: 0.75em 1em;
        border: none;
        border-radius: 8px;
        background: rgba(255,255,255,0.8);
        color: #2A6972;
        font-weight: 500;
        font-size: 0.95em;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(42,105,114,0.2);
      "
    >
      ✍️ Journaling
    </button>
    
    <button 
      class="modern-tab-btn" 
      id="manifestTabButton" 
      onclick="showTab('manifestTab')"
      data-tab="manifest"
      style="
        flex: none;
        width: 160px;
        padding: 0.75em 1em;
        border: none;
        border-radius: 8px;
        background: rgba(255,255,255,0.8);
        color: #2A6972;
        font-weight: 500;
        font-size: 0.95em;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(42,105,114,0.2);
      "
    >
      🎯 Manifesting
    </button>
    
    <button 
      class="modern-tab-btn" 
      id="calendarTabButton" 
      onclick="showTab('calendarTab')"
      data-tab="calendar"
      style="
        flex: none;
        width: 160px;
        padding: 0.75em 1em;
        border: none;
        border-radius: 8px;
        background: rgba(255,255,255,0.8);
        color: #2A6972;
        font-weight: 500;
        font-size: 0.95em;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(42,105,114,0.2);
      "
    >
      📚 Past Entries
    </button>
  </nav>

  <!-- Tab Content Container -->
  <div class="tab-content-wrapper" style="
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    min-height: 500px;
    border: 1px solid rgba(255,255,255,0.5);
    backdrop-filter: blur(5px);
  ">

<!-- Journal Tab Content -->
<div id="journalTab" class="modern-tab-content" style="display: block; padding: 2em;">
<div class="tab-inner" style="width: 100%; box-sizing: border-box; padding: 0 1em;">
     <h2 class="journal-heading" style="text-align:center;margin-bottom:2rem;color:var(--font-main);">Your Journal</h2>

<div class="instruction-section" style="background: var(--info-bg, #eaf6fb); padding: 1.5em; border-radius: 8px; border-left: 4px solid #2A6972; margin: 1em 0;">
  <h4 style="margin-top: 0; color: #2A6972; font-size: 1.1em;">🛋️ This is your brain's comfy lounge</h4>
  
  <div style="color: #333; line-height: 1.5; font-size: 0.95em;">
    <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
      <span style="margin-right: 0.5rem; font-size: 1.1rem;">💭</span>
      <span>Dump your thoughts, dreams, half-baked ideas — whatever's buzzing around up there</span>
    </div>
    
    <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
      <span style="margin-right: 0.5rem; font-size: 1.1rem;">✍️</span>
      <span>Need a nudge? Sophy's got writing prompts you can save right into your entry</span>
    </div>
    
    <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
      <span style="margin-right: 0.5rem; font-size: 1.1rem;">🎤</span>
      <span>Not in the mood to type? Fire up InkOutLoud and just talk it out</span>
    </div>
    
    <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
      <span style="margin-right: 0.5rem; font-size: 1.1rem;">🎨</span>
      <span>Add pics, files, doodles — jazz things up however you want</span>
    </div>
    
    <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
      <span style="margin-right: 0.5rem; font-size: 1.1rem;">🤝</span>
      <span>Share with your practitioner for that "real human insight" no algorithm can touch</span>
    </div>
  </div>
  
  <p style="margin: 1em 0 0 0; color: #666; font-size: 0.9em; font-style: italic; text-align: center;">
    🎢 Your mind's playground is open. Go play.
  </p>
</div>

    <p class="subtext-muted" style="margin-top: 1em;">If you want a topic or some inspiration, <strong>Sophy</strong> can suggest ideas — you can even give her a topic to focus on.</p>

    <input
      type="text"
      id="promptTopic"
      class="ai-input"
      placeholder="e.g., burnout last week, goals, feeling stuck"
    />
    <button class="btn btn-sophy" onclick="generatePrompt()" style="color:#ffffff;">Ask Sophy for a Prompt</button>
    <p id="generatedPrompt" class="sophy-info" style="color:#FDF7F1 !important;"></p>

    <label style="font-size:0.85em;display:block;margin-top:0.5em;margin-bottom:0.5em;">
      <input type="checkbox" id="autoInsertPrompt" />
      Save this Prompt in my Journal Entry
    </label>

    <div class="workflow-divider"></div>

    <button id="voiceBtn" class="btn" style="margin-bottom:0.5em;">🎙️ InkOutLoud</button>
    <div id="voiceStatus" style="font-size:0.85em;color:#2A6972;margin-bottom:1em;"></div>

    <h2 class="journal-heading" style="text-align:center;margin-bottom:2rem;color:var(--font-main);">Journal Entry</h2>
    <textarea id="journal" placeholder="Write your thoughts here..." style="width:100%;box-sizing:border-box;margin-bottom:0.5em;"></textarea>
    <div id="entryStatus" style="font-size:0.85em;margin-top:0.5em;"></div>

<button type="button" class="btn btn-sophy" id="askSophyBtn" style="color:#ffffff;" onclick="askSophyToReflect()">Ask Sophy for Reflection</button>    <div id="sophyInsight" class="sophy-info" style="white-space:pre-wrap;"></div>

    <label style="font-size:0.85em;display:block;margin-top:0.5em;margin-bottom:0.5em;">
      <input type="checkbox" id="autoInsertReflection" />
      Save this Reflection in my Journal Entry
    </label>

    <hr style="margin:2em 0;border:none;border-top:1px solid #3a6b6b;" />

    <p style="margin-bottom:1em; color: #333;">
      Attach one or more photos or files to enrich your journal entry. Multiple files can be selected before saving. Take your time; every small detail counts in your growth journey.
    </p>
    <label for="attachment" style="display:block;font-weight:600; color: #333;">Select files to upload:</label>
    <input type="file" id="attachment" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,image/*" style="margin-bottom:1em;" multiple />
    <div id="attachmentPreview" style="margin-bottom:1em;"></div>

    <div class="workflow-divider"></div>

    <!-- Coach tag + Save belong to Journal tab -->
    <div class="coach-tag-toggle">
      <input type="checkbox" id="coachReviewCheckbox" />
      <label for="coachReviewCheckbox">📬 Send this entry to my practitioner</label>
    </div>

    <button class="btn" onclick="saveJournalEntry()" style="margin-top:0.5em;">Save Journal Entry</button>
    <span id="saveStatus" style="margin-left:10px;font-style:italic;"></span>
  </div>
</div>

<!-- Manifest Tab Content -->
<div id="manifestTab" class="modern-tab-content" style="display:none; padding: 2em;">
  <div class="tab-inner">
<h2 class="manifest-heading" style="text-align:center;margin-bottom:2rem;color:var(--font-main);">Your WISH</h2>

<div class="instruction-section" style="background: var(--info-bg, #eaf6fb); padding: 1.5em; border-radius: 8px; border-left: 4px solid #2A6972; margin: 1em 0;">
  <h4 style="margin-top: 0; color: #2A6972; font-size: 1.1em;">🎯 Your personal guiding vision</h4>
  
  <div style="color: #333; line-height: 1.5; font-size: 0.95em;">
    <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
      <span style="margin-right: 0.5rem; font-size: 1.1rem;">🎯</span>
      <span>Dream big, then get real — contrast your ideal future with what's actually stopping you</span>
    </div>
    
    <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
      <span style="margin-right: 0.5rem; font-size: 1.1rem;">🧠</span>
      <span>Your biggest obstacles aren't "out there" — they're the voice in your head saying you can't</span>
    </div>
    
    <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
      <span style="margin-right: 0.5rem; font-size: 1.1rem;">⚡</span>
      <span>Turn good intentions into action scripts: "If X derails me, then I will do Y"</span>
    </div>
  </div>
  
  <p style="margin: 1em 0 0 0; color: #666; font-size: 0.9em; font-style: italic; text-align: center;">
    🌟 Make it meaningful. Make it yours.
  </p>
  
  <p style="margin: 1em 0 0 0; color: #2A6972; font-size: 0.95em; font-weight: 500; text-align: center;">
    Work through these 4 steps and turn hopeful thinking into an actual game plan and fulfill your WISH!
  </p>
</div>

   <!-- Timeline Section with Dynamic Progress - THEME COMPATIBLE VERSION -->
<div class="wish-timeline-container">
  <h4 class="wish-timeline-title">🎯 Timeline for Your WISH</h4>
  
  <div class="wish-timeline-input-group">
    <label for="wishTimelineSelect" class="wish-timeline-label">How many days to achieve this WISH?</label>
    <select id="wishTimelineSelect" onchange="updateWishTimeline()" class="wish-timeline-select">
      <option value="30">30 days</option>
      <option value="60" selected>60 days</option>
      <option value="90">90 days</option>
    </select>
  </div>

  <!-- Static Timeline (shows before saving) -->
  <div id="staticTimeline" style="text-align: center;">
    <p style="margin: 0 0 1em 0; color: #2A6972; font-weight: 500; font-size: 0.9em;">Your WISH Growth Journey</p>
    <div id="growthStages" style="
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      max-width: 400px; 
      margin: 0 auto;
    ">
      <!-- Stages will be populated by JavaScript -->
    </div>
    <div id="timelineLabels" style="
      display: flex; 
      justify-content: space-between; 
      margin-top: 0.5em; 
      font-size: 0.8em; 
      color: #666;
      max-width: 400px; 
      margin-left: auto;
      margin-right: auto;
    ">
      <!-- Labels will be populated by JavaScript -->
    </div>
  </div>
  
  <!-- Dynamic Progress Bar (shows after saving) -->
  <div id="wishProgressBar" style="display: none; margin-top: 1.5em;">
    <h4 style="text-align: center; color: #2A6972; margin-bottom: 0.8em; font-size: 1em;">Your WISH Growth Journey</h4>
    
    <div style="position: relative; height: 25px; background: #f0f0f0; border-radius: 15px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); margin: 0 auto; width: 75%; max-width: 400px;">
      <div id="wishProgressFill" style="position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: linear-gradient(90deg, #4a9ead, #7bb8c4); transition: width 0.8s ease, background 0.5s ease; border-radius: 15px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px;">
        <span id="wishProgressEmoji" style="font-size: 1.2em; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.15));">🌱</span>
      </div>
    </div>
    
    <p id="wishProgressMessage" style="text-align: center; font-style: italic; color: #666; margin-top: 0.8em; font-size: 0.9em;"></p>
  </div>
</div>

<!-- Wish Block -->
<div class="wish-section">
    <h2 class="journal-heading" style="text-align:center;margin-bottom:2rem;color:var(--font-main);">Want</h2>

    <textarea id="wishInput" placeholder="Identify a deeply meaningful, specific, and attainable goal that you truly want to achieve.

- What is something I genuinely want to accomplish?
- Is this challenging yet realistic for me?" style="width:100%;height:133px;margin-bottom:1em;padding:0.5em;border-radius:5px;border:1px solid #ccc;box-sizing:border-box;max-width:100%;"></textarea>


    <p id="wishStatus" style="margin-top:0.5em;font-style:italic;"></p>
    <button class="btn btn-sophy" onclick="askSophyToRefine('wish')">Reflect on your Want with Sophy</button>
    <div id="wishSuggestion" class="sophy-info"></div>
</div>

<div class="workflow-divider"></div>

<!-- Outcome Block -->
<div class="wish-section">
      <h2 class="journal-heading" style="text-align:center;margin-bottom:2rem;color:var(--font-main);">Imagine</h2>

    <textarea id="outcomeInput" placeholder="Vividly imagine and describe the best possible result of achieving what you want.

- What would success look and feel like in detail?
- How will my life be different and better?" style="width:100%;height:133px;margin-bottom:0.5em;padding:0.5em;border-radius:5px;border:1px solid #ccc;box-sizing:border-box;max-width:100%;"></textarea>

    <p id="outcomeStatus" style="margin-top:0.5em;font-style:italic;"></p>
    <button class="btn btn-sophy" onclick="askSophyToRefine('outcome')">Reflect on your Imagine with Sophy</button>
    <div id="outcomeSuggestion" class="sophy-info"></div>
</div>

<div class="workflow-divider"></div>

<!-- Opposition Block -->
<div class="wish-section">
        <h2 class="journal-heading" style="text-align:center;margin-bottom:2rem;color:var(--font-main);">Snags</h2>

    <textarea id="oppositionInput" placeholder="Recognize internal and external snags that could interfere with your success.

- What within me (habits, thoughts, beliefs) might get in the way?
- Which external factors or obstacles could derail my progress?" style="width:100%;height:133px;margin-bottom:0.5em;padding:0.5em;border-radius:5px;border:1px solid #ccc;box-sizing:border-box;max-width:100%;"></textarea>

    <p id="oppositionStatus" style="margin-top:0.5em;font-style:italic;"></p>
    <button class="btn btn-sophy" onclick="askSophyToRefine('opposition')">Reflect on your Snags with Sophy</button>
    <div id="oppositionSuggestion" class="sophy-info"></div>
</div>

<div class="workflow-divider"></div>

<!-- Plan Block -->
<div class="wish-section">
        <h2 class="journal-heading" style="text-align:center;margin-bottom:2rem;color:var(--font-main);">How</h2>

    <textarea id="planInput" placeholder="Create “if-then” statements for overcoming the snags you identified.

- If I encounter [specific snag], then I will [planned response or action].
- How will I get back on track when things go wrong?" style="width:100%;height:133px;margin-bottom:0.5em;padding:0.5em;border-radius:5px;border:1px solid #ccc;box-sizing:border-box;max-width:100%;"></textarea>

    <p id="planStatus" style="margin-top:0.5em;font-style:italic;"></p>
    <button class="btn btn-sophy" onclick="askSophyToRefine('plan')">Reflect on your How with Sophy</button>
    <div id="planSuggestion" class="sophy-info"></div>
</div>

    <!-- Coach guidance for Manifest tab -->
    
    <div class="instruction-section" style="background: var(--info-bg, #eaf6fb); padding: 1.5em; border-radius: 8px; border-left: 4px solid #2A6972; margin: 1em 0;">
      <h4 style="margin-top: 0; color: #2A6972; font-size: 1em;">✨ Want to share your WISH with your practitioner?</h4>
      <p style="margin: 0.5em 0; color: #333; line-height: 1.5; font-size: 0.95em;">
        Your WISH is a personal visioning tool for your private reflection. To share it with your practitioner, 
        create a <strong>journal entry</strong> about your WISH using the "Journal" tab, then tag it for practitioner review. 
        Your current WISH will automatically be included as context with your entry.
      </p>
      <p style="margin: 0.5em 0 0 0; color: #666; font-size: 0.9em; font-style: italic;">
        � Consider reflecting: What insights emerged from this WISH? What support do you need from your practitioner?
      </p>
    </div>

    <div class="workflow-divider"></div>

    <button class="btn" onclick="saveManifest()" style="margin-top:0.5em;">Save My WISH</button>
    <button class="btn btn-gray" onclick="clearManifestData()" style="margin-top:0.5em;margin-left:1em;">Time for New WISH</button>
    <span id="manifestSaveStatus" style="margin-left:10px;font-style:italic;"></span>
  </div>
</div>

<!-- Past Entries Tab Content -->
<div id="calendarTab" class="modern-tab-content" style="display:none; padding: 2em; box-sizing: border-box; max-width: 100%; overflow-x: hidden;">
  <div class="tab-inner">
<h2 class="journal-heading" style="text-align:center;margin-bottom:2rem;color:var(--font-main);">Your Past Entries</h2>

    <div class="instruction-section" style="background: var(--info-bg, #eaf6fb); padding: 1.5em; border-radius: 8px; border-left: 4px solid #2A6972; margin: 1em 0;">
      <h4 style="margin-top: 0; color: #2A6972; font-size: 1.1em;">🪄 Your journaling history awaits</h4>
      
      <div style="color: #333; line-height: 1.5; font-size: 0.95em;">
        <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
          <span style="margin-right: 0.5rem; font-size: 1.1rem;">📅</span>
          <span>Browse your entries by date using the calendar below</span>
        </div>
        
        <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
          <span style="margin-right: 0.5rem; font-size: 1.1rem;">🔍</span>
          <span>Use Smart Search to find entries by keywords, themes, or feelings</span>
        </div>
        
        <div style="display: flex; align-items: flex-start; margin: 0.75em 0;">
          <span style="margin-right: 0.5rem; font-size: 1.1rem;">✨</span>
          <span>Revisit your growth journey and see how far you've come</span>
        </div>
      </div>
      
      <p style="margin: 1em 0 0 0; color: #666; font-size: 0.9em; font-style: italic; text-align: center;">
        📖 Every entry is a chapter in your story.
      </p>
    </div>

    <div class="workflow-divider"></div>

    <div id="calendarControls" style="text-align: center; margin-bottom: 1em;">
      <button class="btn" onclick="changeMonth(-1)">← Previous</button>
      <button class="btn" onclick="changeMonth(1)">Next →</button>
    </div>
    <div id="calendarContainer"></div>
    
    <div class="workflow-divider"></div>

<!-- Smart Search Bar UI -->
    <div style="margin-top: 2em; width: calc(100% - 2em); margin-left: auto; margin-right: auto;">
      <h3 class="section-header" style="text-align:center;margin-bottom:1.5rem;color:var(--font-main);">Smart Search Your Journal</h3>
      <div style="display: flex; flex-direction: column; gap: 1em; width: 100%;">
        <input
          type="text"
          id="searchQuery"
          class="ai-input"
          placeholder="e.g., burnout last week, goals, feeling stuck"
          style="width: 100%; box-sizing: border-box;"
        />
        <button class="btn" id="searchBtn" onclick="runSmartSearch()" disabled style="width: 100%;">Search</button>
      </div>
  <div id="searchResults" style="margin-top: 1em; width: 100%;"></div>
  <div id="emptyPastEntriesMessage" style="display:none;"></div>
  <div id="calendarEntries" style="display:none;"></div>
    </div>

    <div id="pastEntries" style="margin-top: 1em;"></div>    
  </div>
</div>

  </div> <!-- Close tab-content-wrapper -->
</div> <!-- Close modern-tab-container -->

<!-- Footer Start -->
  <footer style="margin-top: 2em; font-size: 0.85em; text-align: center;">
    <span style="display: block; margin-bottom: 0.2em;">
      © 2025 Pegasus Realm LLC.
    </span>
    <span style="display: block; margin-bottom: 0.2em;">
      InkWell is your trusted journaling companion, designed with evidence-based positive psychology principles to foster well-being, focus, and productivity.
    </span>
    <span style="display: block;">
      Especially mindful of neurodivergent-friendly UI efficiency and clarity.
    </span>
    <p>
      <a href="https://www.inkwelljournal.io/privacy-policy/" target="_blank" style="text-decoration: underline;">Privacy Policy</a> |
      <a href="https://www.inkwelljournal.io/terms-conditions/" target="_blank" style="text-decoration: underline;">Terms and Conditions</a> |
      <a href="https://www.inkwelljournal.io/alpha-beta-testers/" target="_blank" style="text-decoration: underline;">Alpha/Beta Tester Agreement</a>
    </p>
    <div style="display: flex; justify-content: center; align-items: flex-start; gap: 4em; margin-bottom: 1.3em;">
      <!-- Pegasus Realm block -->
      <div style="display:flex; flex-direction:column; align-items:center;">
        <img src="/PR Logo WHITE.svg" alt="Pegasus Realm Logo" width="54" height="54" style="margin-bottom: 0.5em;"/>
        <div style="display:flex; gap:10px; margin-top:0;">
          <!-- PR IG -->
          <a href="https://www.instagram.com/pegasus.realm/" target="_blank" aria-label="Pegasus Realm Instagram">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24" style="vertical-align:middle;">
              <rect x="3" y="3" width="18" height="18" rx="5" fill="none" stroke="currentColor"/>
              <circle cx="12" cy="12" r="5" stroke="currentColor"/>
              <circle cx="17" cy="7" r="1.3" fill="currentColor"/>
            </svg>
          </a>
          <!-- PR LI -->
          <a href="https://www.linkedin.com/company/pegasus-realm" target="_blank" aria-label="Pegasus Realm LinkedIn">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align:middle;">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
          </a>
        </div>
      </div>
      <!-- Adam Grimm block -->
      <div style="display:flex; flex-direction:column; align-items:center;">
        <img src="/AG Silhouette.svg" alt="Adam Grimm Silhouette" width="54" height="54" style="margin-bottom: 0.5em;"/>
        <div style="display:flex; gap:10px; margin-top:0;">
          <!-- Adam IG -->
          <a href="https://www.instagram.com/gestaltinsight/" target="_blank" aria-label="Adam Grimm Instagram">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" viewBox="0 0 24 24" style="vertical-align:middle;">
              <rect x="3" y="3" width="18" height="18" rx="5" fill="none" stroke="currentColor"/>
              <circle cx="12" cy="12" r="5" stroke="currentColor"/>
              <circle cx="17" cy="7" r="1.3" fill="currentColor"/>
            </svg>
          </a>
          <!-- Adam LI -->
          <a href="https://www.linkedin.com/in/adamgrimm808/" target="_blank" aria-label="Adam Grimm LinkedIn">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="vertical-align:middle;">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </footer>
  </main>

<!-- Feedback Block -->
 <div style="color: var(--text-light); margin-top: 2em; text-align: center;">
 <button id="logoutBtn" class="btn btn-gray" style="margin-bottom: 1em;">
  Log Out
</button>
  <h3 style="color: var(--text-light);">We're Building InkWell Together</h3>
  <p style="margin-bottom: 1em;">
    Your feedback shapes everything. If you have ideas, concerns, or suggestions, we'd love to hear from you.
  </p>
  <p style="margin-bottom: 1.5em;">
    Our goal is to make InkWell the most intuitive and supportive journaling companion — grounded in clarity, science, and your lived experience.
  </p>
  <div style="display: flex; justify-content: center; margin-top: 1em;">
 <button onclick="window.location.href='mailto:support@inkwelljournal.io';" class="btn">
  Email the InkWell Team
</button>
</div>

</div>
<!-- End mainUI -->

  <div id="aboutInkwellModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(21,54,58,0.86); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#2A6972; padding:2em 1.3em 1.5em 1.3em; border-radius:10px; max-width:560px; width:92%; max-height:86vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.13);">
      <h2 style="margin-top:0; text-align:center;">About InkWell</h2>
      <div style="font-size:1em; line-height:1.65; margin-bottom:1.2em;">
        <strong>InkWell</strong> is part of the Pegasus Realm wellness ecosystem—designed for individuals, coaches, counselors, and mental health practitioners seeking science-backed, intuitive tools for growth.
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">Why Manifest Statements?</h3>
        At the heart of InkWell is your Manifest Statement: a personal guiding vision. This method draws on <strong>goal-setting theory</strong> and positive psychology, helping you translate intentions into action through evidence-based habit building and self-reflection.<br/>
        <span style="font-size:0.98em; color:#388b97;">
          <em>Research shows written goals and expressive journaling increase achievement, resilience, and emotional well-being.</em>
        </span>
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">The Power of Journaling</h3>
        Journaling improves clarity, well-being, and positive behavior change. It’s linked to increased self-awareness, reduced anxiety, and improved coping skills.<br/>
        <span style="font-size:0.98em; color:#388b97;">
          <em>References: Pennebaker & Smyth (2016), Baikie & Wilhelm (2005), Locke & Latham (2002)</em>
        </span>
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">Sophy: Your AI Guide</h3>
        Sophy supports you with <b>positive psychology</b> strategies, evidence-based habit support, and guidance from both Western and Hawaiian models of wellness.<br/>
        <ul style="font-size:0.97em; margin:0.5em 0 0 1em;">
          <li><b>SAMHSA’s 8 Dimensions of Wellness</b> – holistic, practical, and evidence-based.</li>
          <li><b>Kūkulu Kumuhana</b> – rooted in Native Hawaiian wisdom, emphasizing collective well-being, connectedness, and purpose through culture and community.</li>
        </ul>
        Sophy motivates and supports you as you work toward your goals, blending proven frameworks with the spirit of aloha.
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">Feeling Overwhelmed?</h3>
        Try the <strong>Aloha Wellness Guide™</strong> at <a href="https://www.alohawellness.guide" target="_blank" style="color:#2A6972;text-decoration:underline;">alohawellness.guide</a> for simple, beginner-friendly wellness tips. InkWell is best for those ready to deepen their journey and set actionable goals.
        <hr style="margin:1em 0;"/>
        <h3 style="font-size:1.09em;">About the Founder</h3>
        <div style="font-size: 0.98em; line-height:1.55; margin:0.7em 0;">
        Adam Grimm’s journey into wellness began during a transformative period in his life, leading to a 20-year career in the U.S. Air Force. As an Explosive Ordnance Disposal (EOD) Technician, Adam served in active war zones and led the response team at Daniel K. Inouye (Honolulu) International Airport, developing resilience and leadership skills under intense pressure. Following his medical retirement in 2021, Adam channeled his experiences into advancing mental health and wellness initiatives in Hawai‘i.<br/><br/>
        Adam earned his Bachelor’s degree in Psychology from the University of Hawai‘i at Mānoa, where he contributed to the CDC-funded Overdose Data to Action (OD2A)-Care Coordination and Capacity Building (C3) Project. His work focused on combating the opioid epidemic across O‘ahu, Kaua‘i, and Moloka‘i by fostering collaboration among law enforcement, educational institutions, and local organizations.<br/><br/>
        Adam also served as a research assistant for three years, delving into organizational wellness, lived experience, and preventative care within Hawai‘i’s non-profit sector. Now pursuing his Doctorate in Clinical Psychology at the Hawai‘i School of Professional Psychology at Chaminade University, Adam balances his academic pursuits with his role at Hawai‘i Neuropsychology, where he supports patients with diverse mental health needs.<br/><br/>
        He has begun in-person psychoeducation sessions about wellness and action at the Present Mind Institute Hawaii, in Kaneohe, that you can participate in.<br/><br/>
        In addition, Adam is the founder of Pegasus Realm, a wellness research and consulting company dedicated to improving well-being through innovative, evidence-based practices. His work focuses on creating holistic wellness strategies for individuals and organizations, blending research, coaching, and a deep understanding of lived experience to enhance quality of life and foster adaptability and equity.
        </div>
        <hr style="margin:1em 0;"/>
        <div style="font-size:0.96em; text-align:center; color:#2A6972;">
          <b>For questions, feedback, or upgrade ideas:<br/>
          <a href="mailto:support@inkwelljournal.io" style="color:#2A6972; text-decoration:underline;">support@inkwelljournal.io</a></b>
        </div>
      </div>
      <button class="btn" onclick="document.getElementById('aboutInkwellModal').style.display='none'">Close</button>
    </div>
  </div>

<!-- Welcome to Beta Modal -->
<div id="welcomeBetaModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(21,54,58,0.86); z-index:10000; align-items:center; justify-content:center;">
  <div style="background: var(--bg-card, #fff); color: var(--font-main, #2A6972); padding:2em 1.5em 1.5em 1.5em; border-radius:12px; max-width:700px; width:94%; max-height:90vh; overflow-y:auto; box-shadow:0 12px 40px rgba(0,0,0,0.15); border: 1px solid var(--border, rgba(42,105,114,0.1));">
    
    <div style="text-align: center; margin-bottom: 1.5em;">
      <img src="InkWell-Logo.png" alt="InkWell Logo" style="max-height: 80px; margin-bottom: 0.5em;" />
      <h2 style="margin: 0; font-size: 1.4em; color: var(--brand-primary, #2A6972);">Welcome to InkWell Beta! 🌟</h2>
      <p style="margin: 0.5em 0; font-style: italic; color: var(--text-secondary, #666); font-size: 1.1em;">"For the thinkers and the forgetters."</p>
    </div>
    
    <div style="font-size: 0.95em; line-height: 1.6; color: var(--font-main, #333);">
      <p style="margin-bottom: 1.2em;">
        Life is messy—<strong>InkWell™</strong> holds your ideas, plans, and dreams so you can come back to them anytime. You're now part of our beta community, helping us refine a digital sanctuary designed for reflection and growth.
      </p>
      
      <h3 style="color: var(--brand-primary, #2A6972); font-size: 1.1em; margin: 1.3em 0 0.7em 0;">What You Can Do in InkWell:</h3>
      
      <div style="margin-bottom: 1.2em;">
        <h4 style="color: var(--brand-secondary, #4A8B8B); font-size: 1em; margin: 0.8em 0 0.4em 0;">✍️ Core Journaling</h4>
        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
          <li>Unlimited journaling with a clean, neurodivergent-friendly interface</li>
          <li>Voice journaling with "InkOutLoud" - speak your thoughts and let AI clean up your transcriptions</li>
          <li>File attachments - enrich entries with photos, documents, and media</li>
          <li>WISH Goal Tracking - structure your aspirations with our "Wants, Imagination, Snags, and How" framework</li>
        </ul>
      </div>
      
      <div style="margin-bottom: 1.2em;">
        <h4 style="color: var(--brand-secondary, #4A8B8B); font-size: 1em; margin: 0.8em 0 0.4em 0;">🤖 Meet Sophy - Your AI Wellness Guide</h4>
        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
          <li>Personalized prompts to spark meaningful reflection (25/month on Basic, unlimited on Plus)</li>
          <li>AI-powered insights that recognize patterns and growth opportunities</li>
          <li>Weekly email insights analyzing your mood patterns and growth themes</li>
          <li>Evidence-based coaching grounded in positive psychology principles</li>
          <li>24/7 availability - Sophy never sleeps, so your growth never has to pause</li>
        </ul>
      </div>
      
      <div style="margin-bottom: 1.2em;">
        <h4 style="color: var(--brand-secondary, #4A8B8B); font-size: 1em; margin: 0.8em 0 0.4em 0;">🤝 Professional Support</h4>
        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
          <li>Connect with practitioners - licensed therapists, counselors, and coaches</li>
          <li>Secure practitioner portal for professional guidance integration</li>
          <li>Coach communication directly within your journaling space</li>
        </ul>
      </div>
      
      <div style="margin-bottom: 1.2em;">
        <h4 style="color: var(--brand-secondary, #4A8B8B); font-size: 1em; margin: 0.8em 0 0.4em 0;">📊 Growth & Analytics</h4>
        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
          <li>Progress tracking with mood patterns and reflection insights</li>
          <li>Growth analytics to visualize your personal development journey</li>
          <li>Manifest creation to clarify your vision and track meaningful goals</li>
          <li>Weekly insight emails from Sophy - personalized reflection on your growth patterns</li>
        </ul>
      </div>
      
      <div style="margin-bottom: 1.2em;">
        <h4 style="color: var(--brand-secondary, #4A8B8B); font-size: 1em; margin: 0.8em 0 0.4em 0;">🔒 Privacy & Security</h4>
        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
          <li>Bank-grade encryption - your thoughts remain completely private</li>
          <li>Flexible data retention (90 days Basic, unlimited Plus)</li>
          <li>100% privacy protected - we never share your personal information</li>
        </ul>
      </div>
      
      <div style="background: var(--info-bg, rgba(42,105,114,0.1)); padding: 1em; border-radius: 8px; margin: 1.2em 0; border-left: 4px solid var(--brand-primary, #2A6972);">
        <h4 style="color: var(--brand-primary, #2A6972); font-size: 1em; margin: 0 0 0.5em 0;">🎯 What's New:</h4>
        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
          <li>New: Weekly insight emails from Sophy (opt-out available in settings)</li>
          <li><strong>Free during beta</strong> - all features available while we perfect the experience</li>
          <li>Your feedback shapes the future - help us build something truly transformative</li>
        </ul>
      </div>
      
      <div style="margin-bottom: 1.2em;">
        <h4 style="color: var(--brand-secondary, #4A8B8B); font-size: 1em; margin: 0.8em 0 0.4em 0;">Getting Started:</h4>
        <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
          <li>Jump into journaling - no rules, just write</li>
          <li>Ask Sophy for a prompt if you need inspiration</li>
          <li>Try voice journaling with InkOutLoud</li>
          <li>Explore WISH manifests to clarify your bigger picture</li>
        </ul>
      </div>
      
      <div style="text-align: center; padding: 1em; background: var(--pale-teal, rgba(42,105,114,0.05)); border-radius: 8px; margin: 1.2em 0;">
        <p style="margin: 0 0 0.5em 0; font-weight: 500; color: var(--brand-primary, #2A6972);">Remember:</p>
        <p style="margin: 0; font-style: italic;">This doesn't have to be perfect. Small, consistent actions create lasting change. Your wellness journey starts with a single thought—let's capture it together.</p>
      </div>
      
      <div style="text-align: center; margin-top: 1.5em; padding-top: 1em; border-top: 1px solid var(--border, rgba(42,105,114,0.2));">
        <h4 style="color: var(--brand-primary, #2A6972); margin: 0 0 0.5em 0;">Ready to transform thoughts into insights and action?</h4>
        <p style="margin: 0; color: var(--text-secondary, #666);">Start journaling, and let InkWell hold space for your growth.</p>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 1.5em;">
      <button class="btn" onclick="closeWelcomeBetaModal()" style="background: var(--brand-primary, #2A6972); color: white; padding: 0.8em 2em; font-size: 1em;">Start My Journey</button>
    </div>
  </div>
</div>

<!-- Manifest Data Modal -->
<div id="manifestDataModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 9999;">
  <div style="background: var(--bg-card); color: var(--font-main); padding: 2em; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
    <h2 style="margin-top: 0; text-align: center; color: var(--brand-primary);">🌟 Manifest Data</h2>
    
    <div id="manifestDataContent" style="line-height: 1.6;">
      <!-- Content will be populated by JavaScript -->
    </div>
    
    <div style="text-align: center; margin-top: 2em;">
      <button class="btn" onclick="closeManifestModal()" style="background-color: var(--btn-bg); color: var(--btn-font);">Close</button>
    </div>
  </div>
</div>

<!-- Reflection Data Modal -->
<div id="reflectionDataModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 9999;">
  <div style="background: var(--bg-card); color: var(--font-main); padding: 2em; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
    <h2 style="margin-top: 0; text-align: center; color: #7BB8C4;">💭 Sophy's Reflection</h2>
    
    <div id="reflectionDataContent" style="line-height: 1.6;">
      <!-- Content will be populated by JavaScript -->
    </div>
    
    <div style="text-align: center; margin-top: 2em;">
      <button class="btn" onclick="closeReflectionModal()" style="background-color: var(--btn-bg); color: var(--btn-font);">Close</button>
    </div>
  </div>
</div>



<!-- User Settings Modal -->
<div id="userSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 9999;">
  <div class="card-block" style="max-width: 450px; width: 90%; background: white; padding: 2em; border-radius: 8px; text-align: center; max-height: 85vh; overflow-y: auto;">
    <img src="InkWell-Logo.png" alt="InkWell Logo" style="max-height: 120px; margin-bottom: 1.5em;" />
    
    <h2 style="margin-top: 0; margin-bottom: 1.5em; color: #2A6972; font-size: 1.3em;">
      ⚙️ Settings
    </h2>
    
   <!-- Profile Section -->
    <div style="background: #f8f9fa; border: 1px solid #e0e6ed; border-radius: 8px; padding: 1.5em; margin-bottom: 1.5em; text-align: left;">
      <h3 style="color: #2A6972; margin-top: 0; margin-bottom: 1em; font-size: 1.1em; display: flex; align-items: center; gap: 0.5em;">
        👤 Profile
      </h3>
      
      <div style="margin-bottom: 1em;">
        <label for="settingsUserName" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">User Name:</label>
        <input type="text" id="settingsUserName" placeholder="Enter your display name" 
          style="width: 100%; padding: 0.6em; border: 1px solid #ccc; border-radius: 5px; background-color: white; color: #0D3F45; font-size: 0.9em; box-sizing: border-box;" />
      </div>
      
      <div style="margin-bottom: 1em;">
        <label for="settingsAvatar" class="settings-label">Avatar URL:</label>
        <input type="url" id="settingsAvatar" placeholder="Enter avatar image URL" 
          style="width: 100%; padding: 0.6em; border: 1px solid #ccc; border-radius: 5px; background-color: white; color: #0D3F45; font-size: 0.9em; box-sizing: border-box;" />
        <p style="font-size: 0.8em; color: #666; margin: 0.5em 0 0 0; text-align: left;">
          💡 <strong>Tip:</strong> Upload to <a href="https://imgur.com" target="_blank" style="color: #2A6972;">Imgur</a> or <a href="https://postimages.org" target="_blank" style="color: #2A6972;">PostImages</a>, then copy the URL here.
        </p>
      </div>
      
      <div style="margin-bottom: 0;">
        <label for="settingsCurrentUser" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">Email:</label>
        <div id="settingsCurrentUser" style="width: 100%; padding: 0.6em; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa; color: #666; font-size: 0.9em; box-sizing: border-box;">Loading...</div>
      </div>
    </div>
    
    <!-- Password Section -->
    <div style="background: #fff9f0; border: 1px solid #f0d5a8; border-radius: 8px; padding: 1.5em; margin-bottom: 1.5em; text-align: left;">
      <h3 style="color: #2A6972; margin-top: 0; margin-bottom: 1em; font-size: 1.1em; display: flex; align-items: center; gap: 0.5em;">
        🔐 Password
      </h3>
      
      <div style="margin-bottom: 1em;">
        <label for="currentPassword" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">Current Password:</label>
        <input type="password" id="currentPassword" placeholder="Enter current password" 
          style="width: 100%; padding: 1em 1.2em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font); font-size: 0.9em; box-sizing: border-box;" />
      </div>
      
      <div style="margin-bottom: 1em;">
        <label for="newPassword" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">New Password:</label>
        <input type="password" id="newPassword" placeholder="Enter new password" 
          style="width: 100%; padding: 1em 1.2em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font); font-size: 0.9em; box-sizing: border-box;" />
      </div>
      
      <div style="margin-bottom: 1.5em;">
        <label for="confirmPassword" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">Confirm New Password:</label>
        <input type="password" id="confirmPassword" placeholder="Confirm new password" 
          style="width: 100%; padding: 1em 1.2em; background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.95) 100%); border: 2px solid rgba(42,105,114,0.15); border-radius: 10px; backdrop-filter: blur(3px); box-shadow: 0 2px 8px rgba(42,105,114,0.08); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); color: #0D3F45; font-family: var(--body-font); font-size: 0.9em; box-sizing: border-box;" />
      </div>
      
      <button onclick="changePassword()" class="btn" style="width: 100%; background: #2A6972; color: white; margin-bottom: 0.5em;">
        🔑 Change Password
      </button>
      
      <p style="font-size: 0.8em; color: #666; text-align: center; margin: 0.5em 0 0 0;">
        Leave fields empty if you don't want to change your password.
      </p>
    </div>
    
<!-- Practitioner Section -->
<div style="background: #f0f8ff; border: 1px solid #c5d7f0; border-radius: 8px; padding: 1.5em; margin-bottom: 1.5em; text-align: left;">
  <h3 style="color: #2A6972; margin-top: 0; margin-bottom: 1em; font-size: 1.1em; display: flex; align-items: center; gap: 0.5em; justify-content: space-between;">
    🩺 My Practitioner
    <button onclick="clearPendingPractitionerInvite()" style="background: #f8f9fa; border: 1px solid #ccc; border-radius: 3px; padding: 0.2em 0.5em; font-size: 0.8em; cursor: pointer; color: #666;">🔄 Refresh</button>
  </h3>
  
  <!-- Current Connection Status -->
  <div id="practitionerStatus" style="margin-bottom: 1em;">
    <!-- Will be populated by JavaScript -->
  </div>
  
  <!-- Invite New Practitioner -->
  <div style="margin-bottom: 1em;">
    <label for="practitionerEmail" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">Practitioner's Email Address:</label>
    <input type="email" id="practitionerEmail" 
           placeholder="doctor@practice.com" 
           style="width: 100%; padding: 0.6em; border: 1px solid #ccc; border-radius: 5px; background-color: white; color: #0D3F45; font-size: 0.9em; box-sizing: border-box;" />
  </div>
  
  <div style="margin-bottom: 1.5em;">
    <label for="practitionerName" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">Practitioner's Name:</label>
    <input type="text" id="practitionerName" 
           placeholder="Dr. Jane Smith" 
           style="width: 100%; padding: 0.6em; border: 1px solid #ccc; border-radius: 5px; background-color: white; color: #0D3F45; font-size: 0.9em; box-sizing: border-box;" />
  </div>
  
  <button onclick="invitePractitioner()" class="btn" style="width: 100%; margin-bottom: 1em; background: #2A6972; color: white;">
    <span id="inviteButtonText">Send InkWell Invitation</span>
  </button>
  
  <div id="inviteStatus" style="margin-bottom: 1em; text-align: center;"></div>
  
  <!-- Disconnect Section (initially hidden) -->
  <div id="disconnectSection" style="display: none; border-top: 1px solid #ddd; padding-top: 1em; margin-top: 1em;">
    <button onclick="disconnectPractitioner()" class="btn" style="width: 100%; background: #dc3545; color: white;">
      🚫 Disconnect from Practitioner
    </button>
    <p style="font-size: 0.8em; color: #666; text-align: center; margin: 0.5em 0 0 0;">
      This will remove your practitioner connection. They will no longer receive your journal entries.
    </p>
  </div>
</div>

   <!-- Appearance Section -->
    <div style="background: #fff5f5; border: 1px solid #f0c5c5; border-radius: 8px; padding: 1.5em; margin-bottom: 1.5em; text-align: left;">
      <h3 style="color: #2A6972; margin-top: 0; margin-bottom: 1em; font-size: 1.1em; display: flex; align-items: center; gap: 0.5em;">
        🎨 Appearance
      </h3>
      
      <div style="margin-bottom: 0.5em;">
        <label for="settingsThemeSelect" style="display: block; margin-bottom: 0.5em; font-weight: 500; color: #333; font-size: 0.9em;">Theme:</label>
        <select id="settingsThemeSelect" style="width: 100%; padding: 0.6em; border: 1px solid #ccc; border-radius: 5px; background-color: white; color: #0D3F45; font-size: 0.9em; box-sizing: border-box;">
          <option value="default">System Default</option>
          <option value="light">Light Mode</option>
          <option value="dark">Dark Mode</option>
        </select>
      </div>
    </div>
    
    <!-- App Info Section -->
    <div style="text-align: left; margin-bottom: 2em; padding: 1em; background: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef;">
      <h3 style="color: #2A6972; margin-top: 0; margin-bottom: 0.5em; font-size: 1.1em; display: flex; align-items: center; gap: 0.5em;">
        ℹ️ App Info
      </h3>
      <div style="font-size: 0.85em; color: #666;">
        <span style="font-weight: 500;">Version:</span>
        <span id="settingsVersion" style="margin-left: 0.5em; font-family: monospace;">v2.25.190</span>
      </div>
    </div>
    
    <!-- Sophy Insights Section -->
    <div style="text-align: left; margin-bottom: 1.5em; padding: 1em; background: #f0f8ff; border-radius: 5px; border: 1px solid #d1ecf1;">
      <h3 style="color: #2A6972; margin-top: 0; margin-bottom: 1em; font-size: 1.1em; display: flex; align-items: center; gap: 0.5em;">
        📊 Sophy's Weekly Insights
      </h3>
      <p style="font-size: 0.85em; color: #555; margin-bottom: 1em; line-height: 1.4;">
        Let Sophy analyze your journal entries and manifesting progress to send you personalized insights about your mood patterns, growth themes, and positive psychology observations.
      </p>
      
      <div style="margin-bottom: 1em;">
        <label style="display: flex; align-items: center; gap: 0.5em; font-size: 0.9em; color: #333; cursor: pointer; margin-bottom: 0.8em;">
          <input type="checkbox" id="weeklyInsightsEnabled" style="transform: scale(1.2); margin-right: 0.3em;" checked />
          <span>📅 <strong>Weekly Insights</strong> - Every Monday morning</span>
        </label>
        <p style="font-size: 0.8em; color: #666; margin-left: 2.2em; margin-bottom: 0;">
          Get a thoughtful review of your week's journaling patterns, mood themes, and growth observations.
        </p>
      </div>
    </div>

    <!-- About & Help Section -->
    <div style="text-align: left; margin-bottom: 1.5em; padding: 1em; background: #fff9f0; border-radius: 5px; border: 1px solid #f0e6d2;">
      <h3 style="color: #2A6972; margin-top: 0; margin-bottom: 1em; font-size: 1.1em; display: flex; align-items: center; gap: 0.5em;">
        🌟 About & Help
      </h3>
      <div style="display: flex; gap: 0.8em; flex-wrap: wrap;">
        <button onclick="showWelcomeBetaModal(); closeUserSettingsModal();" class="btn" 
          style="flex: 1; min-width: 140px; padding: 0.5em 0.8em; background: #2A6972; color: white; border: none; border-radius: 5px; font-size: 0.85em; cursor: pointer;">
          🌟 Welcome Guide
        </button>
        <button onclick="document.getElementById('aboutInkwellModal').style.display='flex'; closeUserSettingsModal();" class="btn" 
          style="flex: 1; min-width: 140px; padding: 0.5em 0.8em; background: #4A8B8B; color: white; border: none; border-radius: 5px; font-size: 0.85em; cursor: pointer;">
          ❓ What is InkWell?
        </button>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div style="display: flex; gap: 0.5em; justify-content: center;">
      <button class="btn" onclick="saveUserSettings()" 
        style="flex: 1; padding: 0.6em; background-color: #2A6972; color: white; border: none; border-radius: 5px; font-weight: 500; cursor: pointer;">
        💾 Save Changes
      </button>
     <button class="btn btn-gray" onclick="closeUserSettingsModal()" 
  style="flex: 1; padding: 0.6em; background-color: #6c757d !important; color: white; border: none; border-radius: 5px; font-weight: 500; cursor: pointer;">
  Cancel
</button>
    </div>
  </div>
</div>


<script>


  // Welcome to Beta Modal Functions
  window.showWelcomeBetaModal = function() {
    document.getElementById("welcomeBetaModal").style.display = "flex";
  };

  window.closeWelcomeBetaModal = function() {
    document.getElementById("welcomeBetaModal").style.display = "none";
    
    // Mark as seen so it doesn't show on next login
    const userId = window.currentUserId || window.auth?.currentUser?.uid;
    if (userId) {
      localStorage.setItem(`welcomeBetaSeen_${userId}`, "true");
      console.log("✅ Welcome Beta modal marked as seen for user");
    }
  };

  // Check if first time login and show welcome modal
  window.checkAndShowWelcomeBeta = function() {
    const userId = window.currentUserId || window.auth?.currentUser?.uid;
    if (!userId) return;
    
    const hasSeenWelcome = localStorage.getItem(`welcomeBetaSeen_${userId}`);
    if (!hasSeenWelcome) {
      console.log("🌟 First time login detected - showing Welcome Beta modal");
      setTimeout(() => {
        window.showWelcomeBetaModal();
      }, 800); // Small delay to let the UI settle
    }
  };

// COMPLETE FIX: Replace your existing updateVisualsAfterMarkAsRead function with this version

async function updateVisualsAfterMarkAsRead(entryId, dateKey, shouldRemoveHighlight) {
  console.log("🎨 FIXING VISUALS - Entry:", entryId, "Date:", dateKey, "Remove highlight:", shouldRemoveHighlight);
  
  // 1. FIX THE ENTRY CARD - Target ALL possible entry containers
  // Look for the entry in multiple ways since rendering is inconsistent
  
  // Method A: Find by button onclick attribute (most reliable)
  const markReadButtons = document.querySelectorAll('button[onclick*="handleMarkAsRead"]');
  markReadButtons.forEach(btn => {
    if (btn.getAttribute('onclick').includes(entryId)) {
      // Found the right button, now traverse up to find the entry container
      let entryContainer = btn.closest('div[style*="border-left"]');
      if (!entryContainer) {
        // Try going up multiple levels
        entryContainer = btn.parentElement?.parentElement?.parentElement;
      }
      
      if (entryContainer) {
        console.log("✅ Found entry container via button");
        
        // Remove NEW REPLY badge - look for any div with that text
        const allDivs = entryContainer.querySelectorAll('div');
        allDivs.forEach(div => {
          if (div.textContent.trim() === 'NEW REPLY' && !div.querySelector('*')) {
            console.log("🗑️ Removing NEW REPLY badge");
            div.style.display = 'none';
            div.remove(); // Actually remove it from DOM
          }
        });
        
        // Fix the border - check both borderLeft and border properties
        if (entryContainer.style.borderLeft) {
          if (entryContainer.style.borderLeft.includes('d49489') || 
              entryContainer.style.borderLeft.includes('coral') ||
              entryContainer.style.borderLeft.includes('5px')) {
            console.log("🎨 Changing border from coral to teal");
            entryContainer.style.borderLeft = '4px solid #7BB8C4';
          }
        }
        
        // Fix the background gradient
        if (entryContainer.style.background) {
          if (entryContainer.style.background.includes('fff3cd') || 
              entryContainer.style.background.includes('ffeaa7')) {
            console.log("🎨 Changing background to normal");
            entryContainer.style.background = 'linear-gradient(180deg, #ffffff 0%, #f2f2f2 100%)';
          }
        }
        
        // Remove box shadow if it has coral shadow
        if (entryContainer.style.boxShadow) {
          if (entryContainer.style.boxShadow.includes('212, 148, 137') ||
              entryContainer.style.boxShadow.includes('d49489')) {
            console.log("🎨 Removing coral box shadow");
            entryContainer.style.boxShadow = '';
          }
        }
      }
    }
  });
  
  // Method B: Find by entry ID in onclick handlers for edit/delete buttons
  const editButtons = document.querySelectorAll('button[onclick*="editEntry"]');
  editButtons.forEach(btn => {
    if (btn.getAttribute('onclick').includes(entryId)) {
      const entryContainer = btn.closest('div[style*="background"]');
      if (entryContainer) {
        console.log("✅ Found entry via edit button");
        
        // Apply same fixes as above
        const allDivs = entryContainer.querySelectorAll('div');
        allDivs.forEach(div => {
          if (div.textContent.trim() === 'NEW REPLY' && !div.querySelector('*')) {
            div.style.display = 'none';
            div.remove();
          }
        });
        
        if (entryContainer.style.borderLeft && entryContainer.style.borderLeft.includes('d49489')) {
          entryContainer.style.borderLeft = '4px solid #7BB8C4';
        }
        
        if (entryContainer.style.background && entryContainer.style.background.includes('fff3cd')) {
          entryContainer.style.background = 'linear-gradient(180deg, #ffffff 0%, #f2f2f2 100%)';
        }
        
        if (entryContainer.style.boxShadow && entryContainer.style.boxShadow.includes('212, 148, 137')) {
          entryContainer.style.boxShadow = '';
        }
      }
    }
  });
  
  // 2. FIX THE CALENDAR CELL
  if (shouldRemoveHighlight && dateKey) {
    console.log("🗓️ Updating calendar for date:", dateKey);
    
    // Method A: Find by data-date attribute
    const calendarCells = document.querySelectorAll(`[data-date="${dateKey}"]`);
    calendarCells.forEach(cell => {
      console.log("📅 Found calendar cell with data-date");
      const tealColor = '#7BB8C4';
      cell.style.backgroundColor = tealColor;
      cell.style.border = '1px solid #ccc';
      cell.style.color = '#fff';
      cell.style.fontWeight = 'normal';
      cell.style.boxShadow = '';
      cell.title = 'Journal entry';
    });
    
    // Method B: Find by day number (more aggressive)
    if (dateKey) {
      const day = parseInt(dateKey.split('-')[2]);
      const month = parseInt(dateKey.split('-')[1]) - 1;
      const year = parseInt(dateKey.split('-')[0]);
      
      console.log("📅 Looking for day:", day, "in month:", month);
      
      // Check all TD elements
      document.querySelectorAll('td').forEach(cell => {
        const cellText = cell.textContent.trim();
        if (cellText === String(day)) {
          // Check if this cell has coral styling
          const bgColor = window.getComputedStyle(cell).backgroundColor;
          const cellBgStyle = cell.style.backgroundColor;
          
          console.log("📅 Checking cell for day", day, "- bg:", cellBgStyle);
          
          if (cellBgStyle.includes('d49489') || 
              cellBgStyle.includes('212, 148, 137') ||
              cellBgStyle.includes('coral') ||
              bgColor.includes('212, 148, 137')) {
            
            console.log("✅ Updating calendar cell for day", day);
            cell.style.backgroundColor = '#7BB8C4';
            cell.style.border = '1px solid #ccc';
            cell.style.color = '#fff';
            cell.style.fontWeight = 'normal';
            cell.style.boxShadow = '';
            cell.title = 'Journal entry';
          }
        }
      });
    }
  }
  
  // 3. FORCE UPDATE ANY "NEW REPLY" TEXT ANYWHERE ON PAGE
  // Nuclear option - find and hide ALL "NEW REPLY" badges
  document.querySelectorAll('*').forEach(element => {
    if (element.textContent === 'NEW REPLY' && !element.querySelector('*')) {
      if (element.style.position === 'absolute' || 
          element.style.background?.includes('d49489')) {
        console.log("🗑️ Found and removing stray NEW REPLY badge");
        element.style.display = 'none';
        element.remove();
      }
    }
  });
  
  // 4. UPDATE GLOBAL STATE AND TRIGGER CALENDAR REBUILD
  if (shouldRemoveHighlight && dateKey && window.globalDatesWithUnreadReplies) {
    window.globalDatesWithUnreadReplies.delete(dateKey);
    console.log("📊 Updated global state, removed date from unread list");
  }
  
  // 5. OPTIONAL: Force calendar rebuild after a delay
  setTimeout(() => {
    if (window.updateCalendarHighlighting && typeof window.updateCalendarHighlighting === 'function') {
      console.log("🔄 Triggering calendar highlighting update");
      window.updateCalendarHighlighting();
    }
  }, 500);
  
  console.log("✅ Visual update complete");
}

// Also add this helper function to force refresh the current view
window.forceRefreshCurrentView = function() {
  console.log("🔄 Force refreshing current view");
  
  // Check which tab is active
  const calendarTab = document.getElementById("calendarTab");
  if (calendarTab && calendarTab.style.display !== "none") {
    // On calendar tab - rebuild calendar and reload entries
    if (window.buildCalendar) {
      window.buildCalendar();
    }
    if (window.loadPastEntries) {
      setTimeout(() => window.loadPastEntries(), 100);
    }
  }
};

</script>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
  // Safari autofill workaround: force field re-evaluation on focus
  document.querySelectorAll("input").forEach((input) => {
    input.addEventListener("focus", () => {
      input.value = input.value; // nudges Safari to reprocess autofill
    });
  });
</script>
<!-- 🔧 Consolidated about-modal opener + Safari autofill + signup toggle -->
<script>


  // Safari autofill workaround: re-evaluate on focus
  document.querySelectorAll("input").forEach((input) => {
    input.addEventListener("focus", () => {
      input.value = input.value; // nudge Safari
    });
  });

  // Signup -> Login toggle (keep all “toggle” logic in one place)
  const toggleLogin = document.getElementById("toggleLogin");
  if (toggleLogin) {
    toggleLogin.addEventListener("click", (e) => {
      e.preventDefault();
      const signup = document.getElementById("signupModal");
      const login  = document.getElementById("loginModal");
      if (signup) signup.style.display = "none";
      if (login)  login.style.display  = "flex";
    });
  }
</script>

<!-- User Settings Modal Functions -->
<script>
  // Open User Settings Modal
  function openUserSettingsModal() {
    const modal = document.getElementById("userSettingsModal");
    if (modal) {
      // Load current user data
      loadCurrentUserSettings();
      modal.style.display = "flex";
    }
  }

  // Close User Settings Modal
  function closeUserSettingsModal() {
    const modal = document.getElementById("userSettingsModal");
    if (modal) {
      modal.style.display = "none";
    }
  }

// Load current user settings into the modal
  async function loadCurrentUserSettings() {
    try {
      // Load current user info
      const auth = window.auth;
      if (auth && auth.currentUser) {
        const currentUserDiv = document.getElementById("settingsCurrentUser");
        if (currentUserDiv) {
          currentUserDiv.textContent = auth.currentUser.email;
        }

        // Load user data from Firestore
        if (window.db) {
          const userDoc = await window.getDoc(window.doc(window.db, "users", auth.currentUser.uid));
          if (userDoc.exists) {
            const userData = userDoc.data();
            
            // Populate form fields with fallbacks for missing data
            const usernameField = document.getElementById("settingsUserName");
            const avatarField = document.getElementById("settingsAvatar");
            
            if (usernameField) {
              usernameField.value = userData.signupUsername || userData.displayName || "";
            }
            if (avatarField) {
              avatarField.value = userData.avatar || "";
            }
            
            // Load insights preferences
            const weeklyCheckbox = document.getElementById("weeklyInsightsEnabled");
            
            if (userData.insightsPreferences) {
              if (weeklyCheckbox) {
                weeklyCheckbox.checked = userData.insightsPreferences.weeklyEnabled !== false; // Default to true
              }
            } else {
              // Default to checked if no preferences exist yet (opt-in by default)
              if (weeklyCheckbox) weeklyCheckbox.checked = true;
            }
          }
        }
      }
      
      // Load theme setting
      const savedTheme = localStorage.getItem('inkwell-theme-mode') || 'default';
      const themeSelect = document.getElementById("settingsThemeSelect");
      if (themeSelect) {
        themeSelect.value = savedTheme;
      }
      
      // Clear password fields for security
      const currentPasswordField = document.getElementById("currentPassword");
      const newPasswordField = document.getElementById("newPassword");
      const confirmPasswordField = document.getElementById("confirmPassword");
      if (currentPasswordField) currentPasswordField.value = "";
      if (newPasswordField) newPasswordField.value = "";
      if (confirmPasswordField) confirmPasswordField.value = "";
      
      // Load practitioner status when settings modal opens
      await loadPractitionerStatus();
      console.log("Practitioner status loaded");
      
    } catch (error) {
      console.error("Error loading user settings:", error);

      // Don't show error to user, just log it
      console.log("🔄 This might be a new user or missing user document - will create on save");
    }
  }

  // Auto-refresh practitioner status when database changes  
function startPractitionerStatusRefresh() {
  if (!window.auth?.currentUser || !window.db || !window.onSnapshot) return;
  
  console.log("🔄 Setting up practitioner status auto-refresh");
  
  // Listen for changes to the approvedPractitioners collection
  const unsubscribe = window.onSnapshot(
    window.collection(window.db, "approvedPractitioners"),
    (snapshot) => {
      console.log("🔄 Approved practitioners list changed, refreshing status");
      // Small delay to ensure database consistency
      setTimeout(() => {
        loadPractitionerStatus();
      }, 1000);
    },
    (error) => {
      console.error("Error listening to practitioner changes:", error);
    }
  );
  
  return unsubscribe;
}

  // Save user settings
  async function saveUserSettings() {
    try {
      const auth = window.auth;
      if (!auth || !auth.currentUser) {
        alert("Please log in to save settings.");
        return;
      }

      const username = document.getElementById("settingsUserName").value.trim();
      const avatar = document.getElementById("settingsAvatar").value.trim();
      const theme = document.getElementById("settingsThemeSelect").value;
      
      // Get insights preferences
      const weeklyInsights = document.getElementById("weeklyInsightsEnabled").checked;

      // Update Firestore user document with merge to handle missing fields
      if (window.db) {
        // Use setDoc with merge to ensure fields are created if they don't exist
        await window.setDoc(window.doc(window.db, "users", auth.currentUser.uid), {
          signupUsername: username,
          displayName: username,
          avatar: avatar,
          // Insights preferences
          insightsPreferences: {
            weeklyEnabled: weeklyInsights,
            updatedAt: window.serverTimestamp()
          },
          // Add updatedAt timestamp to track when profile was last modified
          updatedAt: window.serverTimestamp()
        }, { merge: true }); // This ensures existing fields are preserved

        // Update Firebase Auth profile
        await window.updateProfile(auth.currentUser, { 
          displayName: username 
        });
      }

      // Update theme
      localStorage.setItem('inkwell-theme-mode', theme);
      if (window.applyTheme) {
        window.applyTheme(theme);
      }

      // Update the original theme selector to stay in sync
      const originalThemeSelect = document.getElementById("themeModeSelect");
      if (originalThemeSelect) {
        originalThemeSelect.value = theme;
      }

      // Save avatar to localStorage for the avatar swap functionality
      if (avatar) {
        localStorage.setItem('userAvatar', avatar);
        // Immediately reload the avatar with the new URL
        console.log("🔄 Reloading avatar with new URL:", avatar);
        testAndSetAvatar(avatar);
      } else {
        // If avatar is cleared, remove from localStorage and revert to logo
        localStorage.removeItem('userAvatar');
        console.log("🔄 Avatar URL cleared, reverting to logo");
        testAndSetAvatar('');
      }

      // Show success state on save button
      const saveButton = document.querySelector('button[onclick="saveUserSettings()"]');
      if (saveButton) {
        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = "✅ Saved";
        saveButton.style.backgroundColor = "#4CAF50";
        
        // Reset button after 2 seconds
        setTimeout(() => {
          saveButton.innerHTML = originalText;
          saveButton.style.backgroundColor = "var(--brand-primary)";
        }, 2000);
      }

      closeUserSettingsModal();

      // Refresh user status if function exists
      if (window.updateUserStatus) {
        window.updateUserStatus();
      }

      // Force reload of auth state to update UI
      if (auth.currentUser) {
        console.log("🔄 Triggering auth state refresh after settings update");
        // This will trigger the onAuthStateChanged listener to update UI
        window.currentUserId = auth.currentUser.uid;
      }

    } catch (error) {
      console.error("Error saving settings:", error);
      alert("❌ Error saving settings: " + error.message);
    }
  }

  // Change password function
  async function changePassword() {
    try {
      const auth = window.auth;
      if (!auth || !auth.currentUser) {
        alert("Please log in to change your password.");
        return;
      }

      const currentPassword = document.getElementById("currentPassword").value.trim();
      const newPassword = document.getElementById("newPassword").value.trim();
      const confirmPassword = document.getElementById("confirmPassword").value.trim();

      // Check if user wants to change password (all fields filled)
      if (!currentPassword && !newPassword && !confirmPassword) {
        // User doesn't want to change password, just return
        return;
      }

      // Validate all fields are filled if user wants to change password
      if (!currentPassword || !newPassword || !confirmPassword) {
        alert("Please fill in all password fields to change your password.");
        return;
      }

      // Validate new passwords match
      if (newPassword !== confirmPassword) {
        alert("New passwords do not match.");
        return;
      }

      // Validate new password strength
      if (newPassword.length < 6) {
        alert("New password must be at least 6 characters long.");
        return;
      }

      const changeButton = document.querySelector('button[onclick="changePassword()"]');
      const originalText = changeButton.textContent;
      changeButton.textContent = "🔄 Changing...";
      changeButton.disabled = true;

      // Re-authenticate user with current password
      const credential = window.EmailAuthProvider.credential(auth.currentUser.email, currentPassword);
      await window.reauthenticateWithCredential(auth.currentUser, credential);

      // Update password
      await window.updatePassword(auth.currentUser, newPassword);

      // Clear password fields
      document.getElementById("currentPassword").value = "";
      document.getElementById("newPassword").value = "";
      document.getElementById("confirmPassword").value = "";

      alert("Password changed successfully!");

      changeButton.textContent = originalText;
      changeButton.disabled = false;

    } catch (error) {
      console.error("Password change error:", error);
      
      const changeButton = document.querySelector('button[onclick="changePassword()"]');
      changeButton.textContent = "🔑 Change Password";
      changeButton.disabled = false;

      // Provide user-friendly error messages
      if (error.code === 'auth/wrong-password') {
        alert("Current password is incorrect.");
      } else if (error.code === 'auth/weak-password') {
        alert("New password is too weak. Please choose a stronger password.");
      } else if (error.code === 'auth/requires-recent-login') {
        alert("For security reasons, please log out and log back in before changing your password.");
      } else {
        alert("Failed to change password: " + (error.message || "Unknown error"));
      }
    }
  }

 // Close modal when clicking outside
  document.addEventListener("click", function(e) {
    const modal = document.getElementById("userSettingsModal");
    if (e.target === modal) {
      closeUserSettingsModal();
    }    
  });
</script>


<script defer type="module" src="./auth.js"></script>


<script>
  /**
   * Avatar/Logo swap — robust version - FIXED
   * - Shows InkWell logo by default
   * - Tries saved avatar URL if available
   * - Falls back to Pegasus Realm SVG placeholder if no avatar
   * - Only swaps to avatar if it successfully loaded
   */
  const animatedImg = document.getElementById("animatedImage");
  const avatarImg   = document.getElementById("avatarImage");

  // Pegasus Realm logo path for users without avatars
  const PEGASUS_REALM_LOGO = "/LOGO_SQ_Lg_Border_2024.png";

  // Try saved avatar first
  const savedAvatar = (localStorage.getItem("userAvatar") || "").trim();

  // Mark readiness so we only swap when avatar is valid
  avatarImg.dataset.ready = "0";

  function setAvatarSrc(src, markReady) {
    avatarImg.src = src;
    avatarImg.dataset.ready = markReady ? "1" : "0";
  }

  // Helper function to convert common image hosting URLs to direct image URLs
  function convertToDirectImageUrl(url) {
    if (!url) return url;
    
    // Imgur: Convert imgur.com/xyz to i.imgur.com/xyz.jpg (or .png, .gif)
    const imgurMatch = url.match(/imgur\.com\/([a-zA-Z0-9]+)$/);
    if (imgurMatch) {
      const imageId = imgurMatch[1];
      // Try common extensions, starting with jpg
      return `https://i.imgur.com/${imageId}.jpg`;
    }
    
    // If already a direct image URL or other format, return as-is
    return url;
  }

  function testAndSetAvatar(url) {
    if (!url) {
      // No saved URL; use Pegasus Realm placeholder and mark ready for swapping
      setAvatarSrc(PEGASUS_REALM_LOGO, true);
      console.log("🖼️ No avatar URL provided, using Pegasus Realm logo");
      return;
    }
    
    // Convert to direct image URL if needed
    const directUrl = convertToDirectImageUrl(url);
    if (directUrl !== url) {
      console.log("🔄 Converted URL:", url, "->", directUrl);
    }
    
    console.log("🔍 Testing avatar URL:", directUrl);
    const tester = new Image();
    
    tester.onload = () => {
      console.log("✅ Avatar loaded successfully:", directUrl);
      setAvatarSrc(directUrl, true);
    };
    
    tester.onerror = () => {
      console.warn("❌ Failed to load avatar:", directUrl, "- falling back to Pegasus Realm logo");
      // If the conversion failed, try the original URL as backup
      if (directUrl !== url) {
        console.log("🔄 Trying original URL as backup:", url);
        const backupTester = new Image();
        backupTester.onload = () => {
          console.log("✅ Backup URL worked:", url);
          setAvatarSrc(url, true);
        };
        backupTester.onerror = () => {
          console.warn("❌ Backup URL also failed, using fallback logo");
          setAvatarSrc(PEGASUS_REALM_LOGO, true);
        };
        backupTester.src = url;
      } else {
        setAvatarSrc(PEGASUS_REALM_LOGO, true);
      }
    };
    
    tester.src = directUrl;
  }

  if (animatedImg && avatarImg) {
    // FIXED: Start with logo visible immediately
    animatedImg.classList.add("show");
    animatedImg.style.opacity = "1";
    avatarImg.classList.remove("show");
    avatarImg.style.opacity = "0";

    // Load avatar/placeholder safely
    testAndSetAvatar(savedAvatar);

    // Swap every 30s, but only if avatar is ready
    setInterval(() => {
      const avatarReady = avatarImg.dataset.ready === "1";
      const showingLogo = animatedImg.classList.contains("show");

      if (!avatarReady) {
        // Keep logo showing if avatar failed
        animatedImg.classList.add("show");
        animatedImg.style.opacity = "1";
        avatarImg.classList.remove("show");
        avatarImg.style.opacity = "0";
        return;
      }

      if (showingLogo) {
        // Switch to avatar/placeholder
        animatedImg.classList.remove("show");
        animatedImg.style.opacity = "0";
        avatarImg.classList.add("show");
        avatarImg.style.opacity = "1";
      } else {
        // Switch back to logo
        animatedImg.classList.add("show");
        animatedImg.style.opacity = "1";
        avatarImg.classList.remove("show");
        avatarImg.style.opacity = "0";
      }
    }, 30000); // 30 seconds
  }

  // Prevent auto-loading all past entries; only show when user interacts
window.addEventListener("DOMContentLoaded", function () {
  const emptyMsg = document.getElementById("emptyPastEntriesMessage");
  if (emptyMsg) {
    emptyMsg.style.display = "block";
  }
});


</script>
<style>
  #animatedImage,
  #avatarImage {
    transition: opacity 1.25s cubic-bezier(0.4, 0, 0.2, 1);
  }
</style>
<script>
  // Setup form event listeners for reCAPTCHA verification
  document.addEventListener("DOMContentLoaded", () => {
    // Login form event listener
    // Login and signup form handling moved to auth.js
  });

  document.addEventListener("DOMContentLoaded", () => {
    const toggleLogin = document.getElementById("toggleLogin");
    if (toggleLogin) {
      toggleLogin.addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("signupModal").style.display = "none";
        document.getElementById("loginModal").style.display = "flex";
      });
    }
  });

// Load practitioner status with approved practitioners list
async function loadPractitionerStatus() {
  try {
    const auth = window.auth;
    if (!auth?.currentUser || !window.db) return;

    const userDoc = await window.getDoc(window.doc(window.db, "users", auth.currentUser.uid));
    if (!userDoc.exists) return;

    const userData = userDoc.data();
    const statusDiv = document.getElementById("practitionerStatus");
    const disconnectSection = document.getElementById("disconnectSection");
    
    // Check if dark theme is active
    const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
    
    // Load approved practitioners for dropdown
    const approvedPractitioners = await loadApprovedPractitioners();
    
    if (userData.connectedPractitioner) {
      // User has connected practitioner
      const connectedBg = isDarkTheme ? 'rgba(42, 105, 114, 0.15)' : '#d4edda';
      const connectedBorder = isDarkTheme ? 'rgba(42, 105, 114, 0.3)' : '#c3e6cb';
      const connectedColor = isDarkTheme ? '#89C9D4' : '#155724';
      
      statusDiv.innerHTML = `
        <div style="background: ${connectedBg}; border: 1px solid ${connectedBorder}; color: ${connectedColor}; padding: 0.75rem; border-radius: 4px; margin-bottom: 1em;">
          <strong>✅ Connected to:</strong> ${userData.connectedPractitioner.name}<br>
          <small>Email: ${userData.connectedPractitioner.email}</small><br>
          <small>Connected: ${userData.connectedPractitioner.connectedAt ? new Date(userData.connectedPractitioner.connectedAt.toDate()).toLocaleDateString() : 'Recently'}</small>
        </div>
      `;
      disconnectSection.style.display = "block";
      
      // Pre-fill form with current practitioner info
      document.getElementById("practitionerEmail").value = userData.connectedPractitioner.email || "";
      document.getElementById("practitionerName").value = userData.connectedPractitioner.name || "";
      
    } else if (userData.pendingPractitionerInvite) {
      // Invitation sent, waiting
      const status = userData.pendingPractitionerInvite.status === 'invitation_sent' 
        ? 'Professional invitation sent - awaiting registration'
        : 'Invitation sent - awaiting response';
      
      const pendingBg = isDarkTheme ? 'rgba(42, 105, 114, 0.12)' : '#fff3cd';
      const pendingBorder = isDarkTheme ? 'rgba(42, 105, 114, 0.25)' : '#ffeaa7';
      const pendingColor = isDarkTheme ? '#89C9D4' : '#856404';
        
      statusDiv.innerHTML = `
        <div style="background: ${pendingBg}; border: 1px solid ${pendingBorder}; color: ${pendingColor}; padding: 0.75rem; border-radius: 4px; margin-bottom: 1em;">
          <strong>📤 ${status}:</strong> ${userData.pendingPractitionerInvite.name}<br>
          <small>Email: ${userData.pendingPractitionerInvite.email}</small><br>
          <small>Sent: ${new Date(userData.pendingPractitionerInvite.sentAt.toDate()).toLocaleDateString()}</small>
        </div>
      `;
      disconnectSection.style.display = "none";
    } else {
      // No practitioner - show selection options
      let practitionerOptions = '<option value="">Select a practitioner...</option>';
      approvedPractitioners.forEach(practitioner => {
        practitionerOptions += `<option value="${practitioner.email}" data-name="${practitioner.name}">${practitioner.name}</option>`;
      });
      
      const noPractitionerBg = isDarkTheme ? 'rgba(42, 105, 114, 0.1)' : '#f8f9fa';
      const noPractitionerBorder = isDarkTheme ? 'rgba(42, 105, 114, 0.2)' : '#dee2e6';
      const noPractitionerColor = isDarkTheme ? '#89C9D4' : '#6c757d';
      const labelColor = isDarkTheme ? '#89C9D4' : '#333';
      const selectBg = isDarkTheme ? 'rgba(21, 54, 58, 0.8)' : 'white';
      const selectColor = isDarkTheme ? '#89C9D4' : '#0D3F45';
      const selectBorder = isDarkTheme ? 'rgba(42, 105, 114, 0.4)' : '#ccc';
      const dividerColor = isDarkTheme ? '#89C9D4' : '#666';
      
      statusDiv.innerHTML = `
        <div style="background: ${noPractitionerBg}; border: 1px solid ${noPractitionerBorder}; color: ${noPractitionerColor}; padding: 0.75rem; border-radius: 4px; margin-bottom: 1em;">
          <strong>No practitioner connected</strong><br>
          <small>Choose from approved practitioners or invite a new one</small>
        </div>
        
        <div style="margin-bottom: 1em;">
          <label style="display: block; margin-bottom: 0.5em; font-weight: 500; color: ${labelColor}; font-size: 0.9em;">Choose from approved practitioners:</label>
<select id="approvedPractitionerSelect" 
       style="width: 100%; padding: 0.6em; border: 1px solid ${selectBorder}; border-radius: 5px; background-color: ${selectBg}; color: ${selectColor}; font-size: 0.9em; box-sizing: border-box;">
  ${practitionerOptions}
</select>
       <button id="connectToPractitionerBtn" class="btn" onclick="window.connectToApprovedPractitioner()" style="width: 100%; margin-top: 0.5em; background: #17a2b8; color: white; transition: all 0.3s ease;">
  Connect to Selected Practitioner
</button>
        </div>
        
        <div style="text-align: center; margin: 1em 0; color: ${dividerColor}; font-style: italic;">
          — or invite a new practitioner —
        </div>
      `;

// Fix dropdown auto-closing after it's created
setTimeout(() => {
  const practitionerSelect = document.getElementById('approvedPractitionerSelect');
  if (practitionerSelect) {
    let isMouseOverDropdown = false;
    
    // Remove any existing event listeners to avoid duplicates
    practitionerSelect.replaceWith(practitionerSelect.cloneNode(true));
    const newSelect = document.getElementById('approvedPractitionerSelect');
    
    newSelect.addEventListener('mouseenter', function() {
      isMouseOverDropdown = true;
      this.focus();
    });
    
    newSelect.addEventListener('mouseleave', function() {
      isMouseOverDropdown = false;
    });
    
    newSelect.addEventListener('focus', function() {
      this.size = this.options.length > 8 ? 8 : this.options.length;
    });
    
    newSelect.addEventListener('blur', function(e) {
      if (isMouseOverDropdown) {
        e.preventDefault();
        setTimeout(() => this.focus(), 10);
      } else {
        this.size = 1;
      }
    });
    
    newSelect.addEventListener('change', function() {
      this.size = 1;
      isMouseOverDropdown = false;
    });
    
    newSelect.addEventListener('click', function(e) {
      e.stopPropagation();
      if (this.size === 1) {
        this.size = this.options.length > 8 ? 8 : this.options.length;
      }
    });
  }
}, 100);

      disconnectSection.style.display = "none";
    }
  } catch (error) {
    console.error("Error loading practitioner status:", error);
  }
}

async function loadApprovedPractitioners() {
  try {
    const snapshot = await window.getDocs(
      window.query(
        window.collection(window.db, "approvedPractitioners"),
        window.where("status", "==", "active")
      )
    );
    
    const practitioners = [];
    snapshot.forEach(doc => {
      practitioners.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    return practitioners;
  } catch (error) {
    console.error("Error loading approved practitioners:", error);
    return [];
  }
}

// Connect to approved practitioner
window.connectToApprovedPractitioner = async function() {
  console.log("🎯 connectToApprovedPractitioner function called!");
  
  const select = document.getElementById("approvedPractitionerSelect");
  
  // Check if dropdown exists
  if (!select) {
    console.error("Practitioner dropdown not found");
    return;
  }
  
  const selectedEmail = select.value;
  const selectedOption = select.options[select.selectedIndex];
  const selectedName = selectedOption ? selectedOption.dataset.name : "";
  
 // Find the button to show feedback
const connectButton = document.getElementById('connectToPractitionerBtn');
  
  if (!selectedEmail) {
    // Show error feedback on button
    if (connectButton) {
      const originalText = connectButton.innerHTML;
      const originalColor = connectButton.style.backgroundColor;
      
      connectButton.innerHTML = "❌ Please select a practitioner";
      connectButton.style.backgroundColor = "#dc3545";
      connectButton.disabled = true;
      
      setTimeout(() => {
        connectButton.innerHTML = originalText;
        connectButton.style.backgroundColor = originalColor;
        connectButton.disabled = false;
      }, 3000);
    }
    return;
  }
  
  try {
    const auth = window.auth;
    if (!auth?.currentUser) {
      if (connectButton) {
        connectButton.innerHTML = "❌ Please log in first";
        connectButton.style.backgroundColor = "#dc3545";
      }
      return;
    }
    
    // Show loading state
    if (connectButton) {
      connectButton.innerHTML = "🔄 Connecting...";
      connectButton.style.backgroundColor = "#6c757d";
      connectButton.disabled = true;
    }
    
    // Connect immediately to approved practitioner
    await window.setDoc(window.doc(window.db, "users", auth.currentUser.uid), {
      connectedPractitioner: {
        email: selectedEmail,
        name: selectedName,
        connectedAt: window.serverTimestamp(),
        connectionType: 'approved_selection'
      }
    }, { merge: true });
    
  // Show success state with animation
    if (connectButton) {
      connectButton.innerHTML = `✅ Connected to ${selectedName}!`;
      connectButton.style.backgroundColor = "#28a745";
      connectButton.style.transform = "scale(1.05)";
      connectButton.style.transition = "all 0.3s ease";
      
      // Reset the button transform after animation
      setTimeout(() => {
        connectButton.style.transform = "scale(1)";
      }, 300);
    }
    
// Clear pending invite when practitioner gets approved
async function clearPendingPractitionerInvite() {
  try {
    const auth = window.auth;
    if (!auth?.currentUser) return;
    
    await window.updateDoc(window.doc(window.db, "users", auth.currentUser.uid), {
      pendingPractitionerInvite: window.deleteField()
    });
    
    console.log("✅ Cleared pending practitioner invite");
    loadPractitionerStatus(); // Refresh the display
    
  } catch (error) {
    console.error("Error clearing pending invite:", error);
  }
}

    // Also reset the dropdown to show the connection worked
    if (select) {
      select.value = "";
    }
    
    // Reload the practitioner status after a brief delay
    setTimeout(() => {
      loadPractitionerStatus();
    }, 1500);
    
  } catch (error) {
    console.error("Error connecting to practitioner:", error);
    
    // Show error state
    if (connectButton) {
      connectButton.innerHTML = "❌ Connection failed - try again";
      connectButton.style.backgroundColor = "#dc3545";
      
      setTimeout(() => {
        connectButton.innerHTML = "Connect to Selected Practitioner";
        connectButton.style.backgroundColor = "#17a2b8";
        connectButton.disabled = false;
      }, 3000);
    }
  }
};

// Invite practitioner function
async function invitePractitioner() {
  const email = document.getElementById("practitionerEmail").value.trim();
  const name = document.getElementById("practitionerName").value.trim();
  const inviteButton = document.getElementById("inviteButtonText");
  const statusDiv = document.getElementById("inviteStatus");
  
  if (!email || !name) {
    statusDiv.innerHTML = '<span style="color: #dc3545;">Please fill in both email and name</span>';
    return;
  }
  
  // Simple email validation
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    statusDiv.innerHTML = '<span style="color: #dc3545;">Please enter a valid email address</span>';
    return;
  }
  
  try {
    inviteButton.textContent = "Sending...";
    statusDiv.innerHTML = '<span style="color: #2A6972;">Sending invitation...</span>';
    const auth = window.auth;
    if (!auth?.currentUser) {
      throw new Error("You must be logged in to invite a practitioner");
    }
    
    // Get auth token
    const idToken = await auth.currentUser.getIdToken();
    
    // Call cloud function to send invitation
    const endpoint = location.hostname === "localhost" 
      ? "http://localhost:5001/inkwell-alpha/us-central1/sendPractitionerInvitation"
      : "https://us-central1-inkwell-alpha.cloudfunctions.net/sendPractitionerInvitation";
    
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${idToken}`
      },
      body: JSON.stringify({
        practitionerEmail: email,
        practitionerName: name
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to send invitation');
    }
    
    // Save pending invitation to user document
    await window.setDoc(window.doc(window.db, "users", auth.currentUser.uid), {
      pendingPractitionerInvite: {
        email: email,
        name: name,
        sentAt: window.serverTimestamp(),
        status: 'invitation_sent'
      }
    }, { merge: true });
    
    statusDiv.innerHTML = '<span style="color: #28a745;">✅ Professional invitation sent successfully!</span>';
    inviteButton.textContent = "Invitation Sent";
    
    // Reload status to show pending state
    setTimeout(() => {
      loadPractitionerStatus();
      inviteButton.textContent = "Send InkWell Invitation";
    }, 2000);
    
  } catch (error) {
    console.error("Error inviting practitioner:", error);
    
    // Enhanced error reporting
    let errorMessage = error.message;
    if (error.message.includes('500')) {
      errorMessage = 'Server error - check if the email service is configured properly';
    } else if (error.message.includes('401')) {
      errorMessage = 'Authentication error - please try logging out and back in';
    } else if (error.message.includes('403')) {
      errorMessage = 'Permission denied - check Firebase security rules';
    }
    
    statusDiv.innerHTML = `<span style="color: #dc3545;">❌ Error: ${errorMessage}</span>`;
    inviteButton.textContent = "Send InkWell Invitation";
    
    // Log full error details for debugging
    console.log("Full error details:", {
      message: error.message,
      stack: error.stack,
      practitionerEmail: email,
      practitionerName: name
    });
  }
}

// Disconnect practitioner function
async function disconnectPractitioner() {
  if (!confirm("Are you sure you want to disconnect from your practitioner? They will no longer receive your journal entries.")) {
    return;
  }
  
  try {
    const auth = window.auth;
    if (!auth?.currentUser) return;
    
    // Remove practitioner connection from user document
    await window.updateDoc(window.doc(window.db, "users", auth.currentUser.uid), {
      connectedPractitioner: window.deleteField(),
      pendingPractitionerInvite: window.deleteField()
    });
    
    // Clear the form
    document.getElementById("practitionerEmail").value = "";
    document.getElementById("practitionerName").value = "";
    
    // Reload status
    loadPractitionerStatus();
    
    alert("Disconnected from practitioner successfully.");
    
  } catch (error) {
    console.error("Error disconnecting practitioner:", error);
    alert("Error disconnecting: " + error.message);
  }
}

// Clear pending invite when practitioner gets approved
window.clearPendingPractitionerInvite = async function() {
  try {
    console.log("🔄 Clearing pending practitioner invite...");
    const auth = window.auth;
    if (!auth?.currentUser) {
      console.log("❌ No authenticated user");
      return;
    }
    
    await window.updateDoc(window.doc(window.db, "users", auth.currentUser.uid), {
      pendingPractitionerInvite: window.deleteField()
    });
    
    console.log("✅ Cleared pending practitioner invite");
    setTimeout(() => {
      loadPractitionerStatus(); // Refresh the display
    }, 500);
    
  } catch (error) {
    console.error("Error clearing pending invite:", error);
    alert("Error refreshing status: " + error.message);
  }
};


// Global event delegation for dynamically created buttons
document.addEventListener('click', function(e) {
  if (e.target && e.target.id === 'connectToPractitionerBtn') {
    console.log("Button clicked via delegation!");
    e.preventDefault();
    window.connectToApprovedPractitioner();
  }
});
</script>
<script>
// COMPREHENSIVE DEBUG LOGGING
console.log("=== INKWELL DEBUG START ===");

// Check if critical functions exist
window.addEventListener('DOMContentLoaded', function() {
  console.log("1. DOM Loaded");
  console.log("2. connectToApprovedPractitioner exists?", typeof window.connectToApprovedPractitioner);
  console.log("3. loadPractitionerStatus exists?", typeof window.loadPractitionerStatus);
  console.log("4. openUserSettingsModal exists?", typeof window.openUserSettingsModal);
  
  // Override openUserSettingsModal to add logging
  const originalOpen = window.openUserSettingsModal;
  window.openUserSettingsModal = function() {
    console.log("🔵 SETTINGS MODAL OPENING");
    if (originalOpen) {
      originalOpen.call(this);
    }
    
    // Check what's in the practitioner area after modal opens
    setTimeout(() => {
      const statusDiv = document.getElementById("practitionerStatus");
      const button = document.getElementById("connectToPractitionerBtn");
      const dropdown = document.getElementById("approvedPractitionerSelect");
      
      console.log("5. After modal open - practitionerStatus div exists?", !!statusDiv);
      console.log("6. After modal open - connectToPractitionerBtn exists?", !!button);
      console.log("7. After modal open - dropdown exists?", !!dropdown);
      
      if (button) {
        console.log("8. Button onclick attribute:", button.onclick);
        console.log("9. Button outerHTML:", button.outerHTML);
        
        // Force add a click handler as a test
        button.onclick = function(e) {
          console.log("🟢 BUTTON CLICKED VIA ONCLICK OVERRIDE!");
          e.preventDefault();
          if (window.connectToApprovedPractitioner) {
            window.connectToApprovedPractitioner();
          } else {
            console.log("❌ connectToApprovedPractitioner function not found!");
          }
        };
        console.log("10. Forced onclick handler added to button");
      }
    }, 500);
  };
  
  // Override connectToApprovedPractitioner to add logging
  const originalConnect = window.connectToApprovedPractitioner;
  window.connectToApprovedPractitioner = async function() {
    console.log("🟡 connectToApprovedPractitioner CALLED!");
    
    const select = document.getElementById("approvedPractitionerSelect");
    console.log("11. Dropdown found?", !!select);
    
    if (select) {
      console.log("12. Selected value:", select.value);
      console.log("13. Selected index:", select.selectedIndex);
    }
    
    if (originalConnect) {
      return originalConnect.call(this);
    } else {
      console.log("❌ Original connectToApprovedPractitioner not found!");
    }
  };
  
  // Listen for ALL clicks on the page
  document.addEventListener('click', function(e) {
    if (e.target.id === 'connectToPractitionerBtn') {
      console.log("🔴 GLOBAL CLICK LISTENER: Connect button clicked!");
      console.log("14. Event target:", e.target);
      console.log("15. Event type:", e.type);
    }
  }, true); // Use capture phase
  
  console.log("=== DEBUG SETUP COMPLETE ===");
});

// Also check after a delay
setTimeout(() => {
  console.log("=== DELAYED CHECK (5 seconds) ===");
  console.log("16. connectToApprovedPractitioner exists?", typeof window.connectToApprovedPractitioner);
  console.log("17. loadPractitionerStatus exists?", typeof window.loadPractitionerStatus);
  
  // Try to find the button directly
  const button = document.getElementById("connectToPractitionerBtn");
  if (button) {
    console.log("18. Button found after delay");
    console.log("19. Button onclick:", button.onclick);
    console.log("20. Button getAttribute('onclick'):", button.getAttribute('onclick'));
  }
}, 5000);
</script>

</body>
</html>